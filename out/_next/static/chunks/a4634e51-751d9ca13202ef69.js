"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[404],{3061:function(t,e,i){let r,s,a;i.d(e,{ZP:function(){return sz}});var n,l,o,h,d,c,u,f,g,m,p,E,T,y,v,S,A={exports:{}};n=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,l=/^(?=([^\/?#]*))\1([^]*)$/,o=/(?:\/|^)\.(?=\/)/g,h=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,d={buildAbsoluteURL:function(t,e,i){if(i=i||{},t=t.trim(),!(e=e.trim())){if(!i.alwaysNormalize)return t;var r=d.parseURL(t);if(!r)throw Error("Error trying to parse base URL.");return r.path=d.normalizePath(r.path),d.buildURLFromParts(r)}var s=d.parseURL(e);if(!s)throw Error("Error trying to parse relative URL.");if(s.scheme)return i.alwaysNormalize?(s.path=d.normalizePath(s.path),d.buildURLFromParts(s)):e;var a=d.parseURL(t);if(!a)throw Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){var n=l.exec(a.path);a.netLoc=n[1],a.path=n[2]}a.netLoc&&!a.path&&(a.path="/");var o={scheme:a.scheme,netLoc:s.netLoc,path:null,params:s.params,query:s.query,fragment:s.fragment};if(!s.netLoc&&(o.netLoc=a.netLoc,"/"!==s.path[0])){if(s.path){var h=a.path,c=h.substring(0,h.lastIndexOf("/")+1)+s.path;o.path=d.normalizePath(c)}else o.path=a.path,s.params||(o.params=a.params,s.query||(o.query=a.query))}return null===o.path&&(o.path=i.alwaysNormalize?d.normalizePath(s.path):s.path),d.buildURLFromParts(o)},parseURL:function(t){var e=n.exec(t);return e?{scheme:e[1]||"",netLoc:e[2]||"",path:e[3]||"",params:e[4]||"",query:e[5]||"",fragment:e[6]||""}:null},normalizePath:function(t){for(t=t.split("").reverse().join("").replace(o,"");t.length!==(t=t.replace(h,"")).length;);return t.split("").reverse().join("")},buildURLFromParts:function(t){return t.scheme+t.netLoc+t.path+t.params+t.query+t.fragment}},A.exports=d;var L=A.exports;function R(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,r)}return i}function D(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?R(Object(i),!0).forEach(function(e){!function(t,e,i){var r;(e="symbol"==typeof(r=function(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,e||"default");if("object"!=typeof r)return r;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(e,"string"))?r:String(r))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):R(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function I(){return(I=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(t[r]=i[r])}return t}).apply(this,arguments)}let b=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)},k=Number.isSafeInteger||function(t){return"number"==typeof t&&Math.abs(t)<=_},_=Number.MAX_SAFE_INTEGER||9007199254740991,C=((c={}).MEDIA_ATTACHING="hlsMediaAttaching",c.MEDIA_ATTACHED="hlsMediaAttached",c.MEDIA_DETACHING="hlsMediaDetaching",c.MEDIA_DETACHED="hlsMediaDetached",c.BUFFER_RESET="hlsBufferReset",c.BUFFER_CODECS="hlsBufferCodecs",c.BUFFER_CREATED="hlsBufferCreated",c.BUFFER_APPENDING="hlsBufferAppending",c.BUFFER_APPENDED="hlsBufferAppended",c.BUFFER_EOS="hlsBufferEos",c.BUFFER_FLUSHING="hlsBufferFlushing",c.BUFFER_FLUSHED="hlsBufferFlushed",c.MANIFEST_LOADING="hlsManifestLoading",c.MANIFEST_LOADED="hlsManifestLoaded",c.MANIFEST_PARSED="hlsManifestParsed",c.LEVEL_SWITCHING="hlsLevelSwitching",c.LEVEL_SWITCHED="hlsLevelSwitched",c.LEVEL_LOADING="hlsLevelLoading",c.LEVEL_LOADED="hlsLevelLoaded",c.LEVEL_UPDATED="hlsLevelUpdated",c.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",c.LEVELS_UPDATED="hlsLevelsUpdated",c.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",c.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",c.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",c.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",c.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",c.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",c.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",c.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",c.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",c.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",c.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",c.CUES_PARSED="hlsCuesParsed",c.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",c.INIT_PTS_FOUND="hlsInitPtsFound",c.FRAG_LOADING="hlsFragLoading",c.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",c.FRAG_LOADED="hlsFragLoaded",c.FRAG_DECRYPTED="hlsFragDecrypted",c.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",c.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",c.FRAG_PARSING_METADATA="hlsFragParsingMetadata",c.FRAG_PARSED="hlsFragParsed",c.FRAG_BUFFERED="hlsFragBuffered",c.FRAG_CHANGED="hlsFragChanged",c.FPS_DROP="hlsFpsDrop",c.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",c.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",c.ERROR="hlsError",c.DESTROYING="hlsDestroying",c.KEY_LOADING="hlsKeyLoading",c.KEY_LOADED="hlsKeyLoaded",c.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",c.BACK_BUFFER_REACHED="hlsBackBufferReached",c.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",c),w=((u={}).NETWORK_ERROR="networkError",u.MEDIA_ERROR="mediaError",u.KEY_SYSTEM_ERROR="keySystemError",u.MUX_ERROR="muxError",u.OTHER_ERROR="otherError",u),P=((f={}).KEY_SYSTEM_NO_KEYS="keySystemNoKeys",f.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",f.KEY_SYSTEM_NO_SESSION="keySystemNoSession",f.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",f.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",f.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",f.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",f.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",f.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",f.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",f.MANIFEST_LOAD_ERROR="manifestLoadError",f.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",f.MANIFEST_PARSING_ERROR="manifestParsingError",f.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",f.LEVEL_EMPTY_ERROR="levelEmptyError",f.LEVEL_LOAD_ERROR="levelLoadError",f.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",f.LEVEL_PARSING_ERROR="levelParsingError",f.LEVEL_SWITCH_ERROR="levelSwitchError",f.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",f.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",f.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",f.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",f.FRAG_LOAD_ERROR="fragLoadError",f.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",f.FRAG_DECRYPT_ERROR="fragDecryptError",f.FRAG_PARSING_ERROR="fragParsingError",f.FRAG_GAP="fragGap",f.REMUX_ALLOC_ERROR="remuxAllocError",f.KEY_LOAD_ERROR="keyLoadError",f.KEY_LOAD_TIMEOUT="keyLoadTimeOut",f.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",f.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",f.BUFFER_APPEND_ERROR="bufferAppendError",f.BUFFER_APPENDING_ERROR="bufferAppendingError",f.BUFFER_STALLED_ERROR="bufferStalledError",f.BUFFER_FULL_ERROR="bufferFullError",f.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",f.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",f.INTERNAL_EXCEPTION="internalException",f.INTERNAL_ABORTED="aborted",f.UNKNOWN="unknown",f),x=function(){},O={trace:x,debug:x,log:x,warn:x,info:x,error:x},F=O,M=F,N=/^(\d+)x(\d+)$/,U=/(.+?)=(".*?"|.*?)(?:,|$)/g;class B{get clientAttrs(){return Object.keys(this).filter(t=>"X-"===t.substring(0,2))}decimalInteger(t){let e=parseInt(this[t],10);return e>Number.MAX_SAFE_INTEGER?1/0:e}hexadecimalInteger(t){if(!this[t])return null;{let e=(this[t]||"0x").slice(2);e=(1&e.length?"0":"")+e;let i=new Uint8Array(e.length/2);for(let t=0;t<e.length/2;t++)i[t]=parseInt(e.slice(2*t,2*t+2),16);return i}}hexadecimalIntegerAsNumber(t){let e=parseInt(this[t],16);return e>Number.MAX_SAFE_INTEGER?1/0:e}decimalFloatingPoint(t){return parseFloat(this[t])}optionalFloat(t,e){let i=this[t];return i?parseFloat(i):e}enumeratedString(t){return this[t]}bool(t){return"YES"===this[t]}decimalResolution(t){let e=N.exec(this[t]);if(null!==e)return{width:parseInt(e[1],10),height:parseInt(e[2],10)}}static parseAttrList(t){let e;let i={};for(U.lastIndex=0;null!==(e=U.exec(t));){let t=e[2];0===t.indexOf('"')&&t.lastIndexOf('"')===t.length-1&&(t=t.slice(1,-1)),i[e[1].trim()]=t}return i}constructor(t){"string"==typeof t&&(t=B.parseAttrList(t)),I(this,t)}}class G{get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;let t=this.duration;return null!==t?new Date(this._startDate.getTime()+1e3*t):null}get duration(){if("DURATION"in this.attr){let t=this.attr.decimalFloatingPoint("DURATION");if(b(t))return t}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&b(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}constructor(t,e){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,e){let i=e.attr;for(let e in i)if(Object.prototype.hasOwnProperty.call(t,e)&&t[e]!==i[e]){M.warn('DATERANGE tag attribute: "'.concat(e,'" does not match for tags with ID: "').concat(t.ID,'"')),this._badValueForSameId=e;break}t=I(new B({}),i,t)}if(this.attr=t,this._startDate=new Date(t["START-DATE"]),"END-DATE"in this.attr){let t=new Date(this.attr["END-DATE"]);b(t.getTime())&&(this._endDate=t)}}}class K{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var H={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class V{setByteRange(t,e){let i;let r=t.split("@",2);i=1===r.length?(null==e?void 0:e.byteRangeEndOffset)||0:parseInt(r[1]),this._byteRange=[i,parseInt(r[0])+i]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=L.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(t){this._url=t}constructor(t){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[H.AUDIO]:null,[H.VIDEO]:null,[H.AUDIOVIDEO]:null},this.baseurl=t}}class Y extends V{get decryptdata(){let{levelkeys:t}=this;if(!t&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){let t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{let t=Object.keys(this.levelkeys);if(1===t.length)return this._decryptdata=this.levelkeys[t[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime||!b(this.programDateTime))return null;let t=b(this.duration)?this.duration:0;return this.programDateTime+1e3*t}get encrypted(){var t;if(null!=(t=this._decryptdata)&&t.encrypted)return!0;if(this.levelkeys){let t=Object.keys(this.levelkeys),e=t.length;if(e>1||1===e&&this.levelkeys[t[0]].encrypted)return!0}return!1}setKeyFormat(t){if(this.levelkeys){let e=this.levelkeys[t];e&&!this._decryptdata&&(this._decryptdata=e.getDecryptData(this.sn))}}abortRequests(){var t,e;null==(t=this.loader)||t.abort(),null==(e=this.keyLoader)||e.abort()}setElementaryStreamInfo(t,e,i,r,s){let a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],{elementaryStreams:n}=this,l=n[t];if(!l){n[t]={startPTS:e,endPTS:i,startDTS:r,endDTS:s,partial:a};return}l.startPTS=Math.min(l.startPTS,e),l.endPTS=Math.max(l.endPTS,i),l.startDTS=Math.min(l.startDTS,r),l.endDTS=Math.max(l.endDTS,s)}clearElementaryStreamInfo(){let{elementaryStreams:t}=this;t[H.AUDIO]=null,t[H.VIDEO]=null,t[H.AUDIOVIDEO]=null}constructor(t,e){super(e),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new K,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=t}}class W extends V{get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){let{elementaryStreams:t}=this;return!!(t.audio||t.video||t.audiovideo)}constructor(t,e,i,r,s){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new K,this.duration=t.decimalFloatingPoint("DURATION"),this.gap=t.bool("GAP"),this.independent=t.bool("INDEPENDENT"),this.relurl=t.enumeratedString("URI"),this.fragment=e,this.index=r;let a=t.enumeratedString("BYTERANGE");a&&this.setByteRange(a,s),s&&(this.fragOffset=s.fragOffset+s.duration)}}class j{reloaded(t){if(!t){this.advanced=!0,this.updated=!0;return}let e=this.lastPartSn-t.lastPartSn,i=this.lastPartIndex-t.lastPartIndex;this.updated=this.endSN!==t.endSN||!!i||!!e||!this.live,this.advanced=this.endSN>t.endSN||e>0||0===e&&i>0,this.updated||this.advanced?this.misses=Math.floor(.6*t.misses):this.misses=t.misses+1,this.availabilityDelay=t.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&b(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){let t=this.driftEndTime-this.driftStartTime;return t>0?1e3*(this.driftEnd-this.driftStart)/t:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var t;return null!=(t=this.fragments)&&t.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var t;return null!=(t=this.partList)&&t.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}constructor(t){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=t}}function q(t){return Uint8Array.from(atob(t),t=>t.charCodeAt(0))}function X(t){return Uint8Array.from(unescape(encodeURIComponent(t)),t=>t.charCodeAt(0))}let z="undefined"!=typeof self?self:void 0;var Q={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},J={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function $(t){switch(t){case J.FAIRPLAY:return Q.FAIRPLAY;case J.PLAYREADY:return Q.PLAYREADY;case J.WIDEVINE:return Q.WIDEVINE;case J.CLEARKEY:return Q.CLEARKEY}}var Z={WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function tt(t){switch(t){case Q.FAIRPLAY:return J.FAIRPLAY;case Q.PLAYREADY:return J.PLAYREADY;case Q.WIDEVINE:return J.WIDEVINE;case Q.CLEARKEY:return J.CLEARKEY}}function te(t){let{drmSystems:e,widevineLicenseUrl:i}=t,r=e?[Q.FAIRPLAY,Q.WIDEVINE,Q.PLAYREADY,Q.CLEARKEY].filter(t=>!!e[t]):[];return!r[Q.WIDEVINE]&&i&&r.push(Q.WIDEVINE),r}let ti=null!=z&&null!=(g=z.navigator)&&g.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;function tr(t,e,i){return Uint8Array.prototype.slice?t.slice(e,i):new Uint8Array(Array.prototype.slice.call(t,e,i))}let ts=(t,e)=>e+10<=t.length&&73===t[e]&&68===t[e+1]&&51===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128,ta=(t,e)=>e+10<=t.length&&51===t[e]&&68===t[e+1]&&73===t[e+2]&&t[e+3]<255&&t[e+4]<255&&t[e+6]<128&&t[e+7]<128&&t[e+8]<128&&t[e+9]<128,tn=(t,e)=>{let i=e,r=0;for(;ts(t,e);)r+=10+tl(t,e+6),ta(t,e+10)&&(r+=10),e+=r;if(r>0)return t.subarray(i,i+r)},tl=(t,e)=>(127&t[e])<<21|(127&t[e+1])<<14|(127&t[e+2])<<7|127&t[e+3],to=(t,e)=>ts(t,e)&&tl(t,e+6)+10<=t.length-e,th=t=>{let e=tu(t);for(let t=0;t<e.length;t++){let i=e[t];if(td(i))return tE(i)}},td=t=>t&&"PRIV"===t.key&&"com.apple.streaming.transportStreamTimestamp"===t.info,tc=t=>{let e=String.fromCharCode(t[0],t[1],t[2],t[3]),i=tl(t,4);return{type:e,size:i,data:t.subarray(10,10+i)}},tu=t=>{let e=0,i=[];for(;ts(t,e);){let r=tl(t,e+6),s=(e+=10)+r;for(;e+8<s;){let r=tc(t.subarray(e)),s=tf(r);s&&i.push(s),e+=r.size+10}ta(t,e)&&(e+=10)}return i},tf=t=>"PRIV"===t.type?tg(t):"W"===t.type[0]?tp(t):tm(t),tg=t=>{if(t.size<2)return;let e=tT(t.data,!0),i=new Uint8Array(t.data.subarray(e.length+1));return{key:t.type,info:e,data:i.buffer}},tm=t=>{if(t.size<2)return;if("TXXX"===t.type){let e=1,i=tT(t.data.subarray(e),!0);e+=i.length+1;let r=tT(t.data.subarray(e));return{key:t.type,info:i,data:r}}let e=tT(t.data.subarray(1));return{key:t.type,data:e}},tp=t=>{if("WXXX"===t.type){if(t.size<2)return;let e=1,i=tT(t.data.subarray(e),!0);e+=i.length+1;let r=tT(t.data.subarray(e));return{key:t.type,info:i,data:r}}let e=tT(t.data);return{key:t.type,data:e}},tE=t=>{if(8===t.data.byteLength){let e=new Uint8Array(t.data),i=1&e[3],r=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return r/=45,i&&(r+=47721858.84),Math.round(r)}},tT=function(t){let e,i,s=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=function(){if(!navigator.userAgent.includes("PlayStation 4"))return r||void 0===self.TextDecoder||(r=new self.TextDecoder("utf-8")),r}();if(a){let e=a.decode(t);if(s){let t=e.indexOf("\x00");return -1!==t?e.substring(0,t):e}return e.replace(/\0/g,"")}let n=t.length,l="",o=0;for(;o<n&&(0!==(e=t[o++])||!s);)if(0!==e&&3!==e)switch(e>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:l+=String.fromCharCode(e);break;case 12:case 13:l+=String.fromCharCode((31&e)<<6|63&t[o++]);break;case 14:l+=String.fromCharCode((15&e)<<12|(63&t[o++])<<6|(63&t[o++])<<0)}return l},ty={hexDump:function(t){let e="";for(let i=0;i<t.length;i++){let r=t[i].toString(16);r.length<2&&(r="0"+r),e+=r}return e}},tv=[].push,tS={video:1,audio:2,id3:3,text:4};function tA(t){return String.fromCharCode.apply(null,t)}function tL(t,e){let i=t[e]<<8|t[e+1];return i<0?65536+i:i}function tR(t,e){let i=tI(t,e);return i<0?4294967296+i:i}function tD(t,e){let i=tR(t,e);return i*=4294967296,i+=tR(t,e+4)}function tI(t,e){return t[e]<<24|t[e+1]<<16|t[e+2]<<8|t[e+3]}function tb(t,e,i){t[e]=i>>24,t[e+1]=i>>16&255,t[e+2]=i>>8&255,t[e+3]=255&i}function tk(t,e){let i=[];if(!e.length)return i;let r=t.byteLength;for(let s=0;s<r;){let a=tR(t,s),n=tA(t.subarray(s+4,s+8)),l=a>1?s+a:r;if(n===e[0]){if(1===e.length)i.push(t.subarray(s+8,l));else{let r=tk(t.subarray(s+8,l),e.slice(1));r.length&&tv.apply(i,r)}}s=l}return i}function t_(t){let e=[],i=tk(t,["moov","trak"]);for(let t=0;t<i.length;t++){let r=i[t],s=tk(r,["tkhd"])[0];if(s){let t=s[0],i=tR(s,0===t?12:20),a=tk(r,["mdia","mdhd"])[0];if(a){t=a[0];let s=tR(a,0===t?12:20),n=tk(r,["mdia","hdlr"])[0];if(n){let t=tA(n.subarray(8,12)),a={soun:H.AUDIO,vide:H.VIDEO}[t];if(a){let t=function(t){let e=t.subarray(8),i=e.subarray(86),r=tA(e.subarray(4,8)),s=r,a="enca"===r||"encv"===r;if(a){let t=tk(e,[r])[0].subarray("enca"===r?28:78);tk(t,["sinf"]).forEach(t=>{let e=tk(t,["schm"])[0];if(e){let i=tA(e.subarray(4,8));if("cbcs"===i||"cenc"===i){let e=tk(t,["frma"])[0];e&&(s=tA(e))}}})}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{let t=tk(i,["avcC"])[0];s+="."+tw(t[1])+tw(t[2])+tw(t[3]);break}case"mp4a":{let t=tk(e,[r])[0],i=tk(t.subarray(28),["esds"])[0];if(i&&i.length>12){let t=4;if(3!==i[t++])break;t=tC(i,t)+2;let e=i[t++];if(128&e&&(t+=2),64&e&&(t+=i[t++]),4!==i[t++])break;t=tC(i,t);let r=i[t++];if(64===r)s+="."+tw(r);else break;if(t+=12,5!==i[t++])break;t=tC(i,t);let a=i[t++],n=(248&a)>>3;31===n&&(n+=1+((7&a)<<3)+((224&i[t])>>5)),s+="."+n}break}case"hvc1":case"hev1":{let t=tk(i,["hvcC"])[0],e=t[1],r=["","A","B","C"][e>>6],a=tR(t,2),n=t[12],l=t.subarray(6,12);s+="."+r+(31&e)+"."+a.toString(16).toUpperCase()+"."+((32&e)>>5?"H":"L")+n;let o="";for(let t=l.length;t--;){let e=l[t];(e||o)&&(o="."+e.toString(16).toUpperCase()+o)}s+=o;break}case"dvh1":case"dvhe":{let t=tk(i,["dvcC"])[0],e=t[2]>>1&127,r=t[2]<<5&32|t[3]>>3&31;s+="."+tP(e)+"."+tP(r);break}case"vp09":{let t=tk(i,["vpcC"])[0],e=t[4],r=t[5],a=t[6]>>4&15;s+="."+tP(e)+"."+tP(r)+"."+tP(a);break}case"av01":{let t=tk(i,["av1C"])[0],e=t[1]>>>5,r=31&t[1],a=t[2]>>>7?"H":"M",n=(64&t[2])>>6,l=(32&t[2])>>5,o=(16&t[2])>>4,h=(8&t[2])>>3,d=(4&t[2])>>2,c=3&t[2];s+="."+e+"."+tP(r)+a+"."+tP(2===e&&n?l?12:10:n?10:8)+"."+o+"."+h+d+c+"."+tP(1)+"."+tP(1)+"."+tP(1)+".0"}}return{codec:s,encrypted:a}}(tk(r,["mdia","minf","stbl","stsd"])[0]);e[i]={timescale:s,type:a},e[a]=D({timescale:s,id:i},t)}}}}}return tk(t,["moov","mvex","trex"]).forEach(t=>{let i=e[tR(t,4)];i&&(i.default={duration:tR(t,12),flags:tR(t,20)})}),e}function tC(t,e){let i=e+5;for(;128&t[e++]&&e<i;);return e}function tw(t){return("0"+t.toString(16).toUpperCase()).slice(-2)}function tP(t){return(t<10?"0":"")+t}function tx(t){let e=tk(t,["schm"])[0];if(e){let i=tA(e.subarray(4,8));if("cbcs"===i||"cenc"===i)return tk(t,["schi","tenc"])[0]}return M.error("[eme] missing 'schm' box"),null}function tO(t,e){let i=new Uint8Array(t.length+e.length);return i.set(t),i.set(e,t.length),i}function tF(t,e){let i=[],r=e.samples,s=e.timescale,a=e.id,n=!1;return tk(r,["moof"]).map(l=>{let o=l.byteOffset-8;tk(l,["traf"]).map(l=>{let h=tk(l,["tfdt"]).map(t=>{let e=t[0],i=tR(t,4);return 1===e&&(i*=4294967296,i+=tR(t,8)),i/s})[0];return void 0!==h&&(t=h),tk(l,["tfhd"]).map(h=>{let d=tR(h,4),c=16777215&tR(h,0),u=0,f=0,g=8;d===a&&((1&c)!=0&&(g+=8),(2&c)!=0&&(g+=4),(8&c)!=0&&(u=tR(h,g),g+=4),(16&c)!=0&&(f=tR(h,g),g+=4),(32&c)!=0&&(g+=4),"video"===e.type&&(n=function(t){if(!t)return!1;let e=t.indexOf("."),i=e<0?t:t.substring(0,e);return"hvc1"===i||"hev1"===i||"dvh1"===i||"dvhe"===i}(e.codec)),tk(l,["trun"]).map(a=>{let l=a[0],h=16777215&tR(a,0),d=0,c=(256&h)!=0,g=0,m=(512&h)!=0,p=0,E=(1024&h)!=0,T=(2048&h)!=0,y=0,v=tR(a,4),S=8;(1&h)!=0&&(d=tR(a,S),S+=4),(4&h)!=0&&(S+=4);let A=d+o;for(let o=0;o<v;o++){if(c?(g=tR(a,S),S+=4):g=u,m?(p=tR(a,S),S+=4):p=f,E&&(S+=4),T&&(y=0===l?tR(a,S):tI(a,S),S+=4),e.type===H.VIDEO){let e=0;for(;e<p;){let a=tR(r,A);A+=4,function(t,e){if(!t)return 6==(31&e);{let t=e>>1&63;return 39===t||40===t}}(n,r[A])&&tM(r.subarray(A,A+a),n?2:1,t+y/s,i),A+=a,e+=a+4}}t+=g/s}}))})})}),i}function tM(t,e,i,r){let s;let a=tN(t);s=0+e;let n=0,l=0,o=0;for(;s<a.length;){n=0;do{if(s>=a.length)break;n+=o=a[s++]}while(255===o);l=0;do{if(s>=a.length)break;l+=o=a[s++]}while(255===o);let t=a.length-s,e=s;if(l<t)s+=l;else if(l>t){M.error("Malformed SEI payload. ".concat(l," is too small, only ").concat(t," bytes left to parse."));break}if(4===n){if(181===a[e++]){let t=tL(a,e);if(e+=2,49===t){let t=tR(a,e);if(e+=4,1195456820===t){let t=a[e++];if(3===t){let s=a[e++],l=31&s,o=64&s,h=o?2+3*l:0,d=new Uint8Array(h);if(o){d[0]=s;for(let t=1;t<h;t++)d[t]=a[e++]}r.push({type:t,payloadType:n,pts:i,bytes:d})}}}}}else if(5===n&&l>16){let t=[];for(let i=0;i<16;i++){let r=a[e++].toString(16);t.push(1==r.length?"0"+r:r),(3===i||5===i||7===i||9===i)&&t.push("-")}let s=l-16,o=new Uint8Array(s);for(let t=0;t<s;t++)o[t]=a[e++];r.push({payloadType:n,pts:i,uuid:t.join(""),userData:tT(o),userDataBytes:o})}}}function tN(t){let e=t.byteLength,i=[],r=1;for(;r<e-2;)0===t[r]&&0===t[r+1]&&3===t[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return t;let s=e-i.length,a=new Uint8Array(s),n=0;for(r=0;r<s;n++,r++)n===i[0]&&(n++,i.shift()),a[r]=t[n];return a}let tU={};class tB{static clearKeyUriToKeyIdMap(){tU={}}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case J.FAIRPLAY:case J.WIDEVINE:case J.PLAYREADY:case J.CLEARKEY:return -1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(t){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof t&&("AES-128"!==this.method||this.iv||M.warn('missing IV for initialization segment with method="'.concat(this.method,'" - compliance issue')),t=0);let e=function(t){let e=new Uint8Array(16);for(let i=12;i<16;i++)e[i]=t>>8*(15-i)&255;return e}(t);return new tB(this.method,this.uri,"identity",this.keyFormatVersions,e)}let e=function(t){let e=t.split(":"),i=null;if("data"===e[0]&&2===e.length){let t=e[1].split(";"),r=t[t.length-1].split(",");if(2===r.length){let e="base64"===r[0],s=r[1];e?(t.splice(-1,1),i=q(s)):i=function(t){let e=X(t).subarray(0,16),i=new Uint8Array(16);return i.set(e,16-e.length),i}(s)}}return i}(this.uri);if(e)switch(this.keyFormat){case J.WIDEVINE:this.pssh=e,e.length>=22&&(this.keyId=e.subarray(e.length-22,e.length-6));break;case J.PLAYREADY:{let t=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=function(t,e,i){let r,s,a;if(16!==t.byteLength)throw RangeError("Invalid system id");if(e){r=1,s=new Uint8Array(16*e.length);for(let t=0;t<e.length;t++){let i=e[t];if(16!==i.byteLength)throw RangeError("Invalid key");s.set(i,16*t)}}else r=0,s=new Uint8Array;r>0?(a=new Uint8Array(4),e.length>0&&new DataView(a.buffer).setUint32(0,e.length,!1)):a=new Uint8Array;let n=new Uint8Array(4);return i&&i.byteLength>0&&new DataView(n.buffer).setUint32(0,i.byteLength,!1),function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let s=i.length,a=8,n=s;for(;n--;)a+=i[n].byteLength;let l=new Uint8Array(a);for(l[0]=a>>24&255,l[1]=a>>16&255,l[2]=a>>8&255,l[3]=255&a,l.set(t,4),n=0,a=8;n<s;n++)l.set(i[n],a),a+=i[n].byteLength;return l}([112,115,115,104],new Uint8Array([r,0,0,0]),t,a,s,n,i||new Uint8Array)}(t,null,e);let i=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),r=String.fromCharCode.apply(null,Array.from(i)),s=r.substring(r.indexOf("<"),r.length),a=new DOMParser().parseFromString(s,"text/xml").getElementsByTagName("KID")[0];if(a){let t=a.childNodes[0]?a.childNodes[0].nodeValue:a.getAttribute("VALUE");if(t){let e=q(t).subarray(0,16);!function(t){let e=function(t,e,i){let r=t[e];t[e]=t[i],t[i]=r};e(t,0,3),e(t,1,2),e(t,4,5),e(t,6,7)}(e),this.keyId=e}}break}default:{let t=e.subarray(0,16);if(16!==t.length){let e=new Uint8Array(16);e.set(t,16-t.length),t=e}this.keyId=t}}if(!this.keyId||16!==this.keyId.byteLength){let t=tU[this.uri];if(!t){let e=Object.keys(tU).length%Number.MAX_SAFE_INTEGER;t=new Uint8Array(16),new DataView(t.buffer,12,4).setUint32(0,e),tU[this.uri]=t}this.keyId=t}return this}constructor(t,e,i,r=[1],s=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=t,this.uri=e,this.keyFormat=i,this.keyFormatVersions=r,this.iv=s,this.encrypted=!!t&&"NONE"!==t,this.isCommonEncryption=this.encrypted&&"AES-128"!==t}}let tG=/\{\$([a-zA-Z0-9-_]+)\}/g;function tK(t,e,i){if(null!==t.variableList||t.hasVariableRefs)for(let r=i.length;r--;){let s=i[r],a=e[s];a&&(e[s]=tH(t,a))}}function tH(t,e){if(null!==t.variableList||t.hasVariableRefs){let i=t.variableList;return e.replace(tG,e=>{let r=e.substring(2,e.length-1),s=null==i?void 0:i[r];return void 0===s?(t.playlistParsingError||(t.playlistParsingError=Error('Missing preceding EXT-X-DEFINE tag for Variable Reference: "'.concat(r,'"'))),e):s})}return e}function tV(t,e,i){let r,s,a=t.variableList;if(a||(t.variableList=a={}),"QUERYPARAM"in e){r=e.QUERYPARAM;try{let t=new self.URL(i).searchParams;if(t.has(r))s=t.get(r);else throw Error('"'.concat(r,'" does not match any query parameter in URI: "').concat(i,'"'))}catch(e){t.playlistParsingError||(t.playlistParsingError=Error("EXT-X-DEFINE QUERYPARAM: ".concat(e.message)))}}else r=e.NAME,s=e.VALUE;r in a?t.playlistParsingError||(t.playlistParsingError=Error('EXT-X-DEFINE duplicate Variable Name declarations: "'.concat(r,'"'))):a[r]=s||""}function tY(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];if("undefined"!=typeof self)return(t||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}let tW={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function tj(t,e){let i=!(arguments.length>2)||void 0===arguments[2]||arguments[2];return!t.split(",").some(t=>!tq(t,e,i))}function tq(t,e){var i;let r=!(arguments.length>2)||void 0===arguments[2]||arguments[2],s=tY(r);return null!=(i=null==s?void 0:s.isTypeSupported(tX(t,e)))&&i}function tX(t,e){return"".concat(e,'/mp4;codecs="').concat(t,'"')}function tz(t){if(t){let e=t.substring(0,4);return tW.video[e]}return 2}function tQ(t){return t.split(",").reduce((t,e)=>{let i=tW.video[e];return i?(2*i+t)/(t?3:2):(tW.audio[e]+t)/(t?2:1)},0)}let tJ={},t$=/flac|opus/i;function tZ(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];return t.replace(t$,t=>(function(t){let e=!(arguments.length>1)||void 0===arguments[1]||arguments[1];if(tJ[t])return tJ[t];let i={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[t];for(let r=0;r<i.length;r++)if(tq(i[r],"audio",e))return tJ[t]=i[r],i[r];return t})(t.toLowerCase(),e))}function t0(t,e){return t&&"mp4a"!==t?t:e}let t1=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,t2=/#EXT-X-MEDIA:(.*)/g,t4=/^#EXT(?:INF|-X-TARGETDURATION):/m,t3=RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[\S ]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),t5=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class t8{static findGroup(t,e){for(let i=0;i<t.length;i++){let r=t[i];if(r.id===e)return r}}static resolve(t,e){return L.buildAbsoluteURL(e,t,{alwaysNormalize:!0})}static isMediaPlaylist(t){return t4.test(t)}static parseMasterPlaylist(t,e){var i;let r;let s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:tG.test(t)},a=[];for(t1.lastIndex=0;null!=(r=t1.exec(t));)if(r[1]){let t=new B(r[1]);tK(s,t,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);let n=tH(s,r[2]),l={attrs:t,bitrate:t.decimalInteger("BANDWIDTH")||t.decimalInteger("AVERAGE-BANDWIDTH"),name:t.NAME,url:t8.resolve(n,e)},o=t.decimalResolution("RESOLUTION");o&&(l.width=o.width,l.height=o.height),function(t,e){let i=(t||"").split(/[ ,]+/).filter(t=>t);["video","audio","text"].forEach(t=>{let r=i.filter(e=>(function(t,e){let i=tW[e];return!!i&&!!i[t.slice(0,4)]})(e,t));r.length&&(e["".concat(t,"Codec")]=r.join(","),i=i.filter(t=>-1===r.indexOf(t)))}),e.unknownCodecs=i}(t.CODECS,l),null!=(i=l.unknownCodecs)&&i.length||a.push(l),s.levels.push(l)}else if(r[3]){let t=r[3],i=r[4];switch(t){case"SESSION-DATA":{let t=new B(i);tK(s,t,["DATA-ID","LANGUAGE","VALUE","URI"]);let e=t["DATA-ID"];e&&(null===s.sessionData&&(s.sessionData={}),s.sessionData[e]=t);break}case"SESSION-KEY":{let t=t6(i,e,s);t.encrypted&&t.isSupported()?(null===s.sessionKeys&&(s.sessionKeys=[]),s.sessionKeys.push(t)):M.warn('[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "'.concat(i,'"'));break}case"DEFINE":{let t=new B(i);tK(s,t,["NAME","VALUE","QUERYPARAM"]),tV(s,t,e)}break;case"CONTENT-STEERING":{let t=new B(i);tK(s,t,["SERVER-URI","PATHWAY-ID"]),s.contentSteering={uri:t8.resolve(t["SERVER-URI"],e),pathwayId:t["PATHWAY-ID"]||"."};break}case"START":s.startTimeOffset=t9(i)}}let n=a.length>0&&a.length<s.levels.length;return s.levels=n?a:s.levels,0===s.levels.length&&(s.playlistParsingError=Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(t,e,i){let r;let s={},a=i.levels,n={AUDIO:a.map(t=>({id:t.attrs.AUDIO,audioCodec:t.audioCodec})),SUBTITLES:a.map(t=>({id:t.attrs.SUBTITLES,textCodec:t.textCodec})),"CLOSED-CAPTIONS":[]},l=0;for(t2.lastIndex=0;null!==(r=t2.exec(t));){let t=new B(r[1]),a=t.TYPE;if(a){let r=n[a],o=s[a]||[];s[a]=o,tK(i,t,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);let h=t.LANGUAGE,d=t["ASSOC-LANGUAGE"],c=t.CHANNELS,u=t.CHARACTERISTICS,f=t["INSTREAM-ID"],g={attrs:t,bitrate:0,id:l++,groupId:t["GROUP-ID"]||"",name:t.NAME||h||"",type:a,default:t.bool("DEFAULT"),autoselect:t.bool("AUTOSELECT"),forced:t.bool("FORCED"),lang:h,url:t.URI?t8.resolve(t.URI,e):""};if(d&&(g.assocLang=d),c&&(g.channels=c),u&&(g.characteristics=u),f&&(g.instreamId=f),null!=r&&r.length){let t=t8.findGroup(r,g.groupId)||r[0];t7(g,t,"audioCodec"),t7(g,t,"textCodec")}o.push(g)}}return s}static parseLevelPlaylist(t,e,i,r,s,a){let n,l,o;let h=new j(e),d=h.fragments,c=null,u=0,f=0,g=0,m=0,p=null,E=new Y(r,e),T=-1,y=!1,v=null;for(t3.lastIndex=0,h.m3u8=t,h.hasVariableRefs=tG.test(t);null!==(n=t3.exec(t));){y&&(y=!1,(E=new Y(r,e)).start=g,E.sn=u,E.cc=m,E.level=i,c&&(E.initSegment=c,E.rawProgramDateTime=c.rawProgramDateTime,c.rawProgramDateTime=null,v&&(E.setByteRange(v),v=null)));let t=n[1];if(t){E.duration=parseFloat(t);let e=(" "+n[2]).slice(1);E.title=e||null,E.tagList.push(e?["INF",t,e]:["INF",t])}else if(n[3]){if(b(E.duration)){E.start=g,o&&ei(E,o,h),E.sn=u,E.level=i,E.cc=m,d.push(E);let t=(" "+n[3]).slice(1);E.relurl=tH(h,t),et(E,p),p=E,g+=E.duration,u++,f=0,y=!0}}else if(n[4]){let t=(" "+n[4]).slice(1);p?E.setByteRange(t,p):E.setByteRange(t)}else if(n[5])E.rawProgramDateTime=(" "+n[5]).slice(1),E.tagList.push(["PROGRAM-DATE-TIME",E.rawProgramDateTime]),-1===T&&(T=d.length);else{if(!(n=n[0].match(t5))){M.warn("No matches on slow regex match for level playlist!");continue}for(l=1;l<n.length&&void 0===n[l];l++);let t=(" "+n[l]).slice(1),s=(" "+n[l+1]).slice(1),g=n[l+2]?(" "+n[l+2]).slice(1):"";switch(t){case"PLAYLIST-TYPE":h.type=s.toUpperCase();break;case"MEDIA-SEQUENCE":u=h.startSN=parseInt(s);break;case"SKIP":{let t=new B(s);tK(h,t,["RECENTLY-REMOVED-DATERANGES"]);let e=t.decimalInteger("SKIPPED-SEGMENTS");if(b(e)){h.skippedSegments=e;for(let t=e;t--;)d.unshift(null);u+=e}let i=t.enumeratedString("RECENTLY-REMOVED-DATERANGES");i&&(h.recentlyRemovedDateranges=i.split("	"));break}case"TARGETDURATION":h.targetduration=Math.max(parseInt(s),1);break;case"VERSION":h.version=parseInt(s);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":h.live=!1;break;case"#":(s||g)&&E.tagList.push(g?[s,g]:[s]);break;case"DISCONTINUITY":m++,E.tagList.push(["DIS"]);break;case"GAP":E.gap=!0,E.tagList.push([t]);break;case"BITRATE":E.tagList.push([t,s]);break;case"DATERANGE":{let t=new B(s);tK(h,t,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),tK(h,t,t.clientAttrs);let e=new G(t,h.dateRanges[t.ID]);e.isValid||h.skippedSegments?h.dateRanges[e.id]=e:M.warn('Ignoring invalid DATERANGE tag: "'.concat(s,'"')),E.tagList.push(["EXT-X-DATERANGE",s]);break}case"DEFINE":{let t=new B(s);tK(h,t,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in t?function(t,e,i){let r=e.IMPORT;if(i&&r in i){let e=t.variableList;e||(t.variableList=e={}),e[r]=i[r]}else t.playlistParsingError||(t.playlistParsingError=Error('EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "'.concat(r,'"')))}(h,t,a):tV(h,t,e)}break;case"DISCONTINUITY-SEQUENCE":m=parseInt(s);break;case"KEY":{let t=t6(s,e,h);if(t.isSupported()){if("NONE"===t.method){o=void 0;break}o||(o={}),o[t.keyFormat]&&(o=I({},o)),o[t.keyFormat]=t}else M.warn('[Keys] Ignoring invalid EXT-X-KEY tag: "'.concat(s,'"'));break}case"START":h.startTimeOffset=t9(s);break;case"MAP":{let t=new B(s);if(tK(h,t,["BYTERANGE","URI"]),E.duration){let s=new Y(r,e);ee(s,t,i,o),c=s,E.initSegment=c,c.rawProgramDateTime&&!E.rawProgramDateTime&&(E.rawProgramDateTime=c.rawProgramDateTime)}else{let e=E.byteRangeEndOffset;if(e){let t=E.byteRangeStartOffset;v="".concat(e-t,"@").concat(t)}else v=null;ee(E,t,i,o),c=E,y=!0}break}case"SERVER-CONTROL":{let t=new B(s);h.canBlockReload=t.bool("CAN-BLOCK-RELOAD"),h.canSkipUntil=t.optionalFloat("CAN-SKIP-UNTIL",0),h.canSkipDateRanges=h.canSkipUntil>0&&t.bool("CAN-SKIP-DATERANGES"),h.partHoldBack=t.optionalFloat("PART-HOLD-BACK",0),h.holdBack=t.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{let t=new B(s);h.partTarget=t.decimalFloatingPoint("PART-TARGET");break}case"PART":{let t=h.partList;t||(t=h.partList=[]);let i=f>0?t[t.length-1]:void 0,r=f++,a=new B(s);tK(h,a,["BYTERANGE","URI"]);let n=new W(a,E,e,r,i);t.push(n),E.duration+=n.duration;break}case"PRELOAD-HINT":{let t=new B(s);tK(h,t,["URI"]),h.preloadHint=t;break}case"RENDITION-REPORT":{let t=new B(s);tK(h,t,["URI"]),h.renditionReports=h.renditionReports||[],h.renditionReports.push(t);break}default:M.warn("line parsed but not handled: ".concat(n))}}}p&&!p.relurl?(d.pop(),g-=p.duration,h.partList&&(h.fragmentHint=p)):h.partList&&(et(E,p),E.cc=m,h.fragmentHint=E,o&&ei(E,o,h));let S=d.length,A=d[0],L=d[S-1];if((g+=h.skippedSegments*h.targetduration)>0&&S&&L){h.averagetargetduration=g/S;let t=L.sn;h.endSN="initSegment"!==t?t:0,h.live||(L.endList=!0),A&&(h.startCC=A.cc)}else h.endSN=0,h.startCC=0;return h.fragmentHint&&(g+=h.fragmentHint.duration),h.totalduration=g,h.endCC=m,T>0&&function(t,e){let i=t[e];for(let r=e;r--;){let e=t[r];if(!e)return;e.programDateTime=i.programDateTime-1e3*e.duration,i=e}}(d,T),h}}function t6(t,e,i){var r,s;let a=new B(t);tK(i,a,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);let n=null!=(r=a.METHOD)?r:"",l=a.URI,o=a.hexadecimalInteger("IV"),h=a.KEYFORMATVERSIONS,d=null!=(s=a.KEYFORMAT)?s:"identity";return l&&a.IV&&!o&&M.error("Invalid IV: ".concat(a.IV)),new tB(n,l?t8.resolve(l,e):"",d,(h||"1").split("/").map(Number).filter(Number.isFinite),o)}function t9(t){let e=new B(t).decimalFloatingPoint("TIME-OFFSET");return b(e)?e:null}function t7(t,e,i){let r=e[i];r&&(t[i]=r)}function et(t,e){t.rawProgramDateTime?t.programDateTime=Date.parse(t.rawProgramDateTime):null!=e&&e.programDateTime&&(t.programDateTime=e.endProgramDateTime),b(t.programDateTime)||(t.programDateTime=null,t.rawProgramDateTime=null)}function ee(t,e,i,r){t.relurl=e.URI,e.BYTERANGE&&t.setByteRange(e.BYTERANGE),t.level=i,t.sn="initSegment",r&&(t.levelkeys=r),t.initSegment=null}function ei(t,e,i){t.levelkeys=e;let{encryptedFragments:r}=i;(!r.length||r[r.length-1].levelkeys!==e)&&Object.keys(e).some(t=>e[t].isCommonEncryption)&&r.push(t)}var er={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},es={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function ea(t){let{type:e}=t;switch(e){case er.AUDIO_TRACK:return es.AUDIO;case er.SUBTITLE_TRACK:return es.SUBTITLE;default:return es.MAIN}}function en(t,e){let i=t.url;return(void 0===i||0===i.indexOf("data:"))&&(i=e.url),i}class el{startLoad(t){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){let{hls:t}=this;t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.LEVEL_LOADING,this.onLevelLoading,this),t.on(C.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.on(C.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){let{hls:t}=this;t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.LEVEL_LOADING,this.onLevelLoading,this),t.off(C.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),t.off(C.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(t){let e=this.hls.config,i=e.pLoader,r=e.loader,s=new(i||r)(e);return this.loaders[t.type]=s,s}getInternalLoader(t){return this.loaders[t.type]}resetInternalLoader(t){this.loaders[t]&&delete this.loaders[t]}destroyInternalLoaders(){for(let t in this.loaders){let e=this.loaders[t];e&&e.destroy(),this.resetInternalLoader(t)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(t,e){let{url:i}=e;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:er.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(t,e){let{id:i,level:r,pathwayId:s,url:a,deliveryDirectives:n}=e;this.load({id:i,level:r,pathwayId:s,responseType:"text",type:er.LEVEL,url:a,deliveryDirectives:n})}onAudioTrackLoading(t,e){let{id:i,groupId:r,url:s,deliveryDirectives:a}=e;this.load({id:i,groupId:r,level:null,responseType:"text",type:er.AUDIO_TRACK,url:s,deliveryDirectives:a})}onSubtitleTrackLoading(t,e){let{id:i,groupId:r,url:s,deliveryDirectives:a}=e;this.load({id:i,groupId:r,level:null,responseType:"text",type:er.SUBTITLE_TRACK,url:s,deliveryDirectives:a})}load(t){var e;let i;let r=this.hls.config,s=this.getInternalLoader(t);if(s){let e=s.context;if(e&&e.url===t.url&&e.level===t.level){M.trace("[playlist-loader]: playlist request ongoing");return}M.log("[playlist-loader]: aborting previous loader for type: ".concat(t.type)),s.abort()}if(i=t.type===er.MANIFEST?r.manifestLoadPolicy.default:I({},r.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(t),b(null==(e=t.deliveryDirectives)?void 0:e.part)){let e;if(t.type===er.LEVEL&&null!==t.level?e=this.hls.levels[t.level].details:t.type===er.AUDIO_TRACK&&null!==t.id?e=this.hls.audioTracks[t.id].details:t.type===er.SUBTITLE_TRACK&&null!==t.id&&(e=this.hls.subtitleTracks[t.id].details),e){let t=e.partTarget,r=e.targetduration;if(t&&r){let e=1e3*Math.max(3*t,.8*r);i=I({},i,{maxTimeToFirstByteMs:Math.min(e,i.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(e,i.maxTimeToFirstByteMs)})}}}let a=i.errorRetry||i.timeoutRetry||{},n={loadPolicy:i,timeout:i.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0};s.load(t,n,{onSuccess:(t,e,i,r)=>{let s=this.getInternalLoader(i);this.resetInternalLoader(i.type);let a=t.data;if(0!==a.indexOf("#EXTM3U")){this.handleManifestParsingError(t,i,Error("no EXTM3U delimiter"),r||null,e);return}e.parsing.start=performance.now(),t8.isMediaPlaylist(a)?this.handleTrackOrLevelPlaylist(t,e,i,r||null,s):this.handleMasterPlaylist(t,e,i,r)},onError:(t,e,i,r)=>{this.handleNetworkError(e,i,!1,t,r)},onTimeout:(t,e,i)=>{this.handleNetworkError(e,i,!0,void 0,t)}})}handleMasterPlaylist(t,e,i,r){let s=this.hls,a=t.data,n=en(t,i),l=t8.parseMasterPlaylist(a,n);if(l.playlistParsingError){this.handleManifestParsingError(t,i,l.playlistParsingError,r,e);return}let{contentSteering:o,levels:h,sessionData:d,sessionKeys:c,startTimeOffset:u,variableList:f}=l;this.variableList=f;let{AUDIO:g=[],SUBTITLES:m,"CLOSED-CAPTIONS":p}=t8.parseMasterPlaylistMedia(a,n,l);g.length&&!g.some(t=>!t.url)&&h[0].audioCodec&&!h[0].attrs.AUDIO&&(M.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),g.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new B({}),bitrate:0,url:""})),s.trigger(C.MANIFEST_LOADED,{levels:h,audioTracks:g,subtitles:m,captions:p,contentSteering:o,url:n,stats:e,networkDetails:r,sessionData:d,sessionKeys:c,startTimeOffset:u,variableList:f})}handleTrackOrLevelPlaylist(t,e,i,r,s){let a=this.hls,{id:n,level:l,type:o}=i,h=en(t,i),d=b(l)?l:b(n)?n:0,c=ea(i),u=t8.parseLevelPlaylist(t.data,h,d,c,0,this.variableList);if(o===er.MANIFEST){let t={attrs:new B({}),bitrate:0,details:u,name:"",url:h};a.trigger(C.MANIFEST_LOADED,{levels:[t],audioTracks:[],url:h,stats:e,networkDetails:r,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}e.parsing.end=performance.now(),i.levelDetails=u,this.handlePlaylistLoaded(u,t,e,i,r,s)}handleManifestParsingError(t,e,i,r,s){this.hls.trigger(C.ERROR,{type:w.NETWORK_ERROR,details:P.MANIFEST_PARSING_ERROR,fatal:e.type===er.MANIFEST,url:t.url,err:i,error:i,reason:i.message,response:t,context:e,networkDetails:r,stats:s})}handleNetworkError(t,e){let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,a="A network ".concat(i?"timeout":"error"+(r?" (status "+r.code+")":"")," occurred while loading ").concat(t.type);t.type===er.LEVEL?a+=": ".concat(t.level," id: ").concat(t.id):(t.type===er.AUDIO_TRACK||t.type===er.SUBTITLE_TRACK)&&(a+=" id: ".concat(t.id,' group-id: "').concat(t.groupId,'"'));let n=Error(a);M.warn("[playlist-loader]: ".concat(a));let l=P.UNKNOWN,o=!1,h=this.getInternalLoader(t);switch(t.type){case er.MANIFEST:l=i?P.MANIFEST_LOAD_TIMEOUT:P.MANIFEST_LOAD_ERROR,o=!0;break;case er.LEVEL:l=i?P.LEVEL_LOAD_TIMEOUT:P.LEVEL_LOAD_ERROR,o=!1;break;case er.AUDIO_TRACK:l=i?P.AUDIO_TRACK_LOAD_TIMEOUT:P.AUDIO_TRACK_LOAD_ERROR,o=!1;break;case er.SUBTITLE_TRACK:l=i?P.SUBTITLE_TRACK_LOAD_TIMEOUT:P.SUBTITLE_LOAD_ERROR,o=!1}h&&this.resetInternalLoader(t.type);let d={type:w.NETWORK_ERROR,details:l,fatal:o,url:t.url,loader:h,context:t,error:n,networkDetails:e,stats:s};if(r){let i=(null==e?void 0:e.url)||t.url;d.response=D({url:i,data:void 0},r)}this.hls.trigger(C.ERROR,d)}handlePlaylistLoaded(t,e,i,r,s,a){let n=this.hls,{type:l,level:o,id:h,groupId:d,deliveryDirectives:c}=r,u=en(e,r),f=ea(r),g="number"==typeof r.level&&f===es.MAIN?o:void 0;if(!t.fragments.length){let t=Error("No Segments found in Playlist");n.trigger(C.ERROR,{type:w.NETWORK_ERROR,details:P.LEVEL_EMPTY_ERROR,fatal:!1,url:u,error:t,reason:t.message,response:e,context:r,level:g,parent:f,networkDetails:s,stats:i});return}t.targetduration||(t.playlistParsingError=Error("Missing Target Duration"));let m=t.playlistParsingError;if(m){n.trigger(C.ERROR,{type:w.NETWORK_ERROR,details:P.LEVEL_PARSING_ERROR,fatal:!1,url:u,error:m,reason:m.message,response:e,context:r,level:g,parent:f,networkDetails:s,stats:i});return}switch(t.live&&a&&(a.getCacheAge&&(t.ageHeader=a.getCacheAge()||0),(!a.getCacheAge||isNaN(t.ageHeader))&&(t.ageHeader=0)),l){case er.MANIFEST:case er.LEVEL:n.trigger(C.LEVEL_LOADED,{details:t,level:g||0,id:h||0,stats:i,networkDetails:s,deliveryDirectives:c});break;case er.AUDIO_TRACK:n.trigger(C.AUDIO_TRACK_LOADED,{details:t,id:h||0,groupId:d||"",stats:i,networkDetails:s,deliveryDirectives:c});break;case er.SUBTITLE_TRACK:n.trigger(C.SUBTITLE_TRACK_LOADED,{details:t,id:h||0,groupId:d||"",stats:i,networkDetails:s,deliveryDirectives:c})}}constructor(t){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=t,this.registerListeners()}}function eo(t,e){let i;try{i=new Event("addtrack")}catch(t){(i=document.createEvent("Event")).initEvent("addtrack",!1,!1)}i.track=t,e.dispatchEvent(i)}function eh(t,e){let i=t.mode;if("disabled"===i&&(t.mode="hidden"),t.cues&&!t.cues.getCueById(e.id))try{if(t.addCue(e),!t.cues.getCueById(e.id))throw Error("addCue is failed for: ".concat(e))}catch(i){M.debug("[texttrack-utils]: ".concat(i));try{let i=new self.TextTrackCue(e.startTime,e.endTime,e.text);i.id=e.id,t.addCue(i)}catch(t){M.debug("[texttrack-utils]: Legacy TextTrackCue fallback failed: ".concat(t))}}"disabled"===i&&(t.mode=i)}function ed(t){let e=t.mode;if("disabled"===e&&(t.mode="hidden"),t.cues)for(let e=t.cues.length;e--;)t.removeCue(t.cues[e]);"disabled"===e&&(t.mode=e)}function ec(t,e,i,r){let s=t.mode;if("disabled"===s&&(t.mode="hidden"),t.cues&&t.cues.length>0){let s=function(t,e,i){let r=[],s=function(t,e){if(e<t[0].startTime)return 0;let i=t.length-1;if(e>t[i].endTime)return -1;let r=0,s=i;for(;r<=s;){let a=Math.floor((s+r)/2);if(e<t[a].startTime)s=a-1;else{if(!(e>t[a].startTime)||!(r<i))return a;r=a+1}}return t[r].startTime-e<e-t[s].startTime?r:s}(t,e);if(s>-1)for(let a=s,n=t.length;a<n;a++){let s=t[a];if(s.startTime>=e&&s.endTime<=i)r.push(s);else if(s.startTime>i)break}return r}(t.cues,e,i);for(let e=0;e<s.length;e++)(!r||r(s[e]))&&t.removeCue(s[e])}"disabled"===s&&(t.mode=s)}function eu(t){let e=[];for(let i=0;i<t.length;i++){let r=t[i];("subtitles"===r.kind||"captions"===r.kind)&&r.label&&e.push(t[i])}return e}var ef={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};function eg(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function em(t,e,i,r,s){let a=new t(e,i,"");try{a.value=r,s&&(a.type=s)}catch(n){a=new t(e,i,JSON.stringify(s?D({type:s},r):r))}return a}let ep=(()=>{let t=eg();try{t&&new t(0,Number.POSITIVE_INFINITY,"")}catch(t){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function eE(t,e){return t.getTime()/1e3-e}class eT{destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){let{hls:t}=this;t.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(C.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){let{hls:t}=this;t.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),t.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(C.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(t,e){this.media=e.media}onMediaDetaching(){this.id3Track&&(ed(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(t){let e=this.getID3Track(t.textTracks);return e.mode="hidden",e}getID3Track(t){if(this.media){for(let e=0;e<t.length;e++){let i=t[e];if("metadata"===i.kind&&"id3"===i.label)return eo(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(t,e){if(!this.media)return;let{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:r}}}=this;if(!i&&!r)return;let{samples:s}=e;this.id3Track||(this.id3Track=this.createTrack(this.media));let a=eg();if(a)for(let t=0;t<s.length;t++){let e=s[t].type;if(e===ef.emsg&&!i||!r)continue;let n=tu(s[t].data);if(n){let i=s[t].pts,r=i+s[t].duration;r>ep&&(r=ep),r-i<=0&&(r=i+.25);for(let t=0;t<n.length;t++){let s=n[t];if(!td(s)){this.updateId3CueEnds(i,e);let t=em(a,i,r,s,e);t&&this.id3Track.addCue(t)}}}}}updateId3CueEnds(t,e){var i;let r=null==(i=this.id3Track)?void 0:i.cues;if(r)for(let i=r.length;i--;){let s=r[i];s.type===e&&s.startTime<t&&s.endTime===ep&&(s.endTime=t)}}onBufferFlushing(t,e){let{startOffset:i,endOffset:r,type:s}=e,{id3Track:a,hls:n}=this;if(!n)return;let{config:{enableEmsgMetadataCues:l,enableID3MetadataCues:o}}=n;a&&(l||o)&&ec(a,i,r,"audio"===s?t=>t.type===ef.audioId3&&o:"video"===s?t=>t.type===ef.emsg&&l:t=>t.type===ef.audioId3&&o||t.type===ef.emsg&&l)}onLevelUpdated(t,e){let{details:i}=e;if(!this.media||!i.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;let{dateRangeCuesAppended:r,id3Track:s}=this,{dateRanges:a}=i,n=Object.keys(a);if(s){let t=Object.keys(r).filter(t=>!n.includes(t));for(let e=t.length;e--;){let i=t[e];Object.keys(r[i].cues).forEach(t=>{s.removeCue(r[i].cues[t])}),delete r[i]}}let l=i.fragments[i.fragments.length-1];if(0===n.length||!b(null==l?void 0:l.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));let o=l.programDateTime/1e3-l.start,h=eg();for(let t=0;t<n.length;t++){let e=n[t],i=a[e],s=eE(i.startDate,o),l=r[e],c=(null==l?void 0:l.cues)||{},u=(null==l?void 0:l.durationKnown)||!1,f=ep,g=i.endDate;if(g)f=eE(g,o),u=!0;else if(i.endOnNext&&!u){let t=n.reduce((t,e)=>{if(e!==i.id){let r=a[e];if(r.class===i.class&&r.startDate>i.startDate&&(!t||i.startDate<t.startDate))return r}return t},null);t&&(f=eE(t.startDate,o),u=!0)}let m=Object.keys(i.attr);for(let t=0;t<m.length;t++){var d;let r=m[t];if(!("ID"!==r&&"CLASS"!==r&&"START-DATE"!==r&&"DURATION"!==r&&"END-DATE"!==r&&"END-ON-NEXT"!==r))continue;let a=c[r];if(a)u&&!l.durationKnown&&(a.endTime=f);else if(h){let t=i.attr[r];("SCTE35-OUT"===r||"SCTE35-IN"===r)&&(d=t,t=Uint8Array.from(d.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer);let a=em(h,s,f,{key:r,data:t},ef.dateRange);a&&(a.id=e,this.id3Track.addCue(a),c[r]=a)}}r[e]={cues:c,dateRange:i,durationKnown:u}}}constructor(t){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=t,this._registerListeners()}}class ey{get latency(){return this._latency||0}get maxLatency(){let{config:t,levelDetails:e}=this;return void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:e?t.liveMaxLatencyDurationCount*e.targetduration:0}get targetLatency(){let{levelDetails:t}=this;if(null===t)return null;let{holdBack:e,partHoldBack:i,targetduration:r}=t,{liveSyncDuration:s,liveSyncDurationCount:a,lowLatencyMode:n}=this.config,l=this.hls.userConfig,o=n&&i||e;return(l.liveSyncDuration||l.liveSyncDurationCount||0===o)&&(o=void 0!==s?s:a*r),o+Math.min(1*this.stallCount,r)}get liveSyncPosition(){let t=this.estimateLiveEdge(),e=this.targetLatency,i=this.levelDetails;if(null===t||null===e||null===i)return null;let r=i.edge,s=t-e-this.edgeStalled;return Math.min(Math.max(r-i.totalduration,s),r-(this.config.lowLatencyMode&&i.partTarget||i.targetduration))}get drift(){let{levelDetails:t}=this;return null===t?1:t.drift}get edgeStalled(){let{levelDetails:t}=this;if(null===t)return 0;let e=3*(this.config.lowLatencyMode&&t.partTarget||t.targetduration);return Math.max(t.age-e,0)}get forwardBufferLength(){let{media:t,levelDetails:e}=this;if(!t||!e)return 0;let i=t.buffered.length;return(i?t.buffered.end(i-1):e.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(C.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(C.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(C.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(C.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(C.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(C.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(t,e){let{details:i}=e;this.levelDetails=i,i.advanced&&this.timeupdate(),!i.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(t,e){var i;e.details===P.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(i=this.levelDetails)&&i.live&&M.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){let{media:t,levelDetails:e}=this;if(!t||!e)return;this.currentTime=t.currentTime;let i=this.computeLatency();if(null===i)return;this._latency=i;let{lowLatencyMode:r,maxLiveSyncPlaybackRate:s}=this.config;if(!r||1===s||!e.live)return;let a=this.targetLatency;if(null===a)return;let n=i-a;if(n<Math.min(this.maxLatency,a+e.targetduration)&&n>.05&&this.forwardBufferLength>1){let e=Math.round(2/(1+Math.exp(-.75*n-this.edgeStalled))*20)/20;t.playbackRate=Math.min(Math.min(2,Math.max(1,s)),Math.max(1,e))}else 1!==t.playbackRate&&0!==t.playbackRate&&(t.playbackRate=1)}estimateLiveEdge(){let{levelDetails:t}=this;return null===t?null:t.edge+t.age}computeLatency(){let t=this.estimateLiveEdge();return null===t?null:t-this.currentTime}constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=t,this.config=t.config,this.registerListeners()}}let ev=["NONE","TYPE-0","TYPE-1",null],eS=["SDR","PQ","HLG"];var eA={No:"",Yes:"YES",v2:"v2"};class eL{addDirectives(t){let e=new self.URL(t);return void 0!==this.msn&&e.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&e.searchParams.set("_HLS_part",this.part.toString()),this.skip&&e.searchParams.set("_HLS_skip",this.skip),e.href}constructor(t,e,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=t,this.part=e,this.skip=i}}class eR{get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(t){return eD(this._audioGroups,t)}hasSubtitleGroup(t){return eD(this._subtitleGroups,t)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(t,e){if(e){if("audio"===t){let t=this._audioGroups;t||(t=this._audioGroups=[]),-1===t.indexOf(e)&&t.push(e)}else if("text"===t){let t=this._subtitleGroups;t||(t=this._subtitleGroups=[]),-1===t.indexOf(e)&&t.push(e)}}}get urlId(){return 0}set urlId(t){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var t;return null==(t=this.audioGroups)?void 0:t[0]}get textGroupId(){var t;return null==(t=this.subtitleGroups)?void 0:t[0]}addFallback(){}constructor(t){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[t.url],this._attrs=[t.attrs],this.bitrate=t.bitrate,t.details&&(this.details=t.details),this.id=t.id||0,this.name=t.name,this.width=t.width||0,this.height=t.height||0,this.frameRate=t.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=t.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=t.audioCodec,this.videoCodec=t.videoCodec,this.codecSet=[t.videoCodec,t.audioCodec].filter(t=>!!t).map(t=>t.substring(0,4)).join(","),this.addGroupId("audio",t.attrs.AUDIO),this.addGroupId("text",t.attrs.SUBTITLES)}}function eD(t,e){return!!e&&!!t&&-1!==t.indexOf(e)}function eI(t,e){let i=e.startPTS;if(b(i)){let r,s=0;e.sn>t.sn?(s=i-t.start,r=t):(s=t.start-i,r=e),r.duration!==s&&(r.duration=s)}else e.sn>t.sn?t.cc===e.cc&&t.minEndPTS?e.start=t.start+(t.minEndPTS-t.start):e.start=t.start+t.duration:e.start=Math.max(t.start-e.duration,0)}function eb(t,e,i,r,s,a){let n;r-i<=0&&(M.warn("Fragment should have a positive duration",e),r=i+e.duration,a=s+e.duration);let l=i,o=r,h=e.startPTS,d=e.endPTS;if(b(h)){let t=Math.abs(h-i);b(e.deltaPTS)?e.deltaPTS=Math.max(t,e.deltaPTS):e.deltaPTS=t,l=Math.max(i,h),i=Math.min(i,h),s=Math.min(s,e.startDTS),o=Math.min(r,d),r=Math.max(r,d),a=Math.max(a,e.endDTS)}let c=i-e.start;0!==e.start&&(e.start=i),e.duration=r-e.start,e.startPTS=i,e.maxStartPTS=l,e.startDTS=s,e.endPTS=r,e.minEndPTS=o,e.endDTS=a;let u=e.sn;if(!t||u<t.startSN||u>t.endSN)return 0;let f=u-t.startSN,g=t.fragments;for(g[f]=e,n=f;n>0;n--)eI(g[n],g[n-1]);for(n=f;n<g.length-1;n++)eI(g[n],g[n+1]);return t.fragmentHint&&eI(g[g.length-1],t.fragmentHint),t.PTSKnown=t.alignedSliding=!0,c}function ek(t,e){let i=e.startSN+e.skippedSegments-t.startSN,r=t.fragments;i<0||i>=r.length||e_(e,r[i].start)}function e_(t,e){if(e){let i=t.fragments;for(let r=t.skippedSegments;r<i.length;r++)i[r].start+=e;t.fragmentHint&&(t.fragmentHint.start+=e)}}function eC(t,e,i){var r;return null!=t&&t.details?ew(null==(r=t.details)?void 0:r.partList,e,i):null}function ew(t,e,i){if(t)for(let r=t.length;r--;){let s=t[r];if(s.index===i&&s.fragment.sn===e)return s}return null}function eP(t){t.forEach((t,e)=>{let{details:i}=t;null!=i&&i.fragments&&i.fragments.forEach(t=>{t.level=e})})}function ex(t){switch(t.details){case P.FRAG_LOAD_TIMEOUT:case P.KEY_LOAD_TIMEOUT:case P.LEVEL_LOAD_TIMEOUT:case P.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function eO(t,e){let i=ex(e);return t.default["".concat(i?"timeout":"error","Retry")]}function eF(t,e){return Math.min(("linear"===t.backoff?1:Math.pow(2,e))*t.retryDelayMs,t.maxRetryDelayMs)}function eM(t){return D(D({},t),{errorRetry:null,timeoutRetry:null})}function eN(t,e,i,r){if(!t)return!1;let s=null==r?void 0:r.code,a=e<t.maxNumRetry&&(0===s&&!1===navigator.onLine||!!s&&(s<400||s>499)||!!i);return t.shouldRetry?t.shouldRetry(t,e,i,r,a):a}let eU={search:function(t,e){let i=0,r=t.length-1,s=null,a=null;for(;i<=r;){let n=e(a=t[s=(i+r)/2|0]);if(n>0)i=s+1;else{if(!(n<0))return a;r=s-1}}return null}};function eB(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=null;if(t){s=e[t.sn-e[0].sn+1]||null;let r=t.endDTS-i;r>0&&r<15e-7&&(i+=15e-7)}else 0===i&&0===e[0].start&&(s=e[0]);if(s&&(!t||t.level===s.level)&&0===eG(i,r,s))return s;let a=eU.search(e,eG.bind(null,i,r));return a&&(a!==t||!s)?a:s}function eG(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(i.start<=t&&i.start+i.duration>t)return 0;let r=Math.min(e,i.duration+(i.deltaPTS?i.deltaPTS:0));return i.start+i.duration-r<=t?1:i.start-r>t&&i.start?-1:0}var eK={DoNothing:0,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,RetryRequest:5},eH={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2};class eV{registerListeners(){let t=this.hls;t.on(C.ERROR,this.onError,this),t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){let t=this.hls;t&&(t.off(C.ERROR,this.onError,this),t.off(C.ERROR,this.onErrorOut,this),t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(t){}stopLoad(){this.playlistError=0}getVariantLevelIndex(t){return(null==t?void 0:t.type)===es.MAIN?t.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(t,e){var i,r,s,a;if(e.fatal)return;let n=this.hls,l=e.context;switch(e.details){case P.FRAG_LOAD_ERROR:case P.FRAG_LOAD_TIMEOUT:case P.KEY_LOAD_ERROR:case P.KEY_LOAD_TIMEOUT:e.errorAction=this.getFragRetryOrSwitchAction(e);return;case P.FRAG_PARSING_ERROR:if(null!=(i=e.frag)&&i.gap){e.errorAction={action:eK.DoNothing,flags:eH.None};return}case P.FRAG_GAP:case P.FRAG_DECRYPT_ERROR:e.errorAction=this.getFragRetryOrSwitchAction(e),e.errorAction.action=eK.SendAlternateToPenaltyBox;return;case P.LEVEL_EMPTY_ERROR:case P.LEVEL_PARSING_ERROR:{let t=e.parent===es.MAIN?e.level:n.loadLevel;e.details===P.LEVEL_EMPTY_ERROR&&null!=(s=e.context)&&null!=(a=s.levelDetails)&&a.live?e.errorAction=this.getPlaylistRetryOrSwitchAction(e,t):(e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t))}return;case P.LEVEL_LOAD_ERROR:case P.LEVEL_LOAD_TIMEOUT:"number"==typeof(null==l?void 0:l.level)&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,l.level));return;case P.AUDIO_TRACK_LOAD_ERROR:case P.AUDIO_TRACK_LOAD_TIMEOUT:case P.SUBTITLE_LOAD_ERROR:case P.SUBTITLE_TRACK_LOAD_TIMEOUT:if(l){let t=n.levels[n.loadLevel];t&&(l.type===er.AUDIO_TRACK&&t.hasAudioGroup(l.groupId)||l.type===er.SUBTITLE_TRACK&&t.hasSubtitleGroup(l.groupId))&&(e.errorAction=this.getPlaylistRetryOrSwitchAction(e,n.loadLevel),e.errorAction.action=eK.SendAlternateToPenaltyBox,e.errorAction.flags=eH.MoveAllAlternatesMatchingHost)}return;case P.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{let t=n.levels[n.loadLevel],i=null==t?void 0:t.attrs["HDCP-LEVEL"];i?e.errorAction={action:eK.SendAlternateToPenaltyBox,flags:eH.MoveAllAlternatesMatchingHDCP,hdcpLevel:i}:this.keySystemError(e)}return;case P.BUFFER_ADD_CODEC_ERROR:case P.REMUX_ALLOC_ERROR:case P.BUFFER_APPEND_ERROR:e.errorAction=this.getLevelSwitchAction(e,null!=(r=e.level)?r:n.loadLevel);return;case P.INTERNAL_EXCEPTION:case P.BUFFER_APPENDING_ERROR:case P.BUFFER_FULL_ERROR:case P.LEVEL_SWITCH_ERROR:case P.BUFFER_STALLED_ERROR:case P.BUFFER_SEEK_OVER_HOLE:case P.BUFFER_NUDGE_ON_STALL:e.errorAction={action:eK.DoNothing,flags:eH.None};return}e.type===w.KEY_SYSTEM_ERROR&&this.keySystemError(e)}keySystemError(t){let e=this.getVariantLevelIndex(t.frag);t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e)}getPlaylistRetryOrSwitchAction(t,e){let i=eO(this.hls.config.playlistLoadPolicy,t),r=this.playlistError++;if(eN(i,r,ex(t),t.response))return{action:eK.RetryRequest,flags:eH.None,retryConfig:i,retryCount:r};let s=this.getLevelSwitchAction(t,e);return i&&(s.retryConfig=i,s.retryCount=r),s}getFragRetryOrSwitchAction(t){let e=this.hls,i=this.getVariantLevelIndex(t.frag),r=e.levels[i],{fragLoadPolicy:s,keyLoadPolicy:a}=e.config,n=eO(t.details.startsWith("key")?a:s,t),l=e.levels.reduce((t,e)=>t+e.fragmentError,0);if(r&&(t.details!==P.FRAG_GAP&&r.fragmentError++,eN(n,l,ex(t),t.response)))return{action:eK.RetryRequest,flags:eH.None,retryConfig:n,retryCount:l};let o=this.getLevelSwitchAction(t,i);return n&&(o.retryConfig=n,o.retryCount=l),o}getLevelSwitchAction(t,e){let i=this.hls;null==e&&(e=i.loadLevel);let r=this.hls.levels[e];if(r){var s,a,n,l;let e=t.details;r.loadError++,e===P.BUFFER_APPEND_ERROR&&r.fragmentError++;let o=-1,{levels:h,loadLevel:d,minAutoLevel:c,maxAutoLevel:u}=i;i.autoLevelEnabled||(i.loadLevel=-1);let f=null==(s=t.frag)?void 0:s.type,g=(f===es.AUDIO&&e===P.FRAG_PARSING_ERROR||"audio"===t.sourceBufferName&&(e===P.BUFFER_ADD_CODEC_ERROR||e===P.BUFFER_APPEND_ERROR))&&h.some(t=>{let{audioCodec:e}=t;return r.audioCodec!==e}),m="video"===t.sourceBufferName&&(e===P.BUFFER_ADD_CODEC_ERROR||e===P.BUFFER_APPEND_ERROR)&&h.some(t=>{let{codecSet:e,audioCodec:i}=t;return r.codecSet!==e&&r.audioCodec===i}),{type:p,groupId:E}=null!=(a=t.context)?a:{};for(let i=h.length;i--;){let s=(i+d)%h.length;if(s!==d&&s>=c&&s<=u&&0===h[s].loadError){let i=h[s];if(e===P.FRAG_GAP&&t.frag){let e=h[s].details;if(e){let i=eB(t.frag,e.fragments,t.frag.start);if(null!=i&&i.gap)continue}}else if(p===er.AUDIO_TRACK&&i.hasAudioGroup(E)||p===er.SUBTITLE_TRACK&&i.hasSubtitleGroup(E))continue;else if(f===es.AUDIO&&null!=(n=r.audioGroups)&&n.some(t=>i.hasAudioGroup(t))||f===es.SUBTITLE&&null!=(l=r.subtitleGroups)&&l.some(t=>i.hasSubtitleGroup(t))||g&&r.audioCodec===i.audioCodec||!g&&r.audioCodec!==i.audioCodec||m&&r.codecSet===i.codecSet)continue;o=s;break}}if(o>-1&&i.loadLevel!==o)return t.levelRetry=!0,this.playlistError=0,{action:eK.SendAlternateToPenaltyBox,flags:eH.None,nextAutoLevel:o}}return{action:eK.SendAlternateToPenaltyBox,flags:eH.MoveAllAlternatesMatchingHost}}onErrorOut(t,e){var i;switch(null==(i=e.errorAction)?void 0:i.action){case eK.DoNothing:break;case eK.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(e),e.errorAction.resolved||e.details===P.FRAG_GAP?/MediaSource readyState: ended/.test(e.error.message)&&(this.warn('MediaSource ended after "'.concat(e.sourceBufferName,'" sourceBuffer append error. Attempting to recover from media error.')),this.hls.recoverMediaError()):e.fatal=!0;case eK.RetryRequest:}if(e.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(t){let e=this.hls,i=t.errorAction;if(!i)return;let{flags:r,hdcpLevel:s,nextAutoLevel:a}=i;switch(r){case eH.None:this.switchLevel(t,a);break;case eH.MoveAllAlternatesMatchingHDCP:s&&(e.maxHdcpLevel=ev[ev.indexOf(s)-1],i.resolved=!0),this.warn('Restricting playback to HDCP-LEVEL of "'.concat(e.maxHdcpLevel,'" or lower'))}i.resolved||this.switchLevel(t,a)}switchLevel(t,e){void 0!==e&&t.errorAction&&(this.warn("switching to level ".concat(e," after ").concat(t.details)),this.hls.nextAutoLevel=e,t.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}constructor(t){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=t,this.log=M.log.bind(M,"[info]:"),this.warn=M.warn.bind(M,"[warning]:"),this.error=M.error.bind(M,"[error]:"),this.registerListeners()}}class eY{destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(t,e){let i=null==e?void 0:e.renditionReports;if(i){let r=-1;for(let s=0;s<i.length;s++){let a;let n=i[s];try{a=new self.URL(n.URI,e.url).href}catch(t){M.warn("Could not construct new URL for Rendition Report: ".concat(t)),a=n.URI||""}if(a===t){r=s;break}a===t.substring(0,a.length)&&(r=s)}if(-1!==r){let t=i[r],s=parseInt(t["LAST-MSN"])||(null==e?void 0:e.lastPartSn),a=parseInt(t["LAST-PART"])||(null==e?void 0:e.lastPartIndex);if(this.hls.config.lowLatencyMode){let t=Math.min(e.age-e.partTarget,e.targetduration);a>=0&&t>e.partTarget&&(a+=1)}return new eL(s,a>=0?a:void 0,eA.No)}}}loadPlaylist(t){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(t){return this.canLoad&&!!t&&!!t.url&&(!t.details||t.details.live)}shouldReloadPlaylist(t){return -1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(t)}playlistLoaded(t,e,i){let{details:r,stats:s}=e,a=self.performance.now(),n=s.loading.first?Math.max(0,a-s.loading.first):0;if(r.advancedDateTime=Date.now()-n,r.live||null!=i&&i.live){let n,l,o;if(r.reloaded(i),i&&this.log("live playlist ".concat(t," ").concat(r.advanced?"REFRESHED "+r.lastPartSn+"-"+r.lastPartIndex:r.updated?"UPDATED":"MISSED")),i&&r.fragments.length>0&&function(t,e){let i,r=null,s=t.fragments;for(let t=s.length-1;t>=0;t--){let e=s[t].initSegment;if(e){r=e;break}}t.fragmentHint&&delete t.fragmentHint.endPTS;let a=0;if(function(t,e,i){let r=e.skippedSegments,s=Math.max(t.startSN,e.startSN)-e.startSN,a=(t.fragmentHint?1:0)+(r?e.endSN:Math.min(t.endSN,e.endSN))-e.startSN,n=e.startSN-t.startSN,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments;for(let t=s;t<=a;t++){let s=o[n+t],a=l[t];r&&!a&&t<r&&(a=e.fragments[t]=s),s&&a&&i(s,a)}}(t,e,(t,s)=>{t.relurl&&(a=t.cc-s.cc),b(t.startPTS)&&b(t.endPTS)&&(s.start=s.startPTS=t.startPTS,s.startDTS=t.startDTS,s.maxStartPTS=t.maxStartPTS,s.endPTS=t.endPTS,s.endDTS=t.endDTS,s.minEndPTS=t.minEndPTS,s.duration=t.endPTS-t.startPTS,s.duration&&(i=s),e.PTSKnown=e.alignedSliding=!0),s.elementaryStreams=t.elementaryStreams,s.loader=t.loader,s.stats=t.stats,t.initSegment&&(s.initSegment=t.initSegment,r=t.initSegment)}),r&&(e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments).forEach(t=>{var e;t&&(!t.initSegment||t.initSegment.relurl===(null==(e=r)?void 0:e.relurl))&&(t.initSegment=r)}),e.skippedSegments){if(e.deltaUpdateFailed=e.fragments.some(t=>!t),e.deltaUpdateFailed){M.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let t=e.skippedSegments;t--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else e.canSkipDateRanges&&(e.dateRanges=function(t,e,i){let r=I({},t);return i&&i.forEach(t=>{delete r[t]}),Object.keys(e).forEach(t=>{let i=new G(e[t].attr,r[t]);i.isValid?r[t]=i:M.warn('Ignoring invalid Playlist Delta Update DATERANGE tag: "'.concat(JSON.stringify(e[t].attr),'"'))}),r}(t.dateRanges,e.dateRanges,e.recentlyRemovedDateranges))}let n=e.fragments;if(a){M.warn("discontinuity sliding from playlist, take drift into account");for(let t=0;t<n.length;t++)n[t].cc+=a}e.skippedSegments&&(e.startCC=e.fragments[0].cc),function(t,e,i){if(t&&e){let r=0;for(let s=0,a=t.length;s<=a;s++){let a=t[s],n=e[s+r];a&&n&&a.index===n.index&&a.fragment.sn===n.fragment.sn?i(a,n):r--}}}(t.partList,e.partList,(t,e)=>{e.elementaryStreams=t.elementaryStreams,e.stats=t.stats}),i?eb(e,i,i.startPTS,i.endPTS,i.startDTS,i.endDTS):ek(t,e),n.length&&(e.totalduration=e.edge-n[0].start),e.driftStartTime=t.driftStartTime,e.driftStart=t.driftStart;let l=e.advancedDateTime;if(e.advanced&&l){let t=e.edge;e.driftStart||(e.driftStartTime=l,e.driftStart=t),e.driftEndTime=l,e.driftEnd=t}else e.driftEndTime=t.driftEndTime,e.driftEnd=t.driftEnd,e.advancedDateTime=t.advancedDateTime}(i,r),!this.canLoad||!r.live)return;if(r.canBlockReload&&r.endSN&&r.advanced){let t=this.hls.config.lowLatencyMode,s=r.lastPartSn,a=r.endSN,h=r.lastPartIndex,d=s===a;-1!==h?(l=d?a+1:s,o=d?t?0:h:h+1):l=a+1;let c=r.age,u=Math.min(c+r.ageHeader-r.partTarget,1.5*r.targetduration);if(u>0){if(i&&u>i.tuneInGoal)this.warn("CDN Tune-in goal increased from: ".concat(i.tuneInGoal," to: ").concat(u," with playlist age: ").concat(r.age)),u=0;else{let t=Math.floor(u/r.targetduration);l+=t,void 0!==o&&(o+=Math.round(u%r.targetduration/r.partTarget)),this.log("CDN Tune-in age: ".concat(r.ageHeader,"s last advanced ").concat(c.toFixed(2),"s goal: ").concat(u," skip sn ").concat(t," to part ").concat(o))}r.tuneInGoal=u}if(n=this.getDeliveryDirectives(r,e.deliveryDirectives,l,o),t||!d){this.loadPlaylist(n);return}}else(r.canBlockReload||r.canSkipUntil)&&(n=this.getDeliveryDirectives(r,e.deliveryDirectives,l,o));let h=this.hls.mainForwardBufferInfo,d=h?h.end-h.len:0,c=(r.edge-d)*1e3,u=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1/0,i=1e3*t.targetduration;if(t.updated){let r=t.fragments;if(r.length&&4*i>e){let t=1e3*r[r.length-1].duration;t<i&&(i=t)}}else i/=2;return Math.round(i)}(r,c);r.updated&&a>this.requestScheduled+u&&(this.requestScheduled=s.loading.start),void 0!==l&&r.canBlockReload?this.requestScheduled=s.loading.first+u-(1e3*r.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+u<a?this.requestScheduled=a:this.requestScheduled-a<=0&&(this.requestScheduled+=u);let f=this.requestScheduled-a;f=Math.max(0,f),this.log("reload live playlist ".concat(t," in ").concat(Math.round(f)," ms")),this.timer=self.setTimeout(()=>this.loadPlaylist(n),f)}else this.clearTimer()}getDeliveryDirectives(t,e,i,r){let s=function(t,e){let{canSkipUntil:i,canSkipDateRanges:r,endSN:s}=t;return i&&(void 0!==e?e-s:0)<i?r?eA.v2:eA.Yes:eA.No}(t,i);return null!=e&&e.skip&&t.deltaUpdateFailed&&(i=e.msn,r=e.part,s=eA.No),new eL(i,r,s)}checkRetry(t){let e=t.details,i=ex(t),r=t.errorAction,{action:s,retryCount:a=0,retryConfig:n}=r||{},l=!!r&&!!n&&(s===eK.RetryRequest||!r.resolved&&s===eK.SendAlternateToPenaltyBox);if(l){var o;if(this.requestScheduled=-1,a>=n.maxNumRetry)return!1;if(i&&null!=(o=t.context)&&o.deliveryDirectives)this.warn("Retrying playlist loading ".concat(a+1,"/").concat(n.maxNumRetry,' after "').concat(e,'" without delivery-directives')),this.loadPlaylist();else{let t=eF(n,a);this.timer=self.setTimeout(()=>this.loadPlaylist(),t),this.warn("Retrying playlist loading ".concat(a+1,"/").concat(n.maxNumRetry,' after "').concat(e,'" in ').concat(t,"ms"))}t.levelRetry=!0,r.resolved=!0}return l}constructor(t,e){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=M.log.bind(M,"".concat(e,":")),this.warn=M.warn.bind(M,"".concat(e,":")),this.hls=t}}class eW{sample(t,e){let i=Math.pow(this.alpha_,t);this.estimate_=e*(1-i)+i*this.estimate_,this.totalWeight_+=t}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){let t=1-Math.pow(this.alpha_,this.totalWeight_);if(t)return this.estimate_/t}return this.estimate_}constructor(t,e=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=t,this.alpha_=t?Math.exp(Math.log(.5)/t):0,this.estimate_=e,this.totalWeight_=i}}class ej{update(t,e){let{slow_:i,fast_:r,ttfb_:s}=this;i.halfLife!==t&&(this.slow_=new eW(t,i.getEstimate(),i.getTotalWeight())),r.halfLife!==e&&(this.fast_=new eW(e,r.getEstimate(),r.getTotalWeight())),s.halfLife!==t&&(this.ttfb_=new eW(t,s.getEstimate(),s.getTotalWeight()))}sample(t,e){let i=(t=Math.max(t,this.minDelayMs_))/1e3,r=8*e/i;this.fast_.sample(i,r),this.slow_.sample(i,r)}sampleTTFB(t){this.ttfb_.sample(Math.sqrt(2)*Math.exp(-Math.pow(t/1e3,2)/2),Math.max(t,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}constructor(t,e,i,r=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new eW(t),this.fast_=new eW(e),this.defaultTTFB_=r,this.ttfb_=new eW(t)}}let eq={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},eX={};function ez(t,e){M.log('[abr] start candidates with "'.concat(t,'" ignored because ').concat(e))}function eQ(t,e,i){if("attrs"in t){let i=e.indexOf(t);if(-1!==i)return i}for(let r=0;r<e.length;r++)if(eJ(t,e[r],i))return r;return -1}function eJ(t,e,i){let{groupId:r,name:s,lang:a,assocLang:n,characteristics:l,default:o}=t,h=t.forced;return(void 0===r||e.groupId===r)&&(void 0===s||e.name===s)&&(void 0===a||e.lang===a)&&(void 0===a||e.assocLang===n)&&(void 0===o||e.default===o)&&(void 0===h||e.forced===h)&&(void 0===l||function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=t.split(","),r=e.split(",");return i.length===r.length&&!i.some(t=>-1===r.indexOf(t))}(l,e.characteristics))&&(void 0===i||i(t,e))}function e$(t,e){let{audioCodec:i,channels:r}=t;return(void 0===i||(e.audioCodec||"").substring(0,4)===i.substring(0,4))&&(void 0===r||r===(e.channels||"2"))}function eZ(t,e,i){for(let r=e;r;r--)if(i(t[r]))return r;for(let r=e+1;r<t.length;r++)if(i(t[r]))return r;return -1}class e0{resetEstimator(t){t&&(M.log("setting initial bwe to ".concat(t)),this.hls.config.abrEwmaDefaultEstimate=t),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){let t=this.hls.config;return new ej(t.abrEwmaSlowVoD,t.abrEwmaFastVoD,t.abrEwmaDefaultEstimate)}registerListeners(){let{hls:t}=this;t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.FRAG_LOADING,this.onFragLoading,this),t.on(C.FRAG_LOADED,this.onFragLoaded,this),t.on(C.FRAG_BUFFERED,this.onFragBuffered,this),t.on(C.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(C.LEVEL_LOADED,this.onLevelLoaded,this),t.on(C.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(C.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.on(C.ERROR,this.onError,this)}unregisterListeners(){let{hls:t}=this;t&&(t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.FRAG_LOADING,this.onFragLoading,this),t.off(C.FRAG_LOADED,this.onFragLoaded,this),t.off(C.FRAG_BUFFERED,this.onFragBuffered,this),t.off(C.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(C.LEVEL_LOADED,this.onLevelLoaded,this),t.off(C.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(C.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),t.off(C.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(t,e){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(t,e){let i=e.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var r;this.fragCurrent=i,this.partCurrent=null!=(r=e.part)?r:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(t,e){this.clearTimer()}onError(t,e){if(!e.fatal)switch(e.details){case P.BUFFER_ADD_CODEC_ERROR:case P.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case P.FRAG_LOAD_TIMEOUT:{let t=e.frag,{fragCurrent:i,partCurrent:r}=this;if(t&&i&&t.sn===i.sn&&t.level===i.level){let e=performance.now(),i=r?r.stats:t.stats,s=e-i.loading.start,a=i.loading.first?i.loading.first-i.loading.start:-1;if(i.loaded&&a>-1){let t=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(s-Math.min(t,a),i.loaded)}else this.bwEstimator.sampleTTFB(s)}}}}getTimeToLoadFrag(t,e,i,r){return t+i/e+(r?this.lastLevelLoadSec:0)}onLevelLoaded(t,e){let i=this.hls.config,{loading:r}=e.stats,s=r.end-r.start;b(s)&&(this.lastLevelLoadSec=s/1e3),e.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(t,e){let{frag:i,part:r}=e,s=r?r.stats:i.stats;if(i.type===es.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(i)){if(this.clearTimer(),i.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){let t=r?r.duration:i.duration,e=this.hls.levels[i.level],a=(e.loaded?e.loaded.bytes:0)+s.loaded,n=(e.loaded?e.loaded.duration:0)+t;e.loaded={bytes:a,duration:n},e.realBitrate=Math.round(8*a/n)}if(i.bitrateTest){let t={stats:s,frag:i,part:r,id:i.type};this.onFragBuffered(C.FRAG_BUFFERED,t),i.bitrateTest=!1}else this.lastLoadedFragLevel=i.level}}onFragBuffered(t,e){let{frag:i,part:r}=e,s=null!=r&&r.stats.loaded?r.stats:i.stats;if(s.aborted||this.ignoreFragment(i))return;let a=s.parsing.end-s.loading.start-Math.min(s.loading.first-s.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(a,s.loaded),s.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=a/1e3:this.bitrateTestDelay=0}ignoreFragment(t){return t.type!==es.MAIN||"initSegment"===t.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){let{maxAutoLevel:t,minAutoLevel:e}=this.hls,i=this.getBwEstimate(),r=this.hls.config.maxStarvationDelay,s=this.findBestLevel(i,e,t,0,r,1,1);if(s>-1)return s;let a=this.hls.firstLevel,n=Math.min(Math.max(a,e),t);return M.warn("[abr] Could not find best starting auto level. Defaulting to first in playlist ".concat(a," clamped to ").concat(n)),n}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){let t=this.forcedAutoLevel,e=this.bwEstimator.canEstimate(),i=this.lastLoadedFragLevel>-1;if(-1!==t&&(!e||!i||this.nextAutoLevelKey===this.getAutoLevelKey()))return t;let r=e&&i?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==t){let e=this.hls.levels;if(e.length>Math.max(t,r)&&e[t].loadError<=e[r].loadError)return t}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return"".concat(this.getBwEstimate(),"_").concat(this.getStarvationDelay().toFixed(2))}getNextABRAutoLevel(){let{fragCurrent:t,partCurrent:e,hls:i}=this,{maxAutoLevel:r,config:s,minAutoLevel:a}=i,n=e?e.duration:t?t.duration:0,l=this.getBwEstimate(),o=this.getStarvationDelay(),h=s.abrBandWidthFactor,d=s.abrBandWidthUpFactor;if(o){let t=this.findBestLevel(l,a,r,o,0,h,d);if(t>=0)return t}let c=n?Math.min(n,s.maxStarvationDelay):s.maxStarvationDelay;if(!o){let t=this.bitrateTestDelay;t&&(c=(n?Math.min(n,s.maxLoadingDelay):s.maxLoadingDelay)-t,M.info("[abr] bitrate test took ".concat(Math.round(1e3*t),"ms, set first fragment max fetchDuration to ").concat(Math.round(1e3*c)," ms")),h=d=1)}let u=this.findBestLevel(l,a,r,o,c,h,d);if(M.info("[abr] ".concat(o?"rebuffering expected":"buffer is empty",", optimal quality level ").concat(u)),u>-1)return u;let f=i.levels[a],g=i.levels[i.loadLevel];return(null==f?void 0:f.bitrate)<(null==g?void 0:g.bitrate)?a:i.loadLevel}getStarvationDelay(){let t=this.hls,e=t.media;if(!e)return 1/0;let i=e&&0!==e.playbackRate?Math.abs(e.playbackRate):1,r=t.mainForwardBufferInfo;return(r?r.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(t,e,i,r,s,a,n){var l,o;let h;let d=r+s,c=this.lastLoadedFragLevel,u=-1===c?this.hls.firstLevel:c,{fragCurrent:f,partCurrent:g}=this,{levels:m,allAudioTracks:p,loadLevel:E,config:T}=this.hls;if(1===m.length)return 0;let y=m[u],v=!!(null!=y&&null!=(l=y.details)&&l.live),S=-1===E||-1===c,A="SDR",L=(null==y?void 0:y.frameRate)||0,{audioPreference:R,videoPreference:I}=T,k=this.audioTracksByGroup||(this.audioTracksByGroup=p.reduce((t,e)=>{let i=t.groups[e.groupId];i||(i=t.groups[e.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(e);let r=e.channels||"2";return i.channels[r]=(i.channels[r]||0)+1,i.hasDefault=i.hasDefault||e.default,i.hasAutoSelect=i.hasAutoSelect||e.autoselect,i.hasDefault&&(t.hasDefaultAudio=!0),i.hasAutoSelect&&(t.hasAutoSelectAudio=!0),t},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}}));if(S){if(-1!==this.firstSelection)return this.firstSelection;let r=function(t,e,i,r,s){var a;let n,l;let o=Object.keys(t),h=null==r?void 0:r.channels,d=null==r?void 0:r.audioCodec,c=h&&2===parseInt(h),u=!0,f=!1,g=1/0,m=1/0,p=1/0,E=0,T=[],{preferHDR:y,allowedVideoRanges:v}=(n=!1,l=[],(a=e)&&(n="SDR"!==a,l=[a]),s&&(l=s.allowedVideoRanges||eS.slice(0),l=(n=void 0!==s.preferHDR?s.preferHDR:function(){if("function"==typeof matchMedia){let t=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(t.media!==e.media)return!0===t.matches}return!1}())?l.filter(t=>"SDR"!==t):["SDR"]),{preferHDR:n,allowedVideoRanges:l});for(let e=o.length;e--;){let i=t[o[e]];u=i.channels[2]>0,g=Math.min(g,i.minHeight),m=Math.min(m,i.minFramerate),p=Math.min(p,i.minBitrate);let r=v.filter(t=>i.videoRanges[t]>0);r.length>0&&(f=!0,T=r)}g=b(g)?g:0,m=b(m)?m:0;let S=Math.max(1080,g),A=Math.max(30,m);return i=Math.max(p=b(p)?p:i,i),f||(e=void 0,T=[]),{codecSet:o.reduce((e,r)=>{let s=t[r];if(r===e)return e;if(s.minBitrate>i)return ez(r,"min bitrate of ".concat(s.minBitrate," > current estimate of ").concat(i)),e;if(!s.hasDefaultAudio)return ez(r,"no renditions with default or auto-select sound found"),e;if(d&&r.indexOf(d.substring(0,4))%5!=0)return ez(r,'audio codec preference "'.concat(d,'" not found')),e;if(h&&!c){if(!s.channels[h])return ez(r,"no renditions with ".concat(h," channel sound found (channels options: ").concat(Object.keys(s.channels),")")),e}else if((!d||c)&&u&&0===s.channels["2"])return ez(r,"no renditions with stereo sound found"),e;return s.minHeight>S?(ez(r,"min resolution of ".concat(s.minHeight," > maximum of ").concat(S)),e):s.minFramerate>A?(ez(r,"min framerate of ".concat(s.minFramerate," > maximum of ").concat(A)),e):T.some(t=>s.videoRanges[t]>0)?s.maxScore<E?(ez(r,"max score of ".concat(s.maxScore," < selected max of ").concat(E)),e):e&&(tQ(r)>=tQ(e)||s.fragmentError>t[e].fragmentError)?e:(E=s.maxScore,r):(ez(r,"no variants with VIDEO-RANGE of ".concat(JSON.stringify(T)," found")),e)},void 0),videoRanges:T,preferHDR:y,minFramerate:m,minBitrate:p}}(this.codecTiers||(this.codecTiers=m.slice(e,i+1).reduce((t,e)=>{if(!e.codecSet)return t;let i=e.audioGroups,r=t[e.codecSet];r||(t[e.codecSet]=r={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!i,fragmentError:0}),r.minBitrate=Math.min(r.minBitrate,e.bitrate);let s=Math.min(e.height,e.width);return r.minHeight=Math.min(r.minHeight,s),r.minFramerate=Math.min(r.minFramerate,e.frameRate),r.maxScore=Math.max(r.maxScore,e.score),r.fragmentError+=e.fragmentError,r.videoRanges[e.videoRange]=(r.videoRanges[e.videoRange]||0)+1,i&&i.forEach(t=>{if(!t)return;let e=k.groups[t];r.hasDefaultAudio=r.hasDefaultAudio||k.hasDefaultAudio?e.hasDefault:e.hasAutoSelect||!k.hasDefaultAudio&&!k.hasAutoSelectAudio,Object.keys(e.channels).forEach(t=>{r.channels[t]=(r.channels[t]||0)+e.channels[t]})}),t},{})),A,t,R,I),{codecSet:s,videoRanges:a,minFramerate:n,minBitrate:l,preferHDR:o}=r;h=s,A=o?a[a.length-1]:a[0],L=n,t=Math.max(t,l),M.log("[abr] picked start tier ".concat(JSON.stringify(r)))}else h=null==y?void 0:y.codecSet,A=null==y?void 0:y.videoRange;let _=g?g.duration:f?f.duration:0,C=this.bwEstimator.getEstimateTTFB()/1e3,w=[];for(let l=i;l>=e;l--){let e;let f=m[l],p=l>u;if(!f)continue;if(T.useMediaCapabilities&&!f.supportedResult&&!f.supportedPromise){let e=navigator.mediaCapabilities;"function"==typeof(null==e?void 0:e.decodingInfo)&&function(t,e,i,r,s,a){let n=t.audioCodec?t.audioGroups:null,l=null==a?void 0:a.audioCodec,o=null==a?void 0:a.channels,h=o?parseInt(o):l?1/0:2,d=null;if(null!=n&&n.length)try{d=1===n.length&&n[0]?e.groups[n[0]].channels:n.reduce((t,i)=>{if(i){let r=e.groups[i];if(!r)throw Error("Audio track group ".concat(i," not found"));Object.keys(r.channels).forEach(e=>{t[e]=(t[e]||0)+r.channels[e]})}return t},{2:0})}catch(t){return!0}return void 0!==t.videoCodec&&(t.width>1920&&t.height>1088||t.height>1920&&t.width>1088||t.frameRate>Math.max(r,30)||"SDR"!==t.videoRange&&t.videoRange!==i||t.bitrate>Math.max(s,8e6))||!!d&&b(h)&&Object.keys(d).some(t=>parseInt(t)>h)}(f,k,A,L,t,R)?(f.supportedPromise=function(t,e,i){let r=t.videoCodec,s=t.audioCodec;if(!r||!s||!i)return Promise.resolve(eq);let a={width:t.width,height:t.height,bitrate:Math.ceil(Math.max(.9*t.bitrate,t.averageBitrate)),framerate:t.frameRate||30},n=t.videoRange;"SDR"!==n&&(a.transferFunction=n.toLowerCase());let l=r.split(",").map(t=>({type:"media-source",video:D(D({},a),{},{contentType:tX(t,"video")})}));return s&&t.audioGroups&&t.audioGroups.forEach(t=>{var i;t&&(null==(i=e.groups[t])||i.tracks.forEach(e=>{if(e.groupId===t){let t=parseFloat(e.channels||"");b(t)&&t>2&&l.push.apply(l,s.split(",").map(e=>({type:"media-source",audio:{contentType:tX(e,"audio"),channels:""+t}})))}}))}),Promise.all(l.map(t=>{let e=function(t){let{audio:e,video:i}=t,r=i||e;if(r){let t=r.contentType.split('"')[1];if(i)return"r".concat(i.height,"x").concat(i.width,"f").concat(Math.ceil(i.framerate)).concat(i.transferFunction||"sd","_").concat(t,"_").concat(Math.ceil(i.bitrate/1e5));if(e)return"c".concat(e.channels).concat(e.spatialRendering?"s":"n","_").concat(t)}return""}(t);return eX[e]||(eX[e]=i.decodingInfo(t))})).then(t=>({supported:!t.some(t=>!t.supported),configurations:l,decodingInfoResults:t})).catch(t=>({supported:!1,configurations:l,decodingInfoResults:[],error:t}))}(f,k,e),f.supportedPromise.then(t=>{if(!this.hls)return;f.supportedResult=t;let e=this.hls.levels,i=e.indexOf(f);t.error?M.warn('[abr] MediaCapabilities decodingInfo error: "'.concat(t.error,'" for level ').concat(i," ").concat(JSON.stringify(t))):!t.supported&&(M.warn("[abr] Unsupported MediaCapabilities decodingInfo result for level ".concat(i," ").concat(JSON.stringify(t))),i>-1&&e.length>1&&(M.log("[abr] Removing unsupported level ".concat(i)),this.hls.removeLevel(i)))})):f.supportedResult=eq}if(h&&f.codecSet!==h||A&&f.videoRange!==A||p&&L>f.frameRate||!p&&L>0&&L<f.frameRate||f.supportedResult&&!(null!=(o=f.supportedResult.decodingInfoResults)&&o[0].smooth)){w.push(l);continue}let I=f.details,P=(g?null==I?void 0:I.partTarget:null==I?void 0:I.averagetargetduration)||_;e=p?n*t:a*t;let x=_&&r>=2*_&&0===s?m[l].averageBitrate:m[l].maxBitrate,O=this.getTimeToLoadFrag(C,e,x*P,void 0===I);if(e>=x&&(l===c||0===f.loadError&&0===f.fragmentError)&&(O<=C||!b(O)||v&&!this.bitrateTestDelay||O<d)){let t=this.forcedAutoLevel;return l!==E&&(-1===t||t!==E)&&(w.length&&M.trace("[abr] Skipped level(s) ".concat(w.join(",")," of ").concat(i,' max with CODECS and VIDEO-RANGE:"').concat(m[w[0]].codecs,'" ').concat(m[w[0]].videoRange,'; not compatible with "').concat(y.codecs,'" ').concat(A)),M.info("[abr] switch candidate:".concat(u,"->").concat(l," adjustedbw(").concat(Math.round(e),")-bitrate=").concat(Math.round(e-x)," ttfb:").concat(C.toFixed(1)," avgDuration:").concat(P.toFixed(1)," maxFetchDuration:").concat(d.toFixed(1)," fetchDuration:").concat(O.toFixed(1)," firstSelection:").concat(S," codecSet:").concat(h," videoRange:").concat(A," hls.loadLevel:").concat(E))),S&&(this.firstSelection=l),l}}return -1}set nextAutoLevel(t){let{maxAutoLevel:e,minAutoLevel:i}=this.hls,r=Math.min(Math.max(t,i),e);this._nextAutoLevel!==r&&(this.nextAutoLevelKey="",this._nextAutoLevel=r)}constructor(t){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{let t;let{fragCurrent:e,partCurrent:i,hls:r}=this,{autoLevelEnabled:s,media:a}=r;if(!e||!a)return;let n=performance.now(),l=i?i.stats:e.stats,o=i?i.duration:e.duration,h=n-l.loading.start,d=r.minAutoLevel;if(l.aborted||l.loaded&&l.loaded===l.total||e.level<=d){this.clearTimer(),this._nextAutoLevel=-1;return}if(!s||a.paused||!a.playbackRate||!a.readyState)return;let c=r.mainForwardBufferInfo;if(null===c)return;let u=this.bwEstimator.getEstimateTTFB(),f=Math.abs(a.playbackRate);if(h<=Math.max(u,o/(2*f)*1e3))return;let g=c.len/f,m=l.loading.first?l.loading.first-l.loading.start:-1,p=l.loaded&&m>-1,E=this.getBwEstimate(),T=r.levels,y=T[e.level],v=l.total||Math.max(l.loaded,Math.round(o*y.averageBitrate/8)),S=p?h-m:h;S<1&&p&&(S=Math.min(h,8*l.loaded/E));let A=p?1e3*l.loaded/S:0,L=A?(v-l.loaded)/A:8*v/E+u/1e3;if(L<=g)return;let R=A?8*A:E,D=Number.POSITIVE_INFINITY;for(t=e.level-1;t>d;t--){let e=T[t].maxBitrate;if((D=this.getTimeToLoadFrag(u/1e3,R,o*e,!T[t].details))<g)break}if(D>=L||D>10*o)return;r.nextLoadLevel=r.nextAutoLevel=t,p?this.bwEstimator.sample(h-Math.min(u,m),l.loaded):this.bwEstimator.sampleTTFB(h);let I=T[t].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>I&&this.resetEstimator(I),this.clearTimer(),M.warn("[abr] Fragment ".concat(e.sn).concat(i?" part "+i.index:""," of level ").concat(e.level," is loading too slowly;\n      Time to underbuffer: ").concat(g.toFixed(3)," s\n      Estimated load time for current fragment: ").concat(L.toFixed(3)," s\n      Estimated load time for down switch fragment: ").concat(D.toFixed(3)," s\n      TTFB estimate: ").concat(0|m," ms\n      Current BW estimate: ").concat(b(E)?0|E:"Unknown"," bps\n      New BW estimate: ").concat(0|this.getBwEstimate()," bps\n      Switching to level ").concat(t," @ ").concat(0|I," bps")),r.trigger(C.FRAG_LOAD_EMERGENCY_ABORTED,{frag:e,part:i,stats:l})},this.hls=t,this.bwEstimator=this.initEstimator(),this.registerListeners()}}class e1{destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(t){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,t),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}}var e2={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class e4{_registerListeners(){let{hls:t}=this;t.on(C.BUFFER_APPENDED,this.onBufferAppended,this),t.on(C.FRAG_BUFFERED,this.onFragBuffered,this),t.on(C.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){let{hls:t}=this;t.off(C.BUFFER_APPENDED,this.onBufferAppended,this),t.off(C.FRAG_BUFFERED,this.onFragBuffered,this),t.off(C.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(t,e){let i=this.activePartLists[e];if(i)for(let e=i.length;e--;){let r=i[e];if(!r)break;let s=r.end;if(r.start<=t&&null!==s&&t<=s)return r}return this.getBufferedFrag(t,e)}getBufferedFrag(t,e){let{fragments:i}=this,r=Object.keys(i);for(let s=r.length;s--;){let a=i[r[s]];if((null==a?void 0:a.body.type)===e&&a.buffered){let e=a.body;if(e.start<=t&&t<=e.end)return e}}return null}detectEvictedFragments(t,e,i,r){this.timeRanges&&(this.timeRanges[t]=e);let s=(null==r?void 0:r.fragment.sn)||-1;Object.keys(this.fragments).forEach(r=>{let a=this.fragments[r];if(!a||s>=a.body.sn)return;if(!a.buffered&&!a.loaded){a.body.type===i&&this.removeFragment(a.body);return}let n=a.range[t];n&&n.time.some(t=>{let i=!this.isTimeBuffered(t.startPTS,t.endPTS,e);return i&&this.removeFragment(a.body),i})})}detectPartialFragments(t){let e=this.timeRanges,{frag:i,part:r}=t;if(!e||"initSegment"===i.sn)return;let s=e5(i),a=this.fragments[s];if(!a||a.buffered&&i.gap)return;let n=!i.relurl;Object.keys(e).forEach(t=>{let s=i.elementaryStreams[t];if(!s)return;let l=e[t],o=n||!0===s.partial;a.range[t]=this.getBufferedTimes(i,r,o,l)}),a.loaded=null,Object.keys(a.range).length?(a.buffered=!0,(a.body.endList=i.endList||a.body.endList)&&(this.endListFragments[a.body.type]=a),e3(a)||this.removeParts(i.sn-1,i.type)):this.removeFragment(a.body)}removeParts(t,e){let i=this.activePartLists[e];i&&(this.activePartLists[e]=i.filter(e=>e.fragment.sn>=t))}fragBuffered(t,e){let i=e5(t),r=this.fragments[i];!r&&e&&(r=this.fragments[i]={body:t,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},t.gap&&(this.hasGaps=!0)),r&&(r.loaded=null,r.buffered=!0)}getBufferedTimes(t,e,i,r){let s={time:[],partial:i},a=t.start,n=t.end,l=t.minEndPTS||n,o=t.maxStartPTS||a;for(let t=0;t<r.length;t++){let e=r.start(t)-this.bufferPadding,i=r.end(t)+this.bufferPadding;if(o>=e&&l<=i){s.time.push({startPTS:Math.max(a,r.start(t)),endPTS:Math.min(n,r.end(t))});break}if(a<i&&n>e){let e=Math.max(a,r.start(t)),i=Math.min(n,r.end(t));i>e&&(s.partial=!0,s.time.push({startPTS:e,endPTS:i}))}else if(n<=e)break}return s}getPartialFragment(t){let e,i,r,s=null,a=0,{bufferPadding:n,fragments:l}=this;return Object.keys(l).forEach(o=>{let h=l[o];h&&e3(h)&&(i=h.body.start-n,r=h.body.end+n,t>=i&&t<=r&&a<=(e=Math.min(t-i,r-t))&&(s=h.body,a=e))}),s}isEndListAppended(t){let e=this.endListFragments[t];return void 0!==e&&(e.buffered||e3(e))}getState(t){let e=e5(t),i=this.fragments[e];return i?i.buffered?e3(i)?e2.PARTIAL:e2.OK:e2.APPENDING:e2.NOT_LOADED}isTimeBuffered(t,e,i){let r,s;for(let a=0;a<i.length;a++){if(r=i.start(a)-this.bufferPadding,s=i.end(a)+this.bufferPadding,t>=r&&e<=s)return!0;if(e<=r)break}return!1}onFragLoaded(t,e){let{frag:i,part:r}=e;if("initSegment"===i.sn||i.bitrateTest)return;let s=e5(i);this.fragments[s]={body:i,appendedPTS:null,loaded:r?null:e,buffered:!1,range:Object.create(null)}}onBufferAppended(t,e){let{frag:i,part:r,timeRanges:s}=e;if("initSegment"===i.sn)return;let a=i.type;if(r){let t=this.activePartLists[a];t||(this.activePartLists[a]=t=[]),t.push(r)}this.timeRanges=s,Object.keys(s).forEach(t=>{let e=s[t];this.detectEvictedFragments(t,e,a,r)})}onFragBuffered(t,e){this.detectPartialFragments(e)}hasFragment(t){let e=e5(t);return!!this.fragments[e]}hasParts(t){var e;return!!(null!=(e=this.activePartLists[t])&&e.length)}removeFragmentsInRange(t,e,i,r,s){(!r||this.hasGaps)&&Object.keys(this.fragments).forEach(a=>{let n=this.fragments[a];if(!n)return;let l=n.body;l.type===i&&(!r||l.gap)&&l.start<e&&l.end>t&&(n.buffered||s)&&this.removeFragment(l)})}removeFragment(t){let e=e5(t);t.stats.loaded=0,t.clearElementaryStreamInfo();let i=this.activePartLists[t.type];if(i){let e=t.sn;this.activePartLists[t.type]=i.filter(t=>t.fragment.sn!==e)}delete this.fragments[e],t.endList&&delete this.endListFragments[t.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}constructor(t){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=t,this._registerListeners()}}function e3(t){var e,i,r;return t.buffered&&(t.body.gap||(null==(e=t.range.video)?void 0:e.partial)||(null==(i=t.range.audio)?void 0:i.partial)||(null==(r=t.range.audiovideo)?void 0:r.partial))}function e5(t){return"".concat(t.type,"_").concat(t.level,"_").concat(t.sn)}let e8={length:0,start:()=>0,end:()=>0};class e6{static isBuffered(t,e){try{if(t){let i=e6.getBuffered(t);for(let t=0;t<i.length;t++)if(e>=i.start(t)&&e<=i.end(t))return!0}}catch(t){}return!1}static bufferInfo(t,e,i){try{if(t){let r;let s=e6.getBuffered(t),a=[];for(r=0;r<s.length;r++)a.push({start:s.start(r),end:s.end(r)});return this.bufferedInfo(a,e,i)}}catch(t){}return{len:0,start:e,end:e,nextStart:void 0}}static bufferedInfo(t,e,i){let r;e=Math.max(0,e),t.sort(function(t,e){return t.start-e.start||e.end-t.end});let s=[];if(i)for(let e=0;e<t.length;e++){let r=s.length;if(r){let a=s[r-1].end;t[e].start-a<i?t[e].end>a&&(s[r-1].end=t[e].end):s.push(t[e])}else s.push(t[e])}else s=t;let a=0,n=e,l=e;for(let t=0;t<s.length;t++){let o=s[t].start,h=s[t].end;if(e+i>=o&&e<h)n=o,a=(l=h)-e;else if(e+i<o){r=o;break}}return{len:a,start:n||0,end:l||0,nextStart:r}}static getBuffered(t){try{return t.buffered}catch(t){return M.log("failed to get media.buffered",t),e8}}}class e9{constructor(t,e,i,r=0,s=-1,a=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=e7(),this.buffering={audio:e7(),video:e7(),audiovideo:e7()},this.level=t,this.sn=e,this.id=i,this.size=r,this.part=s,this.partial=a}}function e7(){return{start:0,executeStart:0,executeEnd:0,end:0}}function it(t,e){for(let r=0,s=t.length;r<s;r++){var i;if((null==(i=t[r])?void 0:i.cc)===e)return t[r]}return null}function ie(t,e){if(t){let i=t.start+e;t.start=t.startPTS=i,t.endPTS=i+t.duration}}function ii(t,e){let i=e.fragments;for(let e=0,r=i.length;e<r;e++)ie(i[e],t);e.fragmentHint&&ie(e.fragmentHint,t),e.alignedSliding=!0}function ir(t,e){let i,r;if(!t.hasProgramDateTime||!e.hasProgramDateTime)return;let s=t.fragments,a=e.fragments;if(!s.length||!a.length)return;let n=Math.min(e.endCC,t.endCC);e.startCC<n&&t.startCC<n&&(i=it(a,n),r=it(s,n)),i&&r||(r=it(s,(i=a[Math.floor(a.length/2)]).cc)||s[Math.floor(s.length/2)]);let l=i.programDateTime,o=r.programDateTime;l&&o&&ii((o-l)/1e3-(r.start-i.start),t)}class is{destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(t,e){let i=t.url;if(!i)return Promise.reject(new io({type:w.NETWORK_ERROR,details:P.FRAG_LOAD_ERROR,fatal:!1,frag:t,error:Error("Fragment does not have a ".concat(i?"part list":"url")),networkDetails:null}));this.abort();let r=this.config,s=r.fLoader,a=r.loader;return new Promise((n,l)=>{if(this.loader&&this.loader.destroy(),t.gap){if(t.tagList.some(t=>"GAP"===t[0])){l(il(t));return}t.gap=!1}let o=this.loader=t.loader=s?new s(r):new a(r),h=ia(t),d=eM(r.fragLoadPolicy.default),c={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===t.sn?1/0:131072};t.stats=o.stats,o.load(h,c,{onSuccess:(e,i,r,s)=>{this.resetLoader(t,o);let a=e.data;r.resetIV&&t.decryptdata&&(t.decryptdata.iv=new Uint8Array(a.slice(0,16)),a=a.slice(16)),n({frag:t,part:null,payload:a,networkDetails:s})},onError:(e,r,s,a)=>{this.resetLoader(t,o),l(new io({type:w.NETWORK_ERROR,details:P.FRAG_LOAD_ERROR,fatal:!1,frag:t,response:D({url:i,data:void 0},e),error:Error("HTTP Error ".concat(e.code," ").concat(e.text)),networkDetails:s,stats:a}))},onAbort:(e,i,r)=>{this.resetLoader(t,o),l(new io({type:w.NETWORK_ERROR,details:P.INTERNAL_ABORTED,fatal:!1,frag:t,error:Error("Aborted"),networkDetails:r,stats:e}))},onTimeout:(e,i,r)=>{this.resetLoader(t,o),l(new io({type:w.NETWORK_ERROR,details:P.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,error:Error("Timeout after ".concat(c.timeout,"ms")),networkDetails:r,stats:e}))},onProgress:(i,r,s,a)=>{e&&e({frag:t,part:null,payload:s,networkDetails:a})}})})}loadPart(t,e,i){this.abort();let r=this.config,s=r.fLoader,a=r.loader;return new Promise((n,l)=>{if(this.loader&&this.loader.destroy(),t.gap||e.gap){l(il(t,e));return}let o=this.loader=t.loader=s?new s(r):new a(r),h=ia(t,e),d=eM(r.fragLoadPolicy.default),c={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:131072};e.stats=o.stats,o.load(h,c,{onSuccess:(r,s,a,l)=>{this.resetLoader(t,o),this.updateStatsFromPart(t,e);let h={frag:t,part:e,payload:r.data,networkDetails:l};i(h),n(h)},onError:(i,r,s,a)=>{this.resetLoader(t,o),l(new io({type:w.NETWORK_ERROR,details:P.FRAG_LOAD_ERROR,fatal:!1,frag:t,part:e,response:D({url:h.url,data:void 0},i),error:Error("HTTP Error ".concat(i.code," ").concat(i.text)),networkDetails:s,stats:a}))},onAbort:(i,r,s)=>{t.stats.aborted=e.stats.aborted,this.resetLoader(t,o),l(new io({type:w.NETWORK_ERROR,details:P.INTERNAL_ABORTED,fatal:!1,frag:t,part:e,error:Error("Aborted"),networkDetails:s,stats:i}))},onTimeout:(i,r,s)=>{this.resetLoader(t,o),l(new io({type:w.NETWORK_ERROR,details:P.FRAG_LOAD_TIMEOUT,fatal:!1,frag:t,part:e,error:Error("Timeout after ".concat(c.timeout,"ms")),networkDetails:s,stats:i}))}})})}updateStatsFromPart(t,e){let i=t.stats,r=e.stats,s=r.total;if(i.loaded+=r.loaded,s){let r=Math.round(t.duration/e.duration),a=Math.min(Math.round(i.loaded/s),r),n=(r-a)*Math.round(i.loaded/a);i.total=i.loaded+n}else i.total=Math.max(i.loaded,i.total);let a=i.loading,n=r.loading;a.start?a.first+=n.first-n.start:(a.start=n.start,a.first=n.first),a.end=n.end}resetLoader(t,e){t.loader=null,this.loader===e&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),e.destroy()}constructor(t){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=t}}function ia(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=e||t,r={frag:t,part:e,responseType:"arraybuffer",url:i.url,headers:{},rangeStart:0,rangeEnd:0},s=i.byteRangeStartOffset,a=i.byteRangeEndOffset;if(b(s)&&b(a)){var n;let e=s,i=a;if("initSegment"===t.sn&&(null==(n=t.decryptdata)?void 0:n.method)==="AES-128"){let t=a-s;t%16&&(i=a+(16-t%16)),0!==s&&(r.resetIV=!0,e=s-16)}r.rangeStart=e,r.rangeEnd=i}return r}function il(t,e){let i=Error("GAP ".concat(t.gap?"tag":"attribute"," found")),r={type:w.MEDIA_ERROR,details:P.FRAG_GAP,fatal:!1,frag:t,error:i,networkDetails:null};return e&&(r.part=e),(e||t).stats.aborted=!0,new io(r)}class io extends Error{constructor(t){super(t.error.message),this.data=void 0,this.data=t}}class ih{decrypt(t,e){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},e,t)}constructor(t,e){this.subtle=void 0,this.aesIV=void 0,this.subtle=t,this.aesIV=e}}class id{expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}constructor(t,e){this.subtle=void 0,this.key=void 0,this.subtle=t,this.key=e}}class ic{uint8ArrayToUint32Array_(t){let e=new DataView(t),i=new Uint32Array(4);for(let t=0;t<4;t++)i[t]=e.getUint32(4*t);return i}initTable(){let t=this.sBox,e=this.invSBox,i=this.subMix,r=i[0],s=i[1],a=i[2],n=i[3],l=this.invSubMix,o=l[0],h=l[1],d=l[2],c=l[3],u=new Uint32Array(256),f=0,g=0,m=0;for(m=0;m<256;m++)m<128?u[m]=m<<1:u[m]=m<<1^283;for(m=0;m<256;m++){let i=g^g<<1^g<<2^g<<3^g<<4;i=i>>>8^255&i^99,t[f]=i,e[i]=f;let l=u[f],m=u[l],p=u[m],E=257*u[i]^16843008*i;r[f]=E<<24|E>>>8,s[f]=E<<16|E>>>16,a[f]=E<<8|E>>>24,n[f]=E,E=16843009*p^65537*m^257*l^16843008*f,o[i]=E<<24|E>>>8,h[i]=E<<16|E>>>16,d[i]=E<<8|E>>>24,c[i]=E,f?(f=l^u[u[u[p^l]]],g^=u[u[g]]):f=g=1}}expandKey(t){let e,i,r,s;let a=this.uint8ArrayToUint32Array_(t),n=!0,l=0;for(;l<a.length&&n;)n=a[l]===this.key[l],l++;if(n)return;this.key=a;let o=this.keySize=a.length;if(4!==o&&6!==o&&8!==o)throw Error("Invalid aes key size="+o);let h=this.ksRows=(o+6+1)*4,d=this.keySchedule=new Uint32Array(h),c=this.invKeySchedule=new Uint32Array(h),u=this.sBox,f=this.rcon,g=this.invSubMix,m=g[0],p=g[1],E=g[2],T=g[3];for(e=0;e<h;e++){if(e<o){r=d[e]=a[e];continue}s=r,e%o==0?s=(u[(s=s<<8|s>>>24)>>>24]<<24|u[s>>>16&255]<<16|u[s>>>8&255]<<8|u[255&s])^f[e/o|0]<<24:o>6&&e%o==4&&(s=u[s>>>24]<<24|u[s>>>16&255]<<16|u[s>>>8&255]<<8|u[255&s]),d[e]=r=(d[e-o]^s)>>>0}for(i=0;i<h;i++)e=h-i,s=3&i?d[e]:d[e-4],i<4||e<=4?c[i]=s:c[i]=m[u[s>>>24]]^p[u[s>>>16&255]]^E[u[s>>>8&255]]^T[u[255&s]],c[i]=c[i]>>>0}networkToHostOrderSwap(t){return t<<24|(65280&t)<<8|(16711680&t)>>8|t>>>24}decrypt(t,e,i){let r,s,a,n,l,o,h,d,c,u,f,g,m,p;let E=this.keySize+6,T=this.invKeySchedule,y=this.invSBox,v=this.invSubMix,S=v[0],A=v[1],L=v[2],R=v[3],D=this.uint8ArrayToUint32Array_(i),I=D[0],b=D[1],k=D[2],_=D[3],C=new Int32Array(t),w=new Int32Array(C.length),P=this.networkToHostOrderSwap;for(;e<C.length;){for(p=1,c=P(C[e]),u=P(C[e+1]),f=P(C[e+2]),g=P(C[e+3]),l=c^T[0],o=g^T[1],h=f^T[2],d=u^T[3],m=4;p<E;p++)r=S[l>>>24]^A[o>>16&255]^L[h>>8&255]^R[255&d]^T[m],s=S[o>>>24]^A[h>>16&255]^L[d>>8&255]^R[255&l]^T[m+1],a=S[h>>>24]^A[d>>16&255]^L[l>>8&255]^R[255&o]^T[m+2],n=S[d>>>24]^A[l>>16&255]^L[o>>8&255]^R[255&h]^T[m+3],l=r,o=s,h=a,d=n,m+=4;r=y[l>>>24]<<24^y[o>>16&255]<<16^y[h>>8&255]<<8^y[255&d]^T[m],s=y[o>>>24]<<24^y[h>>16&255]<<16^y[d>>8&255]<<8^y[255&l]^T[m+1],a=y[h>>>24]<<24^y[d>>16&255]<<16^y[l>>8&255]<<8^y[255&o]^T[m+2],n=y[d>>>24]<<24^y[l>>16&255]<<16^y[o>>8&255]<<8^y[255&h]^T[m+3],w[e]=P(r^I),w[e+1]=P(n^b),w[e+2]=P(a^k),w[e+3]=P(s^_),I=c,b=u,k=f,_=g,e+=4}return w.buffer}constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}}class iu{destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){let{currentResult:t,remainderData:e}=this;if(!t||e)return this.reset(),null;let i=new Uint8Array(t);return(this.reset(),this.removePKCS7Padding)?function(t){let e=t.byteLength,i=e&&new DataView(t.buffer).getUint8(e-1);return i?tr(t,0,e-i):t}(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(t,e,i){return this.useSoftware?new Promise((r,s)=>{this.softwareDecrypt(new Uint8Array(t),e,i);let a=this.flush();a?r(a.buffer):s(Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(t),e,i)}softwareDecrypt(t,e,i){let{currentIV:r,currentResult:s,remainderData:a}=this;this.logOnce("JS AES decrypt"),a&&(t=tO(a,t),this.remainderData=null);let n=this.getValidChunk(t);if(!n.length)return null;r&&(i=r);let l=this.softwareDecrypter;return(l||(l=this.softwareDecrypter=new ic),l.expandKey(e),this.currentResult=l.decrypt(n.buffer,0,i),this.currentIV=tr(n,-16).buffer,s)?s:null}webCryptoDecrypt(t,e,i){let r=this.subtle;return this.key===e&&this.fastAesKey||(this.key=e,this.fastAesKey=new id(r,e)),this.fastAesKey.expandKey().then(e=>r?(this.logOnce("WebCrypto AES decrypt"),new ih(r,new Uint8Array(i)).decrypt(t.buffer,e)):Promise.reject(Error("web crypto not initialized"))).catch(r=>(M.warn("[decrypter]: WebCrypto Error, disable WebCrypto API, ".concat(r.name,": ").concat(r.message)),this.onWebCryptoError(t,e,i)))}onWebCryptoError(t,e,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(t,e,i);let r=this.flush();if(r)return r.buffer;throw Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(t){let e=t,i=t.length-t.length%16;return i!==t.length&&(e=tr(t,0,i),this.remainderData=tr(t,i)),e}logOnce(t){this.logEnabled&&(M.log("[decrypter]: ".concat(t)),this.logEnabled=!1)}constructor(t,{removePKCS7Padding:e=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=t.enableSoftwareAES,this.removePKCS7Padding=e,e)try{let t=self.crypto;t&&(this.subtle=t.subtle||t.webkitSubtle)}catch(t){}null===this.subtle&&(this.useSoftware=!0)}}let ig={toString:function(t){let e="",i=t.length;for(let r=0;r<i;r++)e+="[".concat(t.start(r).toFixed(3),"-").concat(t.end(r).toFixed(3),"]");return e}},im={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class ip extends e1{doTick(){this.onTickEnd()}onTickEnd(){}startLoad(t){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);let t=this.fragCurrent;null!=t&&t.loader&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=im.STOPPED}_streamEnded(t,e){if(e.live||t.nextStart||!t.end||!this.media)return!1;let i=e.partList;if(null!=i&&i.length){let t=i[i.length-1];return e6.isBuffered(this.media,t.start+t.duration/2)}let r=e.fragments[e.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(r)}getLevelDetails(){if(this.levels&&null!==this.levelLastLoaded){var t;return null==(t=this.levelLastLoaded)?void 0:t.details}}onMediaAttached(t,e){let i=this.media=this.mediaBuffer=e.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);let r=this.config;this.levels&&r.autoStartLoad&&this.state===im.STOPPED&&this.startLoad(r.startPosition)}onMediaDetaching(){let t=this.media;null!=t&&t.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),t&&this.onvseeking&&this.onvended&&(t.removeEventListener("seeking",this.onvseeking),t.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){let{config:t,fragCurrent:e,media:i,mediaBuffer:r,state:s}=this,a=i?i.currentTime:0,n=e6.bufferInfo(r||i,a,t.maxBufferHole);if(this.log("media seeking to ".concat(b(a)?a.toFixed(3):a,", state: ").concat(s)),this.state===im.ENDED)this.resetLoadingState();else if(e){let i=t.maxFragLookUpTolerance,r=e.start-i,s=e.start+e.duration+i;if(!n.len||s<n.start||r>n.end){let t=a>s;(a<r||t)&&(t&&e.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),e.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(a,1/0,this.playlistType,!0),this.lastCurrentTime=a),this.loadedmetadata||n.len||(this.nextLoadPosition=this.startPosition=a),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(t,e){this.startTimeOffset=e.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(C.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=im.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(t,e,i){this._loadFragForPlayback(t,e,i)}_loadFragForPlayback(t,e,i){this._doFragLoad(t,e,i,e=>{if(this.fragContextChanged(t)){this.warn("Fragment ".concat(t.sn).concat(e.part?" p: "+e.part.index:""," of level ").concat(t.level," was dropped during download.")),this.fragmentTracker.removeFragment(t);return}t.stats.chunkCount++,this._handleFragmentLoadProgress(e)}).then(e=>{if(!e)return;let i=this.state;if(this.fragContextChanged(t)){i!==im.FRAG_LOADING&&(this.fragCurrent||i!==im.PARSING)||(this.fragmentTracker.removeFragment(t),this.state=im.IDLE);return}"payload"in e&&(this.log("Loaded fragment ".concat(t.sn," of level ").concat(t.level)),this.hls.trigger(C.FRAG_LOADED,e)),this._handleFragmentLoadComplete(e)}).catch(e=>{this.state!==im.STOPPED&&this.state!==im.ERROR&&(this.warn(e),this.resetFragmentLoading(t))})}clearTrackerIfNeeded(t){var e;let{fragmentTracker:i}=this;if(i.getState(t)===e2.APPENDING){let e=t.type,r=this.getFwdBufferInfo(this.mediaBuffer,e),s=Math.max(t.duration,r?r.len:this.config.maxBufferLength);this.reduceMaxBufferLength(s)&&i.removeFragment(t)}else(null==(e=this.mediaBuffer)?void 0:e.buffered.length)===0?i.removeAllFragments():i.hasParts(t.type)&&(i.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type}),i.getState(t)===e2.PARTIAL&&i.removeFragment(t))}checkLiveUpdate(t){if(t.updated&&!t.live){let e=t.fragments[t.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type})}t.fragments[0]||(t.deltaUpdateFailed=!0)}flushMainBuffer(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;t-e&&this.hls.trigger(C.BUFFER_FLUSHING,{startOffset:t,endOffset:e,type:i})}_loadInitSegment(t,e){this._doFragLoad(t,e).then(e=>{if(!e||this.fragContextChanged(t)||!this.levels)throw Error("init load aborted");return e}).then(e=>{let{hls:i}=this,{payload:r}=e,s=t.decryptdata;if(r&&r.byteLength>0&&null!=s&&s.key&&s.iv&&"AES-128"===s.method){let a=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),s.key.buffer,s.iv.buffer).catch(e=>{throw i.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e}).then(r=>{let s=self.performance.now();return i.trigger(C.FRAG_DECRYPTED,{frag:t,payload:r,stats:{tstart:a,tdecrypt:s}}),e.payload=r,this.completeInitSegmentLoad(e)})}return this.completeInitSegmentLoad(e)}).catch(e=>{this.state!==im.STOPPED&&this.state!==im.ERROR&&(this.warn(e),this.resetFragmentLoading(t))})}completeInitSegmentLoad(t){let{levels:e}=this;if(!e)throw Error("init load aborted, missing levels");let i=t.frag.stats;this.state=im.IDLE,t.frag.data=new Uint8Array(t.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(t){let{fragCurrent:e}=this;return!t||!e||t.sn!==e.sn||t.level!==e.level}fragBufferedComplete(t,e){var i,r,s,a,n;let l=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log("Buffered ".concat(t.type," sn: ").concat(t.sn).concat(e?" part: "+e.index:""," of ").concat(this.playlistType===es.MAIN?"level":"track"," ").concat(t.level," (frag:[").concat((null!=(i=t.startPTS)?i:NaN).toFixed(3),"-").concat((null!=(r=t.endPTS)?r:NaN).toFixed(3),"] > buffer:").concat(l?ig.toString(e6.getBuffered(l)):"(detached)",")")),"initSegment"!==t.sn){if(t.type!==es.SUBTITLE){let e=t.elementaryStreams;if(!Object.keys(e).some(t=>!!e[t])){this.state=im.IDLE;return}}let e=null==(n=this.levels)?void 0:n[t.level];null!=e&&e.fragmentError&&(this.log("Resetting level fragment error count of ".concat(e.fragmentError," on frag buffered")),e.fragmentError=0)}this.state=im.IDLE,l&&(!this.loadedmetadata&&t.type==es.MAIN&&l.buffered.length&&(null==(s=this.fragCurrent)?void 0:s.sn)===(null==(a=this.fragPrevious)?void 0:a.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(t){let{transmuxer:e}=this;if(!e)return;let{frag:i,part:r,partsLoaded:s}=t,a=!s||0===s.length||s.some(t=>!t),n=new e9(i.level,i.sn,i.stats.chunkCount+1,0,r?r.index:-1,!a);e.flush(n)}_handleFragmentLoadProgress(t){}_doFragLoad(t,e){var i;let r,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3?arguments[3]:void 0,n=null==e?void 0:e.details;if(!this.levels||!n)throw Error("frag load aborted, missing level".concat(n?"":" detail","s"));let l=null;if(t.encrypted&&!(null!=(i=t.decryptdata)&&i.key)?(this.log("Loading key for ".concat(t.sn," of [").concat(n.startSN,"-").concat(n.endSN,"], ").concat("[stream-controller]"===this.logPrefix?"level":"track"," ").concat(t.level)),this.state=im.KEY_LOADING,this.fragCurrent=t,l=this.keyLoader.load(t).then(t=>{if(!this.fragContextChanged(t.frag))return this.hls.trigger(C.KEY_LOADED,t),this.state===im.KEY_LOADING&&(this.state=im.IDLE),t}),this.hls.trigger(C.KEY_LOADING,{frag:t}),null===this.fragCurrent&&(l=Promise.reject(Error("frag load aborted, context changed in KEY_LOADING")))):!t.encrypted&&n.encryptedFragments.length&&this.keyLoader.loadClear(t,n.encryptedFragments),s=Math.max(t.start,s||0),this.config.lowLatencyMode&&"initSegment"!==t.sn){let i=n.partList;if(i&&a){s>t.end&&n.fragmentHint&&(t=n.fragmentHint);let r=this.getNextPart(i,t,s);if(r>-1){let o;let h=i[r];return(this.log("Loading part sn: ".concat(t.sn," p: ").concat(h.index," cc: ").concat(t.cc," of playlist [").concat(n.startSN,"-").concat(n.endSN,"] parts [0-").concat(r,"-").concat(i.length-1,"] ").concat("[stream-controller]"===this.logPrefix?"level":"track",": ").concat(t.level,", target: ").concat(parseFloat(s.toFixed(3)))),this.nextLoadPosition=h.start+h.duration,this.state=im.FRAG_LOADING,o=l?l.then(i=>!i||this.fragContextChanged(i.frag)?null:this.doFragPartsLoad(t,h,e,a)).catch(t=>this.handleFragLoadError(t)):this.doFragPartsLoad(t,h,e,a).catch(t=>this.handleFragLoadError(t)),this.hls.trigger(C.FRAG_LOADING,{frag:t,part:h,targetBufferTime:s}),null===this.fragCurrent)?Promise.reject(Error("frag load aborted, context changed in FRAG_LOADING parts")):o}if(!t.url||this.loadedEndOfParts(i,s))return Promise.resolve(null)}}this.log("Loading fragment ".concat(t.sn," cc: ").concat(t.cc," ").concat(n?"of ["+n.startSN+"-"+n.endSN+"] ":"").concat("[stream-controller]"===this.logPrefix?"level":"track",": ").concat(t.level,", target: ").concat(parseFloat(s.toFixed(3)))),b(t.sn)&&!this.bitrateTest&&(this.nextLoadPosition=t.start+t.duration),this.state=im.FRAG_LOADING;let o=this.config.progressive;return(r=o&&l?l.then(e=>!e||this.fragContextChanged(null==e?void 0:e.frag)?null:this.fragmentLoader.load(t,a)).catch(t=>this.handleFragLoadError(t)):Promise.all([this.fragmentLoader.load(t,o?a:void 0),l]).then(t=>{let[e]=t;return!o&&e&&a&&a(e),e}).catch(t=>this.handleFragLoadError(t)),this.hls.trigger(C.FRAG_LOADING,{frag:t,targetBufferTime:s}),null===this.fragCurrent)?Promise.reject(Error("frag load aborted, context changed in FRAG_LOADING")):r}doFragPartsLoad(t,e,i,r){return new Promise((s,a)=>{var n;let l=[],o=null==(n=i.details)?void 0:n.partList,h=e=>{this.fragmentLoader.loadPart(t,e,r).then(r=>{l[e.index]=r;let a=r.part;this.hls.trigger(C.FRAG_LOADED,r);let n=eC(i,t.sn,e.index+1)||ew(o,t.sn,e.index+1);if(!n)return s({frag:t,part:a,partsLoaded:l});h(n)}).catch(a)};h(e)})}handleFragLoadError(t){if("data"in t){let e=t.data;t.data&&e.details===P.INTERNAL_ABORTED?this.handleFragLoadAborted(e.frag,e.part):this.hls.trigger(C.ERROR,e)}else this.hls.trigger(C.ERROR,{type:w.OTHER_ERROR,details:P.INTERNAL_EXCEPTION,err:t,error:t,fatal:!0});return null}_handleTransmuxerFlush(t){let e=this.getCurrentContext(t);if(!e||this.state!==im.PARSING){this.fragCurrent||this.state===im.STOPPED||this.state===im.ERROR||(this.state=im.IDLE);return}let{frag:i,part:r,level:s}=e,a=self.performance.now();i.stats.parsing.end=a,r&&(r.stats.parsing.end=a),this.updateLevelTiming(i,r,s,t.partial)}getCurrentContext(t){let{levels:e,fragCurrent:i}=this,{level:r,sn:s,part:a}=t;if(!(null!=e&&e[r]))return this.warn("Levels object was unset while buffering fragment ".concat(s," of level ").concat(r,". The current chunk will not be buffered.")),null;let n=e[r],l=a>-1?eC(n,s,a):null,o=l?l.fragment:function(t,e,i){if(!(null!=t&&t.details))return null;let r=t.details,s=r.fragments[e-r.startSN];return s||(s=r.fragmentHint)&&s.sn===e?s:e<r.startSN&&i&&i.sn===e?i:null}(n,s,i);return o?(i&&i!==o&&(o.stats=i.stats),{frag:o,part:l,level:n}):null}bufferFragmentData(t,e,i,r,s){var a;if(!t||this.state!==im.PARSING)return;let{data1:n,data2:l}=t,o=n;if(n&&l&&(o=tO(n,l)),!(null!=(a=o)&&a.length))return;let h={type:t.type,frag:e,part:i,chunkMeta:r,parent:e.type,data:o};if(this.hls.trigger(C.BUFFER_APPENDING,h),t.dropped&&t.independent&&!i){if(s)return;this.flushBufferGap(e)}}flushBufferGap(t){let e=this.media;if(!e)return;if(!e6.isBuffered(e,e.currentTime)){this.flushMainBuffer(0,t.start);return}let i=e.currentTime,r=e6.bufferInfo(e,i,0),s=t.duration,a=Math.min(2*this.config.maxFragLookUpTolerance,.25*s),n=Math.max(Math.min(t.start-a,r.end-a),i+a);t.start-n>a&&this.flushMainBuffer(n,t.start)}getFwdBufferInfo(t,e){let i=this.getLoadPosition();return b(i)?this.getFwdBufferInfoAtPos(t,i,e):null}getFwdBufferInfoAtPos(t,e,i){let{config:{maxBufferHole:r}}=this,s=e6.bufferInfo(t,e,r);if(0===s.len&&void 0!==s.nextStart){let a=this.fragmentTracker.getBufferedFrag(e,i);if(a&&s.nextStart<a.end)return e6.bufferInfo(t,e,Math.max(s.nextStart,r))}return s}getMaxBufferLength(t){let{config:e}=this;return Math.min(t?Math.max(8*e.maxBufferSize/t,e.maxBufferLength):e.maxBufferLength,e.maxMaxBufferLength)}reduceMaxBufferLength(t){let e=this.config,i=t||e.maxBufferLength;return e.maxMaxBufferLength>=i&&(e.maxMaxBufferLength/=2,this.warn("Reduce max buffer length to ".concat(e.maxMaxBufferLength,"s")),!0)}getAppendedFrag(t){arguments.length>1&&void 0!==arguments[1]?arguments[1]:es.MAIN;let e=this.fragmentTracker.getAppendedFrag(t,es.MAIN);return e&&"fragment"in e?e.fragment:e}getNextFragment(t,e){let i;let r=e.fragments,s=r.length;if(!s)return null;let{config:a}=this,n=r[0].start;if(e.live){let l=a.initialLiveManifestSize;if(s<l)return this.warn("Not enough fragments to start playback (have: ".concat(s,", need: ").concat(l,")")),null;(e.PTSKnown||this.startFragRequested||-1!==this.startPosition)&&!(t<n)||(i=this.getInitialLiveFragment(e,r),this.startPosition=this.nextLoadPosition=i?this.hls.liveSyncPosition||i.start:t)}else t<=n&&(i=r[0]);if(!i){let r=a.lowLatencyMode?e.partEnd:e.fragmentEnd;i=this.getFragmentAtPosition(t,r,e)}return this.mapToInitFragWhenRequired(i)}isLoopLoading(t,e){let i=this.fragmentTracker.getState(t);return(i===e2.OK||i===e2.PARTIAL&&!!t.gap)&&this.nextLoadPosition>e}getNextFragmentLoopLoading(t,e,i,r,s){let a=t.gap,n=this.getNextFragment(this.nextLoadPosition,e);if(null===n)return n;if(t=n,a&&t&&!t.gap&&i.nextStart){let e=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,r);if(null!==e&&i.len+e.len>=s)return this.log('buffer full after gaps in "'.concat(r,'" playlist starting at sn: ').concat(t.sn)),null}return t}mapToInitFragWhenRequired(t){return null==t||!t.initSegment||null!=t&&t.initSegment.data||this.bitrateTest?t:t.initSegment}getNextPart(t,e,i){let r=-1,s=!1,a=!0;for(let n=0,l=t.length;n<l;n++){let l=t[n];if(a=a&&!l.independent,r>-1&&i<l.start)break;let o=l.loaded;o?r=-1:(s||l.independent||a)&&l.fragment===e&&(r=n),s=o}return r}loadedEndOfParts(t,e){let i=t[t.length-1];return i&&e>i.start&&i.loaded}getInitialLiveFragment(t,e){let i=this.fragPrevious,r=null;if(i){if(t.hasProgramDateTime&&(this.log("Live playlist, switching playlist, load frag with same PDT: ".concat(i.programDateTime)),r=function(t,e,i){if(null===e||!Array.isArray(t)||!t.length||!b(e)||e<(t[0].programDateTime||0)||e>=(t[t.length-1].endProgramDateTime||0))return null;i=i||0;for(let r=0;r<t.length;++r){let s=t[r];if(function(t,e,i){let r=1e3*Math.min(e,i.duration+(i.deltaPTS?i.deltaPTS:0));return(i.endProgramDateTime||0)-r>t}(e,i,s))return s}return null}(e,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!r){let a=i.sn+1;if(a>=t.startSN&&a<=t.endSN){let s=e[a-t.startSN];i.cc===s.cc&&(r=s,this.log("Live playlist, switching playlist, load frag with next SN: ".concat(r.sn)))}if(!r){var s;s=i.cc,(r=eU.search(e,t=>t.cc<s?1:t.cc>s?-1:0))&&this.log("Live playlist, switching playlist, load frag with same CC: ".concat(r.sn))}}}else{let e=this.hls.liveSyncPosition;null!==e&&(r=this.getFragmentAtPosition(e,this.bitrateTest?t.fragmentEnd:t.edge,t))}return r}getFragmentAtPosition(t,e,i){let r;let{config:s}=this,{fragPrevious:a}=this,{fragments:n,endSN:l}=i,{fragmentHint:o}=i,h=s.maxFragLookUpTolerance,d=i.partList,c=!!(s.lowLatencyMode&&null!=d&&d.length&&o);if(c&&o&&!this.bitrateTest&&(n=n.concat(o),l=o.sn),r=t<e?eB(a,n,t,t>e-h?0:h):n[n.length-1]){let t=r.sn-i.startSN,e=this.fragmentTracker.getState(r);if((e===e2.OK||e===e2.PARTIAL&&r.gap)&&(a=r),a&&r.sn===a.sn&&(!c||d[0].fragment.sn>r.sn)&&a&&r.level===a.level){let e=n[t+1];r=r.sn<l&&this.fragmentTracker.getState(e)!==e2.OK?e:null}}return r}synchronizeToLiveEdge(t){let{config:e,media:i}=this;if(!i)return;let r=this.hls.liveSyncPosition,s=i.currentTime,a=t.fragments[0].start,n=t.edge,l=s>=a-e.maxFragLookUpTolerance&&s<=n;if(null!==r&&i.duration>r&&(s<r||!l)){let a=void 0!==e.liveMaxLatencyDuration?e.liveMaxLatencyDuration:e.liveMaxLatencyDurationCount*t.targetduration;(!l&&i.readyState<4||s<n-a)&&(this.loadedmetadata||(this.nextLoadPosition=r),i.readyState&&(this.warn("Playback: ".concat(s.toFixed(3)," is located too far from the end of live sliding playlist: ").concat(n,", reset currentTime to : ").concat(r.toFixed(3))),i.currentTime=r))}}alignPlaylists(t,e,i){let r=t.fragments.length;if(!r)return this.warn("No fragments in live playlist"),0;let s=t.fragments[0].start,a=t.alignedSliding&&b(s);if(!e||!a&&!s){let{fragPrevious:s}=this;i&&(function(t,e,i){if(i&&(e.endCC>e.startCC||t&&t.cc<e.startCC)){let t=function(t,e){let i=t.fragments,r=e.fragments;if(!r.length||!i.length){M.log("No fragments to align");return}let s=it(i,r[0].cc);if(!s||s&&!s.startPTS){M.log("No frag in previous level to align on");return}return s}(i,e);t&&b(t.start)&&(M.log("Adjusting PTS using last level due to CC increase within current level ".concat(e.url)),ii(t.start,e))}}(s,t,i),!t.alignedSliding&&i&&ir(t,i),t.alignedSliding||!i||t.skippedSegments||ek(i,t));let a=t.fragments[0].start;return this.log("Live playlist sliding: ".concat(a.toFixed(2)," start-sn: ").concat(e?e.startSN:"na","->").concat(t.startSN," prev-sn: ").concat(s?s.sn:"na"," fragments: ").concat(r)),a}return s}waitForCdnTuneIn(t){return t.live&&t.canBlockReload&&t.partTarget&&t.tuneInGoal>Math.max(t.partHoldBack,3*t.partTarget)}setStartPosition(t,e){let i=this.startPosition;if(i<e&&(i=-1),-1===i||-1===this.lastCurrentTime){let r=null!==this.startTimeOffset,s=r?this.startTimeOffset:t.startTimeOffset;null!==s&&b(s)?(i=e+s,s<0&&(i+=t.totalduration),i=Math.min(Math.max(e,i),e+t.totalduration),this.log("Start time offset ".concat(s," found in ").concat(r?"multivariant":"media"," playlist, adjust startPosition to ").concat(i)),this.startPosition=i):t.live?i=this.hls.liveSyncPosition||e:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){let{media:t}=this,e=0;return this.loadedmetadata&&t?e=t.currentTime:this.nextLoadPosition&&(e=this.nextLoadPosition),e}handleFragLoadAborted(t,e){this.transmuxer&&"initSegment"!==t.sn&&t.stats.aborted&&(this.warn("Fragment ".concat(t.sn).concat(e?" part "+e.index:""," of level ").concat(t.level," was aborted")),this.resetFragmentLoading(t))}resetFragmentLoading(t){this.fragCurrent&&(this.fragContextChanged(t)||this.state===im.FRAG_LOADING_WAITING_RETRY)||(this.state=im.IDLE)}onFragmentOrKeyLoadError(t,e){if(e.chunkMeta&&!e.frag){let t=this.getCurrentContext(e.chunkMeta);t&&(e.frag=t.frag)}let i=e.frag;if(!i||i.type!==t||!this.levels)return;if(this.fragContextChanged(i)){var r;this.warn("Frag load error must match current frag to retry ".concat(i.url," > ").concat(null==(r=this.fragCurrent)?void 0:r.url));return}let s=e.details===P.FRAG_GAP;s&&this.fragmentTracker.fragBuffered(i,!0);let a=e.errorAction,{action:n,retryCount:l=0,retryConfig:o}=a||{};if(a&&n===eK.RetryRequest&&o){this.resetStartWhenNotLoaded(this.levelLastLoaded);let r=eF(o,l);this.warn("Fragment ".concat(i.sn," of ").concat(t," ").concat(i.level," errored with ").concat(e.details,", retrying loading ").concat(l+1,"/").concat(o.maxNumRetry," in ").concat(r,"ms")),a.resolved=!0,this.retryDate=self.performance.now()+r,this.state=im.FRAG_LOADING_WAITING_RETRY}else if(o&&a){if(this.resetFragmentErrors(t),l<o.maxNumRetry)s||n===eK.RemoveAlternatePermanently||(a.resolved=!0);else{M.warn("".concat(e.details," reached or exceeded max retry (").concat(l,")"));return}}else(null==a?void 0:a.action)===eK.SendAlternateToPenaltyBox?this.state=im.WAITING_LEVEL:this.state=im.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(t){if(this.state===im.PARSING||this.state===im.PARSED){let e=t.parent,i=this.getFwdBufferInfo(this.mediaBuffer,e),r=i&&i.len>.5;r&&this.reduceMaxBufferLength(i.len);let s=!r;return s&&this.warn("Buffer full error while media.currentTime is not buffered, flush ".concat(e," buffer")),t.frag&&(this.fragmentTracker.removeFragment(t.frag),this.nextLoadPosition=t.frag.start),this.resetLoadingState(),s}return!1}resetFragmentErrors(t){t===es.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==im.STOPPED&&(this.state=im.IDLE)}afterBufferFlushed(t,e,i){if(!t)return;let r=e6.getBuffered(t);this.fragmentTracker.detectEvictedFragments(e,r,i),this.state===im.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=im.IDLE}resetStartWhenNotLoaded(t){if(!this.loadedmetadata){this.startFragRequested=!1;let e=t?t.details:null;null!=e&&e.live?(this.startPosition=-1,this.setStartPosition(e,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(t){this.warn("The loading context changed while buffering fragment ".concat(t.sn," of level ").concat(t.level,". This chunk will not be buffered.")),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.fragmentTracker.removeFragmentsInRange(t,1/0,this.playlistType,!1,!0)}updateLevelTiming(t,e,i,r){var s;let a=i.details;if(!a){this.warn("level.details undefined");return}if(!Object.keys(t.elementaryStreams).reduce((e,s)=>{let n=t.elementaryStreams[s];if(n){let l=n.endPTS-n.startPTS;if(l<=0)return this.warn("Could not parse fragment ".concat(t.sn," ").concat(s," duration reliably (").concat(l,")")),e||!1;let o=r?0:eb(a,t,n.startPTS,n.endPTS,n.startDTS,n.endDTS);return this.hls.trigger(C.LEVEL_PTS_UPDATED,{details:a,level:i,drift:o,type:s,frag:t,start:n.startPTS,end:n.endPTS}),!0}return e},!1)&&(null==(s=this.transmuxer)?void 0:s.error)===null){let e=Error("Found no media in fragment ".concat(t.sn," of level ").concat(t.level," resetting transmuxer to fallback to playlist timing"));if(0===i.fragmentError&&(i.fragmentError++,t.gap=!0,this.fragmentTracker.removeFragment(t),this.fragmentTracker.fragBuffered(t,!0)),this.warn(e.message),this.hls.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.FRAG_PARSING_ERROR,fatal:!1,error:e,frag:t,reason:"Found no media in msn ".concat(t.sn,' of level "').concat(i.url,'"')}),!this.hls)return;this.resetTransmuxer()}this.state=im.PARSED,this.hls.trigger(C.FRAG_PARSED,{frag:t,part:e})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(t){"demuxerWorker"===t.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(t){let e=this._state;e!==t&&(this._state=t,this.log("".concat(e,"->").concat(t)))}get state(){return this._state}constructor(t,e,i,r,s){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=im.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=s,this.logPrefix=r,this.log=M.log.bind(M,"".concat(r,":")),this.warn=M.warn.bind(M,"".concat(r,":")),this.hls=t,this.fragmentLoader=new is(t.config),this.keyLoader=i,this.fragmentTracker=e,this.config=t.config,this.decrypter=new iu(t.config),t.on(C.MANIFEST_LOADED,this.onManifestLoaded,this)}}class iE{push(t){this.chunks.push(t),this.dataLength+=t.length}flush(){let t;let{chunks:e,dataLength:i}=this;return e.length?(t=1===e.length?e[0]:function(t,e){let i=new Uint8Array(e),r=0;for(let e=0;e<t.length;e++){let s=t[e];i.set(s,r),r+=s.length}return i}(e,i),this.reset(),t):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}constructor(){this.chunks=[],this.dataLength=0}}function iT(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9e4;return{type:t,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class iy{resetInitSegment(t,e,i,r){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(t){this.initPTS=t,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(t,e){return!1}appendFrame(t,e,i){}demux(t,e){let i;this.cachedData&&(t=tO(this.cachedData,t),this.cachedData=null);let r=tn(t,0),s=r?r.length:0,a=this._audioTrack,n=this._id3Track,l=r?th(r):void 0,o=t.length;for((null===this.basePTS||0===this.frameIndex&&b(l))&&(this.basePTS=iv(l,e,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),r&&r.length>0&&n.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:ef.audioId3,duration:Number.POSITIVE_INFINITY});s<o;){if(this.canParse(t,s)){let e=this.appendFrame(a,t,s);e?(this.frameIndex++,this.lastPTS=e.sample.pts,s+=e.length,i=s):s=o}else to(t,s)?(r=tn(t,s),n.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:r,type:ef.audioId3,duration:Number.POSITIVE_INFINITY}),s+=r.length,i=s):s++;if(s===o&&i!==o){let e=tr(t,i);this.cachedData?this.cachedData=tO(this.cachedData,e):this.cachedData=e}}return{audioTrack:a,videoTrack:iT(),id3Track:n,textTrack:iT()}}demuxSampleAes(t,e,i){return Promise.reject(Error("[".concat(this,"] This demuxer does not support Sample-AES decryption")))}flush(t){let e=this.cachedData;return e&&(this.cachedData=null,this.demux(e,0)),{audioTrack:this._audioTrack,videoTrack:iT(),id3Track:this._id3Track,textTrack:iT()}}destroy(){}constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}}let iv=(t,e,i)=>b(t)?90*t:9e4*e+(i?9e4*i.baseTime/i.timescale:0);function iS(t,e){return 255===t[e]&&(246&t[e+1])==240}function iA(t,e){return 1&t[e+1]?7:9}function iL(t,e){return(3&t[e+3])<<11|t[e+4]<<3|(224&t[e+5])>>>5}function iR(t,e){return e+1<t.length&&iS(t,e)}function iD(t,e,i,r,s){if(!t.samplerate){let a=function(t,e,i,r){let s,a,n,l;let o=navigator.userAgent.toLowerCase(),h=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=((192&e[i+2])>>>6)+1;let d=(60&e[i+2])>>>2;if(d>h.length-1){let e=Error("invalid ADTS sampling index:".concat(d));t.emit(C.ERROR,C.ERROR,{type:w.MEDIA_ERROR,details:P.FRAG_PARSING_ERROR,fatal:!0,error:e,reason:e.message});return}return n=(1&e[i+2])<<2|(192&e[i+3])>>>6,M.log("manifest codec:".concat(r,", ADTS type:").concat(s,", samplingIndex:").concat(d)),/firefox/i.test(o)?d>=6?(s=5,l=[,,,,],a=d-3):(s=2,l=[,,],a=d):-1!==o.indexOf("android")?(s=2,l=[,,],a=d):(s=5,l=[,,,,],r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&d>=6?a=d-3:((r&&-1!==r.indexOf("mp4a.40.2")&&(d>=6&&1===n||/vivaldi/i.test(o))||!r&&1===n)&&(s=2,l=[,,]),a=d)),l[0]=s<<3,l[0]|=(14&d)>>1,l[1]|=(1&d)<<7,l[1]|=n<<3,5===s&&(l[1]|=(14&a)>>1,l[2]=(1&a)<<7,l[2]|=8,l[3]=0),{config:l,samplerate:h[d],channelCount:n,codec:"mp4a.40."+s,manifestCodec:r}}(e,i,r,s);a&&(t.config=a.config,t.samplerate=a.samplerate,t.channelCount=a.channelCount,t.codec=a.codec,t.manifestCodec=a.manifestCodec,M.log("parsed codec:".concat(t.codec,", rate:").concat(a.samplerate,", channels:").concat(a.channelCount)))}}function iI(t,e,i,r,s){let a;let n=r+9216e4/t.samplerate*s,l=function(t,e){let i=iA(t,e);if(e+i<=t.length){let r=iL(t,e)-i;if(r>0)return{headerLength:i,frameLength:r}}}(e,i);if(l){let{frameLength:r,headerLength:s}=l,o=s+r,h=Math.max(0,i+o-e.length);h?(a=new Uint8Array(o-s)).set(e.subarray(i+s,e.length),0):a=e.subarray(i+s,i+o);let d={unit:a,pts:n};return h||t.samples.push(d),{sample:d,length:o,missing:h}}let o=e.length-i;return(a=new Uint8Array(o)).set(e.subarray(i,e.length),0),{sample:{unit:a,pts:n},length:o,missing:-1}}let ib=null,ik=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],i_=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],iC=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],iw=[0,1,1,4];function iP(t,e,i,r,s){if(i+24>e.length)return;let a=ix(e,i);if(a&&i+a.frameLength<=e.length){let n=r+9e4*a.samplesPerFrame/a.sampleRate*s,l={unit:e.subarray(i,i+a.frameLength),pts:n,dts:n};return t.config=[],t.channelCount=a.channelCount,t.samplerate=a.sampleRate,t.samples.push(l),{sample:l,length:a.frameLength,missing:0}}}function ix(t,e){let i=t[e+1]>>3&3,r=t[e+1]>>1&3,s=t[e+2]>>4&15,a=t[e+2]>>2&3;if(1!==i&&0!==s&&15!==s&&3!==a){let n=t[e+2]>>1&1,l=t[e+3]>>6,o=1e3*ik[14*(3===i?3-r:3===r?3:4)+s-1],h=i_[3*(3===i?0:2===i?1:2)+a],d=iC[i][r],c=iw[r],u=Math.floor(d*o/h+n)*c;if(null===ib){let t=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);ib=t?parseInt(t[1]):0}return ib&&ib<=87&&2===r&&o>=224e3&&0===l&&(t[e+3]=128|t[e+3]),{sampleRate:h,channelCount:3===l?1:2,frameLength:u,samplesPerFrame:8*d*c}}}function iO(t,e){return 255===t[e]&&(224&t[e+1])==224&&(6&t[e+1])!=0}function iF(t,e){return e+1<t.length&&iO(t,e)}function iM(t,e){if(e+1<t.length&&iO(t,e)){let i=ix(t,e),r=4;null!=i&&i.frameLength&&(r=i.frameLength);let s=e+r;return s===t.length||iF(t,s)}return!1}class iN extends iy{resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;let e=tn(t,0),i=(null==e?void 0:e.length)||0;if(iM(t,i))return!1;for(let e=t.length;i<e;i++)if(function(t,e){if(iR(t,e)){let i=iA(t,e);if(e+i>=t.length)return!1;let r=iL(t,e);if(r<=i)return!1;let s=e+r;return s===t.length||iR(t,s)}return!1}(t,i))return M.log("ADTS sync word found !"),!0;return!1}canParse(t,e){return e+5<t.length&&iS(t,e)&&iL(t,e)<=t.length-e}appendFrame(t,e,i){iD(t,this.observer,e,i,t.manifestCodec);let r=iI(t,e,i,this.basePTS,this.frameIndex);if(r&&0===r.missing)return r}constructor(t,e){super(),this.observer=void 0,this.config=void 0,this.observer=t,this.config=e}}let iU=/\/emsg[-/]ID3/i;class iB{resetTimeStamp(){}resetInitSegment(t,e,i,r){let s=this.videoTrack=iT("video",1),a=this.audioTrack=iT("audio",1),n=this.txtTrack=iT("text",1);if(this.id3Track=iT("id3",1),this.timeOffset=0,!(null!=t&&t.byteLength))return;let l=t_(t);if(l.video){let{id:t,timescale:e,codec:i}=l.video;s.id=t,s.timescale=n.timescale=e,s.codec=i}if(l.audio){let{id:t,timescale:e,codec:i}=l.audio;a.id=t,a.timescale=e,a.codec=i}n.id=4,s.sampleDuration=0,s.duration=a.duration=r}resetContiguity(){this.remainderData=null}static probe(t){return function(t){let e=t.byteLength;for(let i=0;i<e;){let r=tR(t,i);if(r>8&&109===t[i+4]&&111===t[i+5]&&111===t[i+6]&&102===t[i+7])return!0;i=r>1?i+r:e}return!1}(t)}demux(t,e){this.timeOffset=e;let i=t,r=this.videoTrack,s=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=tO(this.remainderData,t));let e=function(t){let e={valid:null,remainder:null},i=tk(t,["moof"]);if(i.length<2)return e.remainder=t,e;let r=i[i.length-1];return e.valid=tr(t,0,r.byteOffset-8),e.remainder=tr(t,r.byteOffset-8),e}(i);this.remainderData=e.remainder,r.samples=e.valid||new Uint8Array}else r.samples=i;let a=this.extractID3Track(r,e);return s.samples=tF(e,r),{videoTrack:r,audioTrack:this.audioTrack,id3Track:a,textTrack:this.txtTrack}}flush(){let t=this.timeOffset,e=this.videoTrack,i=this.txtTrack;e.samples=this.remainderData||new Uint8Array,this.remainderData=null;let r=this.extractID3Track(e,this.timeOffset);return i.samples=tF(t,e),{videoTrack:e,audioTrack:iT(),id3Track:r,textTrack:iT()}}extractID3Track(t,e){let i=this.id3Track;if(t.samples.length){let r=tk(t.samples,["emsg"]);r&&r.forEach(t=>{let r=function(t){let e=t[0],i="",r="",s=0,a=0,n=0,l=0,o=0,h=0;if(0===e){for(;"\x00"!==tA(t.subarray(h,h+1));)i+=tA(t.subarray(h,h+1)),h+=1;for(i+=tA(t.subarray(h,h+1)),h+=1;"\x00"!==tA(t.subarray(h,h+1));)r+=tA(t.subarray(h,h+1)),h+=1;r+=tA(t.subarray(h,h+1)),h+=1,s=tR(t,12),a=tR(t,16),l=tR(t,20),o=tR(t,24),h=28}else if(1===e){h+=4,s=tR(t,h);let e=tR(t,h+=4),a=tR(t,h+=4);for(h+=4,k(n=4294967296*e+a)||(n=Number.MAX_SAFE_INTEGER,M.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),l=tR(t,h),h+=4,o=tR(t,h),h+=4;"\x00"!==tA(t.subarray(h,h+1));)i+=tA(t.subarray(h,h+1)),h+=1;for(i+=tA(t.subarray(h,h+1)),h+=1;"\x00"!==tA(t.subarray(h,h+1));)r+=tA(t.subarray(h,h+1)),h+=1;r+=tA(t.subarray(h,h+1)),h+=1}return{schemeIdUri:i,value:r,timeScale:s,presentationTime:n,presentationTimeDelta:a,eventDuration:l,id:o,payload:t.subarray(h,t.byteLength)}}(t);if(iU.test(r.schemeIdUri)){let t=b(r.presentationTime)?r.presentationTime/r.timeScale:e+r.presentationTimeDelta/r.timeScale,s=4294967295===r.eventDuration?Number.POSITIVE_INFINITY:r.eventDuration/r.timeScale;s<=.001&&(s=Number.POSITIVE_INFINITY);let a=r.payload;i.samples.push({data:a,len:a.byteLength,dts:t,pts:t,type:ef.emsg,duration:s})}})}return i}demuxSampleAes(t,e,i){return Promise.reject(Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}constructor(t,e){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=e}}let iG=(t,e)=>{let i=0,r=5;e+=5;let s=new Uint32Array(1),a=new Uint32Array(1),n=new Uint8Array(1);for(;r>0;){n[0]=t[e];let l=Math.min(r,8),o=8-l;a[0]=4278190080>>>24+o<<o,s[0]=(n[0]&a[0])>>o,i=i?i<<l|s[0]:s[0],e+=1,r-=l}return i};class iK extends iy{resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}canParse(t,e){return e+64<t.length}appendFrame(t,e,i){let r=iH(t,e,i,this.basePTS,this.frameIndex);if(-1!==r)return{sample:t.samples[t.samples.length-1],length:r,missing:0}}static probe(t){if(!t)return!1;let e=tn(t,0);if(!e)return!1;let i=e.length;return!!(11===t[i]&&119===t[i+1]&&void 0!==th(e)&&16>iG(t,i))}constructor(t){super(),this.observer=void 0,this.observer=t}}function iH(t,e,i,r,s){if(i+8>e.length||11!==e[i]||119!==e[i+1])return -1;let a=e[i+4]>>6;if(a>=3)return -1;let n=[48e3,44100,32e3][a],l=63&e[i+4],o=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*l+a];if(i+o>e.length)return -1;let h=e[i+6]>>5,d=0;2===h?d+=2:(1&h&&1!==h&&(d+=2),4&h&&(d+=2));let c=(e[i+6]<<8|e[i+7])>>12-d&1,u=[2,1,2,3,3,4,4,5][h]+c,f=e[i+5]>>3,g=7&e[i+5],m=new Uint8Array([a<<6|f<<1|g>>2,(3&g)<<6|h<<3|c<<2|l>>4,l<<4&224]),p=e.subarray(i,i+o);return t.config=m,t.channelCount=u,t.samplerate=n,t.samples.push({unit:p,pts:r+1536/n*9e4*s}),o}class iV{createVideoSample(t,e,i,r){return{key:t,frame:!1,pts:e,dts:i,units:[],debug:r,length:0}}getLastNalUnit(t){var e;let i;let r=this.VideoSample;if(r&&0!==r.units.length||(r=t[t.length-1]),null!=(e=r)&&e.units){let t=r.units;i=t[t.length-1]}return i}pushAccessUnit(t,e){if(t.units.length&&t.frame){if(void 0===t.pts){let i=e.samples,r=i.length;if(r){let e=i[r-1];t.pts=e.pts,t.dts=e.dts}else{e.dropped++;return}}e.samples.push(t)}t.debug.length&&M.log(t.pts+"/"+t.dts+":"+t.debug)}constructor(){this.VideoSample=null}}class iY{loadWord(){let t=this.data,e=this.bytesAvailable,i=t.byteLength-e,r=new Uint8Array(4),s=Math.min(4,e);if(0===s)throw Error("no bytes available");r.set(t.subarray(i,i+s)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*s,this.bytesAvailable-=s}skipBits(t){let e;t=Math.min(t,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>t||(t-=this.bitsAvailable,e=t>>3,t-=e<<3,this.bytesAvailable-=e,this.loadWord()),this.word<<=t,this.bitsAvailable-=t}readBits(t){let e=Math.min(this.bitsAvailable,t),i=this.word>>>32-e;if(t>32&&M.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=e,this.bitsAvailable>0)this.word<<=e;else if(this.bytesAvailable>0)this.loadWord();else throw Error("no bits available");return(e=t-e)>0&&this.bitsAvailable?i<<e|this.readBits(e):i}skipLZ(){let t;for(t=0;t<this.bitsAvailable;++t)if((this.word&2147483648>>>t)!=0)return this.word<<=t,this.bitsAvailable-=t,t;return this.loadWord(),t+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let t=this.skipLZ();return this.readBits(t+1)-1}readEG(){let t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(t){let e=8,i=8;for(let r=0;r<t;r++)0!==i&&(i=(e+this.readEG()+256)%256),e=0===i?e:i}readSPS(){let t,e,i,r=0,s=0,a=0,n=0,l=this.readUByte.bind(this),o=this.readBits.bind(this),h=this.readUEG.bind(this),d=this.readBoolean.bind(this),c=this.skipBits.bind(this),u=this.skipEG.bind(this),f=this.skipUEG.bind(this),g=this.skipScalingList.bind(this);l();let m=l();if(o(5),c(3),l(),f(),100===m||110===m||122===m||244===m||44===m||83===m||86===m||118===m||128===m){let t=h();if(3===t&&c(1),f(),f(),c(1),d())for(i=0,e=3!==t?8:12;i<e;i++)d()&&g(i<6?16:64)}f();let p=h();if(0===p)h();else if(1===p)for(c(1),u(),u(),t=h(),i=0;i<t;i++)u();f(),c(1);let E=h(),T=h(),y=o(1);0===y&&c(1),c(1),d()&&(r=h(),s=h(),a=h(),n=h());let v=[1,1];if(d()&&d())switch(l()){case 1:v=[1,1];break;case 2:v=[12,11];break;case 3:v=[10,11];break;case 4:v=[16,11];break;case 5:v=[40,33];break;case 6:v=[24,11];break;case 7:v=[20,11];break;case 8:v=[32,11];break;case 9:v=[80,33];break;case 10:v=[18,11];break;case 11:v=[15,11];break;case 12:v=[64,33];break;case 13:v=[160,99];break;case 14:v=[4,3];break;case 15:v=[3,2];break;case 16:v=[2,1];break;case 255:v=[l()<<8|l(),l()<<8|l()]}return{width:Math.ceil((E+1)*16-2*r-2*s),height:(2-y)*(T+1)*16-(y?2:4)*(a+n),pixelRatio:v}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}constructor(t){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=t,this.bytesAvailable=t.byteLength,this.word=0,this.bitsAvailable=0}}class iW extends iV{parseAVCPES(t,e,i,r,s){let a;let n=this.parseAVCNALu(t,i.data),l=this.VideoSample,o=!1;i.data=null,l&&n.length&&!t.audFound&&(this.pushAccessUnit(l,t),l=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),n.forEach(r=>{var n,h,d,c;switch(r.type){case 1:{let e=!1;a=!0;let s=r.data;if(o&&s.length>4){let t=new iY(s).readSliceType();(2===t||4===t||7===t||9===t)&&(e=!0)}e&&null!=(h=l)&&h.frame&&!l.key&&(this.pushAccessUnit(l,t),l=this.VideoSample=null),l||(l=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),l.frame=!0,l.key=e;break}case 5:a=!0,null!=(n=l)&&n.frame&&!l.key&&(this.pushAccessUnit(l,t),l=this.VideoSample=null),l||(l=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),l.key=!0,l.frame=!0;break;case 6:a=!0,tM(r.data,1,i.pts,e.samples);break;case 7:{a=!0,o=!0;let e=r.data,i=new iY(e).readSPS();if(!t.sps||t.width!==i.width||t.height!==i.height||(null==(d=t.pixelRatio)?void 0:d[0])!==i.pixelRatio[0]||(null==(c=t.pixelRatio)?void 0:c[1])!==i.pixelRatio[1]){t.width=i.width,t.height=i.height,t.pixelRatio=i.pixelRatio,t.sps=[e],t.duration=s;let r=e.subarray(1,4),a="avc1.";for(let t=0;t<3;t++){let e=r[t].toString(16);e.length<2&&(e="0"+e),a+=e}t.codec=a}break}case 8:a=!0,t.pps=[r.data];break;case 9:a=!0,t.audFound=!0,l&&this.pushAccessUnit(l,t),l=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:a=!0;break;default:a=!1,l&&(l.debug+="unknown NAL "+r.type+" ")}l&&a&&l.units.push(r)}),r&&l&&(this.pushAccessUnit(l,t),this.VideoSample=null)}parseAVCNALu(t,e){let i,r,s;let a=e.byteLength,n=t.naluState||0,l=n,o=[],h=0,d=-1,c=0;for(-1===n&&(d=0,c=31&e[0],n=0,h=1);h<a;){if(i=e[h++],!n){n=i?0:1;continue}if(1===n){n=i?0:2;continue}if(i){if(1===i){if(r=h-n-1,d>=0){let t={data:e.subarray(d,r),type:c};o.push(t)}else{let i=this.getLastNalUnit(t.samples);i&&(l&&h<=4-l&&i.state&&(i.data=i.data.subarray(0,i.data.byteLength-l)),r>0&&(i.data=tO(i.data,e.subarray(0,r)),i.state=0))}h<a?(s=31&e[h],d=h,c=s,n=0):n=-1}else n=0}else n=3}if(d>=0&&n>=0){let t={data:e.subarray(d,a),type:c,state:n};o.push(t)}if(0===o.length){let i=this.getLastNalUnit(t.samples);i&&(i.data=tO(i.data,e))}return t.naluState=n,o}}class ij{decryptBuffer(t){return this.decrypter.decrypt(t,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(t,e,i){let r=t[e].unit;if(r.length<=16)return;let s=r.subarray(16,r.length-r.length%16),a=s.buffer.slice(s.byteOffset,s.byteOffset+s.length);this.decryptBuffer(a).then(s=>{let a=new Uint8Array(s);r.set(a,16),this.decrypter.isSync()||this.decryptAacSamples(t,e+1,i)})}decryptAacSamples(t,e,i){for(;;e++){if(e>=t.length){i();return}if(!(t[e].unit.length<32)&&(this.decryptAacSample(t,e,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(t){let e=16*Math.floor((t.length-48)/160)+16,i=new Int8Array(e),r=0;for(let e=32;e<t.length-16;e+=160,r+=16)i.set(t.subarray(e,e+16),r);return i}getAvcDecryptedUnit(t,e){let i=new Uint8Array(e),r=0;for(let e=32;e<t.length-16;e+=160,r+=16)t.set(i.subarray(r,r+16),e);return t}decryptAvcSample(t,e,i,r,s){let a=tN(s.data),n=this.getAvcEncryptedData(a);this.decryptBuffer(n.buffer).then(n=>{s.data=this.getAvcDecryptedUnit(a,n),this.decrypter.isSync()||this.decryptAvcSamples(t,e,i+1,r)})}decryptAvcSamples(t,e,i,r){if(t instanceof Uint8Array)throw Error("Cannot decrypt samples of type Uint8Array");for(;;e++,i=0){if(e>=t.length){r();return}let s=t[e].units;for(;!(i>=s.length);i++){let a=s[i];if(!(a.data.length<=48)&&(1===a.type||5===a.type)&&(this.decryptAvcSample(t,e,i,r,a),!this.decrypter.isSync()))return}}}constructor(t,e,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new iu(e,{removePKCS7Padding:!1})}}class iq{static probe(t){let e=iq.syncOffset(t);return e>0&&M.warn("MPEG2-TS detected but first sync word found @ offset ".concat(e)),-1!==e}static syncOffset(t){let e=t.length,i=Math.min(940,e-188)+1,r=0;for(;r<i;){let s=!1,a=-1,n=0;for(let l=r;l<e;l+=188)if(71===t[l]&&(e-l==188||71===t[l+188])){if(n++,-1===a&&0!==(a=l)&&(i=Math.min(a+18612,t.length-188)+1),s||(s=0===iX(t,l)),s&&n>1&&(0===a&&n>2||l+188>i))return a}else if(n)return -1;else break;r++}return -1}static createTrack(t,e){return{container:"video"===t||"audio"===t?"video/mp2t":void 0,type:t,id:tS[t],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===t?e:void 0}}resetInitSegment(t,e,i,r){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=iq.createTrack("video"),this._audioTrack=iq.createTrack("audio",r),this._id3Track=iq.createTrack("id3"),this._txtTrack=iq.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=e,this.videoCodec=i,this._duration=r}resetTimeStamp(){}resetContiguity(){let{_audioTrack:t,_videoTrack:e,_id3Track:i}=this;t&&(t.pesData=null),e&&(e.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(t,e){let i,r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],s=arguments.length>3&&void 0!==arguments[3]&&arguments[3];r||(this.sampleAes=null);let a=this._videoTrack,n=this._audioTrack,l=this._id3Track,o=this._txtTrack,h=a.pid,d=a.pesData,c=n.pid,u=l.pid,f=n.pesData,g=l.pesData,m=null,p=this.pmtParsed,E=this._pmtId,T=t.length;if(this.remainderData&&(T=(t=tO(this.remainderData,t)).length,this.remainderData=null),T<188&&!s)return this.remainderData=t,{audioTrack:n,videoTrack:a,id3Track:l,textTrack:o};let y=Math.max(0,iq.syncOffset(t));(T-=(T-y)%188)<t.byteLength&&!s&&(this.remainderData=new Uint8Array(t.buffer,T,t.buffer.byteLength-T));let v=0;for(let e=y;e<T;e+=188)if(71===t[e]){let s;let T=!!(64&t[e+1]),v=iX(t,e);if((48&t[e+3])>>4>1){if((s=e+5+t[e+4])===e+188)continue}else s=e+4;switch(v){case h:T&&(d&&(i=iQ(d))&&this.videoParser.parseAVCPES(a,o,i,!1,this._duration),d={data:[],size:0}),d&&(d.data.push(t.subarray(s,e+188)),d.size+=e+188-s);break;case c:if(T){if(f&&(i=iQ(f)))switch(n.segmentCodec){case"aac":this.parseAACPES(n,i);break;case"mp3":this.parseMPEGPES(n,i);break;case"ac3":this.parseAC3PES(n,i)}f={data:[],size:0}}f&&(f.data.push(t.subarray(s,e+188)),f.size+=e+188-s);break;case u:T&&(g&&(i=iQ(g))&&this.parseID3PES(l,i),g={data:[],size:0}),g&&(g.data.push(t.subarray(s,e+188)),g.size+=e+188-s);break;case 0:var S,A;T&&(s+=t[s]+1),E=this._pmtId=(31&(S=t)[(A=s)+10])<<8|S[A+11];break;case E:{T&&(s+=t[s]+1);let i=function(t,e,i,r){let s={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},a=(15&t[e+1])<<8|t[e+2],n=e+3+a-4,l=(15&t[e+10])<<8|t[e+11];for(e+=12+l;e<n;){let a=iX(t,e),n=(15&t[e+3])<<8|t[e+4];switch(t[e]){case 207:if(!r){iz("ADTS AAC");break}case 15:-1===s.audioPid&&(s.audioPid=a);break;case 21:-1===s.id3Pid&&(s.id3Pid=a);break;case 219:if(!r){iz("H.264");break}case 27:-1===s.videoPid&&(s.videoPid=a,s.segmentVideoCodec="avc");break;case 3:case 4:i.mpeg||i.mp3?-1===s.audioPid&&(s.audioPid=a,s.segmentAudioCodec="mp3"):M.log("MPEG audio found, not supported in this browser");break;case 193:if(!r){iz("AC-3");break}case 129:i.ac3?-1===s.audioPid&&(s.audioPid=a,s.segmentAudioCodec="ac3"):M.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===s.audioPid&&n>0){let r=e+5,l=n;for(;l>2;){106===t[r]&&(!0!==i.ac3?M.log("AC-3 audio found, not supported in this browser for now"):(s.audioPid=a,s.segmentAudioCodec="ac3"));let e=t[r+1]+2;r+=e,l-=e}}break;case 194:case 135:M.warn("Unsupported EC-3 in M2TS found");break;case 36:M.warn("Unsupported HEVC in M2TS found")}e+=n+5}return s}(t,s,this.typeSupported,r);(h=i.videoPid)>0&&(a.pid=h,a.segmentCodec=i.segmentVideoCodec),(c=i.audioPid)>0&&(n.pid=c,n.segmentCodec=i.segmentAudioCodec),(u=i.id3Pid)>0&&(l.pid=u),null===m||p||(M.warn("MPEG-TS PMT found at ".concat(e," after unknown PID '").concat(m,"'. Backtracking to sync byte @").concat(y," to parse all TS packets.")),m=null,e=y-188),p=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=v}}else v++;if(v>0){let t=Error("Found ".concat(v," TS packet/s that do not start with 0x47"));this.observer.emit(C.ERROR,C.ERROR,{type:w.MEDIA_ERROR,details:P.FRAG_PARSING_ERROR,fatal:!1,error:t,reason:t.message})}a.pesData=d,n.pesData=f,l.pesData=g;let L={audioTrack:n,videoTrack:a,id3Track:l,textTrack:o};return s&&this.extractRemainingSamples(L),L}flush(){let t;let{remainderData:e}=this;return(this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes)?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(t){let e;let{audioTrack:i,videoTrack:r,id3Track:s,textTrack:a}=t,n=r.pesData,l=i.pesData,o=s.pesData;if(n&&(e=iQ(n))?(this.videoParser.parseAVCPES(r,a,e,!0,this._duration),r.pesData=null):r.pesData=n,l&&(e=iQ(l))){switch(i.segmentCodec){case"aac":this.parseAACPES(i,e);break;case"mp3":this.parseMPEGPES(i,e);break;case"ac3":this.parseAC3PES(i,e)}i.pesData=null}else null!=l&&l.size&&M.log("last AAC PES packet truncated,might overlap between fragments"),i.pesData=l;o&&(e=iQ(o))?(this.parseID3PES(s,e),s.pesData=null):s.pesData=o}demuxSampleAes(t,e,i){let r=this.demux(t,i,!0,!this.config.progressive),s=this.sampleAes=new ij(this.observer,this.config,e);return this.decrypt(r,s)}decrypt(t,e){return new Promise(i=>{let{audioTrack:r,videoTrack:s}=t;r.samples&&"aac"===r.segmentCodec?e.decryptAacSamples(r.samples,0,()=>{s.samples?e.decryptAvcSamples(s.samples,0,0,()=>{i(t)}):i(t)}):s.samples&&e.decryptAvcSamples(s.samples,0,0,()=>{i(t)})})}destroy(){this._duration=0}parseAACPES(t,e){let i,r,s,a,n=0,l=this.aacOverFlow,o=e.data;if(l){this.aacOverFlow=null;let e=l.missing,i=l.sample.unit.byteLength;-1===e?o=tO(l.sample.unit,o):(l.sample.unit.set(o.subarray(0,e),i-e),t.samples.push(l.sample),n=l.missing)}for(i=n,r=o.length;i<r-1&&!iR(o,i);i++);if(i!==n){let t;let e=i<r-1,s=Error(t=e?"AAC PES did not start with ADTS header,offset:".concat(i):"No ADTS header found in AAC PES");if(M.warn("parsing error: ".concat(t)),this.observer.emit(C.ERROR,C.ERROR,{type:w.MEDIA_ERROR,details:P.FRAG_PARSING_ERROR,fatal:!1,levelRetry:e,error:s,reason:t}),!e)return}if(iD(t,this.observer,o,i,this.audioCodec),void 0!==e.pts)s=e.pts;else if(l){let e=9216e4/t.samplerate;s=l.sample.pts+e}else{M.warn("[tsdemuxer]: AAC PES unknown PTS");return}let h=0;for(;i<r;){if(a=iI(t,o,i,s,h),i+=a.length,a.missing){this.aacOverFlow=a;break}for(h++;i<r-1&&!iR(o,i);i++);}}parseMPEGPES(t,e){let i=e.data,r=i.length,s=0,a=0,n=e.pts;if(void 0===n){M.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;a<r;)if(iF(i,a)){let e=iP(t,i,a,n,s);if(e)a+=e.length,s++;else break}else a++}parseAC3PES(t,e){{let i;let r=e.data,s=e.pts;if(void 0===s){M.warn("[tsdemuxer]: AC3 PES unknown PTS");return}let a=r.length,n=0,l=0;for(;l<a&&(i=iH(t,r,l,s,n++))>0;)l+=i}}parseID3PES(t,e){if(void 0===e.pts){M.warn("[tsdemuxer]: ID3 PES unknown PTS");return}let i=I({},e,{type:this._videoTrack?ef.emsg:ef.audioId3,duration:Number.POSITIVE_INFINITY});t.samples.push(i)}constructor(t,e,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.videoParser=new iW}}function iX(t,e){return((31&t[e+1])<<8)+t[e+2]}function iz(t){M.log("".concat(t," with AES-128-CBC encryption found in unencrypted stream"))}function iQ(t){let e,i,r,s,a,n=0,l=t.data;if(!t||0===t.size)return null;for(;l[0].length<19&&l.length>1;)l[0]=tO(l[0],l[1]),l.splice(1,1);if(1===((e=l[0])[0]<<16)+(e[1]<<8)+e[2]){if((i=(e[4]<<8)+e[5])&&i>t.size-6)return null;let o=e[7];192&o&&(s=(14&e[9])*536870912+(255&e[10])*4194304+(254&e[11])*16384+(255&e[12])*128+(254&e[13])/2,64&o?s-(a=(14&e[14])*536870912+(255&e[15])*4194304+(254&e[16])*16384+(255&e[17])*128+(254&e[18])/2)>54e5&&(M.warn("".concat(Math.round((s-a)/9e4),"s delta between PTS and DTS, align them")),s=a):a=s);let h=(r=e[8])+9;if(t.size<=h)return null;t.size-=h;let d=new Uint8Array(t.size);for(let t=0,i=l.length;t<i;t++){let i=(e=l[t]).byteLength;if(h){if(h>i){h-=i;continue}e=e.subarray(h),i-=h,h=0}d.set(e,n),n+=i}return i&&(i-=r+3),{data:d,pts:s,dts:a,len:i}}return null}class iJ extends iy{resetInitSegment(t,e,i,r){super.resetInitSegment(t,e,i,r),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:e,duration:r,inputTimeScale:9e4,dropped:0}}static probe(t){if(!t)return!1;let e=tn(t,0),i=(null==e?void 0:e.length)||0;if(e&&11===t[i]&&119===t[i+1]&&void 0!==th(e)&&16>=iG(t,i))return!1;for(let e=t.length;i<e;i++)if(iM(t,i))return M.log("MPEG Audio sync word found !"),!0;return!1}canParse(t,e){return iO(t,e)&&4<=t.length-e}appendFrame(t,e,i){if(null!==this.basePTS)return iP(t,e,i,this.basePTS,this.frameIndex)}}class i${static getSilentFrame(t,e){if("mp4a.40.2"===t){if(1===e)return new Uint8Array([0,200,0,128,35,128]);if(2===e)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);else if(5===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);else if(6===e)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===e)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===e||3===e)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}class iZ{static init(){let t;for(t in iZ.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},iZ.types)iZ.types.hasOwnProperty(t)&&(iZ.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);let e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);iZ.HDLR_TYPES={video:e,audio:i};let r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),s=new Uint8Array([0,0,0,0,0,0,0,0]);iZ.STTS=iZ.STSC=iZ.STCO=s,iZ.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),iZ.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),iZ.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),iZ.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let a=new Uint8Array([105,115,111,109]),n=new Uint8Array([97,118,99,49]),l=new Uint8Array([0,0,0,1]);iZ.FTYP=iZ.box(iZ.types.ftyp,a,l,a,n),iZ.DINF=iZ.box(iZ.types.dinf,iZ.box(iZ.types.dref,r))}static box(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let s=8,a=i.length,n=a;for(;a--;)s+=i[a].byteLength;let l=new Uint8Array(s);for(l[0]=s>>24&255,l[1]=s>>16&255,l[2]=s>>8&255,l[3]=255&s,l.set(t,4),a=0,s=8;a<n;a++)l.set(i[a],s),s+=i[a].byteLength;return l}static hdlr(t){return iZ.box(iZ.types.hdlr,iZ.HDLR_TYPES[t])}static mdat(t){return iZ.box(iZ.types.mdat,t)}static mdhd(t,e){let i=Math.floor((e*=t)/4294967296),r=Math.floor(e%4294967296);return iZ.box(iZ.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,85,196,0,0]))}static mdia(t){return iZ.box(iZ.types.mdia,iZ.mdhd(t.timescale,t.duration),iZ.hdlr(t.type),iZ.minf(t))}static mfhd(t){return iZ.box(iZ.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}static minf(t){return"audio"===t.type?iZ.box(iZ.types.minf,iZ.box(iZ.types.smhd,iZ.SMHD),iZ.DINF,iZ.stbl(t)):iZ.box(iZ.types.minf,iZ.box(iZ.types.vmhd,iZ.VMHD),iZ.DINF,iZ.stbl(t))}static moof(t,e,i){return iZ.box(iZ.types.moof,iZ.mfhd(t),iZ.traf(i,e))}static moov(t){let e=t.length,i=[];for(;e--;)i[e]=iZ.trak(t[e]);return iZ.box.apply(null,[iZ.types.moov,iZ.mvhd(t[0].timescale,t[0].duration)].concat(i).concat(iZ.mvex(t)))}static mvex(t){let e=t.length,i=[];for(;e--;)i[e]=iZ.trex(t[e]);return iZ.box.apply(null,[iZ.types.mvex,...i])}static mvhd(t,e){let i=Math.floor((e*=t)/4294967296),r=Math.floor(e%4294967296),s=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,i>>24,i>>16&255,i>>8&255,255&i,r>>24,r>>16&255,r>>8&255,255&r,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return iZ.box(iZ.types.mvhd,s)}static sdtp(t){let e,i;let r=t.samples||[],s=new Uint8Array(4+r.length);for(e=0;e<r.length;e++)i=r[e].flags,s[e+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy;return iZ.box(iZ.types.sdtp,s)}static stbl(t){return iZ.box(iZ.types.stbl,iZ.stsd(t),iZ.box(iZ.types.stts,iZ.STTS),iZ.box(iZ.types.stsc,iZ.STSC),iZ.box(iZ.types.stsz,iZ.STSZ),iZ.box(iZ.types.stco,iZ.STCO))}static avc1(t){let e,i,r,s=[],a=[];for(e=0;e<t.sps.length;e++)r=(i=t.sps[e]).byteLength,s.push(r>>>8&255),s.push(255&r),s=s.concat(Array.prototype.slice.call(i));for(e=0;e<t.pps.length;e++)r=(i=t.pps[e]).byteLength,a.push(r>>>8&255),a.push(255&r),a=a.concat(Array.prototype.slice.call(i));let n=iZ.box(iZ.types.avcC,new Uint8Array([1,s[3],s[4],s[5],255,224|t.sps.length].concat(s).concat([t.pps.length]).concat(a))),l=t.width,o=t.height,h=t.pixelRatio[0],d=t.pixelRatio[1];return iZ.box(iZ.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,o>>8&255,255&o,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),n,iZ.box(iZ.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),iZ.box(iZ.types.pasp,new Uint8Array([h>>24,h>>16&255,h>>8&255,255&h,d>>24,d>>16&255,d>>8&255,255&d])))}static esds(t){let e=t.config.length;return new Uint8Array([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([e]).concat(t.config).concat([6,1,2]))}static audioStsd(t){let e=t.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0])}static mp4a(t){return iZ.box(iZ.types.mp4a,iZ.audioStsd(t),iZ.box(iZ.types.esds,iZ.esds(t)))}static mp3(t){return iZ.box(iZ.types[".mp3"],iZ.audioStsd(t))}static ac3(t){return iZ.box(iZ.types["ac-3"],iZ.audioStsd(t),iZ.box(iZ.types.dac3,t.config))}static stsd(t){return"audio"!==t.type?iZ.box(iZ.types.stsd,iZ.STSD,iZ.avc1(t)):"mp3"===t.segmentCodec&&"mp3"===t.codec?iZ.box(iZ.types.stsd,iZ.STSD,iZ.mp3(t)):"ac3"===t.segmentCodec?iZ.box(iZ.types.stsd,iZ.STSD,iZ.ac3(t)):iZ.box(iZ.types.stsd,iZ.STSD,iZ.mp4a(t))}static tkhd(t){let e=t.id,i=t.duration*t.timescale,r=t.width,s=t.height,a=Math.floor(i/4294967296),n=Math.floor(i%4294967296);return iZ.box(iZ.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,0,0,0,0,a>>24,a>>16&255,a>>8&255,255&a,n>>24,n>>16&255,n>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>8&255,255&r,0,0,s>>8&255,255&s,0,0]))}static traf(t,e){let i=iZ.sdtp(t),r=t.id,s=Math.floor(e/4294967296),a=Math.floor(e%4294967296);return iZ.box(iZ.types.traf,iZ.box(iZ.types.tfhd,new Uint8Array([0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),iZ.box(iZ.types.tfdt,new Uint8Array([1,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,a>>24,a>>16&255,a>>8&255,255&a])),iZ.trun(t,i.length+16+20+8+16+8+8),i)}static trak(t){return t.duration=t.duration||4294967295,iZ.box(iZ.types.trak,iZ.tkhd(t),iZ.mdia(t))}static trex(t){let e=t.id;return iZ.box(iZ.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){let i,r,s,a,n,l;let o=t.samples||[],h=o.length,d=12+16*h,c=new Uint8Array(d);for(e+=8+d,c.set(["video"===t.type?1:0,0,15,1,h>>>24&255,h>>>16&255,h>>>8&255,255&h,e>>>24&255,e>>>16&255,e>>>8&255,255&e],0),i=0;i<h;i++)s=(r=o[i]).duration,a=r.size,n=r.flags,l=r.cts,c.set([s>>>24&255,s>>>16&255,s>>>8&255,255&s,a>>>24&255,a>>>16&255,a>>>8&255,255&a,n.isLeading<<2|n.dependsOn,n.isDependedOn<<6|n.hasRedundancy<<4|n.paddingValue<<1|n.isNonSync,61440&n.degradPrio,15&n.degradPrio,l>>>24&255,l>>>16&255,l>>>8&255,255&l],12+16*i);return iZ.box(iZ.types.trun,c)}static initSegment(t){iZ.types||iZ.init();let e=iZ.moov(t);return tO(iZ.FTYP,e)}}function i0(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=t*e*i;return r?Math.round(s):s}function i1(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return i0(t,1e3,11111111111111112e-21,e)}iZ.types=void 0,iZ.HDLR_TYPES=void 0,iZ.STTS=void 0,iZ.STSC=void 0,iZ.STCO=void 0,iZ.STSZ=void 0,iZ.VMHD=void 0,iZ.SMHD=void 0,iZ.STSD=void 0,iZ.FTYP=void 0,iZ.DINF=void 0;let i2=null,i4=null;class i3{destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(t){M.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=t}resetNextTimestamp(){M.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){M.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(t){let e=!1,i=t.reduce((t,i)=>{let r=i.pts-t;return r<-4294967296?(e=!0,i5(t,i.pts)):r>0?t:i.pts},t[0].pts);return e&&M.debug("PTS rollover detected"),i}remux(t,e,i,r,s,a,n,l){let o,h,d,c,u,f;let g=s,m=s,p=t.pid>-1,E=e.pid>-1,T=e.samples.length,y=t.samples.length>0,v=n&&T>0||T>1;if((!p||y)&&(!E||v)||this.ISGenerated||n){let i;if(this.ISGenerated){var S,A,L,R;let t=this.videoTrackConfig;t&&(e.width!==t.width||e.height!==t.height||(null==(S=e.pixelRatio)?void 0:S[0])!==(null==(A=t.pixelRatio)?void 0:A[0])||(null==(L=e.pixelRatio)?void 0:L[1])!==(null==(R=t.pixelRatio)?void 0:R[1]))&&this.resetInitSegment()}else d=this.generateIS(t,e,s,a);let r=this.isVideoContiguous,n=-1;if(v&&(n=function(t){for(let e=0;e<t.length;e++)if(t[e].key)return e;return -1}(e.samples),!r&&this.config.forceKeyFrameOnDiscontinuity)){if(f=!0,n>0){M.warn("[mp4-remuxer]: Dropped ".concat(n," out of ").concat(T," video samples due to a missing keyframe"));let t=this.getVideoStartPts(e.samples);e.samples=e.samples.slice(n),e.dropped+=n,m+=(e.samples[0].pts-t)/e.inputTimeScale,i=m}else -1===n&&(M.warn("[mp4-remuxer]: No keyframe found out of ".concat(T," video samples")),f=!1)}if(this.ISGenerated){if(y&&v){let i=this.getVideoStartPts(e.samples),r=(i5(t.samples[0].pts,i)-i)/e.inputTimeScale;g+=Math.max(0,r),m+=Math.max(0,-r)}if(y){if(t.samplerate||(M.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),d=this.generateIS(t,e,s,a)),h=this.remuxAudio(t,g,this.isAudioContiguous,a,E||v||l===es.AUDIO?m:void 0),v){let i=h?h.endPTS-h.startPTS:0;e.inputTimeScale||(M.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),d=this.generateIS(t,e,s,a)),o=this.remuxVideo(e,m,r,i)}}else v&&(o=this.remuxVideo(e,m,r,0));o&&(o.firstKeyFrame=n,o.independent=-1!==n,o.firstKeyFramePTS=i)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(u=i8(i,s,this._initPTS,this._initDTS)),r.samples.length&&(c=i6(r,s,this._initPTS))),{audio:h,video:o,initSegment:d,independent:f,text:c,id3:u}}generateIS(t,e,i,r){let s,a,n;let l=t.samples,o=e.samples,h=this.typeSupported,d={},c=this._initPTS,u=!c||r,f="audio/mp4";if(u&&(s=a=1/0),t.config&&l.length){switch(t.timescale=t.samplerate,t.segmentCodec){case"mp3":h.mpeg?(f="audio/mpeg",t.codec=""):h.mp3&&(t.codec="mp3");break;case"ac3":t.codec="ac-3"}d.audio={id:"audio",container:f,codec:t.codec,initSegment:"mp3"===t.segmentCodec&&h.mpeg?new Uint8Array(0):iZ.initSegment([t]),metadata:{channelCount:t.channelCount}},u&&(n=t.inputTimeScale,c&&n===c.timescale?u=!1:s=a=l[0].pts-Math.round(n*i))}if(e.sps&&e.pps&&o.length){if(e.timescale=e.inputTimeScale,d.video={id:"main",container:"video/mp4",codec:e.codec,initSegment:iZ.initSegment([e]),metadata:{width:e.width,height:e.height}},u){if(n=e.inputTimeScale,c&&n===c.timescale)u=!1;else{let t=this.getVideoStartPts(o),e=Math.round(n*i);a=Math.min(a,i5(o[0].dts,t)-e),s=Math.min(s,t-e)}}this.videoTrackConfig={width:e.width,height:e.height,pixelRatio:e.pixelRatio}}if(Object.keys(d).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:s,timescale:n},this._initDTS={baseTime:a,timescale:n}):s=n=void 0,{tracks:d,initPTS:s,timescale:n}}remuxVideo(t,e,i,r){let s,a,n;let l=t.inputTimeScale,o=t.samples,h=[],d=o.length,c=this._initPTS,u=this.nextAvcDts,f=8,g=this.videoSampleDuration,m=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,E=!1;if(!i||null===u){let t=e*l,r=o[0].pts-i5(o[0].dts,o[0].pts);i2&&null!==u&&15e3>Math.abs(t-r-u)?i=!0:u=t-r}let T=c.baseTime*l/c.timescale;for(let t=0;t<d;t++){let e=o[t];e.pts=i5(e.pts-T,u),e.dts=i5(e.dts-T,u),e.dts<o[t>0?t-1:t].dts&&(E=!0)}E&&o.sort(function(t,e){let i=t.dts-e.dts,r=t.pts-e.pts;return i||r}),s=o[0].dts;let y=(a=o[o.length-1].dts)-s,v=y?Math.round(y/(d-1)):g||t.inputTimeScale/30;if(i){let t=s-u,i=t>v,r=t<-1;if((i||r)&&(i?M.warn("AVC: ".concat(i1(t,!0)," ms (").concat(t,"dts) hole between fragments detected at ").concat(e.toFixed(3))):M.warn("AVC: ".concat(i1(-t,!0)," ms (").concat(t,"dts) overlapping between fragments detected at ").concat(e.toFixed(3))),!r||u>=o[0].pts||i2)){s=u;let e=o[0].pts-t;if(i)o[0].dts=s,o[0].pts=e;else for(let i=0;i<o.length&&!(o[i].dts>e);i++)o[i].dts-=t,o[i].pts-=t;M.log("Video: Initial PTS/DTS adjusted: ".concat(i1(e,!0),"/").concat(i1(s,!0),", delta: ").concat(i1(t,!0)," ms"))}}let S=0,A=0,L=s=Math.max(0,s);for(let t=0;t<d;t++){let e=o[t],i=e.units,r=i.length,s=0;for(let t=0;t<r;t++)s+=i[t].data.length;A+=s,S+=r,e.length=s,e.dts<L?(e.dts=L,L+=v/4|0||1):L=e.dts,m=Math.min(e.pts,m),p=Math.max(e.pts,p)}a=o[d-1].dts;let R=A+4*S+8;try{n=new Uint8Array(R)}catch(t){this.observer.emit(C.ERROR,C.ERROR,{type:w.MUX_ERROR,details:P.REMUX_ALLOC_ERROR,fatal:!1,error:t,bytes:R,reason:"fail allocating video mdat ".concat(R)});return}let D=new DataView(n.buffer);D.setUint32(0,R),n.set(iZ.types.mdat,4);let b=!1,k=Number.POSITIVE_INFINITY,_=Number.POSITIVE_INFINITY,x=Number.NEGATIVE_INFINITY,O=Number.NEGATIVE_INFINITY;for(let t=0;t<d;t++){let e;let i=o[t],s=i.units,a=0;for(let t=0,e=s.length;t<e;t++){let e=s[t],i=e.data,r=e.data.byteLength;D.setUint32(f,r),f+=4,n.set(i,f),f+=r,a+=4+r}if(t<d-1)g=o[t+1].dts-i.dts,e=o[t+1].pts-i.pts;else{let s=this.config,a=t>0?i.dts-o[t-1].dts:v;if(e=t>0?i.pts-o[t-1].pts:v,s.stretchShortVideoTrack&&null!==this.nextAudioPts){let t=Math.floor(s.maxBufferHole*l),e=(r?m+r*l:this.nextAudioPts)-i.pts;e>t?((g=e-a)<0?g=a:b=!0,M.log("[mp4-remuxer]: It is approximately ".concat(e/90," ms to the next segment; using duration ").concat(g/90," ms for the last video frame."))):g=a}else g=a}let c=Math.round(i.pts-i.dts);k=Math.min(k,g),x=Math.max(x,g),_=Math.min(_,e),O=Math.max(O,e),h.push(new i9(i.key,g,a,c))}if(h.length){if(i2){if(i2<70){let t=h[0].flags;t.dependsOn=2,t.isNonSync=0}}else if(i4&&O-_<x-k&&v/x<.025&&0===h[0].cts){M.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let t=s;for(let e=0,i=h.length;e<i;e++){let r=t+h[e].duration,s=t+h[e].cts;if(e<i-1){let t=r+h[e+1].cts;h[e].duration=t-s}else h[e].duration=e?h[e-1].duration:v;h[e].cts=0,t=r}}}g=b||!g?v:g,this.nextAvcDts=u=a+g,this.videoSampleDuration=g,this.isVideoContiguous=!0;let F={data1:iZ.moof(t.sequenceNumber++,s,I({},t,{samples:h})),data2:n,startPTS:m/l,endPTS:(p+g)/l,startDTS:s/l,endDTS:u/l,type:"video",hasAudio:!1,hasVideo:!0,nb:h.length,dropped:t.dropped};return t.samples=[],t.dropped=0,F}getSamplesPerFrame(t){switch(t.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(t,e,i,r,s){let a;let n=t.inputTimeScale,l=t.samplerate?t.samplerate:n,o=n/l,h=this.getSamplesPerFrame(t),d=h*o,c=this._initPTS,u="mp3"===t.segmentCodec&&this.typeSupported.mpeg,f=[],g=void 0!==s,m=t.samples,p=u?0:8,E=this.nextAudioPts||-1,T=e*n,y=c.baseTime*n/c.timescale;if(this.isAudioContiguous=i=i||m.length&&E>0&&(r&&9e3>Math.abs(T-E)||Math.abs(i5(m[0].pts-y,T)-E)<20*d),m.forEach(function(t){t.pts=i5(t.pts-y,T)}),!i||E<0){if(!(m=m.filter(t=>t.pts>=0)).length)return;E=0===s?0:r&&!g?Math.max(0,T):m[0].pts}if("aac"===t.segmentCodec){let e=this.config.maxAudioFramesDrift;for(let i=0,r=E;i<m.length;i++){let s=m[i],a=s.pts,l=a-r,o=Math.abs(1e3*l/n);if(l<=-e*d&&g)0===i&&(M.warn("Audio frame @ ".concat((a/n).toFixed(3),"s overlaps nextAudioPts by ").concat(Math.round(1e3*l/n)," ms.")),this.nextAudioPts=E=r=a);else if(l>=e*d&&o<1e4&&g){let e=Math.round(l/d);(r=a-e*d)<0&&(e--,r+=d),0===i&&(this.nextAudioPts=E=r),M.warn("[mp4-remuxer]: Injecting ".concat(e," audio frame @ ").concat((r/n).toFixed(3),"s due to ").concat(Math.round(1e3*l/n)," ms gap."));for(let a=0;a<e;a++){let e=Math.max(r,0),a=i$.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);a||(M.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),a=s.unit.subarray()),m.splice(i,0,{unit:a,pts:e}),r+=d,i++}}s.pts=r,r+=d}}let v=null,S=null,A=0,L=m.length;for(;L--;)A+=m[L].unit.byteLength;for(let e=0,r=m.length;e<r;e++){let r=m[e],s=r.unit,n=r.pts;if(null!==S)f[e-1].duration=Math.round((n-S)/o);else{if(i&&"aac"===t.segmentCodec&&(n=E),v=n,!(A>0))return;A+=p;try{a=new Uint8Array(A)}catch(t){this.observer.emit(C.ERROR,C.ERROR,{type:w.MUX_ERROR,details:P.REMUX_ALLOC_ERROR,fatal:!1,error:t,bytes:A,reason:"fail allocating audio mdat ".concat(A)});return}u||(new DataView(a.buffer).setUint32(0,A),a.set(iZ.types.mdat,4))}a.set(s,p);let l=s.byteLength;p+=l,f.push(new i9(!0,h,l,0)),S=n}let R=f.length;if(!R)return;let D=f[f.length-1];this.nextAudioPts=E=S+o*D.duration;let b=u?new Uint8Array(0):iZ.moof(t.sequenceNumber++,v/o,I({},t,{samples:f}));t.samples=[];let k=v/n,_=E/n,x={data1:b,data2:a,startPTS:k,endPTS:_,startDTS:k,endDTS:_,type:"audio",hasAudio:!0,hasVideo:!1,nb:R};return this.isAudioContiguous=!0,x}remuxEmptyAudio(t,e,i,r){let s=t.inputTimeScale,a=t.samplerate?t.samplerate:s,n=this.nextAudioPts,l=this._initDTS,o=9e4*l.baseTime/l.timescale,h=(null!==n?n:r.startDTS*s)+o,d=r.endDTS*s+o,c=s/a*1024,u=Math.ceil((d-h)/c),f=i$.getSilentFrame(t.manifestCodec||t.codec,t.channelCount);if(M.warn("[mp4-remuxer]: remux empty Audio"),!f){M.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}let g=[];for(let t=0;t<u;t++){let e=h+t*c;g.push({unit:f,pts:e,dts:e})}return t.samples=g,this.remuxAudio(t,e,i,!1)}constructor(t,e,i,r=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=t,this.config=e,this.typeSupported=i,this.ISGenerated=!1,null===i2){let t=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);i2=t?parseInt(t[1]):0}if(null===i4){let t=navigator.userAgent.match(/Safari\/(\d+)/i);i4=t?parseInt(t[1]):0}}}function i5(t,e){let i;if(null===e)return t;for(i=e<t?-8589934592:8589934592;Math.abs(t-e)>4294967296;)t+=i;return t}function i8(t,e,i,r){let s=t.samples.length;if(!s)return;let a=t.inputTimeScale;for(let n=0;n<s;n++){let s=t.samples[n];s.pts=i5(s.pts-i.baseTime*a/i.timescale,e*a)/a,s.dts=i5(s.dts-r.baseTime*a/r.timescale,e*a)/a}let n=t.samples;return t.samples=[],{samples:n}}function i6(t,e,i){let r=t.samples.length;if(!r)return;let s=t.inputTimeScale;for(let a=0;a<r;a++){let r=t.samples[a];r.pts=i5(r.pts-i.baseTime*s/i.timescale,e*s)/s}t.samples.sort((t,e)=>t.pts-e.pts);let a=t.samples;return t.samples=[],{samples:a}}class i9{constructor(t,e,i,r){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=e,this.size=i,this.cts=r,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:t?2:1,isNonSync:t?0:1}}}class i7{destroy(){}resetTimeStamp(t){this.initPTS=t,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(t,e,i,r){this.audioCodec=e,this.videoCodec=i,this.generateInitSegment(function(t,e){if(!t||!e)return t;let i=e.keyId;return i&&e.isCommonEncryption&&tk(t,["moov","trak"]).forEach(t=>{let e=tk(t,["mdia","minf","stbl","stsd"])[0].subarray(8),r=tk(e,["enca"]),s=r.length>0;s||(r=tk(e,["encv"])),r.forEach(t=>{tk(s?t.subarray(28):t.subarray(78),["sinf"]).forEach(t=>{let e=tx(t);if(e){let t=e.subarray(8,24);t.some(t=>0!==t)||(M.log("[eme] Patching keyId in 'enc".concat(s?"a":"v",">sinf>>tenc' box: ").concat(ty.hexDump(t)," -> ").concat(ty.hexDump(i))),e.set(i,8))}})})}),t}(t,r)),this.emitInitSegment=!0}generateInitSegment(t){let{audioCodec:e,videoCodec:i}=this;if(!(null!=t&&t.byteLength)){this.initTracks=void 0,this.initData=void 0;return}let r=this.initData=t_(t);r.audio&&(e=rt(r.audio,H.AUDIO)),r.video&&(i=rt(r.video,H.VIDEO));let s={};r.audio&&r.video?s.audiovideo={container:"video/mp4",codec:e+","+i,initSegment:t,id:"main"}:r.audio?s.audio={container:"audio/mp4",codec:e,initSegment:t,id:"audio"}:r.video?s.video={container:"video/mp4",codec:i,initSegment:t,id:"main"}:M.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=s}remux(t,e,i,r,s,a){var n,l,o;let{initPTS:h,lastEndTime:d}=this,c={audio:void 0,video:void 0,text:r,id3:i,initSegment:void 0};b(d)||(d=this.lastEndTime=s||0);let u=e.samples;if(!(null!=u&&u.length))return c;let f={initPTS:void 0,timescale:1},g=this.initData;if(null!=(n=g)&&n.length||(this.generateInitSegment(u),g=this.initData),!(null!=(l=g)&&l.length))return M.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),c;this.emitInitSegment&&(f.tracks=this.initTracks,this.emitInitSegment=!1);let m=function(t,e){let i=0,r=0,s=0,a=tk(t,["moof","traf"]);for(let t=0;t<a.length;t++){let n=a[t],l=tk(n,["tfhd"])[0],o=e[tR(l,4)];if(!o)continue;let h=o.default,d=tR(l,0)|(null==h?void 0:h.flags),c=null==h?void 0:h.duration;8&d&&(c=2&d?tR(l,12):tR(l,8));let u=o.timescale||9e4,f=tk(n,["trun"]);for(let t=0;t<f.length;t++)(i=function(t){let e=tR(t,0),i=8;1&e&&(i+=4),4&e&&(i+=4);let r=0,s=tR(t,4);for(let a=0;a<s;a++)256&e&&(r+=tR(t,i),i+=4),512&e&&(i+=4),1024&e&&(i+=4),2048&e&&(i+=4);return r}(f[t]))||!c||(i=c*tR(f[t],4)),o.type===H.VIDEO?r+=i/u:o.type===H.AUDIO&&(s+=i/u)}if(0===r&&0===s){let e=1/0,i=0,r=0,s=tk(t,["sidx"]);for(let t=0;t<s.length;t++){let a=function(t){let e=[],i=t[0],r=8,s=tR(t,8);r+=4;let a=0,n=0;0===i?(a=tR(t,r),n=tR(t,r+4),r+=8):(a=tD(t,r),n=tD(t,r+8),r+=16),r+=2;let l=t.length+n,o=tL(t,r);r+=2;for(let i=0;i<o;i++){let i=r,a=tR(t,i);i+=4;let n=2147483647&a;if(1==(2147483648&a)>>>31)return M.warn("SIDX has hierarchical references (not supported)"),null;let o=tR(t,i);i+=4,e.push({referenceSize:n,subsegmentDuration:o,info:{duration:o/s,start:l,end:l+n-1}}),l+=n,i+=4,r=i}return{earliestPresentationTime:a,timescale:s,version:i,referencesCount:o,references:e}}(s[t]);null!=a&&a.references&&(e=Math.min(e,a.earliestPresentationTime/a.timescale),r=(i=Math.max(i,a.references.reduce((t,e)=>t+e.info.duration||0,0)+a.earliestPresentationTime/a.timescale))-e)}if(r&&b(r))return r}return r||s}(u,g),p=(o=g,tk(u,["moof","traf"]).reduce((t,e)=>{let i=tk(e,["tfdt"])[0],r=i[0],s=tk(e,["tfhd"]).reduce((t,e)=>{let s=o[tR(e,4)];if(s){let e=tR(i,4);if(1===r){if(4294967295===e)return M.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),t;e*=4294967296,e+=tR(i,8)}let a=e/(s.timescale||9e4);if(b(a)&&(null===t||a<t))return a}return t},null);return null!==s&&b(s)&&(null===t||s<t)?s:t},null)),E=null===p?s:p;((function(t,e,i,r){if(null===t)return!0;let s=Math.max(r,1);return Math.abs(e-t.baseTime/t.timescale-i)>s})(h,E,s,m)||f.timescale!==h.timescale&&a)&&(f.initPTS=E-s,h&&1===h.timescale&&M.warn("Adjusting initPTS by ".concat(f.initPTS-h.baseTime)),this.initPTS=h={baseTime:f.initPTS,timescale:1});let T=t?E-h.baseTime/h.timescale:d,y=T+m;!function(t,e,i){tk(e,["moof","traf"]).forEach(e=>{tk(e,["tfhd"]).forEach(r=>{let s=t[tR(r,4)];if(!s)return;let a=s.timescale||9e4;tk(e,["tfdt"]).forEach(t=>{let e=t[0],r=i*a;if(r){let i=tR(t,4);if(0===e)i-=r,tb(t,4,i=Math.max(i,0));else{i*=4294967296,i+=tR(t,8),i-=r;let e=Math.floor((i=Math.max(i,0))/4294967296),s=Math.floor(i%4294967296);tb(t,4,e),tb(t,8,s)}}})})})}(g,u,h.baseTime/h.timescale),m>0?this.lastEndTime=y:(M.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());let v=!!g.audio,S=!!g.video,A="";v&&(A+="audio"),S&&(A+="video");let L={data1:u,startPTS:T,startDTS:T,endPTS:y,endDTS:y,type:A,hasAudio:v,hasVideo:S,nb:1,dropped:0};return c.audio="audio"===L.type?L:void 0,c.video="audio"!==L.type?L:void 0,c.initSegment=f,c.id3=i8(i,s,h,h),r.samples.length&&(c.text=i6(r,s,h)),c}constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}}function rt(t,e){let i=null==t?void 0:t.codec;if(i&&i.length>4)return i;if(e===H.AUDIO){if("ec-3"===i||"ac-3"===i||"alac"===i)return i;if("fLaC"===i||"Opus"===i)return tZ(i,!1);let t="mp4a.40.5";return M.info('Parsed audio codec "'.concat(i,'" or audio object type not handled. Using "').concat(t,'"')),t}return(M.warn('Unhandled video codec "'.concat(i,'"')),"hvc1"===i||"hev1"===i)?"hvc1.1.6.L120.90":"av01"===i?"av01.0.04M.08":"avc1.42e01e"}try{s=self.performance.now.bind(self.performance)}catch(t){M.debug("Unable to use Performance API on this environment"),s=null==z?void 0:z.Date.now}let re=[{demux:iB,remux:i7},{demux:iq,remux:i3},{demux:iN,remux:i3},{demux:iJ,remux:i3}];re.splice(2,0,{demux:iK,remux:i3});class ri{configure(t){this.transmuxConfig=t,this.decrypter&&this.decrypter.reset()}push(t,e,i,r){let a;let n=i.transmuxing;n.executeStart=s();let l=new Uint8Array(t),{currentTransmuxState:o,transmuxConfig:h}=this;r&&(this.currentTransmuxState=r);let{contiguous:d,discontinuity:c,trackSwitch:u,accurateTimeOffset:f,timeOffset:g,initSegmentChange:m}=r||o,{audioCodec:p,videoCodec:E,defaultInitPts:T,duration:y,initSegmentData:v}=h,S=(a=null,l.byteLength>0&&(null==e?void 0:e.key)!=null&&null!==e.iv&&null!=e.method&&(a=e),a);if(S&&"AES-128"===S.method){let t=this.getDecrypter();if(!t.isSync())return this.decryptionPromise=t.webCryptoDecrypt(l,S.key.buffer,S.iv.buffer).then(t=>{let e=this.push(t,null,i);return this.decryptionPromise=null,e}),this.decryptionPromise;{let e=t.softwareDecrypt(l,S.key.buffer,S.iv.buffer);if(i.part>-1&&(e=t.flush()),!e)return n.executeEnd=s(),rr(i);l=new Uint8Array(e)}}let A=this.needsProbing(c,u);if(A){let t=this.configureTransmuxer(l);if(t)return M.warn("[transmuxer] ".concat(t.message)),this.observer.emit(C.ERROR,C.ERROR,{type:w.MEDIA_ERROR,details:P.FRAG_PARSING_ERROR,fatal:!1,error:t,reason:t.message}),n.executeEnd=s(),rr(i)}(c||u||m||A)&&this.resetInitSegment(v,p,E,y,e),(c||m||A)&&this.resetInitialTimestamp(T),d||this.resetContiguity();let L=this.transmux(l,S,g,f,i),R=this.currentTransmuxState;return R.contiguous=!0,R.discontinuity=!1,R.trackSwitch=!1,n.executeEnd=s(),L}flush(t){let e=t.transmuxing;e.executeStart=s();let{decrypter:i,currentTransmuxState:r,decryptionPromise:a}=this;if(a)return a.then(()=>this.flush(t));let n=[],{timeOffset:l}=r;if(i){let e=i.flush();e&&n.push(this.push(e,null,t))}let{demuxer:o,remuxer:h}=this;if(!o||!h)return e.executeEnd=s(),[rr(t)];let d=o.flush(l);return rs(d)?d.then(e=>(this.flushRemux(n,e,t),n)):(this.flushRemux(n,d,t),n)}flushRemux(t,e,i){let{audioTrack:r,videoTrack:a,id3Track:n,textTrack:l}=e,{accurateTimeOffset:o,timeOffset:h}=this.currentTransmuxState;M.log("[transmuxer.ts]: Flushed fragment ".concat(i.sn).concat(i.part>-1?" p: "+i.part:""," of level ").concat(i.level));let d=this.remuxer.remux(r,a,n,l,h,o,!0,this.id);t.push({remuxResult:d,chunkMeta:i}),i.transmuxing.executeEnd=s()}resetInitialTimestamp(t){let{demuxer:e,remuxer:i}=this;e&&i&&(e.resetTimeStamp(t),i.resetTimeStamp(t))}resetContiguity(){let{demuxer:t,remuxer:e}=this;t&&e&&(t.resetContiguity(),e.resetNextTimestamp())}resetInitSegment(t,e,i,r,s){let{demuxer:a,remuxer:n}=this;a&&n&&(a.resetInitSegment(t,e,i,r),n.resetInitSegment(t,e,i,s))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(t,e,i,r,s){return e&&"SAMPLE-AES"===e.method?this.transmuxSampleAes(t,e,i,r,s):this.transmuxUnencrypted(t,i,r,s)}transmuxUnencrypted(t,e,i,r){let{audioTrack:s,videoTrack:a,id3Track:n,textTrack:l}=this.demuxer.demux(t,e,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(s,a,n,l,e,i,!1,this.id),chunkMeta:r}}transmuxSampleAes(t,e,i,r,s){return this.demuxer.demuxSampleAes(t,e,i).then(t=>({remuxResult:this.remuxer.remux(t.audioTrack,t.videoTrack,t.id3Track,t.textTrack,i,r,!1,this.id),chunkMeta:s}))}configureTransmuxer(t){let e;let{config:i,observer:r,typeSupported:s,vendor:a}=this;for(let i=0,r=re.length;i<r;i++){var n;if(null!=(n=re[i].demux)&&n.probe(t)){e=re[i];break}}if(!e)return Error("Failed to find demuxer by probing fragment data");let l=this.demuxer,o=this.remuxer,h=e.remux,d=e.demux;o&&o instanceof h||(this.remuxer=new h(r,i,s,a)),l&&l instanceof d||(this.demuxer=new d(r,i,s),this.probe=d.probe)}needsProbing(t,e){return!this.demuxer||!this.remuxer||t||e}getDecrypter(){let t=this.decrypter;return t||(t=this.decrypter=new iu(this.config)),t}constructor(t,e,i,r,s){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=t,this.typeSupported=e,this.config=i,this.vendor=r,this.id=s}}let rr=t=>({remuxResult:{},chunkMeta:t});function rs(t){return"then"in t&&t.then instanceof Function}class ra{constructor(t,e,i,r,s){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=t,this.videoCodec=e,this.initSegmentData=i,this.duration=r,this.defaultInitPts=s||null}}class rn{constructor(t,e,i,r,s,a){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=t,this.contiguous=e,this.accurateTimeOffset=i,this.trackSwitch=r,this.timeOffset=s,this.initSegmentChange=a}}var rl={exports:{}};!function(t){var e=Object.prototype.hasOwnProperty,i="~";function r(){}function s(t,e,i){this.fn=t,this.context=e,this.once=i||!1}function a(t,e,r,a,n){if("function"!=typeof r)throw TypeError("The listener must be a function");var l=new s(r,a||t,n),o=i?i+e:e;return t._events[o]?t._events[o].fn?t._events[o]=[t._events[o],l]:t._events[o].push(l):(t._events[o]=l,t._eventsCount++),t}function n(t,e){0==--t._eventsCount?t._events=new r:delete t._events[e]}function l(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(i=!1)),l.prototype.eventNames=function(){var t,r,s=[];if(0===this._eventsCount)return s;for(r in t=this._events)e.call(t,r)&&s.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(t)):s},l.prototype.listeners=function(t){var e=i?i+t:t,r=this._events[e];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,n=Array(a);s<a;s++)n[s]=r[s].fn;return n},l.prototype.listenerCount=function(t){var e=i?i+t:t,r=this._events[e];return r?r.fn?1:r.length:0},l.prototype.emit=function(t,e,r,s,a,n){var l=i?i+t:t;if(!this._events[l])return!1;var o,h,d=this._events[l],c=arguments.length;if(d.fn){switch(d.once&&this.removeListener(t,d.fn,void 0,!0),c){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,e),!0;case 3:return d.fn.call(d.context,e,r),!0;case 4:return d.fn.call(d.context,e,r,s),!0;case 5:return d.fn.call(d.context,e,r,s,a),!0;case 6:return d.fn.call(d.context,e,r,s,a,n),!0}for(h=1,o=Array(c-1);h<c;h++)o[h-1]=arguments[h];d.fn.apply(d.context,o)}else{var u,f=d.length;for(h=0;h<f;h++)switch(d[h].once&&this.removeListener(t,d[h].fn,void 0,!0),c){case 1:d[h].fn.call(d[h].context);break;case 2:d[h].fn.call(d[h].context,e);break;case 3:d[h].fn.call(d[h].context,e,r);break;case 4:d[h].fn.call(d[h].context,e,r,s);break;default:if(!o)for(u=1,o=Array(c-1);u<c;u++)o[u-1]=arguments[u];d[h].fn.apply(d[h].context,o)}}return!0},l.prototype.on=function(t,e,i){return a(this,t,e,i,!1)},l.prototype.once=function(t,e,i){return a(this,t,e,i,!0)},l.prototype.removeListener=function(t,e,r,s){var a=i?i+t:t;if(!this._events[a])return this;if(!e)return n(this,a),this;var l=this._events[a];if(l.fn)l.fn!==e||s&&!l.once||r&&l.context!==r||n(this,a);else{for(var o=0,h=[],d=l.length;o<d;o++)(l[o].fn!==e||s&&!l[o].once||r&&l[o].context!==r)&&h.push(l[o]);h.length?this._events[a]=1===h.length?h[0]:h:n(this,a)}return this},l.prototype.removeAllListeners=function(t){var e;return t?(e=i?i+t:t,this._events[e]&&n(this,e)):(this._events=new r,this._eventsCount=0),this},l.prototype.off=l.prototype.removeListener,l.prototype.addListener=l.prototype.on,l.prefixed=i,l.EventEmitter=l,t.exports=l}(rl);var ro=(m=rl.exports)&&m.__esModule&&Object.prototype.hasOwnProperty.call(m,"default")?m.default:m;class rh{resetWorker(){if(this.workerContext){let{worker:t,objectURL:e}=this.workerContext;e&&self.URL.revokeObjectURL(e),t.removeEventListener("message",this.onwmsg),t.onerror=null,t.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{let t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}let t=this.observer;t&&t.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(t,e,i,r,s,a,n,l,o,h){var d,c;o.transmuxing.start=self.performance.now();let{transmuxer:u}=this,f=a?a.start:s.start,g=s.decryptdata,m=this.frag,p=!(m&&s.cc===m.cc),E=!(m&&o.level===m.level),T=m?o.sn-m.sn:-1,y=this.part?o.part-this.part.index:-1,v=0===T&&o.id>1&&o.id===(null==m?void 0:m.stats.chunkCount),S=!E&&(1===T||0===T&&(1===y||v&&y<=0)),A=self.performance.now();(E||T||0===s.stats.parsing.start)&&(s.stats.parsing.start=A),a&&(y||!S)&&(a.stats.parsing.start=A);let L=!(m&&(null==(d=s.initSegment)?void 0:d.url)===(null==(c=m.initSegment)?void 0:c.url)),R=new rn(p,S,l,E,f,L);if(!S||p||L){M.log("[transmuxer-interface, ".concat(s.type,"]: Starting new transmux session for sn: ").concat(o.sn," p: ").concat(o.part," level: ").concat(o.level," id: ").concat(o.id,"\n        discontinuity: ").concat(p,"\n        trackSwitch: ").concat(E,"\n        contiguous: ").concat(S,"\n        accurateTimeOffset: ").concat(l,"\n        timeOffset: ").concat(f,"\n        initSegmentChange: ").concat(L));let t=new ra(i,r,e,n,h);this.configureTransmuxer(t)}if(this.frag=s,this.part=a,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:t,decryptdata:g,chunkMeta:o,state:R},t instanceof ArrayBuffer?[t]:[]);else if(u){let e=u.push(t,g,o,R);rs(e)?(u.async=!0,e.then(t=>{this.handleTransmuxComplete(t)}).catch(t=>{this.transmuxerError(t,o,"transmuxer-interface push error")})):(u.async=!1,this.handleTransmuxComplete(e))}}flush(t){t.transmuxing.start=self.performance.now();let{transmuxer:e}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:t});else if(e){let i=e.flush(t);rs(i)||e.async?(rs(i)||(i=Promise.resolve(i)),i.then(e=>{this.handleFlushResult(e,t)}).catch(e=>{this.transmuxerError(e,t,"transmuxer-interface flush error")})):this.handleFlushResult(i,t)}}transmuxerError(t,e,i){this.hls&&(this.error=t,this.hls.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.FRAG_PARSING_ERROR,chunkMeta:e,fatal:!1,error:t,err:t,reason:i}))}handleFlushResult(t,e){t.forEach(t=>{this.handleTransmuxComplete(t)}),this.onFlush(e)}onWorkerMessage(t){let e=t.data,i=this.hls;switch(e.event){case"init":{var r;let t=null==(r=this.workerContext)?void 0:r.objectURL;t&&self.URL.revokeObjectURL(t);break}case"transmuxComplete":this.handleTransmuxComplete(e.data);break;case"flush":this.onFlush(e.data);break;case"workerLog":M[e.data.logType]&&M[e.data.logType](e.data.message);break;default:e.data=e.data||{},e.data.frag=this.frag,e.data.id=this.id,i.trigger(e.event,e.data)}}configureTransmuxer(t){let{transmuxer:e}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:t}):e&&e.configure(t)}handleTransmuxComplete(t){t.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(t)}constructor(t,e,i,r){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;let s=t.config;this.hls=t,this.id=e,this.useWorker=!!s.enableWorker,this.onTransmuxComplete=i,this.onFlush=r;let a=(t,e)=>{(e=e||{}).frag=this.frag,e.id=this.id,t===C.ERROR&&(this.error=e.error),this.hls.trigger(t,e)};this.observer=new ro,this.observer.on(C.FRAG_DECRYPTED,a),this.observer.on(C.ERROR,a);let n=tY(s.preferManagedMediaSource)||{isTypeSupported:()=>!1},l={mpeg:n.isTypeSupported("audio/mpeg"),mp3:n.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:n.isTypeSupported('audio/mp4; codecs="ac-3"')},o=navigator.vendor;if(this.useWorker&&"undefined"!=typeof Worker&&(s.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__)){try{s.workerPath?(M.log("loading Web Worker ".concat(s.workerPath,' for "').concat(e,'"')),this.workerContext=function(t){let e=new self.URL(t,self.location.href).href;return{worker:new self.Worker(e),scriptURL:e}}(s.workerPath)):(M.log('injecting Web Worker for "'.concat(e,'"')),this.workerContext=function(){let t=new self.Blob(["var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(".concat(__HLS_WORKER_BUNDLE__.toString(),")(true);")],{type:"text/javascript"}),e=self.URL.createObjectURL(t);return{worker:new self.Worker(e),objectURL:e}}()),this.onwmsg=t=>this.onWorkerMessage(t);let{worker:t}=this.workerContext;t.addEventListener("message",this.onwmsg),t.onerror=t=>{let i=Error("".concat(t.message,"  (").concat(t.filename,":").concat(t.lineno,")"));s.enableWorker=!1,M.warn('Error in "'.concat(e,'" Web Worker, fallback to inline')),this.hls.trigger(C.ERROR,{type:w.OTHER_ERROR,details:P.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:i})},t.postMessage({cmd:"init",typeSupported:l,vendor:o,id:e,config:JSON.stringify(s)})}catch(t){M.warn('Error setting up "'.concat(e,'" Web Worker, fallback to inline'),t),this.resetWorker(),this.error=null,this.transmuxer=new ri(this.observer,l,s,o,e)}return}this.transmuxer=new ri(this.observer,l,s,o,e)}}function rd(t,e){if(t.length!==e.length)return!1;for(let i=0;i<t.length;i++)if(!rc(t[i].attrs,e[i].attrs))return!1;return!0}function rc(t,e,i){let r=t["STABLE-RENDITION-ID"];return r&&!i?r===e["STABLE-RENDITION-ID"]:!(i||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(i=>t[i]!==e[i])}function ru(t,e){return e.label.toLowerCase()===t.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(t.lang||"").toLowerCase())}class rf extends ip{onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){let{hls:t}=this;t.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.LEVEL_LOADED,this.onLevelLoaded,this),t.on(C.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.on(C.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(C.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(C.ERROR,this.onError,this),t.on(C.BUFFER_RESET,this.onBufferReset,this),t.on(C.BUFFER_CREATED,this.onBufferCreated,this),t.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(C.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(C.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(C.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:t}=this;t.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.LEVEL_LOADED,this.onLevelLoaded,this),t.off(C.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),t.off(C.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(C.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(C.ERROR,this.onError,this),t.off(C.BUFFER_RESET,this.onBufferReset,this),t.off(C.BUFFER_CREATED,this.onBufferCreated,this),t.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(C.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(C.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(C.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(t,e){let{frag:i,id:r,initPTS:s,timescale:a}=e;if("main"===r){let t=i.cc;this.initPTS[i.cc]={baseTime:s,timescale:a},this.log("InitPTS for cc: ".concat(t," found from main: ").concat(s)),this.videoTrackCC=t,this.state===im.WAITING_INIT_PTS&&this.tick()}}startLoad(t){if(!this.levels){this.startPosition=t,this.state=im.STOPPED;return}let e=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),e>0&&-1===t?(this.log("Override startPosition with lastCurrentTime @".concat(e.toFixed(3))),t=e,this.state=im.IDLE):(this.loadedmetadata=!1,this.state=im.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}doTick(){var t,e;switch(this.state){case im.IDLE:this.doTickIdle();break;case im.WAITING_TRACK:{let{levels:e,trackId:i}=this,r=null==e?void 0:null==(t=e[i])?void 0:t.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=im.WAITING_INIT_PTS}break}case im.FRAG_LOADING_WAITING_RETRY:{let t=performance.now(),i=this.retryDate;if(!i||t>=i||null!=(e=this.media)&&e.seeking){let{levels:t,trackId:e}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==t?void 0:t[e])||null),this.state=im.IDLE}break}case im.WAITING_INIT_PTS:{let t=this.waitingData;if(t){let{frag:e,part:i,cache:r,complete:s}=t;if(void 0!==this.initPTS[e.cc]){this.waitingData=null,this.waitingVideoCC=-1,this.state=im.FRAG_LOADING;let t={frag:e,part:i,payload:r.flush(),networkDetails:null};this._handleFragmentLoadProgress(t),s&&super._handleFragmentLoadComplete(t)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log("Waiting fragment cc (".concat(e.cc,") cancelled because video is at cc ").concat(this.videoTrackCC)),this.clearWaitingFragment();else{let t=this.getLoadPosition(),i=e6.bufferInfo(this.mediaBuffer,t,this.config.maxBufferHole);0>eG(i.end,this.config.maxFragLookUpTolerance,e)&&(this.log("Waiting fragment cc (".concat(e.cc,") @ ").concat(e.start," cancelled because another fragment at ").concat(i.end," is needed")),this.clearWaitingFragment())}}else this.state=im.IDLE}}this.onTickEnd()}clearWaitingFragment(){let t=this.waitingData;t&&(this.fragmentTracker.removeFragment(t.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=im.IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){let{media:t}=this;null!=t&&t.readyState&&(this.lastCurrentTime=t.currentTime)}doTickIdle(){let{hls:t,levels:e,media:i,trackId:r}=this,s=t.config;if(!i&&(this.startFragRequested||!s.startFragPrefetch)||!(null!=e&&e[r]))return;let a=e[r],n=a.details;if(!n||n.live&&this.levelLastLoaded!==a||this.waitForCdnTuneIn(n)){this.state=im.WAITING_TRACK;return}let l=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&l&&(this.bufferFlushed=!1,this.afterBufferFlushed(l,H.AUDIO,es.AUDIO));let o=this.getFwdBufferInfo(l,es.AUDIO);if(null===o)return;let{bufferedTrack:h,switchingTrack:d}=this;if(!d&&this._streamEnded(o,n)){t.trigger(C.BUFFER_EOS,{type:"audio"}),this.state=im.ENDED;return}let c=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,es.MAIN),u=o.len,f=this.getMaxBufferLength(null==c?void 0:c.len),g=n.fragments,m=g[0].start,p=this.flushing?this.getLoadPosition():o.end;if(d&&i){let t=this.getLoadPosition();h&&!rc(d.attrs,h.attrs)&&(p=t),n.PTSKnown&&t<m&&(o.end>m||o.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=m+.05)}if(u>=f&&!d&&p<g[g.length-1].start)return;let E=this.getNextFragment(p,n),T=!1;if(E&&this.isLoopLoading(E,p)&&(T=!!E.gap,E=this.getNextFragmentLoopLoading(E,n,o,es.MAIN,f)),!E){this.bufferFlushed=!0;return}let y=c&&E.start>c.end+n.targetduration;if(y||!(null!=c&&c.len)&&o.len){let t=this.getAppendedFrag(E.start,es.MAIN);if(null===t||(T||(T=!!t.gap||!!y&&0===c.len),y&&!T||T&&o.nextStart&&o.nextStart<t.end))return}this.loadFragment(E,a,p)}getMaxBufferLength(t){let e=super.getMaxBufferLength();return t?Math.min(Math.max(e,t),this.config.maxMaxBufferLength):e}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(t,e){let{audioTracks:i}=e;this.resetTransmuxer(),this.levels=i.map(t=>new eR(t))}onAudioTrackSwitching(t,e){let i=!!e.url;this.trackId=e.id;let{fragCurrent:r}=this;r&&(r.abortRequests(),this.removeUnbufferedFrags(r.start)),this.resetLoadingState(),i?this.setInterval(100):this.resetTransmuxer(),i?(this.switchingTrack=e,this.state=im.IDLE,this.flushAudioIfNeeded(e)):(this.switchingTrack=null,this.bufferedTrack=e,this.state=im.STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(t,e){this.mainDetails=e.details,null!==this.cachedTrackLoadedData&&(this.hls.trigger(C.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(t,e){var i,r;if(null==this.mainDetails){this.cachedTrackLoadedData=e;return}let{levels:s}=this,{details:a,id:n}=e;if(!s){this.warn("Audio tracks were reset while loading level ".concat(n));return}this.log("Audio track ".concat(n," loaded [").concat(a.startSN,",").concat(a.endSN,"]").concat(a.lastPartSn?"[part-".concat(a.lastPartSn,"-").concat(a.lastPartIndex,"]"):"",",duration:").concat(a.totalduration));let l=s[n],o=0;if(a.live||null!=(i=l.details)&&i.live){this.checkLiveUpdate(a);let t=this.mainDetails;if(a.deltaUpdateFailed||!t)return;!l.details&&a.hasProgramDateTime&&t.hasProgramDateTime?(ir(a,t),o=a.fragments[0].start):o=this.alignPlaylists(a,l.details,null==(r=this.levelLastLoaded)?void 0:r.details)}l.details=a,this.levelLastLoaded=l,this.startFragRequested||!this.mainDetails&&a.live||this.setStartPosition(this.mainDetails||a,o),this.state!==im.WAITING_TRACK||this.waitForCdnTuneIn(a)||(this.state=im.IDLE),this.tick()}_handleFragmentLoadProgress(t){var e;let{frag:i,part:r,payload:s}=t,{config:a,trackId:n,levels:l}=this;if(!l){this.warn("Audio tracks were reset while fragment load was in progress. Fragment ".concat(i.sn," of level ").concat(i.level," will not be buffered"));return}let o=l[n];if(!o){this.warn("Audio track is undefined on fragment load progress");return}let h=o.details;if(!h){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}let d=a.defaultAudioCodec||o.audioCodec||"mp4a.40.2",c=this.transmuxer;c||(c=this.transmuxer=new rh(this.hls,es.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));let u=this.initPTS[i.cc],f=null==(e=i.initSegment)?void 0:e.data;if(void 0!==u){let t=r?r.index:-1,e=new e9(i.level,i.sn,i.stats.chunkCount,s.byteLength,t,-1!==t);c.push(s,f,d,"",i,r,h.totalduration,!1,e,u)}else{this.log("Unknown video PTS for cc ".concat(i.cc,", waiting for video PTS before demuxing audio frag ").concat(i.sn," of [").concat(h.startSN," ,").concat(h.endSN,"],track ").concat(n));let{cache:t}=this.waitingData=this.waitingData||{frag:i,part:r,cache:new iE,complete:!1};t.push(new Uint8Array(s)),this.waitingVideoCC=this.videoTrackCC,this.state=im.WAITING_INIT_PTS}}_handleFragmentLoadComplete(t){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(t)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(t,e){let i=e.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),e.tracks.video&&(this.videoBuffer=e.tracks.video.buffer||null)}onFragBuffered(t,e){let{frag:i,part:r}=e;if(i.type!==es.AUDIO){if(!this.loadedmetadata&&i.type===es.MAIN){let t=this.videoBuffer||this.media;t&&e6.getBuffered(t).length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(i)){this.warn("Fragment ".concat(i.sn).concat(r?" p: "+r.index:""," of level ").concat(i.level," finished buffering, but was aborted. state: ").concat(this.state,", audioSwitch: ").concat(this.switchingTrack?this.switchingTrack.name:"false"));return}if("initSegment"!==i.sn){this.fragPrevious=i;let t=this.switchingTrack;t&&(this.bufferedTrack=t,this.switchingTrack=null,this.hls.trigger(C.AUDIO_TRACK_SWITCHED,D({},t)))}this.fragBufferedComplete(i,r)}onError(t,e){var i;if(e.fatal){this.state=im.ERROR;return}switch(e.details){case P.FRAG_GAP:case P.FRAG_PARSING_ERROR:case P.FRAG_DECRYPT_ERROR:case P.FRAG_LOAD_ERROR:case P.FRAG_LOAD_TIMEOUT:case P.KEY_LOAD_ERROR:case P.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(es.AUDIO,e);break;case P.AUDIO_TRACK_LOAD_ERROR:case P.AUDIO_TRACK_LOAD_TIMEOUT:case P.LEVEL_PARSING_ERROR:e.levelRetry||this.state!==im.WAITING_TRACK||(null==(i=e.context)?void 0:i.type)!==er.AUDIO_TRACK||(this.state=im.IDLE);break;case P.BUFFER_APPEND_ERROR:case P.BUFFER_FULL_ERROR:if(!e.parent||"audio"!==e.parent)return;if(e.details===P.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(e)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case P.INTERNAL_EXCEPTION:this.recoverWorkerError(e)}}onBufferFlushing(t,e){let{type:i}=e;i!==H.VIDEO&&(this.flushing=!0)}onBufferFlushed(t,e){let{type:i}=e;if(i!==H.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===im.ENDED&&(this.state=im.IDLE);let t=this.mediaBuffer||this.media;t&&(this.afterBufferFlushed(t,i,es.AUDIO),this.tick())}}_handleTransmuxComplete(t){var e;let i="audio",{hls:r}=this,{remuxResult:s,chunkMeta:a}=t,n=this.getCurrentContext(a);if(!n){this.resetWhenMissingContext(a);return}let{frag:l,part:o,level:h}=n,{details:d}=h,{audio:c,text:u,id3:f,initSegment:g}=s;if(this.fragContextChanged(l)||!d){this.fragmentTracker.removeFragment(l);return}if(this.state=im.PARSING,this.switchingTrack&&c&&this.completeAudioSwitch(this.switchingTrack),null!=g&&g.tracks){let t=l.initSegment||l;this._bufferInitSegment(h,g.tracks,t,a),r.trigger(C.FRAG_PARSING_INIT_SEGMENT,{frag:t,id:i,tracks:g.tracks})}if(c){let{startPTS:t,endPTS:e,startDTS:i,endDTS:r}=c;o&&(o.elementaryStreams[H.AUDIO]={startPTS:t,endPTS:e,startDTS:i,endDTS:r}),l.setElementaryStreamInfo(H.AUDIO,t,e,i,r),this.bufferFragmentData(c,l,o,a)}if(null!=f&&null!=(e=f.samples)&&e.length){let t=I({id:i,frag:l,details:d},f);r.trigger(C.FRAG_PARSING_METADATA,t)}if(u){let t=I({id:i,frag:l,details:d},u);r.trigger(C.FRAG_PARSING_USERDATA,t)}}_bufferInitSegment(t,e,i,r){if(this.state!==im.PARSING)return;e.video&&delete e.video;let s=e.audio;if(!s)return;s.id="audio";let a=t.audioCodec;this.log("Init audio buffer, container:".concat(s.container,", codecs[level/parsed]=[").concat(a,"/").concat(s.codec,"]")),a&&1===a.split(",").length&&(s.levelCodec=a),this.hls.trigger(C.BUFFER_CODECS,e);let n=s.initSegment;if(null!=n&&n.byteLength){let t={type:"audio",frag:i,part:null,chunkMeta:r,parent:i.type,data:n};this.hls.trigger(C.BUFFER_APPENDING,t)}this.tickImmediate()}loadFragment(t,e,i){let r=this.fragmentTracker.getState(t);if(this.fragCurrent=t,this.switchingTrack||r===e2.NOT_LOADED||r===e2.PARTIAL){var s;if("initSegment"===t.sn)this._loadInitSegment(t,e);else if(null!=(s=e.details)&&s.live&&!this.initPTS[t.cc]){this.log("Waiting for video PTS in continuity counter ".concat(t.cc," of live stream before loading audio fragment ").concat(t.sn," of level ").concat(this.trackId)),this.state=im.WAITING_INIT_PTS;let i=this.mainDetails;i&&i.fragments[0].start!==e.details.fragments[0].start&&ir(e.details,i)}else this.startFragRequested=!0,super.loadFragment(t,e,i)}else this.clearTrackerIfNeeded(t)}flushAudioIfNeeded(t){let{media:e,bufferedTrack:i}=this,r=null==i?void 0:i.attrs,s=t.attrs;e&&r&&(r.CHANNELS!==s.CHANNELS||i.name!==t.name||i.lang!==t.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(t){let{hls:e}=this;this.flushAudioIfNeeded(t),this.bufferedTrack=t,this.switchingTrack=null,e.trigger(C.AUDIO_TRACK_SWITCHED,D({},t))}constructor(t,e,i){super(t,e,i,"[audio-stream-controller]",es.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}}class rg extends eY{registerListeners(){let{hls:t}=this;t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.MANIFEST_PARSED,this.onManifestParsed,this),t.on(C.LEVEL_LOADING,this.onLevelLoading,this),t.on(C.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(C.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.on(C.ERROR,this.onError,this)}unregisterListeners(){let{hls:t}=this;t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.MANIFEST_PARSED,this.onManifestParsed,this),t.off(C.LEVEL_LOADING,this.onLevelLoading,this),t.off(C.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(C.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),t.off(C.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.audioTracks||[]}onAudioTrackLoaded(t,e){let{id:i,groupId:r,details:s}=e,a=this.tracksInGroup[i];if(!a||a.groupId!==r){this.warn("Audio track with id:".concat(i," and group:").concat(r," not found in active group ").concat(null==a?void 0:a.groupId));return}let n=a.details;a.details=e.details,this.log("Audio track ".concat(i,' "').concat(a.name,'" lang:').concat(a.lang," group:").concat(r," loaded [").concat(s.startSN,"-").concat(s.endSN,"]")),i===this.trackId&&this.playlistLoaded(i,e,n)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){let e=this.hls.levels[t];if(!e)return;let i=e.audioGroups||null,r=this.groupIds,s=this.currentTrack;if(!i||(null==r?void 0:r.length)!==(null==i?void 0:i.length)||null!=i&&i.some(t=>(null==r?void 0:r.indexOf(t))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;let t=this.tracks.filter(t=>!i||-1!==i.indexOf(t.groupId));if(t.length)this.selectDefaultTrack&&!t.some(t=>t.default)&&(this.selectDefaultTrack=!1),t.forEach((t,e)=>{t.id=e});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=t;let e=this.hls.config.audioPreference;if(!s&&e){let i=eQ(e,t,e$);if(i>-1)s=t[i];else{let t=eQ(e,this.tracks);s=this.tracks[t]}}let r=this.findTrackId(s);-1===r&&s&&(r=this.findTrackId(null)),this.log("Updating audio tracks, ".concat(t.length," track(s) found in group(s): ").concat(null==i?void 0:i.join(","))),this.hls.trigger(C.AUDIO_TRACKS_UPDATED,{audioTracks:t});let n=this.trackId;if(-1!==r&&-1===n)this.setAudioTrack(r);else if(t.length&&-1===n){var a;let e=Error("No audio track selected for current audio group-ID(s): ".concat(null==(a=this.groupIds)?void 0:a.join(",")," track count: ").concat(t.length));this.warn(e.message),this.hls.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:e})}}else this.shouldReloadPlaylist(s)&&this.setAudioTrack(this.trackId)}onError(t,e){!e.fatal&&e.context&&(e.context.type!==er.AUDIO_TRACK||e.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(e.context.groupId)||(this.requestScheduled=-1,this.checkRetry(e)))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(t){this.selectDefaultTrack=!1,this.setAudioTrack(t)}setAudioOption(t){let e=this.hls;if(e.config.audioPreference=t,t){let i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){let r=this.currentTrack;if(r&&eJ(t,r,e$))return r;let s=eQ(t,this.tracksInGroup,e$);if(s>-1){let t=this.tracksInGroup[s];return this.setAudioTrack(s),t}if(r){let r=e.loadLevel;-1===r&&(r=e.firstAutoLevel);let s=function(t,e,i,r,s){let a=e[r],n=e.reduce((t,e,i)=>{let r=e.uri;return(t[r]||(t[r]=[])).push(i),t},{})[a.uri];n.length>1&&(r=Math.max.apply(Math,n));let l=a.videoRange,o=a.frameRate,h=a.codecSet.substring(0,4),d=eZ(e,r,e=>{if(e.videoRange!==l||e.frameRate!==o||e.codecSet.substring(0,4)!==h)return!1;let r=e.audioGroups;return eQ(t,i.filter(t=>!r||-1!==r.indexOf(t.groupId)),s)>-1});return d>-1?d:eZ(e,r,e=>{let r=e.audioGroups;return eQ(t,i.filter(t=>!r||-1!==r.indexOf(t.groupId)),s)>-1})}(t,e.levels,i,r,e$);if(-1===s)return null;e.nextLoadLevel=s}if(t.channels||t.audioCodec){let e=eQ(t,i);if(e>-1)return i[e]}}}return null}setAudioTrack(t){let e=this.tracksInGroup;if(t<0||t>=e.length){this.warn("Invalid audio track id: ".concat(t));return}this.clearTimer(),this.selectDefaultTrack=!1;let i=this.currentTrack,r=e[t],s=r.details&&!r.details.live;if(t===this.trackId&&r===i&&s||(this.log("Switching to audio-track ".concat(t,' "').concat(r.name,'" lang:').concat(r.lang," group:").concat(r.groupId," channels:").concat(r.channels)),this.trackId=t,this.currentTrack=r,this.hls.trigger(C.AUDIO_TRACK_SWITCHING,D({},r)),s))return;let a=this.switchParams(r.url,null==i?void 0:i.details);this.loadPlaylist(a)}findTrackId(t){let e=this.tracksInGroup;for(let i=0;i<e.length;i++){let r=e[i];if((!this.selectDefaultTrack||r.default)&&(!t||eJ(t,r,e$)))return i}if(t){let{name:i,lang:r,assocLang:s,characteristics:a,audioCodec:n,channels:l}=t;for(let t=0;t<e.length;t++)if(eJ({name:i,lang:r,assocLang:s,characteristics:a,audioCodec:n,channels:l},e[t],e$))return t;for(let i=0;i<e.length;i++){let r=e[i];if(rc(t.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<e.length;i++){let r=e[i];if(rc(t.attrs,r.attrs,["LANGUAGE"]))return i}}return -1}loadPlaylist(t){let e=this.currentTrack;if(this.shouldLoadPlaylist(e)&&e){super.loadPlaylist();let i=e.id,r=e.groupId,s=e.url;if(t)try{s=t.addDirectives(s)}catch(t){this.warn("Could not construct new URL with HLS Delivery Directives: ".concat(t))}this.log("loading audio-track playlist ".concat(i,' "').concat(e.name,'" lang:').concat(e.lang," group:").concat(r)),this.clearTimer(),this.hls.trigger(C.AUDIO_TRACK_LOADING,{url:s,id:i,groupId:r,deliveryDirectives:t||null})}}constructor(t){super(t,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}}class rm extends ip{onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){let{hls:t}=this;t.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.LEVEL_LOADED,this.onLevelLoaded,this),t.on(C.ERROR,this.onError,this),t.on(C.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(C.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.on(C.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(C.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(C.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:t}=this;t.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.LEVEL_LOADED,this.onLevelLoaded,this),t.off(C.ERROR,this.onError,this),t.off(C.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(C.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),t.off(C.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(C.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),t.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(C.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(t){this.stopLoad(),this.state=im.IDLE,this.setInterval(500),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(t,e){this.mainDetails=e.details}onSubtitleFragProcessed(t,e){let i;let{frag:r,success:s}=e;if(this.fragPrevious=r,this.state=im.IDLE,!s)return;let a=this.tracksBuffered[this.currentTrackId];if(!a)return;let n=r.start;for(let t=0;t<a.length;t++)if(n>=a[t].start&&n<=a[t].end){i=a[t];break}let l=r.start+r.duration;i?i.end=l:(i={start:n,end:l},a.push(i)),this.fragmentTracker.fragBuffered(r),this.fragBufferedComplete(r,null)}onBufferFlushing(t,e){let{startOffset:i,endOffset:r}=e;if(0===i&&r!==Number.POSITIVE_INFINITY){let t=r-1;if(t<=0)return;e.endOffsetSubtitles=Math.max(0,t),this.tracksBuffered.forEach(e=>{for(let i=0;i<e.length;){if(e[i].end<=t){e.shift();continue}if(e[i].start<t)e[i].start=t;else break;i++}}),this.fragmentTracker.removeFragmentsInRange(i,t,es.SUBTITLE)}}onFragBuffered(t,e){if(!this.loadedmetadata&&e.frag.type===es.MAIN){var i;null!=(i=this.media)&&i.buffered.length&&(this.loadedmetadata=!0)}}onError(t,e){let i=e.frag;(null==i?void 0:i.type)===es.SUBTITLE&&(this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==im.STOPPED&&(this.state=im.IDLE))}onSubtitleTracksUpdated(t,e){let{subtitleTracks:i}=e;if(this.levels&&rd(this.levels,i)){this.levels=i.map(t=>new eR(t));return}this.tracksBuffered=[],this.levels=i.map(t=>{let e=new eR(t);return this.tracksBuffered[e.id]=[],e}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,es.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(t,e){var i;if(this.currentTrackId=e.id,!(null!=(i=this.levels)&&i.length)||-1===this.currentTrackId){this.clearInterval();return}let r=this.levels[this.currentTrackId];null!=r&&r.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,r&&this.setInterval(500)}onSubtitleTrackLoaded(t,e){var i,r;let{currentTrackId:s,levels:a}=this,{details:n,id:l}=e;if(!a){this.warn("Subtitle tracks were reset while loading level ".concat(l));return}let o=a[s];if(l>=a.length||l!==s||!o)return;this.log("Subtitle track ".concat(l," loaded [").concat(n.startSN,",").concat(n.endSN,"]").concat(n.lastPartSn?"[part-".concat(n.lastPartSn,"-").concat(n.lastPartIndex,"]"):"",",duration:").concat(n.totalduration)),this.mediaBuffer=this.mediaBufferTimeRanges;let h=0;if(n.live||null!=(i=o.details)&&i.live){let t=this.mainDetails;if(n.deltaUpdateFailed||!t)return;let e=t.fragments[0];o.details?0===(h=this.alignPlaylists(n,o.details,null==(r=this.levelLastLoaded)?void 0:r.details))&&e&&e_(n,h=e.start):n.hasProgramDateTime&&t.hasProgramDateTime?(ir(n,t),h=n.fragments[0].start):e&&e_(n,h=e.start)}o.details=n,this.levelLastLoaded=o,this.startFragRequested||!this.mainDetails&&n.live||this.setStartPosition(this.mainDetails||n,h),this.tick(),n.live&&!this.fragCurrent&&this.media&&this.state===im.IDLE&&!eB(null,n.fragments,this.media.currentTime,0)&&(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0)}_handleFragmentLoadComplete(t){let{frag:e,payload:i}=t,r=e.decryptdata,s=this.hls;if(!this.fragContextChanged(e)&&i&&i.byteLength>0&&null!=r&&r.key&&r.iv&&"AES-128"===r.method){let t=performance.now();this.decrypter.decrypt(new Uint8Array(i),r.key.buffer,r.iv.buffer).catch(t=>{throw s.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.FRAG_DECRYPT_ERROR,fatal:!1,error:t,reason:t.message,frag:e}),t}).then(i=>{let r=performance.now();s.trigger(C.FRAG_DECRYPTED,{frag:e,payload:i,stats:{tstart:t,tdecrypt:r}})}).catch(t=>{this.warn("".concat(t.name,": ").concat(t.message)),this.state=im.IDLE})}}doTick(){if(!this.media){this.state=im.IDLE;return}if(this.state===im.IDLE){let{currentTrackId:t,levels:e}=this,i=null==e?void 0:e[t];if(!i||!e.length||!i.details)return;let{config:r}=this,s=this.getLoadPosition(),{end:a,len:n}=e6.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],s,r.maxBufferHole),l=this.getFwdBufferInfo(this.media,es.MAIN),o=i.details;if(n>this.getMaxBufferLength(null==l?void 0:l.len)+o.levelTargetDuration)return;let h=o.fragments,d=h.length,c=o.edge,u=null,f=this.fragPrevious;if(a<c){let t=r.maxFragLookUpTolerance;(u=eB(f,h,Math.max(h[0].start,a),a>c-t?0:t))||!f||!(f.start<h[0].start)||(u=h[0])}else u=h[d-1];if(!u)return;if("initSegment"!==(u=this.mapToInitFragWhenRequired(u)).sn){let t=h[u.sn-o.startSN-1];t&&t.cc===u.cc&&this.fragmentTracker.getState(t)===e2.NOT_LOADED&&(u=t)}this.fragmentTracker.getState(u)===e2.NOT_LOADED&&this.loadFragment(u,i,a)}}getMaxBufferLength(t){let e=super.getMaxBufferLength();return t?Math.max(e,t):e}loadFragment(t,e,i){this.fragCurrent=t,"initSegment"===t.sn?this._loadInitSegment(t,e):(this.startFragRequested=!0,super.loadFragment(t,e,i))}get mediaBufferTimeRanges(){return new rp(this.tracksBuffered[this.currentTrackId]||[])}constructor(t,e,i){super(t,e,i,"[subtitle-stream-controller]",es.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}}class rp{constructor(t){this.buffered=void 0;let e=(e,i,r)=>{if((i>>>=0)>r-1)throw new DOMException("Failed to execute '".concat(e,"' on 'TimeRanges': The index provided (").concat(i,") is greater than the maximum bound (").concat(r,")"));return t[i][e]};this.buffered={get length(){return t.length},end:i=>e("end",i,t.length),start:i=>e("start",i,t.length)}}}class rE extends eY{destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(t){this._subtitleDisplay=t,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){let{hls:t}=this;t.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.MANIFEST_PARSED,this.onManifestParsed,this),t.on(C.LEVEL_LOADING,this.onLevelLoading,this),t.on(C.LEVEL_SWITCHING,this.onLevelSwitching,this),t.on(C.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.on(C.ERROR,this.onError,this)}unregisterListeners(){let{hls:t}=this;t.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.MANIFEST_PARSED,this.onManifestParsed,this),t.off(C.LEVEL_LOADING,this.onLevelLoading,this),t.off(C.LEVEL_SWITCHING,this.onLevelSwitching,this),t.off(C.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),t.off(C.ERROR,this.onError,this)}onMediaAttached(t,e){this.media=e.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(t){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,t)}onMediaDetaching(){this.media&&(self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),eu(this.media.textTracks).forEach(t=>{ed(t)}),this.subtitleTrack=-1,this.media=null)}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(t,e){this.tracks=e.subtitleTracks}onSubtitleTrackLoaded(t,e){let{id:i,groupId:r,details:s}=e,a=this.tracksInGroup[i];if(!a||a.groupId!==r){this.warn("Subtitle track with id:".concat(i," and group:").concat(r," not found in active group ").concat(null==a?void 0:a.groupId));return}let n=a.details;a.details=e.details,this.log("Subtitle track ".concat(i,' "').concat(a.name,'" lang:').concat(a.lang," group:").concat(r," loaded [").concat(s.startSN,"-").concat(s.endSN,"]")),i===this.trackId&&this.playlistLoaded(i,e,n)}onLevelLoading(t,e){this.switchLevel(e.level)}onLevelSwitching(t,e){this.switchLevel(e.level)}switchLevel(t){let e=this.hls.levels[t];if(!e)return;let i=e.subtitleGroups||null,r=this.groupIds,s=this.currentTrack;if(!i||(null==r?void 0:r.length)!==(null==i?void 0:i.length)||null!=i&&i.some(t=>(null==r?void 0:r.indexOf(t))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;let t=this.tracks.filter(t=>!i||-1!==i.indexOf(t.groupId));if(t.length)this.selectDefaultTrack&&!t.some(t=>t.default)&&(this.selectDefaultTrack=!1),t.forEach((t,e)=>{t.id=e});else if(!s&&!this.tracksInGroup.length)return;this.tracksInGroup=t;let e=this.hls.config.subtitlePreference;if(!s&&e){this.selectDefaultTrack=!1;let i=eQ(e,t);if(i>-1)s=t[i];else{let t=eQ(e,this.tracks);s=this.tracks[t]}}let r=this.findTrackId(s);-1===r&&s&&(r=this.findTrackId(null)),this.log("Updating subtitle tracks, ".concat(t.length,' track(s) found in "').concat(null==i?void 0:i.join(","),'" group-id')),this.hls.trigger(C.SUBTITLE_TRACKS_UPDATED,{subtitleTracks:t}),-1!==r&&-1===this.trackId&&this.setSubtitleTrack(r)}else this.shouldReloadPlaylist(s)&&this.setSubtitleTrack(this.trackId)}findTrackId(t){let e=this.tracksInGroup,i=this.selectDefaultTrack;for(let r=0;r<e.length;r++){let s=e[r];if((!i||s.default)&&(i||t)&&(!t||eJ(s,t)))return r}if(t){for(let i=0;i<e.length;i++){let r=e[i];if(rc(t.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return i}for(let i=0;i<e.length;i++){let r=e[i];if(rc(t.attrs,r.attrs,["LANGUAGE"]))return i}}return -1}findTrackForTextTrack(t){if(t){let e=this.tracksInGroup;for(let i=0;i<e.length;i++)if(ru(e[i],t))return i}return -1}onError(t,e){!e.fatal&&e.context&&(e.context.type!==er.SUBTITLE_TRACK||e.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(e.context.groupId)||this.checkRetry(e))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(t){this.selectDefaultTrack=!1,this.setSubtitleTrack(t)}setSubtitleOption(t){if(this.hls.config.subtitlePreference=t,t){let e=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,e.length){let i=this.currentTrack;if(i&&eJ(t,i))return i;let r=eQ(t,this.tracksInGroup);if(r>-1){let t=this.tracksInGroup[r];return this.setSubtitleTrack(r),t}if(i);else{let i=eQ(t,e);if(i>-1)return e[i]}}}return null}loadPlaylist(t){super.loadPlaylist();let e=this.currentTrack;if(this.shouldLoadPlaylist(e)&&e){let i=e.id,r=e.groupId,s=e.url;if(t)try{s=t.addDirectives(s)}catch(t){this.warn("Could not construct new URL with HLS Delivery Directives: ".concat(t))}this.log("Loading subtitle playlist for id ".concat(i)),this.hls.trigger(C.SUBTITLE_TRACK_LOADING,{url:s,id:i,groupId:r,deliveryDirectives:t||null})}}toggleTrackModes(){let t;let{media:e}=this;if(!e)return;let i=eu(e.textTracks),r=this.currentTrack;if(!r||(t=i.filter(t=>ru(r,t))[0])||this.warn('Unable to find subtitle TextTrack with name "'.concat(r.name,'" and language "').concat(r.lang,'"')),[].slice.call(i).forEach(e=>{"disabled"!==e.mode&&e!==t&&(e.mode="disabled")}),t){let e=this.subtitleDisplay?"showing":"hidden";t.mode!==e&&(t.mode=e)}}setSubtitleTrack(t){let e=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=t;return}if(t<-1||t>=e.length||!b(t)){this.warn("Invalid subtitle track id: ".concat(t));return}this.clearTimer(),this.selectDefaultTrack=!1;let i=this.currentTrack,r=e[t]||null;if(this.trackId=t,this.currentTrack=r,this.toggleTrackModes(),!r){this.hls.trigger(C.SUBTITLE_TRACK_SWITCH,{id:t});return}let s=!!r.details&&!r.details.live;if(t===this.trackId&&r===i&&s)return;this.log("Switching to subtitle-track ".concat(t)+(r?' "'.concat(r.name,'" lang:').concat(r.lang," group:").concat(r.groupId):""));let{id:a,groupId:n="",name:l,type:o,url:h}=r;this.hls.trigger(C.SUBTITLE_TRACK_SWITCH,{id:a,groupId:n,name:l,type:o,url:h});let d=this.switchParams(r.url,null==i?void 0:i.details);this.loadPlaylist(d)}constructor(t){super(t,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null,e=eu(this.media.textTracks);for(let i=0;i<e.length;i++)if("hidden"===e[i].mode)t=e[i];else if("showing"===e[i].mode){t=e[i];break}let i=this.findTrackForTextTrack(t);this.subtitleTrack!==i&&this.setSubtitleTrack(i)},this.registerListeners()}}class rT{append(t,e,i){let r=this.queues[e];r.push(t),1!==r.length||i||this.executeNext(e)}insertAbort(t,e){this.queues[e].unshift(t),this.executeNext(e)}appendBlocker(t){let e;let i=new Promise(t=>{e=t}),r={execute:e,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(r,t),i}executeNext(t){let e=this.queues[t];if(e.length){let i=e[0];try{i.execute()}catch(r){M.warn('[buffer-operation-queue]: Exception executing "'.concat(t,'" SourceBuffer operation: ').concat(r)),i.onError(r);let e=this.buffers[t];null!=e&&e.updating||this.shiftAndExecuteNext(t)}}}shiftAndExecuteNext(t){this.queues[t].shift(),this.executeNext(t)}current(t){return this.queues[t][0]}constructor(t){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=t}}let ry=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class rv{hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){let{hls:t}=this;t.on(C.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.MANIFEST_PARSED,this.onManifestParsed,this),t.on(C.BUFFER_RESET,this.onBufferReset,this),t.on(C.BUFFER_APPENDING,this.onBufferAppending,this),t.on(C.BUFFER_CODECS,this.onBufferCodecs,this),t.on(C.BUFFER_EOS,this.onBufferEos,this),t.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this),t.on(C.LEVEL_UPDATED,this.onLevelUpdated,this),t.on(C.FRAG_PARSED,this.onFragParsed,this),t.on(C.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){let{hls:t}=this;t.off(C.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.MANIFEST_PARSED,this.onManifestParsed,this),t.off(C.BUFFER_RESET,this.onBufferReset,this),t.off(C.BUFFER_APPENDING,this.onBufferAppending,this),t.off(C.BUFFER_CODECS,this.onBufferCodecs,this),t.off(C.BUFFER_EOS,this.onBufferEos,this),t.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),t.off(C.LEVEL_UPDATED,this.onLevelUpdated,this),t.off(C.FRAG_PARSED,this.onFragParsed,this),t.off(C.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new rT(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(t,e){let i=2;(!e.audio||e.video)&&e.altAudio||(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log("".concat(this.bufferCodecEventsExpected," bufferCodec event(s) expected"))}onMediaAttaching(t,e){let i=this.media=e.media,r=tY(this.appendSource);if(i&&r){var s;let t=this.mediaSource=new r;this.log("created media source: ".concat(null==(s=t.constructor)?void 0:s.name)),t.addEventListener("sourceopen",this._onMediaSourceOpen),t.addEventListener("sourceended",this._onMediaSourceEnded),t.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.addEventListener("startstreaming",this._onStartStreaming),t.addEventListener("endstreaming",this._onEndStreaming));let e=this._objectUrl=self.URL.createObjectURL(t);if(this.appendSource)try{i.removeAttribute("src");let r=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||r&&t instanceof r,rS(i),function(t,e){let i=self.document.createElement("source");i.type="video/mp4",i.src=e,t.appendChild(i)}(i,e),i.load()}catch(t){i.src=e}else i.src=e;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){let{media:t,mediaSource:e,_objectUrl:i}=this;if(e){if(this.log("media source detaching"),"open"===e.readyState)try{e.endOfStream()}catch(t){this.warn("onMediaDetaching: ".concat(t.message," while calling endOfStream"))}this.onBufferReset(),e.removeEventListener("sourceopen",this._onMediaSourceOpen),e.removeEventListener("sourceended",this._onMediaSourceEnded),e.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.removeEventListener("startstreaming",this._onStartStreaming),e.removeEventListener("endstreaming",this._onEndStreaming)),t&&(t.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(t.removeAttribute("src"),this.appendSource&&rS(t),t.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(C.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(t=>{this.resetBuffer(t)}),this._initSourceBuffer()}resetBuffer(t){let e=this.sourceBuffer[t];try{if(e){var i;this.removeBufferListeners(t),this.sourceBuffer[t]=void 0,null!=(i=this.mediaSource)&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(e)}}catch(e){this.warn("onBufferReset ".concat(t),e)}}onBufferCodecs(t,e){let i=this.getSourceBufferTypes().length,r=Object.keys(e);if(r.forEach(t=>{if(i){let i=this.tracks[t];if(i&&"function"==typeof i.buffer.changeType){var r;let{id:s,codec:a,levelCodec:n,container:l,metadata:o}=e[t],h=t0(i.codec,i.levelCodec),d=null==h?void 0:h.replace(ry,"$1"),c=t0(a,n),u=null==(r=c)?void 0:r.replace(ry,"$1");if(c&&d!==u){"audio"===t.slice(0,5)&&(c=tZ(c,this.appendSource));let e="".concat(l,";codecs=").concat(c);this.appendChangeType(t,e),this.log("switching codec ".concat(h," to ").concat(c)),this.tracks[t]={buffer:i.buffer,codec:a,container:l,levelCodec:n,metadata:o,id:s}}}}else this.pendingTracks[t]=e[t]}),i)return;let s=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==s&&(this.log("".concat(s," bufferCodec event(s) expected ").concat(r.join(","))),this.bufferCodecEventsExpected=s),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(t,e){let{operationQueue:i}=this;i.append({execute:()=>{let r=this.sourceBuffer[t];r&&(this.log("changing ".concat(t," sourceBuffer type to ").concat(e)),r.changeType(e)),i.shiftAndExecuteNext(t)},onStart:()=>{},onComplete:()=>{},onError:e=>{this.warn("Failed to change ".concat(t," SourceBuffer type"),e)}},t,!!this.pendingTracks[t])}onBufferAppending(t,e){let{hls:i,operationQueue:r,tracks:s}=this,{data:a,type:n,frag:l,part:o,chunkMeta:h}=e,d=h.buffering[n],c=self.performance.now();d.start=c;let u=l.stats.buffering,f=o?o.stats.buffering:null;0===u.start&&(u.start=c),f&&0===f.start&&(f.start=c);let g=s.audio,m=!1;"audio"===n&&(null==g?void 0:g.container)==="audio/mpeg"&&(m=!this.lastMpegAudioChunk||1===h.id||this.lastMpegAudioChunk.sn!==h.sn,this.lastMpegAudioChunk=h);let p=l.start;r.append({execute:()=>{if(d.executeStart=self.performance.now(),m){let t=this.sourceBuffer[n];if(t){let e=p-t.timestampOffset;Math.abs(e)>=.1&&(this.log("Updating audio SourceBuffer timestampOffset to ".concat(p," (delta: ").concat(e,") sn: ").concat(l.sn,")")),t.timestampOffset=p)}}this.appendExecutor(a,n)},onStart:()=>{},onComplete:()=>{let t=self.performance.now();d.executeEnd=d.end=t,0===u.first&&(u.first=t),f&&0===f.first&&(f.first=t);let{sourceBuffer:e}=this,i={};for(let t in e)i[t]=e6.getBuffered(e[t]);this.appendErrors[n]=0,"audio"===n||"video"===n?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(C.BUFFER_APPENDED,{type:n,frag:l,part:o,chunkMeta:h,parent:l.type,timeRanges:i})},onError:t=>{let e={type:w.MEDIA_ERROR,parent:l.type,details:P.BUFFER_APPEND_ERROR,sourceBufferName:n,frag:l,part:o,chunkMeta:h,error:t,err:t,fatal:!1};if(t.code===DOMException.QUOTA_EXCEEDED_ERR)e.details=P.BUFFER_FULL_ERROR;else{let t=++this.appendErrors[n];e.details=P.BUFFER_APPEND_ERROR,this.warn("Failed ".concat(t,"/").concat(i.config.appendErrorMaxRetry,' times to append segment in "').concat(n,'" sourceBuffer')),t>=i.config.appendErrorMaxRetry&&(e.fatal=!0)}i.trigger(C.ERROR,e)}},n,!!this.pendingTracks[n])}onBufferFlushing(t,e){let{operationQueue:i}=this,r=t=>({execute:this.removeExecutor.bind(this,t,e.startOffset,e.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(C.BUFFER_FLUSHED,{type:t})},onError:e=>{this.warn("Failed to remove from ".concat(t," SourceBuffer"),e)}});e.type?i.append(r(e.type),e.type):this.getSourceBufferTypes().forEach(t=>{i.append(r(t),t)})}onFragParsed(t,e){let{frag:i,part:r}=e,s=[],a=r?r.elementaryStreams:i.elementaryStreams;a[H.AUDIOVIDEO]?s.push("audiovideo"):(a[H.AUDIO]&&s.push("audio"),a[H.VIDEO]&&s.push("video")),0===s.length&&this.warn("Fragments must have at least one ElementaryStreamType set. type: ".concat(i.type," level: ").concat(i.level," sn: ").concat(i.sn)),this.blockBuffers(()=>{let t=self.performance.now();i.stats.buffering.end=t,r&&(r.stats.buffering.end=t);let e=r?r.stats:i.stats;this.hls.trigger(C.FRAG_BUFFERED,{frag:i,part:r,stats:e,id:i.type})},s)}onFragChanged(t,e){this.trimBuffers()}onBufferEos(t,e){this.getSourceBufferTypes().reduce((t,i)=>{let r=this.sourceBuffer[i];return!r||e.type&&e.type!==i||(r.ending=!0,r.ended||(r.ended=!0,this.log("".concat(i," sourceBuffer now EOS")))),t&&!!(!r||r.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(t=>{let e=this.sourceBuffer[t];e&&(e.ending=!1)});let{mediaSource:t}=this;if(!t||"open"!==t.readyState){t&&this.log("Could not call mediaSource.endOfStream(). mediaSource.readyState: ".concat(t.readyState));return}this.log("Calling mediaSource.endOfStream()"),t.endOfStream()}))}onLevelUpdated(t,e){let{details:i}=e;i.fragments.length&&(this.details=i,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){let{hls:t,details:e,media:i}=this;if(!i||null===e||!this.getSourceBufferTypes().length)return;let r=t.config,s=i.currentTime,a=e.levelTargetDuration,n=e.live&&null!==r.liveBackBufferLength?r.liveBackBufferLength:r.backBufferLength;if(b(n)&&n>0){let t=Math.max(n,a);this.flushBackBuffer(s,a,Math.floor(s/a)*a-t)}if(b(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){let t=Math.max(Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),a);this.flushFrontBuffer(s,a,Math.floor(s/a)*a+t)}}flushBackBuffer(t,e,i){let{details:r,sourceBuffer:s}=this;this.getSourceBufferTypes().forEach(a=>{let n=s[a];if(n){let s=e6.getBuffered(n);if(s.length>0&&i>s.start(0)){if(this.hls.trigger(C.BACK_BUFFER_REACHED,{bufferEnd:i}),null!=r&&r.live)this.hls.trigger(C.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(n.ended&&s.end(s.length-1)-t<2*e){this.log("Cannot flush ".concat(a," back buffer while SourceBuffer is in ended state"));return}this.hls.trigger(C.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:a})}}})}flushFrontBuffer(t,e,i){let{sourceBuffer:r}=this;this.getSourceBufferTypes().forEach(s=>{let a=r[s];if(a){let r=e6.getBuffered(a),n=r.length;if(n<2)return;let l=r.start(n-1),o=r.end(n-1);if(i>l||t>=l&&t<=o)return;if(a.ended&&t-o<2*e){this.log("Cannot flush ".concat(s," front buffer while SourceBuffer is in ended state"));return}this.hls.trigger(C.BUFFER_FLUSHING,{startOffset:l,endOffset:1/0,type:s})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;let{details:t,hls:e,media:i,mediaSource:r}=this,s=t.fragments[0].start+t.totalduration,a=i.duration,n=b(r.duration)?r.duration:0;t.live&&e.config.liveDurationInfinity?(r.duration=1/0,this.updateSeekableRange(t)):(s>n&&s>a||!b(a))&&(this.log("Updating Media Source duration to ".concat(s.toFixed(3))),r.duration=s)}updateSeekableRange(t){let e=this.mediaSource,i=t.fragments;if(i.length&&t.live&&null!=e&&e.setLiveSeekableRange){let r=Math.max(0,i[0].start),s=Math.max(r,r+t.totalduration);this.log("Media Source duration is set to ".concat(e.duration,". Setting seekable range to ").concat(r,"-").concat(s,".")),e.setLiveSeekableRange(r,s)}}checkPendingTracks(){let{bufferCodecEventsExpected:t,operationQueue:e,pendingTracks:i}=this,r=Object.keys(i).length;if(r&&(!t||2===r||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};let t=this.getSourceBufferTypes();if(t.length)this.hls.trigger(C.BUFFER_CREATED,{tracks:this.tracks}),t.forEach(t=>{e.executeNext(t)});else{let t=Error("could not create source buffer for media codec(s)");this.hls.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:t,reason:t.message})}}}createSourceBuffers(t){let{sourceBuffer:e,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(let r in t)if(!e[r]){let s=t[r];if(!s)throw Error("source buffer exists for track ".concat(r,", however track does not"));let a=s.levelCodec||s.codec;a&&"audio"===r.slice(0,5)&&(a=tZ(a,this.appendSource));let n="".concat(s.container,";codecs=").concat(a);this.log("creating sourceBuffer(".concat(n,")"));try{let t=e[r]=i.addSourceBuffer(n);this.addBufferListener(r,"updatestart",this._onSBUpdateStart),this.addBufferListener(r,"updateend",this._onSBUpdateEnd),this.addBufferListener(r,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(r,"bufferedchange",(t,e)=>{let i=e.removedRanges;null!=i&&i.length&&this.hls.trigger(C.BUFFER_FLUSHED,{type:r})}),this.tracks[r]={buffer:t,codec:a,container:s.container,levelCodec:s.levelCodec,metadata:s.metadata,id:s.id}}catch(t){this.error("error while trying to add sourceBuffer: ".concat(t.message)),this.hls.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:t,sourceBufferName:r,mimeType:n})}}}get mediaSrc(){var t;let e=(null==(t=this.media)?void 0:t.firstChild)||this.media;return null==e?void 0:e.src}_onSBUpdateStart(t){let{operationQueue:e}=this;e.current(t).onStart()}_onSBUpdateEnd(t){var e;if((null==(e=this.mediaSource)?void 0:e.readyState)==="closed"){this.resetBuffer(t);return}let{operationQueue:i}=this;i.current(t).onComplete(),i.shiftAndExecuteNext(t)}_onSBUpdateError(t,e){var i;let r=Error("".concat(t," SourceBuffer error. MediaSource readyState: ").concat(null==(i=this.mediaSource)?void 0:i.readyState));this.error("".concat(r),e),this.hls.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.BUFFER_APPENDING_ERROR,sourceBufferName:t,error:r,fatal:!1});let s=this.operationQueue.current(t);s&&s.onError(r)}removeExecutor(t,e,i){let{media:r,mediaSource:s,operationQueue:a,sourceBuffer:n}=this,l=n[t];if(!r||!s||!l){this.warn("Attempting to remove from the ".concat(t," SourceBuffer, but it does not exist")),a.shiftAndExecuteNext(t);return}let o=b(r.duration)?r.duration:1/0,h=b(s.duration)?s.duration:1/0,d=Math.max(0,e),c=Math.min(i,o,h);c>d&&(!l.ending||l.ended)?(l.ended=!1,this.log("Removing [".concat(d,",").concat(c,"] from the ").concat(t," SourceBuffer")),l.remove(d,c)):a.shiftAndExecuteNext(t)}appendExecutor(t,e){let i=this.sourceBuffer[e];if(!i){if(!this.pendingTracks[e])throw Error("Attempting to append to the ".concat(e," SourceBuffer, but it does not exist"));return}i.ended=!1,i.appendBuffer(t)}blockBuffers(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.getSourceBufferTypes();if(!e.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(t);return}let{operationQueue:i}=this;Promise.all(e.map(t=>i.appendBlocker(t))).then(()=>{t(),e.forEach(t=>{let e=this.sourceBuffer[t];null!=e&&e.updating||i.shiftAndExecuteNext(t)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(t,e,i){let r=this.sourceBuffer[t];if(!r)return;let s=i.bind(this,t);this.listeners[t].push({event:e,listener:s}),r.addEventListener(e,s)}removeBufferListeners(t){let e=this.sourceBuffer[t];e&&this.listeners[t].forEach(t=>{e.removeEventListener(t.event,t.listener)})}constructor(t){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=t=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=t=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{let{media:t,mediaSource:e}=this;this.log("Media source opened"),t&&(t.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(C.MEDIA_ATTACHED,{media:t,mediaSource:e})),e&&e.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{let{mediaSrc:t,_objectUrl:e}=this;t!==e&&M.error("Media element src was set while attaching MediaSource (".concat(e," > ").concat(t,")"))},this.hls=t;let e="[buffer-controller]";this.appendSource=t.config.preferManagedMediaSource&&"undefined"!=typeof self&&self.ManagedMediaSource,this.log=M.log.bind(M,e),this.warn=M.warn.bind(M,e),this.error=M.error.bind(M,e),this._initSourceBuffer(),this.registerListeners()}}function rS(t){let e=t.querySelectorAll("source");[].slice.call(e).forEach(e=>{t.removeChild(e)})}let rA={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},rL=function(t){let e=t;return rA.hasOwnProperty(t)&&(e=rA[t]),String.fromCharCode(e)},rR={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},rD={17:2,18:4,21:6,22:8,23:10,19:13,20:15},rI={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},rb={25:2,26:4,29:6,30:8,31:10,27:13,28:15},rk=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class r_{log(t,e){if(this.verboseLevel>=t){let i="function"==typeof e?e():e;M.log("".concat(this.time," [").concat(t,"] ").concat(i))}}constructor(){this.time=null,this.verboseLevel=0}}let rC=function(t){let e=[];for(let i=0;i<t.length;i++)e.push(t[i].toString(16));return e};class rw{reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(t){let e=["foreground","underline","italics","background","flash"];for(let i=0;i<e.length;i++){let r=e[i];t.hasOwnProperty(r)&&(this[r]=t[r])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(t){return this.foreground===t.foreground&&this.underline===t.underline&&this.italics===t.italics&&this.background===t.background&&this.flash===t.flash}copy(t){this.foreground=t.foreground,this.underline=t.underline,this.italics=t.italics,this.background=t.background,this.flash=t.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}}class rP{reset(){this.uchar=" ",this.penState.reset()}setChar(t,e){this.uchar=t,this.penState.copy(e)}setPenState(t){this.penState.copy(t)}equals(t){return this.uchar===t.uchar&&this.penState.equals(t.penState)}copy(t){this.uchar=t.uchar,this.penState.copy(t.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}constructor(){this.uchar=" ",this.penState=new rw}}class rx{equals(t){for(let e=0;e<100;e++)if(!this.chars[e].equals(t.chars[e]))return!1;return!0}copy(t){for(let e=0;e<100;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<100;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(t){this.pos!==t&&(this.pos=t),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>100&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=100)}moveCursor(t){let e=this.pos+t;if(t>1)for(let t=this.pos+1;t<e+1;t++)this.chars[t].setPenState(this.currPenState);this.setCursor(e)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(t){t>=144&&this.backSpace();let e=rL(t);if(this.pos>=100){this.logger.log(0,()=>"Cannot insert "+t.toString(16)+" ("+e+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(e,this.currPenState),this.moveCursor(1)}clearFromPos(t){let e;for(e=t;e<100;e++)this.chars[e].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){let t=[],e=!0;for(let i=0;i<100;i++){let r=this.chars[i].uchar;" "!==r&&(e=!1),t.push(r)}return e?"":t.join("")}setPenStyles(t){this.currPenState.setStyles(t),this.chars[this.pos].setPenState(this.currPenState)}constructor(t){this.chars=[],this.pos=0,this.currPenState=new rw,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<100;t++)this.chars.push(new rP);this.logger=t}}class rO{reset(){for(let t=0;t<15;t++)this.rows[t].clear();this.currRow=14}equals(t){let e=!0;for(let i=0;i<15;i++)if(!this.rows[i].equals(t.rows[i])){e=!1;break}return e}copy(t){for(let e=0;e<15;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<15;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(t){this.rows[this.currRow].insertChar(t)}setPen(t){this.rows[this.currRow].setPenStyles(t)}moveCursor(t){this.rows[this.currRow].moveCursor(t)}setCursor(t){this.logger.log(2,"setCursor: "+t),this.rows[this.currRow].setCursor(t)}setPAC(t){this.logger.log(2,()=>"pacData = "+JSON.stringify(t));let e=t.row-1;if(this.nrRollUpRows&&e<this.nrRollUpRows-1&&(e=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==e){for(let t=0;t<15;t++)this.rows[t].clear();let t=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){let r=i.rows[t].cueStartTime,s=this.logger.time;if(null!==r&&null!==s&&r<s)for(let r=0;r<this.nrRollUpRows;r++)this.rows[e-this.nrRollUpRows+r+1].copy(i.rows[t+r])}}this.currRow=e;let i=this.rows[this.currRow];if(null!==t.indent){let e=Math.max(t.indent-1,0);i.setCursor(t.indent),t.color=i.chars[e].penState.foreground}let r={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(r)}setBkgData(t){this.logger.log(2,()=>"bkgData = "+JSON.stringify(t)),this.backSpace(),this.setPen(t),this.insertChar(32)}setRollUpRows(t){this.nrRollUpRows=t}rollUp(){if(null===this.nrRollUpRows){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());let t=this.currRow+1-this.nrRollUpRows,e=this.rows.splice(t,1)[0];e.clear(),this.rows.splice(this.currRow,0,e),this.logger.log(2,"Rolling up")}getDisplayText(t){t=t||!1;let e=[],i="",r=-1;for(let i=0;i<15;i++){let s=this.rows[i].getTextString();s&&(r=i+1,t?e.push("Row "+r+": '"+s+"'"):e.push(s.trim()))}return e.length>0&&(i=t?"["+e.join(" | ")+"]":e.join("\n")),i}getTextAndFormat(){return this.rows}constructor(t){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let e=0;e<15;e++)this.rows.push(new rx(t));this.logger=t}}class rF{reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(t){this.outputFilter=t}setPAC(t){this.writeScreen.setPAC(t)}setBkgData(t){this.writeScreen.setBkgData(t)}setMode(t){t!==this.mode&&(this.mode=t,this.logger.log(2,()=>"MODE="+t),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=t)}insertChars(t){for(let e=0;e<t.length;e++)this.writeScreen.insertChar(t[e]);let e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>e+": "+this.writeScreen.getDisplayText(!0)),("MODE_PAINT-ON"===this.mode||"MODE_ROLL-UP"===this.mode)&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(t){this.logger.log(2,"RU("+t+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(t)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){let t=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=t,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(t){this.logger.log(2,"TO("+t+") - Tab Offset"),this.writeScreen.moveCursor(t)}ccMIDROW(t){let e={flash:!1};if(e.underline=t%2==1,e.italics=t>=46,e.italics)e.foreground="white";else{let i=Math.floor(t/2)-16;e.foreground=["white","green","blue","cyan","red","yellow","magenta"][i]}this.logger.log(2,"MIDROW: "+JSON.stringify(e)),this.writeScreen.setPen(e)}outputDataUpdate(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=this.logger.time;null!==e&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,e,this.lastOutputScreen),t&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:e):this.cueStartTime=e,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(t){this.outputFilter&&!this.displayedMemory.isEmpty()&&(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,t,this.displayedMemory),this.cueStartTime=t)}constructor(t,e,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=t,this.outputFilter=e,this.mode=null,this.verbose=0,this.displayedMemory=new rO(i),this.nonDisplayedMemory=new rO(i),this.lastOutputScreen=new rO(i),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}}class rM{getHandler(t){return this.channels[t].getHandler()}setHandler(t,e){this.channels[t].setHandler(e)}addData(t,e){let i,r,s;let a=!1;this.logger.time=t;for(let t=0;t<e.length;t+=2)if(r=127&e[t],s=127&e[t+1],0!==r||0!==s){if(this.logger.log(3,"["+rC([e[t],e[t+1]])+"] -> ("+rC([r,s])+")"),(i=this.parseCmd(r,s))||(i=this.parseMidrow(r,s)),i||(i=this.parsePAC(r,s)),i||(i=this.parseBackgroundAttributes(r,s)),!i&&(a=this.parseChars(r,s))){let t=this.currentChannel;t&&t>0?this.channels[t].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}i||a||this.logger.log(2,"Couldn't parse cleaned data "+rC([r,s])+" orig: "+rC([e[t],e[t+1]]))}}parseCmd(t,e){let{cmdHistory:i}=this,r=(20===t||28===t||21===t||29===t)&&e>=32&&e<=47,s=(23===t||31===t)&&e>=33&&e<=35;if(!(r||s))return!1;if(rU(t,e,i))return rN(null,null,i),this.logger.log(3,"Repeated command ("+rC([t,e])+") is dropped"),!0;let a=20===t||21===t||23===t?1:2,n=this.channels[a];return 20===t||21===t||28===t||29===t?32===e?n.ccRCL():33===e?n.ccBS():34===e?n.ccAOF():35===e?n.ccAON():36===e?n.ccDER():37===e?n.ccRU(2):38===e?n.ccRU(3):39===e?n.ccRU(4):40===e?n.ccFON():41===e?n.ccRDC():42===e?n.ccTR():43===e?n.ccRTD():44===e?n.ccEDM():45===e?n.ccCR():46===e?n.ccENM():47===e&&n.ccEOC():n.ccTO(e-32),rN(t,e,i),this.currentChannel=a,!0}parseMidrow(t,e){let i=0;if((17===t||25===t)&&e>=32&&e<=47){if((i=17===t?1:2)!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;let r=this.channels[i];return!!r&&(r.ccMIDROW(e),this.logger.log(3,"MIDROW ("+rC([t,e])+")"),!0)}return!1}parsePAC(t,e){let i;let r=this.cmdHistory,s=(t>=17&&t<=23||t>=25&&t<=31)&&e>=64&&e<=127,a=(16===t||24===t)&&e>=64&&e<=95;if(!(s||a))return!1;if(rU(t,e,r))return rN(null,null,r),!0;let n=t<=23?1:2;i=e>=64&&e<=95?1===n?rR[t]:rI[t]:1===n?rD[t]:rb[t];let l=this.channels[n];return!!l&&(l.setPAC(this.interpretPAC(i,e)),rN(t,e,r),this.currentChannel=n,!0)}interpretPAC(t,e){let i;let r={color:null,italics:!1,indent:null,underline:!1,row:t};return i=e>95?e-96:e-64,r.underline=(1&i)==1,i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((i-16)/2),r}parseChars(t,e){let i;let r=null,s=null;if(t>=25?(i=2,s=t-8):(i=1,s=t),s>=17&&s<=19){let t;t=17===s?e+80:18===s?e+112:e+144,this.logger.log(2,"Special char '"+rL(t)+"' in channel "+i),r=[t]}else t>=32&&t<=127&&(r=0===e?[t]:[t,e]);if(r){let i=rC(r);this.logger.log(3,"Char codes =  "+i.join(",")),rN(t,e,this.cmdHistory)}return r}parseBackgroundAttributes(t,e){let i;let r=(16===t||24===t)&&e>=32&&e<=47,s=(23===t||31===t)&&e>=45&&e<=47;if(!(r||s))return!1;let a={};16===t||24===t?(i=Math.floor((e-32)/2),a.background=rk[i],e%2==1&&(a.background=a.background+"_semi")):45===e?a.background="transparent":(a.foreground="black",47===e&&(a.underline=!0));let n=t<=23?1:2;return this.channels[n].setBkgData(a),rN(t,e,this.cmdHistory),!0}reset(){for(let t=0;t<Object.keys(this.channels).length;t++){let e=this.channels[t];e&&e.reset()}this.cmdHistory=rB()}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++){let i=this.channels[e];i&&i.cueSplitAtTime(t)}}constructor(t,e,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=rB(),this.logger=void 0;let r=this.logger=new r_;this.channels=[null,new rF(t,e,r),new rF(t+1,i,r)]}}function rN(t,e,i){i.a=t,i.b=e}function rU(t,e,i){return i.a===t&&i.b===e}function rB(){return{a:null,b:null}}class rG{dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(t,e,i){(null===this.startTime||this.startTime>t)&&(this.startTime=t),this.endTime=e,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}constructor(t,e){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=t,this.trackName=e}}var rK=function(){if(null!=z&&z.VTTCue)return self.VTTCue;let t=["","lr","rl"],e=["start","middle","end","left","right"];function i(t,e){if("string"!=typeof e||!Array.isArray(t))return!1;let i=e.toLowerCase();return!!~t.indexOf(i)&&i}function r(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];let s=1;for(;s<arguments.length;s++){let e=arguments[s];for(let i in e)t[i]=e[i]}return t}function s(s,a,n){let l={enumerable:!0};this.hasBeenReset=!1;let o="",h=!1,d=s,c=a,u=n,f=null,g="",m=!0,p="auto",E="start",T=50,y="middle",v=50,S="middle";Object.defineProperty(this,"id",r({},l,{get:function(){return o},set:function(t){o=""+t}})),Object.defineProperty(this,"pauseOnExit",r({},l,{get:function(){return h},set:function(t){h=!!t}})),Object.defineProperty(this,"startTime",r({},l,{get:function(){return d},set:function(t){if("number"!=typeof t)throw TypeError("Start time must be set to a number.");d=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"endTime",r({},l,{get:function(){return c},set:function(t){if("number"!=typeof t)throw TypeError("End time must be set to a number.");c=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"text",r({},l,{get:function(){return u},set:function(t){u=""+t,this.hasBeenReset=!0}})),Object.defineProperty(this,"region",r({},l,{get:function(){return f},set:function(t){f=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"vertical",r({},l,{get:function(){return g},set:function(e){let r=i(t,e);if(!1===r)throw SyntaxError("An invalid or illegal string was specified.");g=r,this.hasBeenReset=!0}})),Object.defineProperty(this,"snapToLines",r({},l,{get:function(){return m},set:function(t){m=!!t,this.hasBeenReset=!0}})),Object.defineProperty(this,"line",r({},l,{get:function(){return p},set:function(t){if("number"!=typeof t&&"auto"!==t)throw SyntaxError("An invalid number or illegal string was specified.");p=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"lineAlign",r({},l,{get:function(){return E},set:function(t){let r=i(e,t);if(!r)throw SyntaxError("An invalid or illegal string was specified.");E=r,this.hasBeenReset=!0}})),Object.defineProperty(this,"position",r({},l,{get:function(){return T},set:function(t){if(t<0||t>100)throw Error("Position must be between 0 and 100.");T=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"positionAlign",r({},l,{get:function(){return y},set:function(t){let r=i(e,t);if(!r)throw SyntaxError("An invalid or illegal string was specified.");y=r,this.hasBeenReset=!0}})),Object.defineProperty(this,"size",r({},l,{get:function(){return v},set:function(t){if(t<0||t>100)throw Error("Size must be between 0 and 100.");v=t,this.hasBeenReset=!0}})),Object.defineProperty(this,"align",r({},l,{get:function(){return S},set:function(t){let r=i(e,t);if(!r)throw SyntaxError("An invalid or illegal string was specified.");S=r,this.hasBeenReset=!0}})),this.displayState=void 0}return s.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},s}();class rH{decode(t,e){if(!t)return"";if("string"!=typeof t)throw Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(t))}}function rV(t){function e(t,e,i,r){return(0|t)*3600+(0|e)*60+(0|i)+parseFloat(r||0)}let i=t.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return i?parseFloat(i[2])>59?e(i[2],i[3],0,i[4]):e(i[1],i[2],i[3],i[4]):null}class rY{set(t,e){this.get(t)||""===e||(this.values[t]=e)}get(t,e,i){return i?this.has(t)?this.values[t]:e[i]:this.has(t)?this.values[t]:e}has(t){return t in this.values}alt(t,e,i){for(let r=0;r<i.length;++r)if(e===i[r]){this.set(t,e);break}}integer(t,e){/^-?\d+$/.test(e)&&this.set(t,parseInt(e,10))}percent(t,e){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(e)){let i=parseFloat(e);if(i>=0&&i<=100)return this.set(t,i),!0}return!1}constructor(){this.values=Object.create(null)}}function rW(t,e,i,r){let s=r?t.split(r):[t];for(let t in s){if("string"!=typeof s[t])continue;let r=s[t].split(i);2===r.length&&e(r[0],r[1])}}let rj=new rK(0,0,""),rq="middle"===rj.align?"middle":"center";function rX(t){return t.replace(/<br(?: \/)?>/gi,"\n")}class rz{parse(t){let e=this;function i(){let t=e.buffer,i=0;for(t=rX(t);i<t.length&&"\r"!==t[i]&&"\n"!==t[i];)++i;let r=t.slice(0,i);return"\r"===t[i]&&++i,"\n"===t[i]&&++i,e.buffer=t.slice(i),r}t&&(e.buffer+=e.decoder.decode(t,{stream:!0}));try{let t="";if("INITIAL"===e.state){if(!/\r\n|\n/.test(e.buffer))return this;let r=(t=i()).match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(null!=r&&r[0]))throw Error("Malformed WebVTT signature.");e.state="HEADER"}let s=!1;for(;e.buffer&&/\r\n|\n/.test(e.buffer);)switch(s?s=!1:t=i(),e.state){case"HEADER":if(/:/.test(t)){var r;r=t,rW(r,function(t,e){},/:/)}else t||(e.state="ID");continue;case"NOTE":t||(e.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(t)){e.state="NOTE";break}if(!t)continue;if(e.cue=new rK(0,0,""),e.state="CUE",-1===t.indexOf("-->")){e.cue.id=t;continue}case"CUE":if(!e.cue){e.state="BADCUE";continue}try{!function(t,e,i){let r=t;function s(){let e=rV(t);if(null===e)throw Error("Malformed timestamp: "+r);return t=t.replace(/^[^\sa-zA-Z-]+/,""),e}function a(){t=t.replace(/^\s+/,"")}if(a(),e.startTime=s(),a(),"-->"!==t.slice(0,3))throw Error("Malformed time stamp (time stamps must be separated by '-->'): "+r);t=t.slice(3),a(),e.endTime=s(),a(),function(t,e){let r=new rY;rW(t,function(t,e){let s;switch(t){case"region":for(let s=i.length-1;s>=0;s--)if(i[s].id===e){r.set(t,i[s].region);break}break;case"vertical":r.alt(t,e,["rl","lr"]);break;case"line":s=e.split(","),r.integer(t,s[0]),r.percent(t,s[0])&&r.set("snapToLines",!1),r.alt(t,s[0],["auto"]),2===s.length&&r.alt("lineAlign",s[1],["start",rq,"end"]);break;case"position":s=e.split(","),r.percent(t,s[0]),2===s.length&&r.alt("positionAlign",s[1],["start",rq,"end","line-left","line-right","auto"]);break;case"size":r.percent(t,e);break;case"align":r.alt(t,e,["start",rq,"end","left","right"])}},/:/,/\s/),e.region=r.get("region",null),e.vertical=r.get("vertical","");let s=r.get("line","auto");"auto"===s&&-1===rj.line&&(s=-1),e.line=s,e.lineAlign=r.get("lineAlign","start"),e.snapToLines=r.get("snapToLines",!0),e.size=r.get("size",100),e.align=r.get("align",rq);let a=r.get("position","auto");"auto"===a&&50===rj.position&&(a="start"===e.align||"left"===e.align?0:"end"===e.align||"right"===e.align?100:50),e.position=a}(t,e)}(t,e.cue,e.regionList)}catch(t){e.cue=null,e.state="BADCUE";continue}e.state="CUETEXT";continue;case"CUETEXT":{let i=-1!==t.indexOf("-->");if(!t||i&&(s=!0)){e.oncue&&e.cue&&e.oncue(e.cue),e.cue=null,e.state="ID";continue}if(null===e.cue)continue;e.cue.text&&(e.cue.text+="\n"),e.cue.text+=t}continue;case"BADCUE":t||(e.state="ID")}}catch(t){"CUETEXT"===e.state&&e.cue&&e.oncue&&e.oncue(e.cue),e.cue=null,e.state="INITIAL"===e.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if((this.cue||"HEADER"===this.state)&&(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state||"BADWEBVTT"===this.state)throw Error("Malformed WebVTT signature.")}catch(t){this.onparsingerror&&this.onparsingerror(t)}return this.onflush&&this.onflush(),this}constructor(){this.state="INITIAL",this.buffer="",this.decoder=new rH,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}}let rQ=/\r\n|\n\r|\n|\r/g,rJ=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return t.slice(i,i+e.length)===e},r$=function(t){let e=parseInt(t.slice(-3)),i=parseInt(t.slice(-6,-4)),r=parseInt(t.slice(-9,-7)),s=t.length>9?parseInt(t.substring(0,t.indexOf(":"))):0;if(!b(e)||!b(i)||!b(r)||!b(s))throw Error("Malformed X-TIMESTAMP-MAP: Local:".concat(t));return e+(1e3*i+6e4*r+36e5*s)},rZ=function(t){let e=5381,i=t.length;for(;i;)e=33*e^t.charCodeAt(--i);return(e>>>0).toString()};function r0(t,e,i){return rZ(t.toString())+rZ(e.toString())+rZ(i)}let r1=function(t,e,i){let r=t[e],s=t[r.prevCC];if(!s||!s.new&&r.new){t.ccOffset=t.presentationOffset=r.start,r.new=!1;return}for(;null!=(a=s)&&a.new;){var a;t.ccOffset+=r.start-s.start,r.new=!1,s=t[(r=s).prevCC]}t.presentationOffset=i},r2="stpp.ttml.im1t",r4=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,r3=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,r5={left:"start",center:"center",right:"end",start:"start",end:"end"};function r8(t,e,i,r){let s=tk(new Uint8Array(t),["mdat"]);if(0===s.length){r(Error("Could not parse IMSC1 mdat"));return}let a=s.map(t=>tT(t)),n=function(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return i0(t,1,1/i,r)}(e.baseTime,1,e.timescale);try{a.forEach(t=>i(function(t,e){let i=new DOMParser().parseFromString(t,"text/xml").getElementsByTagName("tt")[0];if(!i)throw Error("Invalid ttml");let r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},s=Object.keys(r).reduce((t,e)=>(t[e]=i.getAttribute("ttp:".concat(e))||r[e],t),{}),a="preserve"!==i.getAttribute("xml:space"),n=r9(r6(i,"styling","style")),l=r9(r6(i,"layout","region")),o=r6(i,"body","[begin]");return[].map.call(o,t=>{let i=function t(e,i){return[].slice.call(e.childNodes).reduce((e,r,s)=>{var a;return"br"===r.nodeName&&s?e+"\n":null!=(a=r.childNodes)&&a.length?t(r,i):i?e+r.textContent.trim().replace(/\s+/g," "):e+r.textContent},"")}(t,a);if(!i||!t.hasAttribute("begin"))return null;let r=se(t.getAttribute("begin"),s),o=se(t.getAttribute("dur"),s),h=se(t.getAttribute("end"),s);if(null===r)throw st(t);if(null===h){if(null===o)throw st(t);h=r+o}let d=new rK(r-e,h-e,i);d.id=r0(d.startTime,d.endTime,d.text);let c=l[t.getAttribute("region")],u=function(t,e,i){let r="http://www.w3.org/ns/ttml#styling",s=null,a=null!=t&&t.hasAttribute("style")?t.getAttribute("style"):null;return a&&i.hasOwnProperty(a)&&(s=i[a]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce((i,a)=>{let n=r7(e,r,a)||r7(t,r,a)||r7(s,r,a);return n&&(i[a]=n),i},{})}(c,n[t.getAttribute("style")],n),{textAlign:f}=u;if(f){let t=r5[f];t&&(d.lineAlign=t),d.align=f}return I(d,u),d}).filter(t=>null!==t)}(t,n)))}catch(t){r(t)}}function r6(t,e,i){let r=t.getElementsByTagName(e)[0];return r?[].slice.call(r.querySelectorAll(i)):[]}function r9(t){return t.reduce((t,e)=>{let i=e.getAttribute("xml:id");return i&&(t[i]=e),t},{})}function r7(t,e,i){return t&&t.hasAttributeNS(e,i)?t.getAttributeNS(e,i):null}function st(t){return Error("Could not parse ttml timestamp ".concat(t))}function se(t,e){if(!t)return null;let i=rV(t);return null===i&&(r4.test(t)?i=function(t,e){let i=r4.exec(t),r=(0|i[4])+(0|i[5])/e.subFrameRate;return(0|i[1])*3600+(0|i[2])*60+(0|i[3])+r/e.frameRate}(t,e):r3.test(t)&&(i=function(t,e){let i=r3.exec(t),r=Number(i[1]);switch(i[2]){case"h":return 3600*r;case"m":return 60*r;case"ms":return 1e3*r;case"f":return r/e.frameRate;case"t":return r/e.tickRate}return r}(t,e))),i}class si{destroy(){let{hls:t}=this;t.off(C.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(C.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.off(C.FRAG_LOADING,this.onFragLoading,this),t.off(C.FRAG_LOADED,this.onFragLoaded,this),t.off(C.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.off(C.FRAG_DECRYPTED,this.onFragDecrypted,this),t.off(C.INIT_PTS_FOUND,this.onInitPtsFound,this),t.off(C.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.off(C.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){let t=new rG(this,"textTrack1"),e=new rG(this,"textTrack2"),i=new rG(this,"textTrack3"),r=new rG(this,"textTrack4");this.cea608Parser1=new rM(1,t,e),this.cea608Parser2=new rM(3,i,r)}}addCues(t,e,i,r,s){let a=!1;for(let t=s.length;t--;){var n;let r=s[t],l=(n=r[0],Math.min(r[1],i)-Math.max(n,e));if(l>=0&&(r[0]=Math.min(r[0],e),r[1]=Math.max(r[1],i),a=!0,l/(i-e)>.5))return}if(a||s.push([e,i]),this.config.renderTextTracksNatively){let s=this.captionsTracks[t];this.Cues.newCue(s,e,i,r)}else{let s=this.Cues.newCue(null,e,i,r);this.hls.trigger(C.CUES_PARSED,{type:"captions",cues:s,track:t})}}onInitPtsFound(t,e){let{frag:i,id:r,initPTS:s,timescale:a}=e,{unparsedVttFrags:n}=this;"main"===r&&(this.initPTS[i.cc]={baseTime:s,timescale:a}),n.length&&(this.unparsedVttFrags=[],n.forEach(t=>{this.onFragLoaded(C.FRAG_LOADED,t)}))}getExistingTrack(t,e){let{media:i}=this;if(i)for(let r=0;r<i.textTracks.length;r++){let s=i.textTracks[r];if(ss(s,{name:t,lang:e,attrs:{}}))return s}return null}createCaptionsTrack(t){this.config.renderTextTracksNatively?this.createNativeTrack(t):this.createNonNativeTrack(t)}createNativeTrack(t){if(this.captionsTracks[t])return;let{captionsProperties:e,captionsTracks:i,media:r}=this,{label:s,languageCode:a}=e[t],n=this.getExistingTrack(s,a);if(n)i[t]=n,ed(i[t]),eo(i[t],r);else{let e=this.createTextTrack("captions",s,a);e&&(e[t]=!0,i[t]=e)}}createNonNativeTrack(t){if(this.nonNativeCaptionsTracks[t])return;let e=this.captionsProperties[t];if(!e)return;let i={_id:t,label:e.label,kind:"captions",default:!!e.media&&!!e.media.default,closedCaptions:e.media};this.nonNativeCaptionsTracks[t]=i,this.hls.trigger(C.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[i]})}createTextTrack(t,e,i){let r=this.media;if(r)return r.addTextTrack(t,e,i)}onMediaAttaching(t,e){this.media=e.media,this._cleanTracks()}onMediaDetaching(){let{captionsTracks:t}=this;Object.keys(t).forEach(e=>{ed(t[e]),delete t[e]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=sa(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){let{media:t}=this;if(!t)return;let e=t.textTracks;if(e)for(let t=0;t<e.length;t++)ed(e[t])}onSubtitleTracksUpdated(t,e){let i=e.subtitleTracks||[],r=i.some(t=>t.textCodec===r2);if(this.config.enableWebVTT||r&&this.config.enableIMSC1){if(rd(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){let t=this.media,e=t?eu(t.textTracks):null;if(this.tracks.forEach((t,i)=>{let r;if(e){let i=null;for(let r=0;r<e.length;r++)if(e[r]&&ss(e[r],t)){i=e[r],e[r]=null;break}i&&(r=i)}if(r)ed(r);else{let e=sr(t);(r=this.createTextTrack(e,t.name,t.lang))&&(r.mode="disabled")}r&&this.textTracks.push(r)}),null!=e&&e.length){let t=e.filter(t=>null!==t).map(t=>t.label);t.length&&M.warn("Media element contains unused subtitle tracks: ".concat(t.join(", "),". Replace media element for each source to clear TextTracks and captions menu."))}}else if(this.tracks.length){let t=this.tracks.map(t=>({label:t.name,kind:t.type.toLowerCase(),default:t.default,subtitleTrack:t}));this.hls.trigger(C.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:t})}}}onManifestLoaded(t,e){this.config.enableCEA708Captions&&e.captions&&e.captions.forEach(t=>{let e=/(?:CC|SERVICE)([1-4])/.exec(t.instreamId);if(!e)return;let i="textTrack".concat(e[1]),r=this.captionsProperties[i];r&&(r.label=t.name,t.lang&&(r.languageCode=t.lang),r.media=t)})}closedCaptionsForLevel(t){let e=this.hls.levels[t.level];return null==e?void 0:e.attrs["CLOSED-CAPTIONS"]}onFragLoading(t,e){this.initCea608Parsers();let{cea608Parser1:i,cea608Parser2:r,lastCc:s,lastSn:a,lastPartIndex:n}=this;if(this.enabled&&i&&r&&e.frag.type===es.MAIN){var l,o;let{cc:t,sn:h}=e.frag,d=null!=(l=null==e?void 0:null==(o=e.part)?void 0:o.index)?l:-1;h===a+1||h===a&&d===n+1||t===s||(i.reset(),r.reset()),this.lastCc=t,this.lastSn=h,this.lastPartIndex=d}}onFragLoaded(t,e){let{frag:i,payload:r}=e;if(i.type===es.SUBTITLE){if(r.byteLength){let t=i.decryptdata,s="stats"in e;if(null==t||!t.encrypted||s){let t=this.tracks[i.level],s=this.vttCCs;s[i.cc]||(s[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),t&&t.textCodec===r2?this._parseIMSC1(i,r):this._parseVTTs(e)}}else this.hls.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:Error("Empty subtitle payload")})}}_parseIMSC1(t,e){let i=this.hls;r8(e,this.initPTS[t.cc],e=>{this._appendCues(e,t.level),i.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:t})},e=>{M.log("Failed to parse IMSC1: ".concat(e)),i.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:t,error:e})})}_parseVTTs(t){var e;let{frag:i,payload:r}=t,{initPTS:s,unparsedVttFrags:a}=this,n=s.length-1;if(!s[i.cc]&&-1===n){a.push(t);return}let l=this.hls;!function(t,e,i,r,s,a,n){let l;let o=new rz,h=tT(new Uint8Array(t)).trim().replace(rQ,"\n").split("\n"),d=[],c=e?function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return i0(t,9e4,1/e)}(e.baseTime,e.timescale):0,u="00:00.000",f=0,g=0,m=!0;o.oncue=function(t){let a=i[r],n=i.ccOffset,o=(f-c)/9e4;if(null!=a&&a.new&&(void 0!==g?n=i.ccOffset=a.start:r1(i,r,o)),o){if(!e){l=Error("Missing initPTS for VTT MPEGTS");return}n=o-i.presentationOffset}let h=t.endTime-t.startTime,u=i5((t.startTime+n-g)*9e4,9e4*s)/9e4;t.startTime=Math.max(u,0),t.endTime=Math.max(u+h,0);let m=t.text.trim();t.text=decodeURIComponent(encodeURIComponent(m)),t.id||(t.id=r0(t.startTime,t.endTime,m)),t.endTime>0&&d.push(t)},o.onparsingerror=function(t){l=t},o.onflush=function(){if(l){n(l);return}a(d)},h.forEach(t=>{if(m){if(rJ(t,"X-TIMESTAMP-MAP=")){m=!1,t.slice(16).split(",").forEach(t=>{rJ(t,"LOCAL:")?u=t.slice(6):rJ(t,"MPEGTS:")&&(f=parseInt(t.slice(7)))});try{g=r$(u)/1e3}catch(t){l=t}return}""===t&&(m=!1)}o.parse(t+"\n")}),o.flush()}(null!=(e=i.initSegment)&&e.data?tO(i.initSegment.data,new Uint8Array(r)):r,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,t=>{this._appendCues(t,i.level),l.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},e=>{let s="Missing initPTS for VTT MPEGTS"===e.message;s?a.push(t):this._fallbackToIMSC1(i,r),M.log("Failed to parse VTT cue: ".concat(e)),s&&n>i.cc||l.trigger(C.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:e})})}_fallbackToIMSC1(t,e){let i=this.tracks[t.level];i.textCodec||r8(e,this.initPTS[t.cc],()=>{i.textCodec=r2,this._parseIMSC1(t,e)},()=>{i.textCodec="wvtt"})}_appendCues(t,e){let i=this.hls;if(this.config.renderTextTracksNatively){let i=this.textTracks[e];if(!i||"disabled"===i.mode)return;t.forEach(t=>eh(i,t))}else{let r=this.tracks[e];if(!r)return;let s=r.default?"default":"subtitles"+e;i.trigger(C.CUES_PARSED,{type:"subtitles",cues:t,track:s})}}onFragDecrypted(t,e){let{frag:i}=e;i.type===es.SUBTITLE&&this.onFragLoaded(C.FRAG_LOADED,e)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(t,e){this.initCea608Parsers();let{cea608Parser1:i,cea608Parser2:r}=this;if(!this.enabled||!i||!r)return;let{frag:s,samples:a}=e;if(s.type!==es.MAIN||"NONE"!==this.closedCaptionsForLevel(s))for(let t=0;t<a.length;t++){let e=a[t].bytes;if(e){let s=this.extractCea608Data(e);i.addData(a[t].pts,s[0]),r.addData(a[t].pts,s[1])}}}onBufferFlushing(t,e){let{startOffset:i,endOffset:r,endOffsetSubtitles:s,type:a}=e,{media:n}=this;if(n&&!(n.currentTime<r)){if(!a||"video"===a){let{captionsTracks:t}=this;Object.keys(t).forEach(e=>ec(t[e],i,r))}if(this.config.renderTextTracksNatively&&0===i&&void 0!==s){let{textTracks:t}=this;Object.keys(t).forEach(e=>ec(t[e],i,s))}}}extractCea608Data(t){let e=[[],[]],i=31&t[0],r=2;for(let s=0;s<i;s++){let i=t[r++],s=127&t[r++],a=127&t[r++];if((0!==s||0!==a)&&(4&i)!=0){let t=3&i;(0===t||1===t)&&(e[t].push(s),e[t].push(a))}}return e}constructor(t){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=sa(),this.captionsProperties=void 0,this.hls=t,this.config=t.config,this.Cues=t.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},t.on(C.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(C.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),t.on(C.FRAG_LOADING,this.onFragLoading,this),t.on(C.FRAG_LOADED,this.onFragLoaded,this),t.on(C.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),t.on(C.FRAG_DECRYPTED,this.onFragDecrypted,this),t.on(C.INIT_PTS_FOUND,this.onInitPtsFound,this),t.on(C.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),t.on(C.BUFFER_FLUSHING,this.onBufferFlushing,this)}}function sr(t){return t.characteristics&&/transcribes-spoken-dialog/gi.test(t.characteristics)&&/describes-music-and-sound/gi.test(t.characteristics)?"captions":"subtitles"}function ss(t,e){return!!t&&t.kind===sr(e)&&ru(e,t)}function sa(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class sn{setStreamController(t){this.streamController=t}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){let{hls:t}=this;t.on(C.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(C.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(C.MANIFEST_PARSED,this.onManifestParsed,this),t.on(C.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(C.BUFFER_CODECS,this.onBufferCodecs,this),t.on(C.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){let{hls:t}=this;t.off(C.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(C.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(C.MANIFEST_PARSED,this.onManifestParsed,this),t.off(C.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(C.BUFFER_CODECS,this.onBufferCodecs,this),t.off(C.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){let i=this.hls.levels[e.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(t,e){let i=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,i.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onLevelsUpdated(t,e){this.timer&&b(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}let t=this.hls.levels;if(t.length){let e=this.hls,i=this.getMaxLevel(t.length-1);i!==this.autoLevelCapping&&M.log("Setting autoLevelCapping to ".concat(i,": ").concat(t[i].height,"p@").concat(t[i].bitrate," for media ").concat(this.mediaWidth,"x").concat(this.mediaHeight)),e.autoLevelCapping=i,e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){let e=this.hls.levels;if(!e.length)return -1;let i=e.filter((e,i)=>this.isLevelAllowed(e)&&i<=t);return this.clientRect=null,sn.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;let t=this.media,e={width:0,height:0};if(t){let i=t.getBoundingClientRect();e.width=i.width,e.height=i.height,e.width||e.height||(e.width=i.right-i.left||t.width||0,e.height=i.bottom-i.top||t.height||0)}return this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;if(!this.hls.config.ignoreDevicePixelRatio)try{t=self.devicePixelRatio}catch(t){}return t}isLevelAllowed(t){return!this.restrictedLevels.some(e=>t.bitrate===e.bitrate&&t.width===e.width&&t.height===e.height)}static getMaxLevelByMediaSize(t,e,i){if(!(null!=t&&t.length))return -1;let r=(t,e)=>!e||t.width!==e.width||t.height!==e.height,s=t.length-1,a=Math.max(e,i);for(let e=0;e<t.length;e+=1){let i=t[e];if((i.width>=a||i.height>=a)&&r(i,t[e+1])){s=e;break}}return s}constructor(t){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}}class sl{setStreamController(t){this.streamController=t}registerListeners(){this.hls.on(C.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(C.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(t,e){let i=this.hls.config;if(i.capLevelOnFPSDrop){let t=e.media instanceof self.HTMLVideoElement?e.media:null;this.media=t,t&&"function"==typeof t.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(t,e,i){let r=performance.now();if(e){if(this.lastTime){let t=r-this.lastTime,s=i-this.lastDroppedFrames,a=e-this.lastDecodedFrames,n=1e3*s/t,l=this.hls;if(l.trigger(C.FPS_DROP,{currentDropped:s,currentDecoded:a,totalDroppedFrames:i}),n>0&&s>l.config.fpsDroppedMonitoringThreshold*a){let t=l.currentLevel;M.warn("drop FPS ratio greater than max allowed value for currentLevel: "+t),t>0&&(-1===l.autoLevelCapping||l.autoLevelCapping>=t)&&(t-=1,l.trigger(C.FPS_DROP_LEVEL_CAPPING,{level:t,droppedLevel:l.currentLevel}),l.autoLevelCapping=t,this.streamController.nextLevelSwitch())}}this.lastTime=r,this.lastDroppedFrames=i,this.lastDecodedFrames=e}}checkFPSInterval(){let t=this.media;if(t){if(this.isVideoPlaybackQualityAvailable){let e=t.getVideoPlaybackQuality();this.checkFPS(t,e.totalVideoFrames,e.droppedVideoFrames)}else this.checkFPS(t,t.webkitDecodedFrameCount,t.webkitDroppedFrameCount)}}constructor(t){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=t,this.registerListeners()}}let so="[eme]";class sh{destroy(){this.unregisterListeners(),this.onMediaDetached();let t=this.config;t.requestMediaKeySystemAccessFunc=null,t.licenseXhrSetup=t.licenseResponseCallback=void 0,t.drmSystems=t.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(C.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(C.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(C.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(C.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(C.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(C.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(t){let{drmSystems:e,widevineLicenseUrl:i}=this.config,r=e[t];if(r)return r.licenseUrl;if(t===Q.WIDEVINE&&i)return i;throw Error('no license server URL configured for key-system "'.concat(t,'"'))}getServerCertificateUrl(t){let{drmSystems:e}=this.config,i=e[t];if(i)return i.serverCertificateUrl;this.log('No Server Certificate in config.drmSystems["'.concat(t,'"]'))}attemptKeySystemAccess(t){let e=this.hls.levels,i=(t,e,i)=>!!t&&i.indexOf(t)===e,r=e.map(t=>t.audioCodec).filter(i),s=e.map(t=>t.videoCodec).filter(i);return r.length+s.length===0&&s.push("avc1.42e01e"),new Promise((e,i)=>{let a=t=>{let n=t.shift();this.getMediaKeysPromise(n,r,s).then(t=>e({keySystem:n,mediaKeys:t})).catch(e=>{t.length?a(t):e instanceof sd?i(e):i(new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_NO_ACCESS,error:e,fatal:!0},e.message))})};a(t)})}requestMediaKeySystemAccess(t,e){let{requestMediaKeySystemAccessFunc:i}=this.config;if("function"!=typeof i){let t="Configured requestMediaKeySystemAccess is not a function ".concat(i);return null===ti&&"http:"===self.location.protocol&&(t="navigator.requestMediaKeySystemAccess is not available over insecure protocol ".concat(location.protocol)),Promise.reject(Error(t))}return i(t,e)}getMediaKeysPromise(t,e,i){let r=function(t,e,i,r){let s;switch(t){case Q.FAIRPLAY:s=["cenc","sinf"];break;case Q.WIDEVINE:case Q.PLAYREADY:s=["cenc"];break;case Q.CLEARKEY:s=["cenc","keyids"];break;default:throw Error("Unknown key-system: ".concat(t))}return[{initDataTypes:s,persistentState:r.persistentState||"optional",distinctiveIdentifier:r.distinctiveIdentifier||"optional",sessionTypes:r.sessionTypes||[r.sessionType||"temporary"],audioCapabilities:e.map(t=>({contentType:'audio/mp4; codecs="'.concat(t,'"'),robustness:r.audioRobustness||"",encryptionScheme:r.audioEncryptionScheme||null})),videoCapabilities:i.map(t=>({contentType:'video/mp4; codecs="'.concat(t,'"'),robustness:r.videoRobustness||"",encryptionScheme:r.videoEncryptionScheme||null}))}]}(t,e,i,this.config.drmSystemOptions),s=this.keySystemAccessPromises[t],a=null==s?void 0:s.keySystemAccess;if(!a){this.log('Requesting encrypted media "'.concat(t,'" key-system access with config: ').concat(JSON.stringify(r))),a=this.requestMediaKeySystemAccess(t,r);let e=this.keySystemAccessPromises[t]={keySystemAccess:a};return a.catch(e=>{this.log('Failed to obtain access to key-system "'.concat(t,'": ').concat(e))}),a.then(i=>{this.log('Access for key-system "'.concat(i.keySystem,'" obtained'));let r=this.fetchServerCertificate(t);return this.log('Create media-keys for "'.concat(t,'"')),e.mediaKeys=i.createMediaKeys().then(e=>(this.log('Media-keys created for "'.concat(t,'"')),r.then(i=>i?this.setMediaKeysServerCertificate(e,t,i):e))),e.mediaKeys.catch(e=>{this.error('Failed to create media-keys for "'.concat(t,'"}: ').concat(e))}),e.mediaKeys})}return a.then(()=>s.mediaKeys)}createMediaKeySessionContext(t){let{decryptdata:e,keySystem:i,mediaKeys:r}=t;this.log('Creating key-system session "'.concat(i,'" keyId: ').concat(ty.hexDump(e.keyId||[])));let s=r.createSession(),a={decryptdata:e,keySystem:i,mediaKeys:r,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(a),a}renewKeySession(t){let e=t.decryptdata;if(e.pssh){let i=this.createMediaKeySessionContext(t),r=this.getKeyIdString(e);this.keyIdToKeySessionPromise[r]=this.generateRequestWithPreferredKeySession(i,"cenc",e.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(t)}getKeyIdString(t){if(!t)throw Error("Could not read keyId of undefined decryptdata");if(null===t.keyId)throw Error("keyId is null");return ty.hexDump(t.keyId)}updateKeySession(t,e){var i;let r=t.mediaKeysSession;return this.log('Updating key-session "'.concat(r.sessionId,'" for keyID ').concat(ty.hexDump((null==(i=t.decryptdata)?void 0:i.keyId)||[]),"\n      } (data length: ").concat(e?e.byteLength:e,")")),r.update(e)}selectKeySystemFormat(t){let e=Object.keys(t.levelkeys||{});return this.keyFormatPromise||(this.log("Selecting key-system from fragment (sn: ".concat(t.sn," ").concat(t.type,": ").concat(t.level,") key formats ").concat(e.join(", "))),this.keyFormatPromise=this.getKeyFormatPromise(e)),this.keyFormatPromise}getKeyFormatPromise(t){return new Promise((e,i)=>{let r=te(this.config),s=t.map($).filter(t=>!!t&&-1!==r.indexOf(t));return this.getKeySystemSelectionPromise(s).then(t=>{let{keySystem:r}=t,s=tt(r);s?e(s):i(Error('Unable to find format for key-system "'.concat(r,'"')))}).catch(i)})}loadKey(t){let e=t.keyInfo.decryptdata,i=this.getKeyIdString(e),r="(keyId: ".concat(i,' format: "').concat(e.keyFormat,'" method: ').concat(e.method," uri: ").concat(e.uri,")");this.log("Starting session for key ".concat(r));let s=this.keyIdToKeySessionPromise[i];return s||(s=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(e).then(i=>{let{keySystem:s,mediaKeys:a}=i;return this.throwIfDestroyed(),this.log("Handle encrypted media sn: ".concat(t.frag.sn," ").concat(t.frag.type,": ").concat(t.frag.level," using key ").concat(r)),this.attemptSetMediaKeys(s,a).then(()=>{this.throwIfDestroyed();let t=this.createMediaKeySessionContext({keySystem:s,mediaKeys:a,decryptdata:e});return this.generateRequestWithPreferredKeySession(t,"cenc",e.pssh,"playlist-key")})})).catch(t=>this.handleError(t)),s}throwIfDestroyed(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0],!this.hls)throw Error("invalid state")}handleError(t){this.hls&&(this.error(t.message),t instanceof sd?this.hls.trigger(C.ERROR,t.data):this.hls.trigger(C.ERROR,{type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_NO_KEYS,error:t,fatal:!0}))}getKeySystemForKeyPromise(t){let e=this.getKeyIdString(t),i=this.keyIdToKeySessionPromise[e];if(!i){let e=$(t.keyFormat),i=e?[e]:te(this.config);return this.attemptKeySystemAccess(i)}return i}getKeySystemSelectionPromise(t){if(t.length||(t=te(this.config)),0===t.length)throw new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},"Missing key-system license configuration options ".concat(JSON.stringify({drmSystems:this.config.drmSystems})));return this.attemptKeySystemAccess(t)}_onMediaEncrypted(t){let e,i;let{initDataType:r,initData:s}=t;if(this.debug('"'.concat(t.type,'" event: init data type: "').concat(r,'"')),null===s)return;if("sinf"===r&&this.config.drmSystems[Q.FAIRPLAY]){let t=tA(new Uint8Array(s));try{let r=q(JSON.parse(t).sinf),s=tx(new Uint8Array(r));if(!s)return;e=s.subarray(8,24),i=Q.FAIRPLAY}catch(t){this.warn('Failed to parse sinf "encrypted" event message initData');return}}else{let t=function(t){if(!(t instanceof ArrayBuffer)||t.byteLength<32)return null;let e={version:0,systemId:"",kids:null,data:null},i=new DataView(t),r=i.getUint32(0);if(t.byteLength!==r&&r>44||1886614376!==i.getUint32(4)||(e.version=i.getUint32(8)>>>24,e.version>1))return null;e.systemId=ty.hexDump(new Uint8Array(t,12,16));let s=i.getUint32(28);if(0===e.version){if(r-32<s)return null;e.data=new Uint8Array(t,32,s)}else if(1===e.version){e.kids=[];for(let i=0;i<s;i++)e.kids.push(new Uint8Array(t,32+16*i,16))}return e}(s);if(null===t)return;0===t.version&&t.systemId===Z.WIDEVINE&&t.data&&(e=t.data.subarray(8,24)),i=function(t){if(t===Z.WIDEVINE)return Q.WIDEVINE}(t.systemId)}if(!i||!e)return;let a=ty.hexDump(e),{keyIdToKeySessionPromise:n,mediaKeySessions:l}=this,o=n[a];for(let t=0;t<l.length;t++){let i=l[t],h=i.decryptdata;if(h.pssh||!h.keyId)continue;let d=ty.hexDump(h.keyId);if(a===d||-1!==h.uri.replace(/-/g,"").indexOf(a)){o=n[d],delete n[d],h.pssh=new Uint8Array(s),h.keyId=e,o=n[a]=o.then(()=>this.generateRequestWithPreferredKeySession(i,r,s,"encrypted-event-key-match"));break}}o||(o=n[a]=this.getKeySystemSelectionPromise([i]).then(t=>{var i;let{keySystem:n,mediaKeys:l}=t;this.throwIfDestroyed();let o=new tB("ISO-23001-7",a,null!=(i=tt(n))?i:"");return o.pssh=new Uint8Array(s),o.keyId=e,this.attemptSetMediaKeys(n,l).then(()=>{this.throwIfDestroyed();let t=this.createMediaKeySessionContext({decryptdata:o,keySystem:n,mediaKeys:l});return this.generateRequestWithPreferredKeySession(t,r,s,"encrypted-event-no-match")})})),o.catch(t=>this.handleError(t))}_onWaitingForKey(t){this.log('"'.concat(t.type,'" event'))}attemptSetMediaKeys(t,e){let i=this.setMediaKeysQueue.slice();this.log('Setting media-keys for "'.concat(t,'"'));let r=Promise.all(i).then(()=>{if(!this.media)throw Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(e)});return this.setMediaKeysQueue.push(r),r.then(()=>{this.log('Media-keys set for "'.concat(t,'"')),i.push(r),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(t=>-1===i.indexOf(t))})}generateRequestWithPreferredKeySession(t,e,i,r){var s,a,n;let l=null==(s=this.config.drmSystems)?void 0:null==(a=s[t.keySystem])?void 0:a.generateRequest;if(l)try{let r=l.call(this.hls,e,i,t);if(!r)throw Error("Invalid response from configured generateRequest filter");e=r.initDataType,i=t.decryptdata.pssh=r.initData?new Uint8Array(r.initData):null}catch(t){if(this.warn(t.message),null!=(n=this.hls)&&n.config.debug)throw t}if(null===i)return this.log('Skipping key-session request for "'.concat(r,'" (no initData)')),Promise.resolve(t);let o=this.getKeyIdString(t.decryptdata);this.log('Generating key-session request for "'.concat(r,'": ').concat(o," (init data type: ").concat(e," length: ").concat(i?i.byteLength:null,")"));let h=new ro,d=t._onmessage=e=>{let i=t.mediaKeysSession;if(!i){h.emit("error",Error("invalid state"));return}let{messageType:r,message:s}=e;this.log('"'.concat(r,'" message event for session "').concat(i.sessionId,'" message size: ').concat(s.byteLength)),"license-request"===r||"license-renewal"===r?this.renewLicense(t,s).catch(t=>{this.handleError(t),h.emit("error",t)}):"license-release"===r?t.keySystem===Q.FAIRPLAY&&(this.updateKeySession(t,X("acknowledged")),this.removeSession(t)):this.warn('unhandled media key message type "'.concat(r,'"'))},c=t._onkeystatuseschange=e=>{if(!t.mediaKeysSession){h.emit("error",Error("invalid state"));return}this.onKeyStatusChange(t);let i=t.keyStatus;h.emit("keyStatus",i),"expired"===i&&(this.warn("".concat(t.keySystem," expired for key ").concat(o)),this.renewKeySession(t))};t.mediaKeysSession.addEventListener("message",d),t.mediaKeysSession.addEventListener("keystatuseschange",c);let u=new Promise((t,e)=>{h.on("error",e),h.on("keyStatus",i=>{i.startsWith("usable")?t():"output-restricted"===i?e(new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===i?e(new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},'key status changed to "'.concat(i,'"'))):"expired"===i?e(Error("key expired while generating request")):this.warn('unhandled key status change "'.concat(i,'"'))})});return t.mediaKeysSession.generateRequest(e,i).then(()=>{var e;this.log('Request generated for key-session "'.concat(null==(e=t.mediaKeysSession)?void 0:e.sessionId,'" keyId: ').concat(o))}).catch(t=>{throw new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_NO_SESSION,error:t,fatal:!1},"Error generating key-session request: ".concat(t))}).then(()=>u).catch(e=>{throw h.removeAllListeners(),this.removeSession(t),e}).then(()=>(h.removeAllListeners(),t))}onKeyStatusChange(t){t.mediaKeysSession.keyStatuses.forEach((e,i)=>{this.log('key status change "'.concat(e,'" for keyStatuses keyId: ').concat(ty.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))," session keyId: ").concat(ty.hexDump(new Uint8Array(t.decryptdata.keyId||[]))," uri: ").concat(t.decryptdata.uri)),t.keyStatus=e})}fetchServerCertificate(t){let e=this.config,i=new e.loader(e),r=this.getServerCertificateUrl(t);return r?(this.log('Fetching server certificate for "'.concat(t,'"')),new Promise((s,a)=>{let n={responseType:"arraybuffer",url:r},l=e.certLoadPolicy.default,o={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};i.load(n,o,{onSuccess:(t,e,i,r)=>{s(t.data)},onError:(e,i,s,l)=>{a(new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:D({url:n.url,data:void 0},e)},'"'.concat(t,'" certificate request failed (').concat(r,"). Status: ").concat(e.code," (").concat(e.text,")")))},onTimeout:(e,i,s)=>{a(new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:s,response:{url:n.url,data:void 0}},'"'.concat(t,'" certificate request timed out (').concat(r,")")))},onAbort:(t,e,i)=>{a(Error("aborted"))}})})):Promise.resolve()}setMediaKeysServerCertificate(t,e,i){return new Promise((r,s)=>{t.setServerCertificate(i).then(s=>{this.log("setServerCertificate ".concat(s?"success":"not supported by CDM"," (").concat(null==i?void 0:i.byteLength,') on "').concat(e,'"')),r(t)}).catch(t=>{s(new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:t,fatal:!0},t.message))})})}renewLicense(t,e){return this.requestLicense(t,new Uint8Array(e)).then(e=>this.updateKeySession(t,new Uint8Array(e)).catch(t=>{throw new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:t,fatal:!0},t.message)}))}unpackPlayReadyKeyMessage(t,e){let i=String.fromCharCode.apply(null,new Uint16Array(e.buffer));if(!i.includes("PlayReadyKeyMessage"))return t.setRequestHeader("Content-Type","text/xml; charset=utf-8"),e;let r=new DOMParser().parseFromString(i,"application/xml"),s=r.querySelectorAll("HttpHeader");if(s.length>0){let e;for(let i=0,r=s.length;i<r;i++){var a,n;let r=null==(a=(e=s[i]).querySelector("name"))?void 0:a.textContent,l=null==(n=e.querySelector("value"))?void 0:n.textContent;r&&l&&t.setRequestHeader(r,l)}}let l=r.querySelector("Challenge"),o=null==l?void 0:l.textContent;if(!o)throw Error("Cannot find <Challenge> in key message");return X(atob(o))}setupLicenseXHR(t,e,i,r){let s=this.config.licenseXhrSetup;return s?Promise.resolve().then(()=>{if(!i.decryptdata)throw Error("Key removed");return s.call(this.hls,t,e,i,r)}).catch(a=>{if(!i.decryptdata)throw a;return t.open("POST",e,!0),s.call(this.hls,t,e,i,r)}).then(i=>(t.readyState||t.open("POST",e,!0),{xhr:t,licenseChallenge:i||r})):(t.open("POST",e,!0),Promise.resolve({xhr:t,licenseChallenge:r}))}requestLicense(t,e){let i=this.config.keyLoadPolicy.default;return new Promise((r,s)=>{let a=this.getLicenseServerUrl(t.keySystem);this.log("Sending license request to URL: ".concat(a));let n=new XMLHttpRequest;n.responseType="arraybuffer",n.onreadystatechange=()=>{if(!this.hls||!t.mediaKeysSession)return s(Error("invalid state"));if(4===n.readyState){if(200===n.status){this._requestLicenseFailureCount=0;let e=n.response;this.log("License received ".concat(e instanceof ArrayBuffer?e.byteLength:e));let i=this.config.licenseResponseCallback;if(i)try{e=i.call(this.hls,n,a,t)}catch(t){this.error(t)}r(e)}else{let l=i.errorRetry,o=l?l.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>o||n.status>=400&&n.status<500)s(new sd({type:w.KEY_SYSTEM_ERROR,details:P.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:{url:a,data:void 0,code:n.status,text:n.statusText}},"License Request XHR failed (".concat(a,"). Status: ").concat(n.status," (").concat(n.statusText,")")));else{let i=o-this._requestLicenseFailureCount+1;this.warn("Retrying license request, ".concat(i," attempts left")),this.requestLicense(t,e).then(r,s)}}}},t.licenseXhr&&t.licenseXhr.readyState!==XMLHttpRequest.DONE&&t.licenseXhr.abort(),t.licenseXhr=n,this.setupLicenseXHR(n,a,t,e).then(e=>{let{xhr:i,licenseChallenge:r}=e;t.keySystem==Q.PLAYREADY&&(r=this.unpackPlayReadyKeyMessage(i,r)),i.send(r)})})}onMediaAttached(t,e){if(!this.config.emeEnabled)return;let i=e.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){let t=this.media,e=this.mediaKeySessions;t&&(t.removeEventListener("encrypted",this.onMediaEncrypted),t.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},tB.clearKeyUriToKeyIdMap();let i=e.length;sh.CDMCleanupPromise=Promise.all(e.map(t=>this.removeSession(t)).concat(null==t?void 0:t.setMediaKeys(null).catch(t=>{this.log("Could not clear media keys: ".concat(t))}))).then(()=>{i&&(this.log("finished closing key sessions and clearing media keys"),e.length=0)}).catch(t=>{this.log("Could not close sessions and clear media keys: ".concat(t))})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(t,e){let{sessionKeys:i}=e;if(i&&this.config.emeEnabled&&!this.keyFormatPromise){let t=i.reduce((t,e)=>(-1===t.indexOf(e.keyFormat)&&t.push(e.keyFormat),t),[]);this.log("Selecting key-system from session-keys ".concat(t.join(", "))),this.keyFormatPromise=this.getKeyFormatPromise(t)}}removeSession(t){let{mediaKeysSession:e,licenseXhr:i}=t;if(e){this.log("Remove licenses and keys and close session ".concat(e.sessionId)),t._onmessage&&(e.removeEventListener("message",t._onmessage),t._onmessage=void 0),t._onkeystatuseschange&&(e.removeEventListener("keystatuseschange",t._onkeystatuseschange),t._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),t.mediaKeysSession=t.decryptdata=t.licenseXhr=void 0;let r=this.mediaKeySessions.indexOf(t);return r>-1&&this.mediaKeySessions.splice(r,1),e.remove().catch(t=>{this.log("Could not remove session: ".concat(t))}).then(()=>e.close()).catch(t=>{this.log("Could not close session: ".concat(t))})}}constructor(t){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=sh.CDMCleanupPromise?[sh.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=M.debug.bind(M,so),this.log=M.log.bind(M,so),this.warn=M.warn.bind(M,so),this.error=M.error.bind(M,so),this.hls=t,this.config=t.config,this.registerListeners()}}sh.CDMCleanupPromise=void 0;class sd extends Error{constructor(t,e){super(e),this.data=void 0,t.error||(t.error=Error(e)),this.data=t,t.err=t.error}}(p=y||(y={})).MANIFEST="m",p.AUDIO="a",p.VIDEO="v",p.MUXED="av",p.INIT="i",p.CAPTION="c",p.TIMED_TEXT="tt",p.KEY="k",p.OTHER="o",(E=v||(v={})).DASH="d",E.HLS="h",E.SMOOTH="s",E.OTHER="o",(T=S||(S={})).OBJECT="CMCD-Object",T.REQUEST="CMCD-Request",T.SESSION="CMCD-Session",T.STATUS="CMCD-Status";let sc={[S.OBJECT]:["br","d","ot","tb"],[S.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[S.SESSION]:["cid","pr","sf","sid","st","v"],[S.STATUS]:["bs","rtp"]};class su{constructor(t,e){this.value=void 0,this.params=void 0,Array.isArray(t)&&(t=t.map(t=>t instanceof su?t:new su(t))),this.value=t,this.params=e}}class sf{constructor(t){this.description=void 0,this.description=t}}let sg="Bare Item",sm=/[\x00-\x1f\x7f]+/;function sp(t,e,i){return Error("failed to ".concat("serialize",' "').concat(Array.isArray(t)?JSON.stringify(t):t instanceof Map?"Map{}":t instanceof Set?"Set{}":"object"==typeof t?JSON.stringify(t):String(t),'" as ').concat(e),{cause:i})}function sE(t){if(t<-999999999999999||999999999999999<t)throw sp(t,"Integer");return t.toString()}function sT(t){let e=t.description||t.toString().slice(7,-1);if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e))throw sp(e,"Token");return e}function sy(t){switch(typeof t){case"number":if(!b(t))throw sp(t,sg);if(Number.isInteger(t))return sE(t);return function(t){let e=function t(e,i){if(e<0)return-t(-e,i);let r=Math.pow(10,i);if(!(Math.abs(e*r%1-.5)<Number.EPSILON))return Math.round(e*r)/r;{let t=Math.floor(e*r);return(t%2==0?t:t+1)/r}}(t,3);if(Math.floor(Math.abs(e)).toString().length>12)throw sp(t,"Decimal");let i=e.toString();return i.includes(".")?i:"".concat(i,".0")}(t);case"string":return function(t){if(sm.test(t))throw sp(t,"String");return'"'.concat(t.replace(/\\/g,"\\\\").replace(/"/g,'\\"'),'"')}(t);case"symbol":return sT(t);case"boolean":return function(t){if("boolean"!=typeof t)throw sp(t,"Boolean");return t?"?1":"?0"}(t);case"object":if(t instanceof Date)return"@".concat(sE(t.getTime()/1e3));if(t instanceof Uint8Array)return function(t){if(!1===ArrayBuffer.isView(t))throw sp(t,"Byte Sequence");return":".concat(btoa(String.fromCharCode(...t)),":")}(t);if(t instanceof sf)return sT(t);default:throw sp(t,sg)}}function sv(t){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(t))throw sp(t,"Key");return t}function sS(t){return null==t?"":Object.entries(t).map(t=>{let[e,i]=t;return!0===i?";".concat(sv(e)):";".concat(sv(e),"=").concat(sy(i))}).join("")}function sA(t){return t instanceof su?"".concat(sy(t.value)).concat(sS(t.params)):sy(t)}let sL=t=>"ot"===t||"sf"===t||"st"===t,sR=t=>"number"==typeof t?b(t):null!=t&&""!==t&&!1!==t,sD=t=>Math.round(t),sI=t=>100*sD(t/100),sb={br:sD,d:sD,bl:sI,dl:sI,mtp:sI,nor:(t,e)=>(null!=e&&e.baseUrl&&(t=function(t,e){let i=new URL(t),r=new URL(e);if(i.origin!==r.origin)return t;let s=i.pathname.split("/").slice(1),a=r.pathname.split("/").slice(1,-1);for(;s[0]===a[0];)s.shift(),a.shift();for(;a.length;)a.shift(),s.unshift("..");return s.join("/")}(t,e.baseUrl)),encodeURIComponent(t)),rtp:sI,tb:sD};function sk(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t?function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{whitespace:!0};if("object"!=typeof t)throw sp(t,"Dict");let i=t instanceof Map?t.entries():Object.entries(t),r=null!=e&&e.whitespace?" ":"";return Array.from(i).map(t=>{let[e,i]=t;i instanceof su==!1&&(i=new su(i));let r=sv(e);if(!0===i.value)r+=sS(i.params);else if(r+="=",Array.isArray(i.value)){var s;r+=(s=i,"(".concat(s.value.map(sA).join(" "),")").concat(sS(s.params)))}else r+=sA(i);return r}).join(",".concat(r))}(function(t,e){let i={};if(null==t||"object"!=typeof t)return i;let r=Object.keys(t).sort(),s=I({},sb,null==e?void 0:e.formatters),a=null==e?void 0:e.filter;return r.forEach(r=>{if(null!=a&&a(r))return;let n=t[r],l=s[r];l&&(n=l(n,e)),("v"!==r||1!==n)&&("pr"!=r||1!==n)&&sR(n)&&(sL(r)&&"string"==typeof n&&(n=new sf(n)),i[r]=n)}),i}(t,e),I({whitespace:!1},e)):""}let s_=/CMCD=[^&#]+/;class sC{registerListeners(){let t=this.hls;t.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(C.MEDIA_DETACHED,this.onMediaDetached,this),t.on(C.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){let t=this.hls;t.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(C.MEDIA_DETACHED,this.onMediaDetached,this),t.off(C.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(t,e){this.media=e.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(t,e){var i,r;this.audioBuffer=null==(i=e.tracks.audio)?void 0:i.buffer,this.videoBuffer=null==(r=e.tracks.video)?void 0:r.buffer}createData(){var t;return{v:1,sf:v.HLS,sid:this.sid,cid:this.cid,pr:null==(t=this.media)?void 0:t.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};I(e,this.createData());let i=e.ot===y.INIT||e.ot===y.VIDEO||e.ot===y.MUXED;this.starved&&i&&(e.bs=!0,e.su=!0,this.starved=!1),null==e.su&&(e.su=this.buffering);let{includeKeys:r}=this;if(r&&(e=Object.keys(e).reduce((t,i)=>(r.includes(i)&&(t[i]=e[i]),t),{})),this.useHeaders){var s;t.headers||(t.headers={}),s=t.headers,I(s,function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return{};let i=Object.entries(t),r=Object.entries(sc).concat(Object.entries((null==e?void 0:e.customHeaderMap)||{}));return Object.entries(i.reduce((t,e)=>{var i;let[s,a]=e,n=(null==(i=r.find(t=>t[1].includes(s)))?void 0:i[0])||S.REQUEST;return null!=t[n]||(t[n]={}),t[n][s]=a,t},{})).reduce((t,i)=>{let[r,s]=i;return t[r]=sk(s,e),t},{})}(e,void 0))}else t.url=function(t,e,i){let r=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return"";let i=sk(t,e);return"".concat("CMCD","=").concat(encodeURIComponent(i))}(e,void 0);if(!r)return t;if(s_.test(t))return t.replace(s_,r);let s=t.includes("?")?"&":"?";return"".concat(t).concat(s).concat(r)}(t.url,e)}getObjectType(t){let{type:e}=t;return"subtitle"===e?y.TIMED_TEXT:"initSegment"===t.sn?y.INIT:"audio"===e?y.AUDIO:"main"===e?this.hls.audioTracks.length?y.VIDEO:y.MUXED:void 0}getTopBandwidth(t){let e,i=0,r=this.hls;if(t===y.AUDIO)e=r.audioTracks;else{let t=r.maxAutoLevel,i=t>-1?t+1:r.levels.length;e=r.levels.slice(0,i)}for(let t of e)t.bitrate>i&&(i=t.bitrate);return i>0?i:NaN}getBufferLength(t){let e=this.hls.media,i=t===y.AUDIO?this.audioBuffer:this.videoBuffer;return i&&e?1e3*e6.bufferInfo(i,e.currentTime,this.config.maxBufferHole).len:NaN}createPlaylistLoader(){let{pLoader:t}=this.config,e=this.applyPlaylistData,i=t||this.config.loader;return class{get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(t,i,r){e(t),this.loader.load(t,i,r)}constructor(t){this.loader=void 0,this.loader=new i(t)}}}createFragmentLoader(){let{fLoader:t}=this.config,e=this.applyFragmentData,i=t||this.config.loader;return class{get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(t,i,r){e(t),this.loader.load(t,i,r)}constructor(t){this.loader=void 0,this.loader=new i(t)}}}constructor(t){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=t=>{try{this.apply(t,{ot:y.MANIFEST,su:!this.initialized})}catch(t){M.warn("Could not generate manifest CMCD data.",t)}},this.applyFragmentData=t=>{try{let e=t.frag,i=this.hls.levels[e.level],r=this.getObjectType(e),s={d:1e3*e.duration,ot:r};(r===y.VIDEO||r===y.AUDIO||r==y.MUXED)&&(s.br=i.bitrate/1e3,s.tb=this.getTopBandwidth(r)/1e3,s.bl=this.getBufferLength(r)),this.apply(t,s)}catch(t){M.warn("Could not generate segment CMCD data.",t)}},this.hls=t;let e=this.config=t.config,{cmcd:i}=e;null!=i&&(e.pLoader=this.createPlaylistLoader(),e.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||function(){try{return crypto.randomUUID()}catch(t){try{let t=URL.createObjectURL(new Blob),e=t.toString();return URL.revokeObjectURL(t),e.slice(e.lastIndexOf("/")+1)}catch(e){let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?i:3&i|8).toString(16)})}}}(),this.cid=i.contentId,this.useHeaders=!0===i.useHeaders,this.includeKeys=i.includeKeys,this.registerListeners())}}class sw{registerListeners(){let t=this.hls;t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(C.MANIFEST_PARSED,this.onManifestParsed,this),t.on(C.ERROR,this.onError,this)}unregisterListeners(){let t=this.hls;t&&(t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(C.MANIFEST_PARSED,this.onManifestParsed,this),t.off(C.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){let t=1e3*this.timeToLoad-(performance.now()-this.updated);if(t>0){this.scheduleRefresh(this.uri,t);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(t){let e=this.levels;e&&(this.levels=e.filter(e=>e!==t))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(t,e){let{contentSteering:i}=e;null!==i&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(t,e){this.audioTracks=e.audioTracks,this.subtitleTracks=e.subtitleTracks}onError(t,e){let{errorAction:i}=e;if((null==i?void 0:i.action)===eK.SendAlternateToPenaltyBox&&i.flags===eH.MoveAllAlternatesMatchingHost){let t=this.levels,r=this.pathwayPriority,s=this.pathwayId;if(e.context){let{groupId:i,pathwayId:r,type:a}=e.context;i&&t?s=this.getPathwayForGroupId(i,a,s):r&&(s=r)}s in this.penalizedPathways||(this.penalizedPathways[s]=performance.now()),!r&&t&&(r=t.reduce((t,e)=>(-1===t.indexOf(e.pathwayId)&&t.push(e.pathwayId),t),[])),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==s),i.resolved||M.warn("Could not resolve ".concat(e.details,' ("').concat(e.error.message,'") with content-steering for Pathway: ').concat(s," levels: ").concat(t?t.length:t," priorities: ").concat(JSON.stringify(r)," penalized: ").concat(JSON.stringify(this.penalizedPathways)))}}filterParsedLevels(t){this.levels=t;let e=this.getLevelsForPathway(this.pathwayId);if(0===e.length){let i=t[0].pathwayId;this.log("No levels found in Pathway ".concat(this.pathwayId,'. Setting initial Pathway to "').concat(i,'"')),e=this.getLevelsForPathway(i),this.pathwayId=i}return e.length!==t.length?(this.log("Found ".concat(e.length,"/").concat(t.length,' levels in Pathway "').concat(this.pathwayId,'"')),e):t}getLevelsForPathway(t){return null===this.levels?[]:this.levels.filter(e=>t===e.pathwayId)}updatePathwayPriority(t){let e;this.pathwayPriority=t;let i=this.penalizedPathways,r=performance.now();Object.keys(i).forEach(t=>{r-i[t]>3e5&&delete i[t]});for(let r=0;r<t.length;r++){let s=t[r];if(s in i)continue;if(s===this.pathwayId)return;let a=this.hls.nextLoadLevel,n=this.hls.levels[a];if((e=this.getLevelsForPathway(s)).length>0){this.log('Setting Pathway to "'.concat(s,'"')),this.pathwayId=s,eP(e),this.hls.trigger(C.LEVELS_UPDATED,{levels:e});let t=this.hls.levels[a];n&&t&&this.levels&&(t.attrs["STABLE-VARIANT-ID"]!==n.attrs["STABLE-VARIANT-ID"]&&t.bitrate!==n.bitrate&&this.log("Unstable Pathways change from bitrate ".concat(n.bitrate," to ").concat(t.bitrate)),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(t,e,i){let r=this.getLevelsForPathway(i).concat(this.levels||[]);for(let i=0;i<r.length;i++)if(e===er.AUDIO_TRACK&&r[i].hasAudioGroup(t)||e===er.SUBTITLE_TRACK&&r[i].hasSubtitleGroup(t))return r[i].pathwayId;return i}clonePathways(t){let e=this.levels;if(!e)return;let i={},r={};t.forEach(t=>{let{ID:s,"BASE-ID":a,"URI-REPLACEMENT":n}=t;if(e.some(t=>t.pathwayId===s))return;let l=this.getLevelsForPathway(a).map(t=>{let e=new B(t.attrs);e["PATHWAY-ID"]=s;let a=e.AUDIO&&"".concat(e.AUDIO,"_clone_").concat(s),l=e.SUBTITLES&&"".concat(e.SUBTITLES,"_clone_").concat(s);a&&(i[e.AUDIO]=a,e.AUDIO=a),l&&(r[e.SUBTITLES]=l,e.SUBTITLES=l);let o=sx(t.uri,e["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",n),h=new eR({attrs:e,audioCodec:t.audioCodec,bitrate:t.bitrate,height:t.height,name:t.name,url:o,videoCodec:t.videoCodec,width:t.width});if(t.audioGroups)for(let e=1;e<t.audioGroups.length;e++)h.addGroupId("audio","".concat(t.audioGroups[e],"_clone_").concat(s));if(t.subtitleGroups)for(let e=1;e<t.subtitleGroups.length;e++)h.addGroupId("text","".concat(t.subtitleGroups[e],"_clone_").concat(s));return h});e.push(...l),sP(this.audioTracks,i,n,s),sP(this.subtitleTracks,r,n,s)})}loadSteeringManifest(t){let e;let i=this.hls.config,r=i.loader;this.loader&&this.loader.destroy(),this.loader=new r(i);try{e=new self.URL(t)}catch(e){this.enabled=!1,this.log("Failed to parse Steering Manifest URI: ".concat(t));return}if("data:"!==e.protocol){let t=0|(this.hls.bandwidthEstimate||i.abrEwmaDefaultEstimate);e.searchParams.set("_HLS_pathway",this.pathwayId),e.searchParams.set("_HLS_throughput",""+t)}let s={responseType:"json",url:e.href},a=i.steeringManifestLoadPolicy.default,n=a.errorRetry||a.timeoutRetry||{},l={loadPolicy:a,timeout:a.maxLoadTimeMs,maxRetry:n.maxNumRetry||0,retryDelay:n.retryDelayMs||0,maxRetryDelay:n.maxRetryDelayMs||0};this.log("Requesting steering manifest: ".concat(e)),this.loader.load(s,l,{onSuccess:(t,i,r,s)=>{this.log('Loaded steering manifest: "'.concat(e,'"'));let a=t.data;if(1!==a.VERSION){this.log("Steering VERSION ".concat(a.VERSION," not supported!"));return}this.updated=performance.now(),this.timeToLoad=a.TTL;let{"RELOAD-URI":n,"PATHWAY-CLONES":l,"PATHWAY-PRIORITY":o}=a;if(n)try{this.uri=new self.URL(n,e).href}catch(t){this.enabled=!1,this.log("Failed to parse Steering Manifest RELOAD-URI: ".concat(n));return}this.scheduleRefresh(this.uri||r.url),l&&this.clonePathways(l);let h={steeringManifest:a,url:e.toString()};this.hls.trigger(C.STEERING_MANIFEST_LOADED,h),o&&this.updatePathwayPriority(o)},onError:(t,e,i,r)=>{if(this.log("Error loading steering manifest: ".concat(t.code," ").concat(t.text," (").concat(e.url,")")),this.stopLoad(),410===t.code){this.enabled=!1,this.log("Steering manifest ".concat(e.url," no longer available"));return}let s=1e3*this.timeToLoad;if(429===t.code){let t=this.loader;if("function"==typeof(null==t?void 0:t.getResponseHeader)){let e=t.getResponseHeader("Retry-After");e&&(s=1e3*parseFloat(e))}this.log("Steering manifest ".concat(e.url," rate limited"));return}this.scheduleRefresh(this.uri||e.url,s)},onTimeout:(t,e,i)=>{this.log("Timeout loading steering manifest (".concat(e.url,")")),this.scheduleRefresh(this.uri||e.url)}})}scheduleRefresh(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3*this.timeToLoad;this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var e;let i=null==(e=this.hls)?void 0:e.media;if(i&&!i.ended){this.loadSteeringManifest(t);return}this.scheduleRefresh(t,1e3*this.timeToLoad)},e)}constructor(t){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=t,this.log=M.log.bind(M,"[content-steering]:"),this.registerListeners()}}function sP(t,e,i,r){t&&Object.keys(e).forEach(s=>{let a=t.filter(t=>t.groupId===s).map(t=>{let a=I({},t);return a.details=void 0,a.attrs=new B(a.attrs),a.url=a.attrs.URI=sx(t.url,t.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",i),a.groupId=a.attrs["GROUP-ID"]=e[s],a.attrs["PATHWAY-ID"]=r,a});t.push(...a)})}function sx(t,e,i,r){let s;let{HOST:a,PARAMS:n,[i]:l}=r;e&&(s=null==l?void 0:l[e])&&(t=s);let o=new self.URL(t);return a&&!s&&(o.host=a),n&&Object.keys(n).sort().forEach(t=>{t&&o.searchParams.set(t,n[t])}),o.href}let sO=/^age:\s*[\d.]+\s*$/im;class sF{destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null,this.stats=null}abortInternal(){let t=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),t&&(t.onreadystatechange=null,t.onprogress=null,4!==t.readyState&&(this.stats.aborted=!0,t.abort()))}abort(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(t,e,i){if(this.stats.loading.start)throw Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=t,this.config=e,this.callbacks=i,this.loadInternal()}loadInternal(){let{config:t,context:e}=this;if(!t||!e)return;let i=this.loader=new self.XMLHttpRequest,r=this.stats;r.loading.first=0,r.loaded=0,r.aborted=!1;let s=this.xhrSetup;s?Promise.resolve().then(()=>{if(!this.stats.aborted)return s(i,e.url)}).catch(t=>(i.open("GET",e.url,!0),s(i,e.url))).then(()=>{this.stats.aborted||this.openAndSendXhr(i,e,t)}).catch(t=>{this.callbacks.onError({code:i.status,text:t.message},e,i,r)}):this.openAndSendXhr(i,e,t)}openAndSendXhr(t,e,i){t.readyState||t.open("GET",e.url,!0);let r=e.headers,{maxTimeToFirstByteMs:s,maxLoadTimeMs:a}=i.loadPolicy;if(r)for(let e in r)t.setRequestHeader(e,r[e]);e.rangeEnd&&t.setRequestHeader("Range","bytes="+e.rangeStart+"-"+(e.rangeEnd-1)),t.onreadystatechange=this.readystatechange.bind(this),t.onprogress=this.loadprogress.bind(this),t.responseType=e.responseType,self.clearTimeout(this.requestTimeout),i.timeout=s&&b(s)?s:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),t.send()}readystatechange(){let{context:t,loader:e,stats:i}=this;if(!t||!e)return;let r=e.readyState,s=this.config;if(!i.aborted&&r>=2&&(0===i.loading.first&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),s.timeout!==s.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),s.timeout=s.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),4===r)){self.clearTimeout(this.requestTimeout),e.onreadystatechange=null,e.onprogress=null;let r=e.status,a="text"!==e.responseType;if(r>=200&&r<300&&(a&&e.response||null!==e.responseText)){i.loading.end=Math.max(self.performance.now(),i.loading.first);let s=a?e.response:e.responseText,n="arraybuffer"===e.responseType?s.byteLength:s.length;if(i.loaded=i.total=n,i.bwEstimate=8e3*i.total/(i.loading.end-i.loading.first),!this.callbacks)return;let l=this.callbacks.onProgress;if(l&&l(i,t,s,e),!this.callbacks)return;let o={url:e.responseURL,data:s,code:r};this.callbacks.onSuccess(o,i,t,e)}else{let a=s.loadPolicy.errorRetry;eN(a,i.retry,!1,{url:t.url,data:void 0,code:r})?this.retry(a):(M.error("".concat(r," while loading ").concat(t.url)),this.callbacks.onError({code:r,text:e.statusText},t,e,i))}}}loadtimeout(){var t,e;let i=null==(t=this.config)?void 0:t.loadPolicy.timeoutRetry;if(eN(i,this.stats.retry,!0))this.retry(i);else{M.warn("timeout while loading ".concat(null==(e=this.context)?void 0:e.url));let t=this.callbacks;t&&(this.abortInternal(),t.onTimeout(this.stats,this.context,this.loader))}}retry(t){let{context:e,stats:i}=this;this.retryDelay=eF(t,i.retry),i.retry++,M.warn("".concat(status?"HTTP Status "+status:"Timeout"," while loading ").concat(null==e?void 0:e.url,", retrying ").concat(i.retry,"/").concat(t.maxNumRetry," in ").concat(this.retryDelay,"ms")),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(t){let e=this.stats;e.loaded=t.loaded,t.lengthComputable&&(e.total=t.total)}getCacheAge(){let t=null;if(this.loader&&sO.test(this.loader.getAllResponseHeaders())){let e=this.loader.getResponseHeader("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.loader&&RegExp("^".concat(t,":\\s*[\\d.]+\\s*$"),"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(t):null}constructor(t){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=t&&t.xhrSetup||null,this.stats=new K,this.retryDelay=0}}let sM=/(\d+)-(\d+)\/(\d+)/;class sN{destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var t;this.abortInternal(),null!=(t=this.callbacks)&&t.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(t,e,i){let r=this.stats;if(r.loading.start)throw Error("Loader can only be used once.");r.loading.start=self.performance.now();let s=function(t,e){let i={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(I({},t.headers))};return t.rangeEnd&&i.headers.set("Range","bytes="+t.rangeStart+"-"+String(t.rangeEnd-1)),i}(t,this.controller.signal),a=i.onProgress,n="arraybuffer"===t.responseType,l=n?"byteLength":"length",{maxTimeToFirstByteMs:o,maxLoadTimeMs:h}=e.loadPolicy;this.context=t,this.config=e,this.callbacks=i,this.request=this.fetchSetup(t,s),self.clearTimeout(this.requestTimeout),e.timeout=o&&b(o)?o:h,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(r,t,this.response)},e.timeout),self.fetch(this.request).then(s=>{this.response=this.loader=s;let l=Math.max(self.performance.now(),r.loading.start);if(self.clearTimeout(this.requestTimeout),e.timeout=h,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(r,t,this.response)},h-(l-r.loading.start)),!s.ok){let{status:t,statusText:e}=s;throw new sB(e||"fetch, bad network response",t,s)}return(r.loading.first=l,r.total=function(t){let e=t.get("Content-Range");if(e){let t=function(t){let e=sM.exec(t);if(e)return parseInt(e[2])-parseInt(e[1])+1}(e);if(b(t))return t}let i=t.get("Content-Length");if(i)return parseInt(i)}(s.headers)||r.total,a&&b(e.highWaterMark))?this.loadProgressively(s,r,t,e.highWaterMark,a):n?s.arrayBuffer():"json"===t.responseType?s.json():s.text()}).then(s=>{let n=this.response;if(!n)throw Error("loader destroyed");self.clearTimeout(this.requestTimeout),r.loading.end=Math.max(self.performance.now(),r.loading.first);let o=s[l];o&&(r.loaded=r.total=o);let h={url:n.url,data:s,code:n.status};a&&!b(e.highWaterMark)&&a(r,t,s,n),i.onSuccess(h,r,t,n)}).catch(e=>{if(self.clearTimeout(this.requestTimeout),r.aborted)return;let s=e&&e.code||0,a=e?e.message:null;i.onError({code:s,text:a},t,e?e.details:null,r)})}getCacheAge(){let t=null;if(this.response){let e=this.response.headers.get("age");t=e?parseFloat(e):null}return t}getResponseHeader(t){return this.response?this.response.headers.get(t):null}loadProgressively(t,e,i){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4?arguments[4]:void 0,a=new iE,n=t.body.getReader(),l=()=>n.read().then(n=>{if(n.done)return a.dataLength&&s(e,i,a.flush(),t),Promise.resolve(new ArrayBuffer(0));let o=n.value,h=o.length;return e.loaded+=h,h<r||a.dataLength?(a.push(o),a.dataLength>=r&&s(e,i,a.flush(),t)):s(e,i,o,t),l()}).catch(()=>Promise.reject());return l()}constructor(t){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=t.fetchSetup||sU,this.controller=new self.AbortController,this.stats=new K}}function sU(t,e){return new self.Request(t.url,e)}class sB extends Error{constructor(t,e,i){super(t),this.code=void 0,this.details=void 0,this.code=e,this.details=i}}let sG=/\s/,sK=D(D({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:sF,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:e0,bufferController:rv,capLevelController:sn,errorController:eV,fpsController:sl,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:ti,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:{newCue(t,e,i,r){let s,a,n,l,o;let h=[],d=self.VTTCue||self.TextTrackCue;for(let u=0;u<r.rows.length;u++)if(s=r.rows[u],n=!0,l=0,o="",!s.isEmpty()){var c;for(let t=0;t<s.chars.length;t++)sG.test(s.chars[t].uchar)&&n?l++:(o+=s.chars[t].uchar,n=!1);s.cueStartTime=e,e===i&&(i+=1e-4),l>=16?l--:l++;let r=rX(o.trim()),f=r0(e,i,r);null!=t&&null!=(c=t.cues)&&c.getCueById(f)||((a=new d(e,i,r)).id=f,a.line=u+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),h.push(a))}return t&&h.length&&(h.sort((t,e)=>"auto"===t.line||"auto"===e.line?0:t.line>8&&e.line>8?e.line-t.line:t.line-e.line),h.forEach(e=>eh(t,e))),h}},enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:rm,subtitleTrackController:rE,timelineController:si,audioStreamController:rf,audioTrackController:rg,emeController:sh,cmcdController:sC,contentSteeringController:sw});class sH extends eY{_registerListeners(){let{hls:t}=this;t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.MANIFEST_LOADED,this.onManifestLoaded,this),t.on(C.LEVEL_LOADED,this.onLevelLoaded,this),t.on(C.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(C.FRAG_BUFFERED,this.onFragBuffered,this),t.on(C.ERROR,this.onError,this)}_unregisterListeners(){let{hls:t}=this;t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.MANIFEST_LOADED,this.onManifestLoaded,this),t.off(C.LEVEL_LOADED,this.onLevelLoaded,this),t.off(C.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(C.FRAG_BUFFERED,this.onFragBuffered,this),t.off(C.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(t,e){this.resetLevels()}onManifestLoaded(t,e){let i=this.hls.config.preferManagedMediaSource,r=[],s={},n={},l=!1,o=!1,h=!1;e.levels.forEach(t=>{var e,d;let c=t.attrs,{audioCodec:u,videoCodec:f}=t;(null==(e=u)?void 0:e.indexOf("mp4a.40.34"))!==-1&&(a||(a=/chrome|firefox/i.test(navigator.userAgent)),a&&(t.audioCodec=u=void 0)),u&&(t.audioCodec=u=tZ(u,i)),(null==(d=f)?void 0:d.indexOf("avc1"))===0&&(f=t.videoCodec=function(t){let e=t.split(".");return e.length>2?e.shift()+"."+(parseInt(e.shift()).toString(16)+("000"+parseInt(e.shift()).toString(16)).slice(-4)):t}(f));let{width:g,height:m,unknownCodecs:p}=t;if(l||(l=!!(g&&m)),o||(o=!!f),h||(h=!!u),null!=p&&p.length||u&&!tj(u,"audio",i)||f&&!tj(f,"video",i))return;let{CODECS:E,"FRAME-RATE":T,"HDCP-LEVEL":y,"PATHWAY-ID":v,RESOLUTION:S,"VIDEO-RANGE":A}=c,L="".concat("".concat(v||".","-")).concat(t.bitrate,"-").concat(S,"-").concat(T,"-").concat(E,"-").concat(A,"-").concat(y);if(s[L]){if(s[L].uri===t.url||t.attrs["PATHWAY-ID"])s[L].addGroupId("audio",c.AUDIO),s[L].addGroupId("text",c.SUBTITLES);else{let e=n[L]+=1;t.attrs["PATHWAY-ID"]=Array(e+1).join(".");let i=new eR(t);s[L]=i,r.push(i)}}else{let e=new eR(t);s[L]=e,n[L]=1,r.push(e)}}),this.filterAndSortMediaOptions(r,e,l,o,h)}filterAndSortMediaOptions(t,e,i,r,s){let a=[],n=[],l=t;if((i||r)&&s&&(l=l.filter(t=>{var e;let{videoCodec:i,videoRange:r,width:s,height:a}=t;return(!!i||!!(s&&a))&&!!(e=r)&&eS.indexOf(e)>-1})),0===l.length){Promise.resolve().then(()=>{if(this.hls){e.levels.length&&this.warn("One or more CODECS in variant not supported: ".concat(JSON.stringify(e.levels[0].attrs)));let t=Error("no level with compatible codecs found in manifest");this.hls.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:e.url,error:t,reason:t.message})}});return}if(e.audioTracks){let{preferManagedMediaSource:t}=this.hls.config;sV(a=e.audioTracks.filter(e=>!e.audioCodec||tj(e.audioCodec,"audio",t)))}e.subtitles&&sV(n=e.subtitles);let o=l.slice(0);l.sort((t,e)=>{if(t.attrs["HDCP-LEVEL"]!==e.attrs["HDCP-LEVEL"])return(t.attrs["HDCP-LEVEL"]||"")>(e.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&t.height!==e.height)return t.height-e.height;if(t.frameRate!==e.frameRate)return t.frameRate-e.frameRate;if(t.videoRange!==e.videoRange)return eS.indexOf(t.videoRange)-eS.indexOf(e.videoRange);if(t.videoCodec!==e.videoCodec){let i=tz(t.videoCodec),r=tz(e.videoCodec);if(i!==r)return r-i}if(t.uri===e.uri&&t.codecSet!==e.codecSet){let i=tQ(t.codecSet),r=tQ(e.codecSet);if(i!==r)return r-i}return t.averageBitrate!==e.averageBitrate?t.averageBitrate-e.averageBitrate:0});let h=o[0];if(this.steering&&(l=this.steering.filterParsedLevels(l)).length!==o.length){for(let t=0;t<o.length;t++)if(o[t].pathwayId===l[0].pathwayId){h=o[t];break}}this._levels=l;for(let t=0;t<l.length;t++)if(l[t]===h){var d;this._firstLevel=t;let e=h.bitrate,i=this.hls.bandwidthEstimate;if(this.log("manifest loaded, ".concat(l.length," level(s) found, first bitrate: ").concat(e)),(null==(d=this.hls.userConfig)?void 0:d.abrEwmaDefaultEstimate)===void 0){let t=Math.min(e,this.hls.config.abrEwmaDefaultEstimateMax);t>i&&i===sK.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=t)}break}let c=s&&!r,u={levels:l,audioTracks:a,subtitleTracks:n,sessionData:e.sessionData,sessionKeys:e.sessionKeys,firstLevel:this._firstLevel,stats:e.stats,audio:s,video:r,altAudio:!c&&a.some(t=>!!t.url)};this.hls.trigger(C.MANIFEST_PARSED,u),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(t){let e=this._levels;if(0===e.length)return;if(t<0||t>=e.length){let i=Error("invalid level idx"),r=t<0;if(this.hls.trigger(C.ERROR,{type:w.OTHER_ERROR,details:P.LEVEL_SWITCH_ERROR,level:t,fatal:r,error:i,reason:i.message}),r)return;t=Math.min(t,e.length-1)}let i=this.currentLevelIndex,r=this.currentLevel,s=r?r.attrs["PATHWAY-ID"]:void 0,a=e[t],n=a.attrs["PATHWAY-ID"];if(this.currentLevelIndex=t,this.currentLevel=a,i===t&&a.details&&r&&s===n)return;this.log("Switching to level ".concat(t," (").concat(a.height?a.height+"p ":"").concat(a.videoRange?a.videoRange+" ":"").concat(a.codecSet?a.codecSet+" ":"","@").concat(a.bitrate,")").concat(n?" with Pathway "+n:""," from level ").concat(i).concat(s?" with Pathway "+s:""));let l={level:t,attrs:a.attrs,details:a.details,bitrate:a.bitrate,averageBitrate:a.averageBitrate,maxBitrate:a.maxBitrate,realBitrate:a.realBitrate,width:a.width,height:a.height,codecSet:a.codecSet,audioCodec:a.audioCodec,videoCodec:a.videoCodec,audioGroups:a.audioGroups,subtitleGroups:a.subtitleGroups,loaded:a.loaded,loadError:a.loadError,fragmentError:a.fragmentError,name:a.name,id:a.id,uri:a.uri,url:a.url,urlId:0,audioGroupIds:a.audioGroupIds,textGroupIds:a.textGroupIds};this.hls.trigger(C.LEVEL_SWITCHING,l);let o=a.details;if(!o||o.live){let t=this.switchParams(a.uri,null==r?void 0:r.details);this.loadPlaylist(t)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(t){this.manualLevelIndex=t,void 0===this._startLevel&&(this._startLevel=t),-1!==t&&(this.level=t)}get firstLevel(){return this._firstLevel}set firstLevel(t){this._firstLevel=t}get startLevel(){if(void 0===this._startLevel){let t=this.hls.config.startLevel;return void 0!==t?t:this.hls.firstAutoLevel}return this._startLevel}set startLevel(t){this._startLevel=t}onError(t,e){!e.fatal&&e.context&&e.context.type===er.LEVEL&&e.context.level===this.level&&this.checkRetry(e)}onFragBuffered(t,e){let{frag:i}=e;if(void 0!==i&&i.type===es.MAIN){let t=i.elementaryStreams;if(!Object.keys(t).some(e=>!!t[e]))return;let e=this._levels[i.level];null!=e&&e.loadError&&(this.log("Resetting level error count of ".concat(e.loadError," on frag buffered")),e.loadError=0)}}onLevelLoaded(t,e){var i,r;let{level:s,details:a}=e,n=this._levels[s];if(!n){this.warn("Invalid level index ".concat(s)),null!=(r=e.deliveryDirectives)&&r.skip&&(a.deltaUpdateFailed=!0);return}s===this.currentLevelIndex?(0===n.fragmentError&&(n.loadError=0),this.playlistLoaded(s,e,n.details)):null!=(i=e.deliveryDirectives)&&i.skip&&(a.deltaUpdateFailed=!0)}loadPlaylist(t){super.loadPlaylist();let e=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let r=i.uri;if(t)try{r=t.addDirectives(r)}catch(t){this.warn("Could not construct new URL with HLS Delivery Directives: ".concat(t))}let s=i.attrs["PATHWAY-ID"];this.log("Loading level index ".concat(e).concat((null==t?void 0:t.msn)!==void 0?" at sn "+t.msn+" part "+t.part:""," with").concat(s?" Pathway "+s:""," ").concat(r)),this.clearTimer(),this.hls.trigger(C.LEVEL_LOADING,{url:r,level:e,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}}get nextLoadLevel(){return -1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(t){this.level=t,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=t)}removeLevel(t){var e;let i=this._levels.filter((e,i)=>i!==t||(this.steering&&this.steering.removeLevel(e),e===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,e.details&&e.details.fragments.forEach(t=>t.level=-1)),!1));eP(i),this._levels=i,this.currentLevelIndex>-1&&null!=(e=this.currentLevel)&&e.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(C.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(t,e){let{levels:i}=e;this._levels=i}checkMaxAutoUpdated(){let{autoLevelCapping:t,maxAutoLevel:e,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==e&&(this._maxAutoLevel=e,this.hls.trigger(C.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:t,levels:this.levels,maxAutoLevel:e,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}constructor(t,e){super(t,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=e,this._registerListeners()}}function sV(t){let e={};t.forEach(t=>{let i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}class sY{abort(t){for(let i in this.keyUriToKeyInfo){let r=this.keyUriToKeyInfo[i].loader;if(r){var e;if(t&&t!==(null==(e=r.context)?void 0:e.frag.type))return;r.abort()}}}detach(){for(let t in this.keyUriToKeyInfo){let e=this.keyUriToKeyInfo[t];(e.mediaKeySessionContext||e.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[t]}}destroy(){for(let t in this.detach(),this.keyUriToKeyInfo){let e=this.keyUriToKeyInfo[t].loader;e&&e.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:P.KEY_LOAD_ERROR,i=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0;return new io({type:w.NETWORK_ERROR,details:e,fatal:!1,frag:t,response:s,error:i,networkDetails:r})}loadClear(t,e){if(this.emeController&&this.config.emeEnabled){let{sn:i,cc:r}=t;for(let t=0;t<e.length;t++){let s=e[t];if(r<=s.cc&&("initSegment"===i||"initSegment"===s.sn||i<s.sn)){this.emeController.selectKeySystemFormat(s).then(t=>{s.setKeyFormat(t)});break}}}}load(t){return!t.decryptdata&&t.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(t).then(e=>this.loadInternal(t,e)):this.loadInternal(t)}loadInternal(t,e){var i,r,s;e&&t.setKeyFormat(e);let a=t.decryptdata;if(!a){let i=Error(e?"Expected frag.decryptdata to be defined after setting format ".concat(e):"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(t,P.KEY_LOAD_ERROR,i))}let n=a.uri;if(!n)return Promise.reject(this.createKeyLoadError(t,P.KEY_LOAD_ERROR,Error('Invalid key URI: "'.concat(n,'"'))));let l=this.keyUriToKeyInfo[n];if(null!=(i=l)&&i.decryptdata.key)return a.key=l.decryptdata.key,Promise.resolve({frag:t,keyInfo:l});if(null!=(r=l)&&r.keyLoadPromise)switch(null==(s=l.mediaKeySessionContext)?void 0:s.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return l.keyLoadPromise.then(e=>(a.key=e.keyInfo.decryptdata.key,{frag:t,keyInfo:l}))}switch(l=this.keyUriToKeyInfo[n]={decryptdata:a,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},a.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":if("identity"===a.keyFormat)return this.loadKeyHTTP(l,t);return this.loadKeyEME(l,t);case"AES-128":return this.loadKeyHTTP(l,t);default:return Promise.reject(this.createKeyLoadError(t,P.KEY_LOAD_ERROR,Error('Key supplied with unsupported METHOD: "'.concat(a.method,'"'))))}}loadKeyEME(t,e){let i={frag:e,keyInfo:t};if(this.emeController&&this.config.emeEnabled){let e=this.emeController.loadKey(i);if(e)return(t.keyLoadPromise=e.then(e=>(t.mediaKeySessionContext=e,i))).catch(e=>{throw t.keyLoadPromise=null,e})}return Promise.resolve(i)}loadKeyHTTP(t,e){let i=this.config,r=new i.loader(i);return e.keyLoader=t.loader=r,t.keyLoadPromise=new Promise((s,a)=>{let n={keyInfo:t,frag:e,responseType:"arraybuffer",url:t.decryptdata.uri},l=i.keyLoadPolicy.default,o={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};r.load(n,o,{onSuccess:(t,e,i,r)=>{let{frag:n,keyInfo:l,url:o}=i;if(!n.decryptdata||l!==this.keyUriToKeyInfo[o])return a(this.createKeyLoadError(n,P.KEY_LOAD_ERROR,Error("after key load, decryptdata unset or changed"),r));l.decryptdata.key=n.decryptdata.key=new Uint8Array(t.data),n.keyLoader=null,l.loader=null,s({frag:n,keyInfo:l})},onError:(t,i,r,s)=>{this.resetLoader(i),a(this.createKeyLoadError(e,P.KEY_LOAD_ERROR,Error("HTTP Error ".concat(t.code," loading key ").concat(t.text)),r,D({url:n.url,data:void 0},t)))},onTimeout:(t,i,r)=>{this.resetLoader(i),a(this.createKeyLoadError(e,P.KEY_LOAD_TIMEOUT,Error("key loading timed out"),r))},onAbort:(t,i,r)=>{this.resetLoader(i),a(this.createKeyLoadError(e,P.INTERNAL_ABORTED,Error("key loading aborted"),r))}})})}resetLoader(t){let{frag:e,keyInfo:i,url:r}=t,s=i.loader;e.keyLoader===s&&(e.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[r],s&&s.destroy()}constructor(t){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=t}}function sW(){return self.SourceBuffer||self.WebKitSourceBuffer}function sj(){if(!tY())return!1;let t=sW();return!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove}class sq{destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(t,e){let{config:i,media:r,stalled:s}=this;if(null===r)return;let{currentTime:a,seeking:n}=r,l=this.seeking&&!n,o=!this.seeking&&n;if(this.seeking=n,a!==t){if(this.moved=!0,n||(this.nudgeRetry=0),null!==s){if(this.stallReported){let t=self.performance.now()-s;M.warn("playback not stuck anymore @".concat(a,", after ").concat(Math.round(t),"ms")),this.stallReported=!1}this.stalled=null}return}if(o||l){this.stalled=null;return}if(r.paused&&!n||r.ended||0===r.playbackRate||!e6.getBuffered(r).length){this.nudgeRetry=0;return}let h=e6.bufferInfo(r,a,0),d=h.nextStart||0;if(n){let t=h.len>2,i=!d||e&&e.start<=a||d-a>2&&!this.fragmentTracker.getPartialFragment(a);if(t||i)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var c;if(!(h.len>0)&&!d)return;let t=Math.max(d,h.start||0)-a,e=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,i=(null==e?void 0:null==(c=e.details)?void 0:c.live)?2*e.details.targetduration:2,s=this.fragmentTracker.getPartialFragment(a);if(t>0&&(t<=i||s)){r.paused||this._trySkipBufferHole(s);return}}let u=self.performance.now();if(null===s){this.stalled=u;return}let f=u-s;if(!n&&f>=250&&(this._reportStall(h),!this.media))return;let g=e6.bufferInfo(r,a,i.maxBufferHole);this._tryFixBufferStall(g,f)}_tryFixBufferStall(t,e){let{config:i,fragmentTracker:r,media:s}=this;if(null===s)return;let a=s.currentTime,n=r.getPartialFragment(a);!(n&&(this._trySkipBufferHole(n)||!this.media))&&(t.len>i.maxBufferHole||t.nextStart&&t.nextStart-a<i.maxBufferHole)&&e>1e3*i.highBufferWatchdogPeriod&&(M.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(t){let{hls:e,media:i,stallReported:r}=this;if(!r&&i){this.stallReported=!0;let r=Error("Playback stalling at @".concat(i.currentTime," due to low buffer (").concat(JSON.stringify(t),")"));M.warn(r.message),e.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:t.len})}}_trySkipBufferHole(t){let{config:e,hls:i,media:r}=this;if(null===r)return 0;let s=r.currentTime,a=e6.bufferInfo(r,s,0),n=s<a.start?a.start:a.nextStart;if(n){let l=a.len<=e.maxBufferHole,o=a.len>0&&a.len<1&&r.readyState<3,h=n-s;if(h>0&&(l||o)){if(h>e.maxBufferHole){let{fragmentTracker:e}=this,i=!1;if(0===s){let t=e.getAppendedFrag(0,es.MAIN);t&&n<t.end&&(i=!0)}if(!i){let i=t||e.getAppendedFrag(s,es.MAIN);if(i){let t=!1,r=i.end;for(;r<n;){let i=e.getPartialFragment(r);if(i)r+=i.duration;else{t=!0;break}}if(t)return 0}}}let a=Math.max(n+.05,s+.1);if(M.warn("skipping hole, adjusting currentTime from ".concat(s," to ").concat(a)),this.moved=!0,this.stalled=null,r.currentTime=a,t&&!t.gap){let e=Error("fragment loaded with buffer holes, seeking from ".concat(s," to ").concat(a));i.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:e,reason:e.message,frag:t})}return a}}return 0}_tryNudgeBuffer(){let{config:t,hls:e,media:i,nudgeRetry:r}=this;if(null===i)return;let s=i.currentTime;if(this.nudgeRetry++,r<t.nudgeMaxRetry){let a=s+(r+1)*t.nudgeOffset,n=Error("Nudging 'currentTime' from ".concat(s," to ").concat(a));M.warn(n.message),i.currentTime=a,e.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.BUFFER_NUDGE_ON_STALL,error:n,fatal:!1})}else{let i=Error("Playhead still not moving while enough data buffered @".concat(s," after ").concat(t.nudgeMaxRetry," nudges"));M.error(i.message),e.trigger(C.ERROR,{type:w.MEDIA_ERROR,details:P.BUFFER_STALLED_ERROR,error:i,fatal:!0})}}constructor(t,e,i,r){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=t,this.media=e,this.fragmentTracker=i,this.hls=r}}class sX extends ip{_registerListeners(){let{hls:t}=this;t.on(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.on(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.on(C.MANIFEST_LOADING,this.onManifestLoading,this),t.on(C.MANIFEST_PARSED,this.onManifestParsed,this),t.on(C.LEVEL_LOADING,this.onLevelLoading,this),t.on(C.LEVEL_LOADED,this.onLevelLoaded,this),t.on(C.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.on(C.ERROR,this.onError,this),t.on(C.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.on(C.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.on(C.BUFFER_CREATED,this.onBufferCreated,this),t.on(C.BUFFER_FLUSHED,this.onBufferFlushed,this),t.on(C.LEVELS_UPDATED,this.onLevelsUpdated,this),t.on(C.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:t}=this;t.off(C.MEDIA_ATTACHED,this.onMediaAttached,this),t.off(C.MEDIA_DETACHING,this.onMediaDetaching,this),t.off(C.MANIFEST_LOADING,this.onManifestLoading,this),t.off(C.MANIFEST_PARSED,this.onManifestParsed,this),t.off(C.LEVEL_LOADED,this.onLevelLoaded,this),t.off(C.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),t.off(C.ERROR,this.onError,this),t.off(C.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),t.off(C.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),t.off(C.BUFFER_CREATED,this.onBufferCreated,this),t.off(C.BUFFER_FLUSHED,this.onBufferFlushed,this),t.off(C.LEVELS_UPDATED,this.onLevelsUpdated,this),t.off(C.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(t){if(this.levels){let{lastCurrentTime:e,hls:i}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let t=i.startLevel;-1===t&&(i.config.testBandwidth&&this.levels.length>1?(t=0,this.bitrateTest=!0):t=i.firstAutoLevel),i.nextLoadLevel=t,this.level=i.loadLevel,this.loadedmetadata=!1}e>0&&-1===t&&(this.log("Override startPosition with lastCurrentTime @".concat(e.toFixed(3))),t=e),this.state=im.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=t,this.tick()}else this._forceStartLoad=!0,this.state=im.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case im.WAITING_LEVEL:{let{levels:t,level:e}=this,i=null==t?void 0:t[e],r=null==i?void 0:i.details;if(r&&(!r.live||this.levelLastLoaded===i)){if(this.waitForCdnTuneIn(r))break;this.state=im.IDLE}else this.hls.nextLoadLevel!==this.level&&(this.state=im.IDLE);break}case im.FRAG_LOADING_WAITING_RETRY:{var t;let e=self.performance.now(),i=this.retryDate;if(!i||e>=i||null!=(t=this.media)&&t.seeking){let{levels:t,level:e}=this,i=null==t?void 0:t[e];this.resetStartWhenNotLoaded(i||null),this.state=im.IDLE}}}this.state===im.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){let{hls:t,levelLastLoaded:e,levels:i,media:r}=this;if(null===e||!r&&(this.startFragRequested||!t.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;let s=t.nextLoadLevel;if(!(null!=i&&i[s]))return;let a=i[s],n=this.getMainFwdBufferInfo();if(null===n)return;let l=this.getLevelDetails();if(l&&this._streamEnded(n,l)){let t={};this.altAudio&&(t.type="video"),this.hls.trigger(C.BUFFER_EOS,t),this.state=im.ENDED;return}t.loadLevel!==s&&-1===t.manualLevel&&this.log("Adapting to level ".concat(s," from level ").concat(this.level)),this.level=t.nextLoadLevel=s;let o=a.details;if(!o||this.state===im.WAITING_LEVEL||o.live&&this.levelLastLoaded!==a){this.level=s,this.state=im.WAITING_LEVEL;return}let h=n.len,d=this.getMaxBufferLength(a.maxBitrate);if(h>=d)return;this.backtrackFragment&&this.backtrackFragment.start>n.end&&(this.backtrackFragment=null);let c=this.backtrackFragment?this.backtrackFragment.start:n.end,u=this.getNextFragment(c,o);if(this.couldBacktrack&&!this.fragPrevious&&u&&"initSegment"!==u.sn&&this.fragmentTracker.getState(u)!==e2.OK){var f;let t=(null!=(f=this.backtrackFragment)?f:u).sn-o.startSN,e=o.fragments[t-1];e&&u.cc===e.cc&&(u=e,this.fragmentTracker.removeFragment(e))}else this.backtrackFragment&&n.len&&(this.backtrackFragment=null);if(u&&this.isLoopLoading(u,c)){if(!u.gap){let t=this.audioOnly&&!this.altAudio?H.AUDIO:H.VIDEO,e=(t===H.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;e&&this.afterBufferFlushed(e,t,es.MAIN)}u=this.getNextFragmentLoopLoading(u,o,n,es.MAIN,d)}u&&(!u.initSegment||u.initSegment.data||this.bitrateTest||(u=u.initSegment),this.loadFragment(u,a,c))}loadFragment(t,e,i){let r=this.fragmentTracker.getState(t);this.fragCurrent=t,r===e2.NOT_LOADED||r===e2.PARTIAL?"initSegment"===t.sn?this._loadInitSegment(t,e):this.bitrateTest?(this.log("Fragment ".concat(t.sn," of level ").concat(t.level," is being downloaded to test bitrate and will not be buffered")),this._loadBitrateTestFrag(t,e)):(this.startFragRequested=!0,super.loadFragment(t,e,i)):this.clearTrackerIfNeeded(t)}getBufferedFrag(t){return this.fragmentTracker.getBufferedFrag(t,es.MAIN)}followingBufferedFrag(t){return t?this.getBufferedFrag(t.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){let{levels:t,media:e}=this;if(null!=e&&e.readyState){let i;let r=this.getAppendedFrag(e.currentTime);r&&r.start>1&&this.flushMainBuffer(0,r.start-1);let s=this.getLevelDetails();if(null!=s&&s.live){let t=this.getMainFwdBufferInfo();if(!t||t.len<2*s.targetduration)return}if(!e.paused&&t){let e=t[this.hls.nextLoadLevel],r=this.fragLastKbps;i=r&&this.fragCurrent?this.fragCurrent.duration*e.maxBitrate/(1e3*r)+1:0}else i=0;let a=this.getBufferedFrag(e.currentTime+i);if(a){let t=this.followingBufferedFrag(a);if(t){this.abortCurrentFrag();let e=t.maxStartPTS?t.maxStartPTS:t.start,i=t.duration,r=Math.max(a.end,e+Math.min(Math.max(i-this.config.maxFragLookUpTolerance,i*(this.couldBacktrack?.5:.125)),i*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(r,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){let t=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,t&&(t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.state){case im.KEY_LOADING:case im.FRAG_LOADING:case im.FRAG_LOADING_WAITING_RETRY:case im.PARSING:case im.PARSED:this.state=im.IDLE}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(t,e){super.flushMainBuffer(t,e,this.altAudio?"video":null)}onMediaAttached(t,e){super.onMediaAttached(t,e);let i=e.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new sq(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){let{media:t}=this;t&&this.onvplaying&&this.onvseeked&&(t.removeEventListener("playing",this.onvplaying),t.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){let t=this.media,e=t?t.currentTime:null;b(e)&&this.log("Media seeked to ".concat(e.toFixed(3)));let i=this.getMainFwdBufferInfo();if(null===i||0===i.len){this.warn('Main forward buffer length on "seeked" event '.concat(i?i.len:"empty",")"));return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(C.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(t,e){let i=!1,r=!1;e.levels.forEach(t=>{let e=t.audioCodec;e&&(i=i||-1!==e.indexOf("mp4a.40.2"),r=r||-1!==e.indexOf("mp4a.40.5"))}),this.audioCodecSwitch=i&&r&&!function(){var t;let e=sW();return"function"==typeof(null==e?void 0:null==(t=e.prototype)?void 0:t.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=e.levels,this.startFragRequested=!1}onLevelLoading(t,e){let{levels:i}=this;if(!i||this.state!==im.IDLE)return;let r=i[e.level];(!r.details||r.details.live&&this.levelLastLoaded!==r||this.waitForCdnTuneIn(r.details))&&(this.state=im.WAITING_LEVEL)}onLevelLoaded(t,e){var i,r;let{levels:s}=this,a=e.level,n=e.details,l=n.totalduration;if(!s){this.warn("Levels were reset while loading level ".concat(a));return}this.log("Level ".concat(a," loaded [").concat(n.startSN,",").concat(n.endSN,"]").concat(n.lastPartSn?"[part-".concat(n.lastPartSn,"-").concat(n.lastPartIndex,"]"):"",", cc [").concat(n.startCC,", ").concat(n.endCC,"] duration:").concat(l));let o=s[a],h=this.fragCurrent;h&&(this.state===im.FRAG_LOADING||this.state===im.FRAG_LOADING_WAITING_RETRY)&&h.level!==e.level&&h.loader&&this.abortCurrentFrag();let d=0;if(n.live||null!=(i=o.details)&&i.live){if(this.checkLiveUpdate(n),n.deltaUpdateFailed)return;d=this.alignPlaylists(n,o.details,null==(r=this.levelLastLoaded)?void 0:r.details)}if(o.details=n,this.levelLastLoaded=o,this.hls.trigger(C.LEVEL_UPDATED,{details:n,level:a}),this.state===im.WAITING_LEVEL){if(this.waitForCdnTuneIn(n))return;this.state=im.IDLE}this.startFragRequested?n.live&&this.synchronizeToLiveEdge(n):this.setStartPosition(n,d),this.tick()}_handleFragmentLoadProgress(t){var e;let{frag:i,part:r,payload:s}=t,{levels:a}=this;if(!a){this.warn("Levels were reset while fragment load was in progress. Fragment ".concat(i.sn," of level ").concat(i.level," will not be buffered"));return}let n=a[i.level],l=n.details;if(!l){this.warn("Dropping fragment ".concat(i.sn," of level ").concat(i.level," after level details were reset")),this.fragmentTracker.removeFragment(i);return}let o=n.videoCodec,h=l.PTSKnown||!l.live,d=null==(e=i.initSegment)?void 0:e.data,c=this._getAudioCodec(n),u=this.transmuxer=this.transmuxer||new rh(this.hls,es.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),f=r?r.index:-1,g=new e9(i.level,i.sn,i.stats.chunkCount,s.byteLength,f,-1!==f),m=this.initPTS[i.cc];u.push(s,d,c,o,i,r,l.totalduration,h,g,m)}onAudioTrackSwitching(t,e){let i=this.altAudio;if(!e.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;let t=this.fragCurrent;t&&(this.log("Switching to main audio track, cancel main fragment load"),t.abortRequests(),this.fragmentTracker.removeFragment(t)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();let t=this.hls;i&&(t.trigger(C.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),t.trigger(C.AUDIO_TRACK_SWITCHED,e)}}onAudioTrackSwitched(t,e){let i=e.id,r=!!this.hls.audioTracks[i].url;if(r){let t=this.videoBuffer;t&&this.mediaBuffer!==t&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=t)}this.altAudio=r,this.tick()}onBufferCreated(t,e){let i,r;let s=e.tracks,a=!1;for(let t in s){let e=s[t];if("main"===e.id){if(r=t,i=e,"video"===t){let e=s[t];e&&(this.videoBuffer=e.buffer)}}else a=!0}a&&i?(this.log("Alternate track found, use ".concat(r,".buffered to schedule main fragment loading")),this.mediaBuffer=i.buffer):this.mediaBuffer=this.media}onFragBuffered(t,e){let{frag:i,part:r}=e;if(i&&i.type!==es.MAIN)return;if(this.fragContextChanged(i)){this.warn("Fragment ".concat(i.sn).concat(r?" p: "+r.index:""," of level ").concat(i.level," finished buffering, but was aborted. state: ").concat(this.state)),this.state===im.PARSED&&(this.state=im.IDLE);return}let s=r?r.stats:i.stats;this.fragLastKbps=Math.round(8*s.total/(s.buffering.end-s.loading.first)),"initSegment"!==i.sn&&(this.fragPrevious=i),this.fragBufferedComplete(i,r)}onError(t,e){var i;if(e.fatal){this.state=im.ERROR;return}switch(e.details){case P.FRAG_GAP:case P.FRAG_PARSING_ERROR:case P.FRAG_DECRYPT_ERROR:case P.FRAG_LOAD_ERROR:case P.FRAG_LOAD_TIMEOUT:case P.KEY_LOAD_ERROR:case P.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(es.MAIN,e);break;case P.LEVEL_LOAD_ERROR:case P.LEVEL_LOAD_TIMEOUT:case P.LEVEL_PARSING_ERROR:e.levelRetry||this.state!==im.WAITING_LEVEL||(null==(i=e.context)?void 0:i.type)!==er.LEVEL||(this.state=im.IDLE);break;case P.BUFFER_APPEND_ERROR:case P.BUFFER_FULL_ERROR:if(!e.parent||"main"!==e.parent)return;if(e.details===P.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(e)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case P.INTERNAL_EXCEPTION:this.recoverWorkerError(e)}}checkBuffer(){let{media:t,gapController:e}=this;if(t&&e&&t.readyState){if(this.loadedmetadata||!e6.getBuffered(t).length){let t=this.state!==im.IDLE?this.fragCurrent:null;e.poll(this.lastCurrentTime,t)}this.lastCurrentTime=t.currentTime}}onFragLoadEmergencyAborted(){this.state=im.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(t,e){let{type:i}=e;if(i!==H.AUDIO||this.audioOnly&&!this.altAudio){let t=(i===H.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(t,i,es.MAIN),this.tick()}}onLevelsUpdated(t,e){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=e.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){let{media:t}=this;if(!t)return;let e=t.currentTime,i=this.startPosition;if(i>=0&&e<i){if(t.seeking){this.log("could not seek to ".concat(i,", already seeking at ").concat(e));return}let r=e6.getBuffered(t),s=(r.length?r.start(0):0)-i;s>0&&(s<this.config.maxBufferHole||s<this.config.maxFragLookUpTolerance)&&(this.log("adjusting start position by ".concat(s," to match buffer start")),i+=s,this.startPosition=i),this.log("seek to target start position ".concat(i," from current time ").concat(e)),t.currentTime=i}}_getAudioCodec(t){let e=this.config.defaultAudioCodec||t.audioCodec;return this.audioCodecSwap&&e&&(this.log("Swapping audio codec"),e=-1!==e.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),e}_loadBitrateTestFrag(t,e){t.bitrateTest=!0,this._doFragLoad(t,e).then(i=>{let{hls:r}=this;if(!i||this.fragContextChanged(t))return;e.fragmentError=0,this.state=im.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;let s=t.stats;s.parsing.start=s.parsing.end=s.buffering.start=s.buffering.end=self.performance.now(),r.trigger(C.FRAG_LOADED,i),t.bitrateTest=!1})}_handleTransmuxComplete(t){var e;let i="main",{hls:r}=this,{remuxResult:s,chunkMeta:a}=t,n=this.getCurrentContext(a);if(!n){this.resetWhenMissingContext(a);return}let{frag:l,part:o,level:h}=n,{video:d,text:c,id3:u,initSegment:f}=s,{details:g}=h,m=this.altAudio?void 0:s.audio;if(this.fragContextChanged(l)){this.fragmentTracker.removeFragment(l);return}if(this.state=im.PARSING,f){if(null!=f&&f.tracks){let t=l.initSegment||l;this._bufferInitSegment(h,f.tracks,t,a),r.trigger(C.FRAG_PARSING_INIT_SEGMENT,{frag:t,id:i,tracks:f.tracks})}let t=f.initPTS,e=f.timescale;b(t)&&(this.initPTS[l.cc]={baseTime:t,timescale:e},r.trigger(C.INIT_PTS_FOUND,{frag:l,id:i,initPTS:t,timescale:e}))}if(d&&g&&"initSegment"!==l.sn){let t=g.fragments[l.sn-1-g.startSN],e=l.sn===g.startSN,i=!t||l.cc>t.cc;if(!1!==s.independent){let{startPTS:t,endPTS:r,startDTS:s,endDTS:n}=d;if(o)o.elementaryStreams[d.type]={startPTS:t,endPTS:r,startDTS:s,endDTS:n};else if(d.firstKeyFrame&&d.independent&&1===a.id&&!i&&(this.couldBacktrack=!0),d.dropped&&d.independent){let s=this.getMainFwdBufferInfo(),a=(s?s.end:this.getLoadPosition())+this.config.maxBufferHole,o=d.firstKeyFramePTS?d.firstKeyFramePTS:t;if(e||!(a<o-this.config.maxBufferHole)||i)i&&(l.gap=!0);else{this.backtrack(l);return}l.setElementaryStreamInfo(d.type,l.start,r,l.start,n,!0)}else e&&t>2&&(l.gap=!0);l.setElementaryStreamInfo(d.type,t,r,s,n),this.backtrackFragment&&(this.backtrackFragment=l),this.bufferFragmentData(d,l,o,a,e||i)}else if(e||i)l.gap=!0;else{this.backtrack(l);return}}if(m){let{startPTS:t,endPTS:e,startDTS:i,endDTS:r}=m;o&&(o.elementaryStreams[H.AUDIO]={startPTS:t,endPTS:e,startDTS:i,endDTS:r}),l.setElementaryStreamInfo(H.AUDIO,t,e,i,r),this.bufferFragmentData(m,l,o,a)}if(g&&null!=u&&null!=(e=u.samples)&&e.length){let t={id:i,frag:l,details:g,samples:u.samples};r.trigger(C.FRAG_PARSING_METADATA,t)}if(g&&c){let t={id:i,frag:l,details:g,samples:c.samples};r.trigger(C.FRAG_PARSING_USERDATA,t)}}_bufferInitSegment(t,e,i,r){if(this.state!==im.PARSING)return;this.audioOnly=!!e.audio&&!e.video,this.altAudio&&!this.audioOnly&&delete e.audio;let{audio:s,video:a,audiovideo:n}=e;if(s){let e=t.audioCodec,i=navigator.userAgent.toLowerCase();this.audioCodecSwitch&&(e&&(e=-1!==e.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),1!==s.metadata.channelCount&&-1===i.indexOf("firefox")&&(e="mp4a.40.5")),e&&-1!==e.indexOf("mp4a.40.5")&&-1!==i.indexOf("android")&&"audio/mpeg"!==s.container&&(e="mp4a.40.2",this.log("Android: force audio codec to ".concat(e))),t.audioCodec&&t.audioCodec!==e&&this.log('Swapping manifest audio codec "'.concat(t.audioCodec,'" for "').concat(e,'"')),s.levelCodec=e,s.id="main",this.log("Init audio buffer, container:".concat(s.container,", codecs[selected/level/parsed]=[").concat(e||"","/").concat(t.audioCodec||"","/").concat(s.codec,"]"))}a&&(a.levelCodec=t.videoCodec,a.id="main",this.log("Init video buffer, container:".concat(a.container,", codecs[level/parsed]=[").concat(t.videoCodec||"","/").concat(a.codec,"]"))),n&&this.log("Init audiovideo buffer, container:".concat(n.container,", codecs[level/parsed]=[").concat(t.codecs,"/").concat(n.codec,"]")),this.hls.trigger(C.BUFFER_CODECS,e),Object.keys(e).forEach(t=>{let s=e[t].initSegment;null!=s&&s.byteLength&&this.hls.trigger(C.BUFFER_APPENDING,{type:t,data:s,frag:i,part:null,chunkMeta:r,parent:i.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,es.MAIN)}backtrack(t){this.couldBacktrack=!0,this.backtrackFragment=t,this.resetTransmuxer(),this.flushBufferGap(t),this.fragmentTracker.removeFragment(t),this.fragPrevious=null,this.nextLoadPosition=t.start,this.state=im.IDLE}checkFragmentChanged(){let t=this.media,e=null;if(t&&t.readyState>1&&!1===t.seeking){let i=t.currentTime;if(e6.isBuffered(t,i)?e=this.getAppendedFrag(i):e6.isBuffered(t,i+.1)&&(e=this.getAppendedFrag(i+.1)),e){this.backtrackFragment=null;let t=this.fragPlaying,i=e.level;t&&e.sn===t.sn&&t.level===i||(this.fragPlaying=e,this.hls.trigger(C.FRAG_CHANGED,{frag:e}),t&&t.level===i||this.hls.trigger(C.LEVEL_SWITCHED,{level:i}))}}}get nextLevel(){let t=this.nextBufferedFrag;return t?t.level:-1}get currentFrag(){let t=this.media;return t?this.fragPlaying||this.getAppendedFrag(t.currentTime):null}get currentProgramDateTime(){let t=this.media;if(t){let e=t.currentTime,i=this.currentFrag;if(i&&b(e)&&b(i.programDateTime))return new Date(i.programDateTime+(e-i.start)*1e3)}return null}get currentLevel(){let t=this.currentFrag;return t?t.level:-1}get nextBufferedFrag(){let t=this.currentFrag;return t?this.followingBufferedFrag(t):null}get forceStartLoad(){return this._forceStartLoad}constructor(t,e,i){super(t,e,i,"[stream-controller]",es.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}}class sz{static get version(){return"1.5.7"}static isMSESupported(){return sj()}static isSupported(){return function(){if(!sj())return!1;let t=tY();return"function"==typeof(null==t?void 0:t.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>t.isTypeSupported(tX(e,"video")))||["mp4a.40.2","fLaC"].some(e=>t.isTypeSupported(tX(e,"audio"))))}()}static getMediaSource(){return tY()}static get Events(){return C}static get ErrorTypes(){return w}static get ErrorDetails(){return P}static get DefaultConfig(){return sz.defaultConfig?sz.defaultConfig:sK}static set DefaultConfig(t){sz.defaultConfig=t}createController(t,e){if(t){let i=new t(this);return e&&e.push(i),i}return null}on(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this;this._emitter.on(t,e,i)}once(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this;this._emitter.once(t,e,i)}removeAllListeners(t){this._emitter.removeAllListeners(t)}off(t,e){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this,r=arguments.length>3?arguments[3]:void 0;this._emitter.off(t,e,i,r)}listeners(t){return this._emitter.listeners(t)}emit(t,e,i){return this._emitter.emit(t,e,i)}trigger(t,e){if(this.config.debug)return this.emit(t,t,e);try{return this.emit(t,t,e)}catch(e){if(M.error("An internal error happened while handling event "+t+'. Error message: "'+e.message+'". Here is a stacktrace:',e),!this.triggeringException){this.triggeringException=!0;let i=t===C.ERROR;this.trigger(C.ERROR,{type:w.OTHER_ERROR,details:P.INTERNAL_EXCEPTION,fatal:i,event:t,error:e}),this.triggeringException=!1}}return!1}listenerCount(t){return this._emitter.listenerCount(t)}destroy(){M.log("destroy"),this.trigger(C.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;let t=this.config;t.xhrSetup=t.fetchSetup=void 0,this.userConfig=null}attachMedia(t){M.log("attachMedia"),this._media=t,this.trigger(C.MEDIA_ATTACHING,{media:t})}detachMedia(){M.log("detachMedia"),this.trigger(C.MEDIA_DETACHING,void 0),this._media=null}loadSource(t){this.stopLoad();let e=this.media,i=this.url,r=this.url=L.buildAbsoluteURL(self.location.href,t,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,M.log("loadSource:".concat(r)),e&&i&&(i!==r||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(e)),this.trigger(C.MANIFEST_LOADING,{url:t})}startLoad(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;M.log("startLoad(".concat(t,")")),this.started=!0,this.networkControllers.forEach(e=>{e.startLoad(t)})}stopLoad(){M.log("stopLoad"),this.started=!1,this.networkControllers.forEach(t=>{t.stopLoad()})}resumeBuffering(){this.started&&this.networkControllers.forEach(t=>{"fragmentLoader"in t&&t.startLoad(-1)})}pauseBuffering(){this.networkControllers.forEach(t=>{"fragmentLoader"in t&&t.stopLoad()})}swapAudioCodec(){M.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){M.log("recoverMediaError");let t=this._media;this.detachMedia(),t&&this.attachMedia(t)}removeLevel(t){this.levelController.removeLevel(t)}get levels(){return this.levelController.levels||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(t){M.log("set currentLevel:".concat(t)),this.levelController.manualLevel=t,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(t){M.log("set nextLevel:".concat(t)),this.levelController.manualLevel=t,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(t){M.log("set loadLevel:".concat(t)),this.levelController.manualLevel=t}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(t){this.levelController.nextLoadLevel=t}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(t){M.log("set firstLevel:".concat(t)),this.levelController.firstLevel=t}get startLevel(){let t=this.levelController.startLevel;return -1===t&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:t}set startLevel(t){M.log("set startLevel:".concat(t)),-1!==t&&(t=Math.max(t,this.minAutoLevel)),this.levelController.startLevel=t}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(t){let e=!!t;e!==this.config.capLevelToPlayerSize&&(e?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=e)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){let{bwEstimator:t}=this.abrController;return t?t.getEstimate():NaN}set bandwidthEstimate(t){this.abrController.resetEstimator(t)}get ttfbEstimate(){let{bwEstimator:t}=this.abrController;return t?t.getEstimateTTFB():NaN}set autoLevelCapping(t){this._autoLevelCapping!==t&&(M.log("set autoLevelCapping:".concat(t)),this._autoLevelCapping=t,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(t){ev.indexOf(t)>-1&&this._maxHdcpLevel!==t&&(this._maxHdcpLevel=t,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return -1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){let{levels:t,config:{minAutoBitrate:e}}=this;if(!t)return 0;let i=t.length;for(let r=0;r<i;r++)if(t[r].maxBitrate>=e)return r;return 0}get maxAutoLevel(){let t;let{levels:e,autoLevelCapping:i,maxHdcpLevel:r}=this;if(t=-1===i&&null!=e&&e.length?e.length-1:i,r)for(let i=t;i--;){let t=e[i].attrs["HDCP-LEVEL"];if(t&&t<=r)return i}return t}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(t){this.abrController.nextAutoLevel=t}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(t){var e;return null==(e=this.audioTrackController)?void 0:e.setAudioOption(t)}setSubtitleOption(t){var e;return null==(e=this.subtitleTrackController)||e.setSubtitleOption(t),null}get allAudioTracks(){let t=this.audioTrackController;return t?t.allAudioTracks:[]}get audioTracks(){let t=this.audioTrackController;return t?t.audioTracks:[]}get audioTrack(){let t=this.audioTrackController;return t?t.audioTrack:-1}set audioTrack(t){let e=this.audioTrackController;e&&(e.audioTrack=t)}get allSubtitleTracks(){let t=this.subtitleTrackController;return t?t.allSubtitleTracks:[]}get subtitleTracks(){let t=this.subtitleTrackController;return t?t.subtitleTracks:[]}get subtitleTrack(){let t=this.subtitleTrackController;return t?t.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(t){let e=this.subtitleTrackController;e&&(e.subtitleTrack=t)}get subtitleDisplay(){let t=this.subtitleTrackController;return!!t&&t.subtitleDisplay}set subtitleDisplay(t){let e=this.subtitleTrackController;e&&(e.subtitleDisplay=t)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(t){this.config.lowLatencyMode=t}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}constructor(t={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new ro,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,function(t,e){if("object"==typeof console&&!0===t||"object"==typeof t){!function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];i.forEach(function(e){F[e]=t[e]?t[e].bind(t):function(t){let e=self.console[t];return e?e.bind(self.console,"[".concat(t,"] >")):x}(e)})}(t,"debug","log","info","warn","error");try{F.log('Debug logs enabled for "'.concat(e,'" in hls.js version ',"1.5.7"))}catch(t){F=O}}else F=O}(t.debug||!1,"Hls instance");let e=this.config=function(t,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==e.liveMaxLatencyDurationCount&&(void 0===e.liveSyncDurationCount||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==e.liveMaxLatencyDuration&&(void 0===e.liveSyncDuration||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');let i=function t(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(t):Object.keys(e).reduce((i,r)=>(i[r]=t(e[r]),i),{}):e}(t),r=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach(t=>{let s="".concat("level"===t?"playlist":t,"LoadPolicy"),a=void 0===e[s],n=[];r.forEach(r=>{let l="".concat(t,"Loading").concat(r),o=e[l];if(void 0!==o&&a){n.push(l);let t=i[s].default;switch(e[s]={default:t},r){case"TimeOut":t.maxLoadTimeMs=o,t.maxTimeToFirstByteMs=o;break;case"MaxRetry":t.errorRetry.maxNumRetry=o,t.timeoutRetry.maxNumRetry=o;break;case"RetryDelay":t.errorRetry.retryDelayMs=o,t.timeoutRetry.retryDelayMs=o;break;case"MaxRetryTimeout":t.errorRetry.maxRetryDelayMs=o,t.timeoutRetry.maxRetryDelayMs=o}}}),n.length&&M.warn('hls.js config: "'.concat(n.join('", "'),'" setting(s) are deprecated, use "').concat(s,'": ').concat(JSON.stringify(e[s])))}),D(D({},i),e)}(sz.DefaultConfig,t);this.userConfig=t,e.progressive&&function(t){let e=t.loader;e!==sN&&e!==sF?(M.log("[config]: Custom loader detected, cannot enable progressive streaming"),t.progressive=!1):function(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(t){}return!1}()&&(t.loader=sN,t.progressive=!0,t.enableSoftwareAES=!0,M.log("[config]: Progressive streaming enabled, using FetchLoader"))}(e);let{abrController:i,bufferController:r,capLevelController:s,errorController:a,fpsController:n}=e,l=new a(this),o=this.abrController=new i(this),h=this.bufferController=new r(this),d=this.capLevelController=new s(this),c=new n(this),u=new el(this),f=new eT(this),g=e.contentSteeringController,m=g?new g(this):null,p=this.levelController=new sH(this,m),E=new e4(this),T=new sY(this.config),y=this.streamController=new sX(this,E,T);d.setStreamController(y),c.setStreamController(y);let v=[u,p,y];m&&v.splice(1,0,m),this.networkControllers=v;let S=[o,h,d,c,f,E];this.audioTrackController=this.createController(e.audioTrackController,v);let A=e.audioStreamController;A&&v.push(new A(this,E,T)),this.subtitleTrackController=this.createController(e.subtitleTrackController,v);let L=e.subtitleStreamController;L&&v.push(new L(this,E,T)),this.createController(e.timelineController,S),T.emeController=this.emeController=this.createController(e.emeController,S),this.cmcdController=this.createController(e.cmcdController,S),this.latencyController=this.createController(ey,S),this.coreComponents=S,v.push(l);let R=l.onErrorOut;"function"==typeof R&&this.on(C.ERROR,R,l)}}sz.defaultConfig=void 0}}]);